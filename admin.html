<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULY - 验证码管理</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .admin-container { max-width: 700px; width: 100%; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        
        /* 登录界面样式 */
        .login-container { text-align: center; }
        .login-title { color: #333; margin-bottom: 20px; font-size: 28px; }
        .login-form { margin-top: 30px; }
        .login-input { width: 100%; padding: 12px 15px; margin-bottom: 20px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        .login-input:focus { outline: none; border-color: #4caf50; }
        .login-btn { background: linear-gradient(to right, #4caf50, #45a049); color: white; border: none; padding: 14px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; width: 100%; transition: transform 0.2s, box-shadow 0.2s; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4); }
        .login-btn:disabled { background: #cccccc; cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* 主界面样式 */
        .main-content { display: none; }
        h1 { color: #333; margin-bottom: 30px; text-align: center; font-size: 24px; }
        .info-box { background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; transition: border-color 0.3s; }
        input:focus { outline: none; border-color: #4caf50; }
        button { background: linear-gradient(to right, #4caf50, #45a049); color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600; transition: transform 0.2s, box-shadow 0.2s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4); }
        .current-code { background: #fff8e1; padding: 15px; border-radius: 5px; margin-top: 20px; border: 1px solid #ffe082; }
        .message { padding: 12px 15px; margin: 10px 0; border-radius: 5px; display: none; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        /* 头部样式 */
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        .user-info { font-size: 14px; color: #666; }
        .logout-btn { background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background 0.3s; }
        .logout-btn:hover { background: #d32f2f; }
        
        /* 安全提示 */
        .security-note { background: #fff3e0; border: 1px solid #ffb74d; padding: 10px; border-radius: 5px; margin-top: 20px; font-size: 14px; color: #e65100; }
        
        /* 加载动画 */
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #4caf50; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* GitHub状态样式 */
        .github-status { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin-top: 10px; 
            padding: 8px; 
            background: #f5f5f5; 
            border-radius: 5px; 
            font-size: 14px; 
        }
        .github-status.synced { color: #4caf50; }
        .github-status.local { color: #ff9800; }
        .github-status.error { color: #f44336; }
        
        /* 按钮组 */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .sync-btn { 
            background: linear-gradient(to right, #2196f3, #1976d2);
            flex: 1;
        }
        .sync-btn:hover { 
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4); 
        }
        .test-btn { 
            background: linear-gradient(to right, #ff9800, #f57c00);
            flex: 1;
        }
        .test-btn:hover { 
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4); 
        }
        
        /* 配置区域 */
        .config-section {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .config-section h3 {
            margin-bottom: 10px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="admin-container" id="adminContainer">
        <!-- 登录界面 -->
        <div class="login-container" id="loginContainer">
            <h2 class="login-title"><i class="fas fa-lock"></i> 管理员登录</h2>
            <div class="info-box">
                <p><strong>安全提示：</strong> 请使用管理员密码登录。为防止暴力破解，连续5次失败将锁定30分钟。</p>
            </div>
            <form class="login-form" id="loginForm" onsubmit="return false;">
                <div class="form-group">
                    <input type="password" 
                           id="adminPassword" 
                           class="login-input" 
                           placeholder="输入管理员密码" 
                           required
                           autocomplete="off">
                </div>
                <button type="submit" 
                        class="login-btn" 
                        onclick="adminLogin()" 
                        id="loginBtn">
                    <span id="loginText">登录</span>
                    <span id="loginLoading" style="display:none;">登录中...</span>
                </button>
            </form>
            <div class="message" id="loginMessage"></div>
            <div class="security-note">
                <p><small><i class="fas fa-shield-alt"></i> 系统已启用防注入保护和安全会话管理</small></p>
            </div>
        </div>
        
        <!-- 主管理界面 -->
        <div class="main-content" id="mainContent">
            <div class="admin-header">
                <h1><i class="fas fa-cog"></i> ULY 验证码管理系统</h1>
                <div class="user-info">
                    <span id="sessionInfo">会话有效期：--:--</span>
                    <button class="logout-btn" onclick="adminLogout()">
                        <i class="fas fa-sign-out-alt"></i> 退出
                    </button>
                </div>
            </div>
            
            <!-- GitHub配置区域 -->
            <div class="config-section">
                <h3><i class="fab fa-github"></i> GitHub Gist 配置</h3>
                <div class="form-group">
                    <label for="gist-id">Gist ID:</label>
                    <input type="text" 
                           id="gist-id" 
                           placeholder="请输入你的GitHub Gist ID"
                           value="">
                    <small style="color: #666;">在GitHub创建Gist后获取的ID</small>
                </div>
                <div class="form-group">
                    <label for="github-token">GitHub Token:</label>
                    <input type="password" 
                           id="github-token" 
                           placeholder="请输入GitHub Personal Access Token"
                           value="">
                    <small style="color: #666;">需要gist权限的Token（只用于更新Gist）</small>
                </div>
                <button onclick="saveGistConfig()" class="sync-btn">
                    <i class="fas fa-save"></i> 保存配置
                </button>
            </div>
            
            <div class="info-box">
                <p><strong>说明：</strong> 更新验证码将自动同步到GitHub Gist，所有设备会立即生效。</p>
                <p><strong>配置步骤：</strong> 1. 创建GitHub Gist → 2. 创建GitHub Token → 3. 填入上方配置</p>
            </div>
            
            <form id="codeForm" onsubmit="return false;">
                <div class="form-group">
                    <label for="new-code">新验证码：</label>
                    <input type="text" 
                           id="new-code" 
                           placeholder="输入新验证码 (最少4位)" 
                           minlength="4" 
                           maxlength="20"
                           pattern="[A-Za-z0-9]+"
                           title="只能包含字母和数字">
                </div>
                
                <div class="form-group">
                    <label for="confirm-code">确认验证码：</label>
                    <input type="text" 
                           id="confirm-code" 
                           placeholder="再次输入新验证码"
                           pattern="[A-Za-z0-9]+"
                           title="只能包含字母和数字">
                </div>
                
                <button type="submit" onclick="updateCode()" id="updateBtn">
                    <i class="fas fa-sync-alt"></i> 更新验证码并同步到Gist
                </button>
            </form>
            
            <div class="button-group">
                <button onclick="testGistConnection()" class="test-btn" id="testBtn">
                    <i class="fas fa-wifi"></i> 测试Gist连接
                </button>
                <button onclick="refreshFromGist()" class="sync-btn" id="refreshBtn">
                    <i class="fas fa-redo"></i> 从Gist刷新
                </button>
            </div>
            
            <div class="current-code" id="current-code-display">
                <p><strong>当前验证码：</strong> <span id="current-code">---</span></p>
                <p><small>来源：<span id="code-source">本地存储</span></small></p>
                <p><small>最后更新时间：<span id="last-update-time">-</span></small></p>
                <div class="github-status" id="github-status">
                    <i class="fab fa-github"></i>
                    <span id="gist-status">GitHub Gist: 未配置</span>
                </div>
            </div>
            
            <div class="message" id="message"></div>
            
            <div class="security-note">
                <p><small><i class="fas fa-exclamation-triangle"></i> 重要：GitHub Token仅用于更新Gist，不会发送到其他服务器。</small></p>
                <p><small><i class="fas fa-info-circle"></i> 提示：验证码更新后，所有用户需要重新登录才能使用新验证码。</small></p>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        // 管理员配置
        const adminConfig = {
            storageKey: 'uly_admin_session',
            sessionDuration: 10 * 60 * 1000, // 10分钟
            maxLoginAttempts: 5,
            lockTime: 30 * 60 * 1000,
            attemptsKey: 'uly_admin_attempts',
            lockKey: 'uly_admin_lock',
            
            // 管理员密码
            adminPasswordHash: '3.1415926',
            
            // 安全选项
            idleTimeout: 15 * 60 * 1000,
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminSession();
            setupInputValidation();
            setupIdleTimer();
            setupSessionTimer();
            loadGistConfig();
            loadCurrentCode(); // 页面加载时显示当前验证码信息
        });

        // 加载Gist配置
        function loadGistConfig() {
            try {
                const savedConfig = localStorage.getItem('uly_gist_config');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    document.getElementById('gist-id').value = config.gistId || '';
                    document.getElementById('github-token').value = config.githubToken || '';
                    
                    // 更新authManager的配置
                    if (config.gistId) {
                        authManager.config.gistId = config.gistId;
                        updateGistStatus();
                    }
                }
            } catch (error) {
                console.error('加载Gist配置失败:', error);
            }
        }

        // 保存Gist配置
        function saveGistConfig() {
            const gistId = document.getElementById('gist-id').value.trim();
            const githubToken = document.getElementById('github-token').value.trim();
            
            if (!gistId) {
                showMessage('请输入Gist ID', 'error');
                return;
            }
            
            const config = {
                gistId: gistId,
                githubToken: githubToken
            };
            
            try {
                localStorage.setItem('uly_gist_config', JSON.stringify(config));
                
                // 更新authManager配置
                authManager.config.gistId = gistId;
                
                showMessage('GitHub Gist配置已保存', 'success');
                updateCurrentCodeDisplay();
                
                // 测试连接
                setTimeout(() => testGistConnection(), 1000);
            } catch (error) {
                showMessage('保存配置失败: ' + error.message, 'error');
            }
        }

        // 管理员登录
        async function adminLogin() {
            const passwordInput = document.getElementById('adminPassword');
            const password = passwordInput.value.trim();
            const loginBtn = document.getElementById('loginBtn');
            const loginText = document.getElementById('loginText');
            const loginLoading = document.getElementById('loginLoading');
            
            if (isAdminLocked()) {
                showLoginMessage(`账号已锁定，请 ${getAdminRemainingLockTime()} 后再试`, 'error');
                return;
            }
            
            if (!password) {
                showLoginMessage('请输入管理员密码', 'error');
                return;
            }
            
            loginText.style.display = 'none';
            loginLoading.style.display = 'inline';
            loginBtn.disabled = true;
            
            await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 500));
            
            if (password === adminConfig.adminPasswordHash) {
                createAdminSession();
                clearAdminFailedAttempts();
                showLoginMessage('登录成功', 'success');
                
                setTimeout(() => {
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    loadCurrentCode();
                }, 1000);
            } else {
                const result = recordAdminFailedAttempt();
                loginText.style.display = 'inline';
                loginLoading.style.display = 'none';
                loginBtn.disabled = false;
                
                if (result.locked) {
                    showLoginMessage(`密码错误，账号已被锁定30分钟`, 'error');
                } else {
                    showLoginMessage(`密码错误，还剩 ${result.remainingAttempts} 次尝试`, 'error');
                }
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        // 更新验证码并同步到Gist
        async function updateCode() {
            const newCode = document.getElementById('new-code').value.trim();
            const confirmCode = document.getElementById('confirm-code').value.trim();
            const updateBtn = document.getElementById('updateBtn');
            
            // 验证输入
            if (!newCode || !confirmCode) {
                showMessage('请输入新验证码和确认验证码', 'error');
                return;
            }
            
            if (newCode.length < 4) {
                showMessage('验证码长度不能少于4位', 'error');
                return;
            }
            
            if (!/^[A-Za-z0-9]+$/.test(newCode)) {
                showMessage('验证码只能包含字母和数字', 'error');
                return;
            }
            
            if (newCode !== confirmCode) {
                showMessage('两次输入的验证码不一致', 'error');
                return;
            }
            
            // 禁用按钮
            updateBtn.disabled = true;
            updateBtn.innerHTML = '<span class="loading"></span> 更新中...';
            
            try {
                // 1. 更新本地验证码
                const localResult = authManager.updateCode(newCode);
                
                if (!localResult.success) {
                    throw new Error(localResult.message);
                }
                
                // 保存本地更新时间
                localStorage.setItem('uly_code_update_time', Date.now().toString());
                
                // 2. 同步到GitHub Gist
                const gistResult = await updateGist(newCode);
                
                if (gistResult.success) {
                    showMessage('验证码已更新并同步到GitHub Gist！所有设备将立即生效', 'success');
                    
                    // 更新显示
                    updateCurrentCodeDisplay();
                    
                    // 清空输入框
                    document.getElementById('new-code').value = '';
                    document.getElementById('confirm-code').value = '';
                    
                    // 记录日志
                    logAdminAction('update_code', { 
                        code: newCode,
                        gistSynced: true,
                        gistId: authManager.config.gistId
                    });
                } else {
                    showMessage(`本地更新成功，但Gist同步失败：${gistResult.message}`, 'warning');
                    updateCurrentCodeDisplay();
                }
            } catch (error) {
                showMessage('更新失败：' + error.message, 'error');
            } finally {
                updateBtn.disabled = false;
                updateBtn.innerHTML = '<i class="fas fa-sync-alt"></i> 更新验证码并同步到Gist';
            }
        }

        // 更新GitHub Gist
        async function updateGist(code) {
            // 获取配置
            const config = JSON.parse(localStorage.getItem('uly_gist_config') || '{}');
            const gistId = config.gistId;
            const githubToken = config.githubToken;
            
            if (!gistId) {
                return { success: false, message: '未配置Gist ID' };
            }
            
            if (!githubToken) {
                return { success: false, message: '未配置GitHub Token' };
            }
            
            try {
                const updateData = {
                    description: `ULY验证码更新 - ${new Date().toLocaleString('zh-CN')}`,
                    files: {
                        'uly_config.json': {
                            content: JSON.stringify({
                                code: code,
                                updated_at: new Date().toISOString(),
                                updated_by: 'admin',
                                version: Date.now(),
                                note: 'ULY系统验证码'
                            }, null, 2)
                        }
                    }
                };
                
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (response.ok) {
                    // 更新Gist缓存
                    localStorage.setItem('uly_gist_cache', code);
                    localStorage.setItem('uly_gist_cache_time', Date.now().toString());
                    
                    return { 
                        success: true, 
                        message: 'Gist更新成功',
                        timestamp: new Date().toISOString()
                    };
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('更新Gist失败:', error);
                return { 
                    success: false, 
                    message: `更新失败: ${error.message}` 
                };
            }
        }

        // 测试Gist连接
        async function testGistConnection() {
            const testBtn = document.getElementById('testBtn');
            const originalText = testBtn.innerHTML;
            
            testBtn.disabled = true;
            testBtn.innerHTML = '<span class="loading"></span> 测试中...';
            
            try {
                const config = JSON.parse(localStorage.getItem('uly_gist_config') || '{}');
                
                if (!config.gistId) {
                    throw new Error('未配置Gist ID');
                }
                
                // 测试读取
                const gistUrl = `https://gist.githubusercontent.com/raw/${config.gistId}/uly_config.json`;
                const response = await fetch(gistUrl, { cache: 'no-cache' });
                
                if (response.ok) {
                    const data = await response.json();
                    showMessage(`✓ Gist连接成功！当前验证码：${data.code || '未找到'}`, 'success');
                    
                    // 更新Gist缓存
                    if (data.code) {
                        localStorage.setItem('uly_gist_cache', data.code);
                        localStorage.setItem('uly_gist_cache_time', Date.now().toString());
                        updateCurrentCodeDisplay();
                    }
                } else {
                    throw new Error(`Gist不存在或无法访问 (HTTP ${response.status})`);
                }
            } catch (error) {
                showMessage(`✗ Gist连接失败：${error.message}`, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = originalText;
            }
        }

        // 从Gist刷新验证码
        async function refreshFromGist() {
            const refreshBtn = document.getElementById('refreshBtn');
            const originalText = refreshBtn.innerHTML;
            
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<span class="loading"></span> 刷新中...';
            
            try {
                const config = JSON.parse(localStorage.getItem('uly_gist_config') || '{}');
                
                if (!config.gistId) {
                    throw new Error('未配置Gist ID');
                }
                
                // 强制从Gist获取最新
                const gistUrl = `https://gist.githubusercontent.com/raw/${config.gistId}/uly_config.json`;
                const response = await fetch(gistUrl, { cache: 'no-store' });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.code) {
                        // 更新本地
                        authManager.updateCode(data.code);
                        
                        // 更新Gist缓存
                        localStorage.setItem('uly_gist_cache', data.code);
                        localStorage.setItem('uly_gist_cache_time', Date.now().toString());
                        
                        showMessage(`✓ 已从Gist刷新验证码：${data.code}`, 'success');
                        updateCurrentCodeDisplay();
                    } else {
                        throw new Error('Gist中没有找到验证码');
                    }
                } else {
                    throw new Error(`无法访问Gist (HTTP ${response.status})`);
                }
            } catch (error) {
                showMessage(`刷新失败：${error.message}`, 'error');
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = originalText;
            }
        }

        // 加载并显示当前验证码信息
        function loadCurrentCode() {
            try {
                updateCurrentCodeDisplay();
            } catch (error) {
                console.error('加载验证码失败:', error);
                document.getElementById('current-code').textContent = '加载失败';
            }
        }

        // 更新当前验证码显示（包含来源和时间信息）
        function updateCurrentCodeDisplay() {
            try {
                // 获取当前验证码
                const code = authManager.getCurrentCodeSync();
                document.getElementById('current-code').textContent = code;
                
                // 获取Gist配置
                const config = JSON.parse(localStorage.getItem('uly_gist_config') || '{}');
                const hasGistConfig = !!config.gistId;
                
                // 获取Gist缓存信息
                const gistCacheTime = localStorage.getItem('uly_gist_cache_time');
                const gistCacheCode = localStorage.getItem('uly_gist_cache');
                
                // 获取本地更新时间
                const localUpdateTime = localStorage.getItem('uly_code_update_time');
                
                // 确定来源和更新时间
                let source = '本地存储';
                let updateTime = '-';
                
                if (hasGistConfig && gistCacheTime && gistCacheCode === code) {
                    // 如果Gist缓存存在且匹配当前验证码
                    source = 'GitHub Gist';
                    const time = new Date(parseInt(gistCacheTime));
                    updateTime = time.toLocaleString('zh-CN');
                } else if (localUpdateTime) {
                    // 使用本地更新时间
                    const time = new Date(parseInt(localUpdateTime));
                    updateTime = time.toLocaleString('zh-CN');
                }
                
                // 更新显示
                document.getElementById('code-source').textContent = source;
                document.getElementById('last-update-time').textContent = updateTime;
                
                // 更新Gist状态
                updateGistStatus();
            } catch (error) {
                console.error('更新显示失败:', error);
            }
        }

        // 更新Gist状态显示
        function updateGistStatus() {
            const statusEl = document.getElementById('gist-status');
            const statusContainer = document.getElementById('github-status');
            
            // 获取配置
            const config = JSON.parse(localStorage.getItem('uly_gist_config') || '{}');
            const hasGistConfig = !!config.gistId;
            
            if (!hasGistConfig) {
                statusEl.textContent = 'GitHub Gist: 未配置';
                statusContainer.className = 'github-status error';
                return;
            }
            
            // 获取当前验证码
            const currentCode = authManager.getCurrentCodeSync();
            
            // 检查Gist缓存
            const gistCacheCode = localStorage.getItem('uly_gist_cache');
            
            if (gistCacheCode === currentCode) {
                statusEl.textContent = 'GitHub Gist: 已同步';
                statusContainer.className = 'github-status synced';
            } else {
                statusEl.textContent = 'GitHub Gist: 不同步';
                statusContainer.className = 'github-status local';
            }
        }

        // 防注入检查
        function hasInjection(input) {
            const dangerousPatterns = [
                /<script/i, /javascript:/i, /on\w+\s*=/i, /eval\(/i,
                /document\./i, /window\./i, /alert\(/i, /prompt\(/i, /confirm\(/i,
                /<\/?\w+.*?>/, /['"`].*?['"`].*?['"`]/,
            ];
            return dangerousPatterns.some(pattern => pattern.test(input));
        }

        // 显示消息
        function showMessage(text, type) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = `message ${type}`;
            message.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => message.style.display = 'none', 5000);
            }
        }

        // 显示登录消息
        function showLoginMessage(text, type) {
            const message = document.getElementById('loginMessage');
            message.textContent = text;
            message.className = `message ${type}`;
            message.style.display = 'block';
        }

        function setupInputValidation() {
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', function(e) {
                    let value = e.target.value;
                    value = value.replace(/[<>"'`]/g, '');
                    if (value !== e.target.value) e.target.value = value;
                });
            });
        }

        function createAdminSession() {
            const sessionData = {
                authenticated: true,
                expires: Date.now() + adminConfig.sessionDuration,
                lastActivity: Date.now()
            };
            localStorage.setItem(adminConfig.storageKey, btoa(JSON.stringify(sessionData)));
            startSessionTimer();
        }

        function checkAdminSession() {
            try {
                const session = localStorage.getItem(adminConfig.storageKey);
                if (!session) return false;
                
                const sessionData = JSON.parse(atob(session));
                if (Date.now() > sessionData.expires) {
                    adminLogout();
                    return false;
                }
                
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                loadCurrentCode();
                startSessionTimer();
                return true;
            } catch {
                return false;
            }
        }

        function adminLogout() {
            localStorage.removeItem(adminConfig.storageKey);
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            showLoginMessage('已安全退出', 'success');
            stopSessionTimer();
        }

        function isAdminLocked() {
            try {
                const lockUntil = localStorage.getItem(adminConfig.lockKey);
                return lockUntil && Date.now() < parseInt(lockUntil);
            } catch {
                return false;
            }
        }

        function recordAdminFailedAttempt() {
            let attempts = parseInt(localStorage.getItem(adminConfig.attemptsKey) || '0') + 1;
            localStorage.setItem(adminConfig.attemptsKey, attempts.toString());
            
            if (attempts >= adminConfig.maxLoginAttempts) {
                localStorage.setItem(adminConfig.lockKey, (Date.now() + adminConfig.lockTime).toString());
                return { locked: true, remainingAttempts: 0 };
            }
            return { locked: false, remainingAttempts: adminConfig.maxLoginAttempts - attempts };
        }

        function clearAdminFailedAttempts() {
            localStorage.removeItem(adminConfig.attemptsKey);
            localStorage.removeItem(adminConfig.lockKey);
        }

        function getAdminRemainingLockTime() {
            try {
                const lockUntil = localStorage.getItem(adminConfig.lockKey);
                const remaining = parseInt(lockUntil) - Date.now();
                const minutes = Math.ceil(remaining / 60000);
                return `${minutes}分钟`;
            } catch {
                return "未知时间";
            }
        }

        function setupIdleTimer() {
            let idleTimer;
            function resetIdleTimer() {
                clearTimeout(idleTimer);
                idleTimer = setTimeout(() => {
                    if (checkAdminSession()) {
                        adminLogout();
                        showLoginMessage('由于长时间无操作，已自动退出', 'warning');
                    }
                }, adminConfig.idleTimeout);
            }
            ['mousemove', 'keypress', 'click'].forEach(event => {
                window.addEventListener(event, resetIdleTimer);
            });
            resetIdleTimer();
        }

        let sessionTimer;
        function startSessionTimer() {
            stopSessionTimer();
            sessionTimer = setInterval(updateSessionInfo, 1000);
            updateSessionInfo();
        }
        
        function stopSessionTimer() {
            if (sessionTimer) clearInterval(sessionTimer);
        }
        
        function updateSessionInfo() {
            try {
                const session = localStorage.getItem(adminConfig.storageKey);
                if (!session) return;
                
                const sessionData = JSON.parse(atob(session));
                const remaining = Math.max(0, sessionData.expires - Date.now());
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                
                document.getElementById('sessionInfo').textContent = 
                    `会话有效期：${minutes}分${seconds}秒`;
                
                if (remaining < 60000) {
                    document.getElementById('sessionInfo').style.color = '#f44336';
                } else if (remaining < 300000) {
                    document.getElementById('sessionInfo').style.color = '#ff9800';
                } else {
                    document.getElementById('sessionInfo').style.color = '#4caf50';
                }
                
                if (remaining <= 0) adminLogout();
            } catch {}
        }

        function setupSessionTimer() {
            if (checkAdminSession()) startSessionTimer();
        }

        function logAdminAction(action, details = {}) {
            const logEntry = { action, details, timestamp: Date.now() };
            try {
                const logs = JSON.parse(localStorage.getItem('uly_admin_logs') || '[]');
                logs.unshift(logEntry);
                if (logs.length > 50) logs.pop();
                localStorage.setItem('uly_admin_logs', JSON.stringify(logs));
            } catch {}
        }

        // 回车键提交
        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') adminLogin();
        });
        
        document.getElementById('confirm-code').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') updateCode();
        });
    </script>
</body>
</html>