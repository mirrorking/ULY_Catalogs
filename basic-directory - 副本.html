<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基础配件目录 - 选购系统</title>
    <link rel="icon" href="Info/Title.jpg" type="image/jpeg">
    <link rel="apple-touch-icon" href="Info/Title.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* 所有之前的CSS样式保持不变 */
        /* 语言切换按钮样式 */
        .language-switcher {
            position: relative;
            display: flex;
            align-items: center;
            margin-right: 15px;
        }
        
        .language-btn {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #495057;
            transition: all 0.2s ease;
        }
        
        .language-btn:hover {
            background: #e9ecef;
            border-color: #3498db;
        }
        
        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-width: 120px;
            z-index: 100;
            display: none;
        }
        
        .language-dropdown.active {
            display: block;
        }
        
        .language-option {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s ease;
        }
        
        .language-option:hover {
            background: #f8f9fa;
        }
        
        .language-option.active {
            background: #3498db;
            color: white;
        }
        
        .language-flag {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .flag-cn {
            background: #de2910;
            color: #ffde00;
        }
        
        .flag-us {
            background: #3c3b6e;
            color: white;
        }
        
        /* 分页控件样式 */
        .pagination-container {
            padding: 20px 25px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-info {
            font-size: 14px;
            color: #6c757d;
            white-space: nowrap;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .pagination-button {
            padding: 8px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            color: #495057;
            transition: all 0.2s ease;
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination-button:hover:not(:disabled) {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-button.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .page-numbers {
            display: flex;
            gap: 5px;
        }

        .pagination-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }

        .pagination-input {
            width: 50px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 13px;
        }

        .pagination-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .pagination-input-group span {
            font-size: 13px;
            color: #6c757d;
        }

        /* 卡片加载动画 */
        .product-card {
            animation: fadeIn 0.5s ease forwards;
            opacity: 0;
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .product-name {
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
            line-height: 1.4;
            margin-bottom: 8px;
            /* 多行文本省略 */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-word;
            max-height: 2.8em;
        }

        /* 商品规格信息限制高度 */
        .product-specs {
            font-size: 12px;
            color: #7f8c8d;
            line-height: 1.4;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-word;
            max-height: 3.6em;
        }

        /* 商品编码显示样式 */
        .product-code-display {
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 13px;
            color: #3498db;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 原始编码显示样式 */
        .original-code-display {
            font-size: 11px;
            color: #7f8c8d;
            font-family: 'Courier New', monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }

        /* 编码容器 */
        .code-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .code-label {
            font-size: 11px;
            color: #95a5a6;
            font-weight: 500;
        }

        /* 搜索框样式 */
        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 10px 10px 35px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #3498db;
        }

        .search-box .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #95a5a6;
            font-size: 14px;
        }

        .search-box .clear-search {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #95a5a6;
            cursor: pointer;
            font-size: 14px;
            display: none;
        }

        .search-box input:not(:placeholder-shown) + .clear-search {
            display: block;
        }

        /* 购物车按钮样式 */
        .cart-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            opacity: 0;
        }

        .product-card:hover .cart-button {
            opacity: 1;
        }

        .cart-button:hover {
            background: #2980b9;
            transform: scale(1.1);
        }

        .cart-button.added {
            background: #27ae60;
        }

        /* 购物车遮罩层 */
        .cart-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .cart-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* 购物车侧边栏 */
        .cart-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .cart-sidebar.active {
            right: 0;
        }

        .cart-header {
            padding: 20px;
            background: #3498db;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .cart-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .cart-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .cart-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            gap: 15px;
        }

        .cart-item-image {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .cart-item-code {
            font-size: 12px;
            color: #7f8c8d;
            font-family: 'Courier New', monospace;
            margin-bottom: 3px;
        }

        .cart-item-original-code {
            font-size: 11px;
            color: #95a5a6;
            font-family: 'Courier New', monospace;
            margin-bottom: 5px;
        }

        .cart-item-sheet {
            font-size: 11px;
            color: #95a5a6;
            margin-bottom: 8px;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quantity-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity-btn:hover {
            background: #f8f9fa;
        }

        .quantity-input {
            width: 50px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .remove-item {
            color: #e74c3c;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .cart-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            background: #f8f9fa;
        }

        .cart-total {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .cart-actions {
            display: flex;
            gap: 10px;
        }

        .cart-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .cart-btn.primary {
            background: #3498db;
            color: white;
        }

        .cart-btn.primary:hover {
            background: #2980b9;
        }

        .cart-btn.secondary {
            background: #95a5a6;
            color: white;
        }

        .cart-btn.secondary:hover {
            background: #7f8c8d;
        }

        .cart-btn.danger {
            background: #e74c3c;
            color: white;
        }

        .cart-btn.danger:hover {
            background: #c0392b;
        }

        /* 购物车通知 */
        .cart-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* 数量选择模态框 */
        .quantity-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .quantity-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .quantity-modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .quantity-modal-title {
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .quantity-input-large {
            width: 100%;
            padding: 12px;
            border: 2px solid #3498db;
            border-radius: 4px;
            font-size: 16px;
            text-align: center;
            margin-bottom: 15px;
        }

        .brand-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 20px;
            background-color: white;
            cursor: pointer;
        }

        .brand-select:focus {
            outline: none;
            border-color: #3498db;
        }

        .quantity-modal-actions {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .modal-btn.primary {
            background: #3498db;
            color: white;
        }

        .modal-btn.secondary {
            background: #95a5a6;
            color: white;
        }

        /* 购物车徽章 */
        .cart-badge {
            position: relative;
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            font-size: 11px;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .pagination-container {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }
            
            .pagination-controls {
                justify-content: center;
            }
            
            .page-numbers {
                order: 3;
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
            
            .cart-sidebar {
                width: 100%;
                right: -100%;
            }
            
            .cart-button {
                opacity: 1;
            }
            
            .language-switcher {
                margin-right: 0;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <script>
        // 验证检查脚本
        (function() {
            try {
                // 尝试从本地存储读取认证状态
                const token = localStorage.getItem('uly_access_token');
                
                if (!token) {
                    // 未登录，跳转到验证页面
                    window.location.href = 'auth.html';
                    return;
                }
                
                // 验证token有效性
                const data = JSON.parse(atob(token));
                const now = Date.now();
                
                if (now >= data.expires) {
                    // token已过期，清除并重定向
                    localStorage.removeItem('uly_access_token');
                    window.location.href = 'auth.html';
                }
                
                // token有效，允许访问
            } catch (error) {
                // 解析失败，清除无效token并重定向
                localStorage.removeItem('uly_access_token');
                window.location.href = 'auth.html';
            }
        })();
    </script>
    
    <!-- 购物车遮罩层 -->
    <div class="cart-overlay" id="cart-overlay"></div>
    
    <!-- 购物车侧边栏 -->
    <div class="cart-sidebar" id="cart-sidebar">
        <div class="cart-header">
            <h3 id="cart-title">购物车</h3>
            <button class="cart-close" id="cart-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="cart-content" id="cart-content">
            <!-- 购物车内容动态生成 -->
            <div class="empty-state" id="empty-cart">
                <i class="fas fa-shopping-cart"></i>
                <h3 id="empty-cart-title">购物车为空</h3>
                <p id="empty-cart-message">请添加商品到购物车</p>
            </div>
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <span id="cart-total-label">总计:</span> <span id="cart-total-items">0</span> <span id="cart-total-unit">件商品</span>
            </div>
            <div class="cart-actions">
                <button class="cart-btn danger" id="clear-cart">
                    <i class="fas fa-trash"></i> <span id="clear-cart-text">清空</span>
                </button>
                <button class="cart-btn secondary" id="export-cart">
                    <i class="fas fa-file-excel"></i> <span id="export-cart-text">导出Excel</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 数量选择模态框 -->
    <div class="quantity-modal" id="quantity-modal">
        <div class="quantity-modal-content">
            <div class="quantity-modal-title" id="quantity-modal-title">选择数量和品牌</div>
            <input type="number" class="quantity-input-large" id="quantity-input" min="1" value="1" autofocus>
            <select class="brand-select" id="brand-select">
                <option value="no_brand">无品牌</option>
                <option value="kelon">科龙</option>
                <option value="lixiong">力雄</option>
            </select>
            <div class="quantity-modal-actions">
                <button class="modal-btn secondary" id="cancel-quantity">
                    <span id="cancel-quantity-text">取消</span>
                </button>
                <button class="modal-btn primary" id="confirm-quantity">
                    <span id="confirm-quantity-text">确认</span>
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 顶部导航栏 -->
        <div class="top-nav">
            <div class="logo">
                <i class="fas fa-tools logo-icon"></i>
                <div class="logo-text">
                    <h1 id="page-title">基础配件目录 - 选购系统</h1>
                    <div class="subtitle" id="page-subtitle">选择商品并添加到购物车，生成采购清单</div>
                </div>
            </div>
            <div class="nav-tabs">
                <!-- 语言切换器 -->
                <div class="language-switcher">
                    <button class="language-btn" id="language-btn">
                        <div class="language-flag flag-cn">中</div>
                        <span id="current-language">中文</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="language-dropdown" id="language-dropdown">
                        <div class="language-option active" data-lang="zh-CN">
                            <div class="language-flag flag-cn">中</div>
                            <span>中文</span>
                        </div>
                        <div class="language-option" data-lang="en-US">
                            <div class="language-flag flag-us">US</div>
                            <span>English</span>
                        </div>
                    </div>
                </div>
                
                <a href="index.html" class="nav-tab">
                    <i class="fas fa-home"></i> <span id="nav-home">返回首页</span>
                </a>
                <a href="machine-directory.html" class="nav-tab">
                    <i class="fas fa-tractor"></i> <span id="nav-machine">整机目录</span>
                </a>
                <button class="nav-tab cart-badge" id="view-cart">
                    <i class="fas fa-shopping-cart"></i> <span id="nav-cart">购物车</span>
                    <span class="cart-count" id="cart-count">0</span>
                </button>
                <button class="nav-tab" id="refresh-data">
                    <i class="fas fa-sync-alt"></i> <span id="nav-refresh">刷新数据</span>
                </button>
            </div>
        </div>
        
        <!-- 主内容区域 -->
        <div class="main-area">
            <!-- 侧边栏 - 商品类别树 -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title" id="sidebar-title">工作表列表</div>
                    
                    <!-- 商品搜索框 -->
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="product-search-input" placeholder="在所有商品中搜索...">
                        <button class="clear-search" id="clear-search">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="data-status" id="data-status">
                        <i class="fas fa-circle"></i>
                        <span id="data-status-text">正在加载数据...</span>
                    </div>
                </div>
                
                <!-- 树形分类 -->
                <div class="tree-container">
                    <ul class="tree-list" id="category-tree">
                        <!-- 树形分类将通过JavaScript动态生成 -->
                    </ul>
                </div>
            </div>
            
            <!-- 主内容区 -->
            <div class="main-content" id="main-content">
                <!-- 内容区域将通过JavaScript动态生成 -->
            </div>
        </div>
        
        <!-- 图片放大模态框 -->
        <div class="image-modal" id="image-modal">
            <div class="modal-content">
                <button class="modal-close" id="modal-close">
                    <i class="fas fa-times"></i>
                </button>
                <img id="modal-image" class="modal-image" src="" alt="">
            </div>
        </div>
        
        <footer>
            <p id="footer-text">© 2023 配件目录管理系统 | 基础配件目录 | 数据来源: products_data.json | 图片路径: images/</p>
        </footer>
    </div>
<!-- 添加exceljs库 -->
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
<!-- 保留SheetJS用于其他功能 -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
    
    // 多语言文本定义
    const translations = {
        'zh-CN': {
            // 页面标题
            'pageTitle': '基础配件目录 - 选购系统',
            'pageSubtitle': '选择商品并添加到购物车，生成采购清单',
            
            // 导航栏
            'navHome': '返回首页',
            'navMachine': '整机目录',
            'navCart': '购物车',
            'navRefresh': '刷新数据',
            
            // 侧边栏
            'sidebarTitle': '工作表列表',
            'searchPlaceholder': '在所有商品中搜索...',
            'loadingData': '正在加载数据...',
            'dataReady': '数据已就绪',
            
            // 内容区域
            'allSheets': '所有工作表',
            'dataDirectory': 'JSON数据目录系统',
            'dataDescription': '基于XLSM转换的配件信息管理系统',
            'sheetsCount': '工作表',
            'partsCount': '基础配件',
            'instructions': '使用说明：',
            'instruction1': '在左侧选择工作表查看该工作表中的商品',
            'instruction2': '使用搜索框在所有商品中搜索',
            'instruction3': '每页显示10个商品，支持分页浏览',
            'instruction4': '点击商品卡片查看详细信息',
            'instruction5': '点击购物车图标添加商品到采购清单',
            'instruction6': '点击顶部购物车按钮查看和管理采购清单',
            'instruction7': '可以导出Excel格式的采购清单',
            'instruction8': '商品图片自动从 images/ 目录加载',
            'instruction9': '数据来源: products_data.json (从XLSM转换)',
            
            // 购物车
            'cartTitle': '购物车',
            'emptyCartTitle': '购物车为空',
            'emptyCartMessage': '请添加商品到购物车',
            'cartTotal': '总计:',
            'cartItemsUnit': '件商品',
            'clearCart': '清空',
            'exportCart': '导出Excel',
            'addToCart': '添加到购物车',
            'removeFromCart': '从购物车移除',
            'cartNotification': '商品已添加到购物车',
            'cartRemoved': '商品已从购物车移除',
            'cartCleared': '购物车已清空',
            
            // 模态框
            'selectQuantity': '选择数量和品牌',
            'cancel': '取消',
            'confirm': '确认',
            'enterQuantity': '请输入有效的数量',
            
            // 商品详情
            'productDetails': '商品详情',
            'productCode': '商品编码:',
            'backToList': '返回列表',
            'basicInfo': '基本信息',
            'productName': '商品名称',
            'sheetName': '所属工作表',
            'detailedInfo': '详细信息',
            
            // 搜索结果
            'searchResults': '搜索结果',
            'foundItems': '共找到',
            'itemsFor': '个商品',
            'noResults': '未找到相关商品',
            'tryOtherKeywords': '请尝试其他搜索关键词',
            
            // 分页
            'showItems': '显示第',
            'to': '到',
            'of': '条，共',
            'items': '条',
            'goToPage': '跳至',
            'page': '页',
            'jump': '跳转',
            
            // 其他
            'noProducts': '暂无商品',
            'noProductsInSheet': '该工作表中暂无商品数据',
            'noImage': '无图片',
            'clickToZoom': '点击图片放大查看',
            'imageNotFound': '图片未找到',
            'saveImageAs': '请将图片保存为:',
            'confirmRemove': '确定要从购物车中移除这个商品吗？',
            'confirmClearCart': '确定要清空购物车吗？',
            'cartEmpty': '购物车为空，无法导出',
            'exportSuccess': '订购清单已导出为Excel文件',
            
            // 页脚
            'footerText': '© 2026 配件目录管理系统 | 基础配件目录',
            
            // 品牌选项
            'noBrand': '无品牌',
            'kelon': '科龙',
            'lixiong': '力雄',
            
            // Excel表头
            'excelSerial': '序号',
            'excelProductCode': '商品编码',
            'excelOriginalCode': 'Original CODE',
            'excelProductName': '商品名称',
            'excelSpecs': '规格型号',
            'excelBrand': '品牌',
            'excelQuantity': '数量',
            'excelImage': '商品图片',
            'excelSummary': '汇总信息',
            'excelCategoryCount': '商品种类数',
            'excelTotalQuantity': '商品总数量',
            'excelExportDate': '导出日期',
            'excelExportTime': '导出时间'
        },
        'en-US': {
            // 页面标题
            'pageTitle': 'Basic Parts Directory - Selection System',
            'pageSubtitle': 'Select products and add to cart to generate purchase list',
            
            // 导航栏
            'navHome': 'Back to Home',
            'navMachine': 'Machine Directory',
            'navCart': 'Shopping Cart',
            'navRefresh': 'Refresh Data',
            
            // 侧边栏
            'sidebarTitle': 'Worksheet List',
            'searchPlaceholder': 'Search in all products...',
            'loadingData': 'Loading data...',
            'dataReady': 'Data ready',
            
            // 内容区域
            'allSheets': 'All Worksheets',
            'dataDirectory': 'JSON Data Directory System',
            'dataDescription': 'Parts information management system converted from XLSM',
            'sheetsCount': 'Worksheets',
            'partsCount': 'Basic Parts',
            'instructions': 'Instructions:',
            'instruction1': 'Select worksheet on the left to view products',
            'instruction2': 'Use search box to search in all products',
            'instruction3': '10 items per page with pagination',
            'instruction4': 'Click product card to view details',
            'instruction5': 'Click cart icon to add product to purchase list',
            'instruction6': 'Click top cart button to view and manage purchase list',
            'instruction7': 'Export purchase list in Excel format',
            'instruction8': 'Product images automatically loaded from images/ directory',
            'instruction9': 'Data source: products_data.json (converted from XLSM)',
            
            // 购物车
            'cartTitle': 'Shopping Cart',
            'emptyCartTitle': 'Cart is empty',
            'emptyCartMessage': 'Please add products to cart',
            'cartTotal': 'Total:',
            'cartItemsUnit': 'items',
            'clearCart': 'Clear',
            'exportCart': 'Export Excel',
            'addToCart': 'Add to Cart',
            'removeFromCart': 'Remove from Cart',
            'cartNotification': 'Product added to cart',
            'cartRemoved': 'Product removed from cart',
            'cartCleared': 'Cart cleared',
            
            // 模态框
            'selectQuantity': 'Select quantity and brand',
            'cancel': 'Cancel',
            'confirm': 'Confirm',
            'enterQuantity': 'Please enter a valid quantity',
            
            // 商品详情
            'productDetails': 'Product Details',
            'productCode': 'Product Code:',
            'backToList': 'Back to List',
            'basicInfo': 'Basic Information',
            'productName': 'Product Name',
            'sheetName': 'Worksheet',
            'detailedInfo': 'Detailed Information',
            
            // 搜索结果
            'searchResults': 'Search Results',
            'foundItems': 'Found',
            'itemsFor': 'items for',
            'noResults': 'No relevant products found',
            'tryOtherKeywords': 'Please try other keywords',
            
            // 分页
            'showItems': 'Showing',
            'to': 'to',
            'of': 'of',
            'items': 'items',
            'goToPage': 'Go to',
            'page': 'page',
            'jump': 'Go',
            
            // 其他
            'noProducts': 'No products',
            'noProductsInSheet': 'No product data in this worksheet',
            'noImage': 'No image',
            'clickToZoom': 'Click image to zoom',
            'imageNotFound': 'Image not found',
            'saveImageAs': 'Please save image as:',
            'confirmRemove': 'Are you sure you want to remove this item from cart?',
            'confirmClearCart': 'Are you sure you want to clear the cart?',
            'cartEmpty': 'Cart is empty, cannot export',
            'exportSuccess': 'Order list exported to Excel file',
            
            // 页脚
            'footerText': '© 2026 Parts Directory Management System | Basic Parts Directory',
            
            // 品牌选项
            'noBrand': 'No Brand',
            'kelon': 'Kelon',
            'lixiong': 'Lixiong',
            
            // Excel表头
            'excelSerial': 'Serial',
            'excelProductCode': 'Product Code',
            'excelOriginalCode': 'Original CODE',
            'excelProductName': 'Product Name',
            'excelSpecs': 'Specifications',
            'excelBrand': 'Brand',
            'excelQuantity': 'Quantity',
            'excelImage': 'Product Image',
            'excelSummary': 'Summary Information',
            'excelCategoryCount': 'Product Categories',
            'excelTotalQuantity': 'Total Quantity',
            'excelExportDate': 'Export Date',
            'excelExportTime': 'Export Time'
        }
    };

    // 品牌映射
    const brandMappings = {
        'zh-CN': {
            'no_brand': '无品牌',
            'kelon': '科龙',
            'lixiong': '力雄'
        },
        'en-US': {
            'no_brand': 'No Brand',
            'kelon': 'Kelon',
            'lixiong': 'Lixiong'
        }
    };

    // 全局状态
    const state = {
        // 当前语言
        currentLanguage: localStorage.getItem('product_language') || 'en-US',
        
        // JSON数据（从products_data.json加载）
        jsonData: null,
        // 所有工作表名称
        sheetNames: [],
        // 按工作表分类的商品数据
        productsBySheet: {},
        // 所有商品数据（用于全局搜索）
        allProducts: [],
        // 当前选择的工作表
        selectedSheet: null,
        // 当前选择的商品
        selectedProduct: null,
        // 当前视图模式：'sheets'（工作表列表）、'products'（商品网格）、'detail'（商品详情）
        currentView: 'sheets',
        // 搜索关键字
        searchTerm: '',
        // 搜索过滤后的商品（全局搜索）
        filteredProducts: [],
        // 是否处于搜索模式
        isSearchMode: false,
        // 图片缓存（记录图片是否存在）
        imageCache: {},
        // 已加载图片的商品编码集合（记录图片URL）
        loadedImages: {},
        // 分页相关状态
        pagination: {
            currentPage: 1,
            itemsPerPage: 10, // 每页显示10个商品
            totalItems: 0,
            totalPages: 1,
            // 延迟加载图片相关
            loadedItems: 0,
            isLoading: false
        },
        // 购物车状态
        cart: {
            items: [],
            // 从localStorage加载购物车
            load() {
                const saved = localStorage.getItem('product_cart');
                if (saved) {
                    this.items = JSON.parse(saved);
                }
                this.updateUI();
            },
            // 保存购物车到localStorage
            save() {
                localStorage.setItem('product_cart', JSON.stringify(this.items));
                this.updateUI();
            },
            // 添加商品到购物车（现在包含品牌选择）
            add(product, quantity = 1, brandKey = 'no_brand') {
                const productCode = safeGetValue(product, ['CODE', 'code'], '');
                
                // 获取当前语言的品牌显示文本
                const brandDisplay = brandMappings[state.currentLanguage][brandKey] || brandKey;
                
                // 检查购物车中是否已有相同编码和品牌的商品
                const existingItem = this.items.find(item => 
                    item.code === productCode && item.selectedBrandKey === brandKey
                );
                
                if (existingItem) {
                    existingItem.quantity += quantity;
                    existingItem.selectedBrand = brandDisplay;
                } else {
                    this.items.push({
                        code: productCode,
                        originalCode: safeGetValue(product, 'originalCode', productCode),
                        name: product.MODEL || product.NAME || product.model || product.name || '未命名商品',
                        sheetName: product.sheetName,
                        specs: product.SPECS || product.specs || product['FITS MACHINE'] || product['fits machine'] || '',
                        quantity: quantity,
                        brand: product.BRAND || product.brand || '',
                        selectedBrandKey: brandKey,
                        selectedBrand: brandDisplay,
                        price: product.PRICE || product.price || 0,
                        image: state.loadedImages[productCode] || null
                    });
                }
                this.save();
                this.showNotification(translate('cartNotification'));
            },
            // 更新商品数量
            update(code, quantity) {
                const item = this.items.find(item => item.code === code);
                if (item) {
                    if (quantity <= 0) {
                        this.remove(code);
                    } else {
                        item.quantity = quantity;
                        this.save();
                    }
                }
            },
            // 从购物车移除商品
            remove(code) {
                this.items = this.items.filter(item => item.code !== code);
                this.save();
                this.showNotification(translate('cartRemoved'));
            },
            // 清空购物车
            clear() {
                this.items = [];
                this.save();
                this.showNotification(translate('cartCleared'));
            },
            // 获取购物车总数量
            getTotalItems() {
                return this.items.reduce((total, item) => total + item.quantity, 0);
            },
            // 获取购物车总金额（如果有价格）
            getTotalPrice() {
                return this.items.reduce((total, item) => total + (item.price * item.quantity), 0);
            },
            // 更新购物车UI
            updateUI() {
                // 更新购物车徽章
                document.getElementById('cart-count').textContent = this.getTotalItems();
                
                // 更新购物车侧边栏
                this.renderCart();
                
                // 更新商品卡片上的购物车按钮状态
                updateCartButtonStates();
            },
            // 渲染购物车内容
            renderCart() {
                const cartContent = document.getElementById('cart-content');
                
                if (this.items.length === 0) {
                    cartContent.innerHTML = `
                        <div class="empty-state" id="empty-cart">
                            <i class="fas fa-shopping-cart"></i>
                            <h3 id="empty-cart-title">${translate('emptyCartTitle')}</h3>
                            <p id="empty-cart-message">${translate('emptyCartMessage')}</p>
                        </div>
                    `;
                    document.getElementById('cart-total-items').textContent = '0';
                    return;
                }
                
                let cartHTML = '';
                
                this.items.forEach((item, index) => {
                    cartHTML += `
                        <div class="cart-item" data-index="${index}" data-code="${item.code}">
                            ${item.image ? `<img src="${item.image}" alt="${item.code}" class="cart-item-image">` : 
                              `<div class="cart-item-image" style="display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
                                <i class="fas fa-box" style="color: #95a5a6;"></i>
                              </div>`}
                            <div class="cart-item-info">
                                <div class="cart-item-name">${item.name}</div>
                                <div class="cart-item-code">${item.code}</div>
                                <div class="cart-item-original-code">${item.originalCode}</div>
                                ${item.selectedBrand ? `<div class="cart-item-brand" style="font-size: 12px; color: #27ae60; margin-bottom: 5px;">${translate('excelBrand')}: ${item.selectedBrand}</div>` : ''}
                                <div class="cart-item-sheet">${item.sheetName}</div>
                                <div class="cart-item-controls">
                                    <div class="quantity-control">
                                        <button type="button" class="quantity-btn decrease-quantity" data-code="${item.code}">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <input type="number" class="quantity-input" value="${item.quantity}" min="1" data-code="${item.code}">
                                        <button type="button" class="quantity-btn increase-quantity" data-code="${item.code}">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <button type="button" class="remove-item" data-code="${item.code}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                cartContent.innerHTML = cartHTML;
                document.getElementById('cart-total-items').textContent = this.getTotalItems();
                
                // 绑定购物车事件
                this.bindCartEvents();
            },
            // 绑定购物车事件
            bindCartEvents() {
                const cartContent = document.getElementById('cart-content');
                
                // 为每个购物车项绑定事件
                this.items.forEach(item => {
                    const code = item.code;
                    
                    // 减少数量按钮
                    const decreaseBtn = cartContent.querySelector(`.decrease-quantity[data-code="${code}"]`);
                    if (decreaseBtn) {
                        decreaseBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (item.quantity > 1) {
                                this.update(code, item.quantity - 1);
                            } else {
                                if (confirm(translate('confirmRemove'))) {
                                    this.remove(code);
                                }
                            }
                        });
                    }
                    
                    // 增加数量按钮
                    const increaseBtn = cartContent.querySelector(`.increase-quantity[data-code="${code}"]`);
                    if (increaseBtn) {
                        increaseBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.update(code, item.quantity + 1);
                        });
                    }
                    
                    // 移除按钮
                    const removeBtn = cartContent.querySelector(`.remove-item[data-code="${code}"]`);
                    if (removeBtn) {
                        removeBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (confirm(translate('confirmRemove'))) {
                                this.remove(code);
                            }
                        });
                    }
                    
                    // 数量输入框
                    const quantityInput = cartContent.querySelector(`.quantity-input[data-code="${code}"]`);
                    if (quantityInput) {
                        quantityInput.addEventListener('change', (e) => {
                            e.stopPropagation();
                            const newQuantity = parseInt(e.target.value);
                            if (!isNaN(newQuantity) && newQuantity > 0) {
                                this.update(code, newQuantity);
                            } else {
                                e.target.value = item.quantity;
                            }
                        });
                        
                        quantityInput.addEventListener('input', (e) => {
                            e.stopPropagation();
                            const newQuantity = parseInt(e.target.value);
                            if (!isNaN(newQuantity) && newQuantity > 0) {
                                this.update(code, newQuantity);
                            }
                        });
                    }
                });
            },
            // 显示通知
            showNotification(message) {
                // 移除现有的通知
                const existingNotification = document.querySelector('.cart-notification');
                if (existingNotification) {
                    existingNotification.remove();
                }
                
                // 创建新通知
                const notification = document.createElement('div');
                notification.className = 'cart-notification';
                notification.innerHTML = `
                    <i class="fas fa-check-circle"></i> ${message}
                `;
                document.body.appendChild(notification);
                
                // 3秒后自动移除
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }, 1000);
            },
            // 检查图片是否存在
            async checkImageExists(productCode) {
                const imageExtensions = ['.png', '.jpg', '.jpeg'];
                for (const ext of imageExtensions) {
                    const url = `images/${productCode}${ext}`;
                    try {
                        const exists = await this.checkImageUrlExists(url);
                        if (exists) {
                            return true;
                        }
                    } catch (error) {
                        continue;
                    }
                }
                return false;
            },
            
            // 检查图片URL是否存在
            checkImageUrlExists(url) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => resolve(true);
                    img.onerror = () => resolve(false);
                    img.src = url;
                });
            },
            
            // 加载图片为ArrayBuffer
            async loadImageToBuffer(productCode) {
                const imageExtensions = ['.png', '.jpg', '.jpeg'];
                
                for (const ext of imageExtensions) {
                    const url = `images/${productCode}${ext}`;
                    try {
                        const exists = await this.checkImageUrlExists(url);
                        if (exists) {
                            // 通过fetch获取图片
                            const response = await fetch(url);
                            if (!response.ok) {
                                throw new Error(`HTTP错误! 状态: ${response.status}`);
                            }
                            
                            const blob = await response.blob();
                            return new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onloadend = function() {
                                    resolve(this.result);
                                };
                                reader.onerror = reject;
                                reader.readAsArrayBuffer(blob);
                            });
                        }
                    } catch (error) {
                        console.warn(`无法加载图片 ${url}:`, error);
                        continue;
                    }
                }
                return null; // 图片不存在
            },
            
            // 获取图片扩展名
            getImageExtensionFromBuffer(buffer, productCode) {
                // 从buffer中检测图片类型
                const arr = new Uint8Array(buffer);
                
                // 检测PNG
                if (arr.length > 3 && arr[0] === 0x89 && arr[1] === 0x50 && arr[2] === 0x4E && arr[3] === 0x47) {
                    return 'png';
                }
                
                // 检测JPEG
                if (arr.length > 1 && arr[0] === 0xFF && arr[1] === 0xD8) {
                    return 'jpeg';
                }
                
                // 检测JPG
                if (arr.length > 10 && arr[6] === 'J' && arr[7] === 'F' && arr[8] === 'I' && arr[9] === 'F') {
                    return 'jpeg';
                }
                
                // 根据文件名后缀判断
                const lowerCode = productCode.toLowerCase();
                if (lowerCode.endsWith('.png')) return 'png';
                if (lowerCode.endsWith('.jpg') || lowerCode.endsWith('.jpeg')) return 'jpeg';
                
                // 默认返回png
                return 'png';
            },
            
            // 导出购物车为Excel（修复版）
            async exportToExcel() {
                if (this.items.length === 0) {
                    alert(translate('cartEmpty'));
                    return;
                }
                
                // 显示加载提示
                const exportBtn = document.getElementById('export-cart');
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在生成Excel...';
                exportBtn.disabled = true;
                
                try {
                    // 创建新的Excel工作簿
                    const workbook = new ExcelJS.Workbook();
                    workbook.creator = '配件选购系统';
                    workbook.lastModifiedBy = '配件选购系统';
                    workbook.created = new Date();
                    workbook.modified = new Date();
                    
                    // 添加工作表
                    const worksheet = workbook.addWorksheet(
                        state.currentLanguage === 'zh-CN' ? '订购清单' : 'Order List'
                    );
                    
                    // 设置列宽 - 增加图片列的宽度
                    worksheet.columns = [
                        { header: translate('excelSerial'), key: 'serial', width: 8 },
                        { header: translate('excelImage'), key: 'image', width: 40 }, // 增加图片列宽度到40
                        { header: translate('excelProductCode'), key: 'code', width: 20 },
                        { header: translate('excelOriginalCode'), key: 'originalCode', width: 20 },
                        { header: translate('excelProductName'), key: 'name', width: 30 },
                        { header: translate('excelSpecs'), key: 'specs', width: 40 },
                        { header: translate('excelBrand'), key: 'brand', width: 15 },
                        { header: translate('excelQuantity'), key: 'quantity', width: 10 }
                    ];
                    
                    // 增加图片列的行高
                    worksheet.getColumn(2).height = 120; // B列的高度（像素）
                    
                    // 添加表头行并设置样式
                    const headerRow = worksheet.getRow(1);
                    headerRow.font = { bold: true, color: { argb: 'FFFFFF' } };
                    headerRow.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: '3498DB' }
                    };
                    headerRow.alignment = { vertical: 'middle', horizontal: 'center' };
                    headerRow.height = 25;
                    
                    // 设置表头边框
                    headerRow.eachCell((cell) => {
                        cell.border = {
                            top: { style: 'thin', color: { argb: '000000' } },
                            left: { style: 'thin', color: { argb: '000000' } },
                            bottom: { style: 'thin', color: { argb: '000000' } },
                            right: { style: 'thin', color: { argb: '000000' } }
                        };
                    });
                    
                    // 先创建所有数据行
                    for (let i = 0; i < this.items.length; i++) {
                        const item = this.items[i];
                        const rowNumber = i + 2; // 从第2行开始
                        
                        // 创建数据行
                        const row = worksheet.addRow({
                            serial: i + 1,
                            image: '', // 图片单元格留空
                            code: item.code || '',
                            originalCode: item.originalCode || '',
                            name: item.name || '',
                            specs: item.specs || '',
                            brand: item.selectedBrand || translate('noBrand'),
                            quantity: item.quantity || 0
                        });
                        
                        // 增加行高到150像素，为图片提供足够空间
                        row.height = 75;
                        
                        // 设置所有单元格的边框
                        for (let col = 1; col <= 8; col++) {
                            const cell = row.getCell(col);
                            cell.border = {
                                top: { style: 'thin', color: { argb: 'DDDDDD' } },
                                left: { style: 'thin', color: { argb: 'DDDDDD' } },
                                bottom: { style: 'thin', color: { argb: 'DDDDDD' } },
                                right: { style: 'thin', color: { argb: 'DDDDDD' } }
                            };
                            
                            // 设置对齐方式
                            if (col === 1 || col === 8) { // 序号和数量居中
                                cell.alignment = { vertical: 'middle', horizontal: 'center' };
                            } else if (col === 2) { // 图片单元格居中对齐
                                cell.alignment = { vertical: 'middle', horizontal: 'center' };
                            } else { // 其他列左对齐
                                cell.alignment = { vertical: 'middle', horizontal: 'left' };
                            }
                        }
                    }
                    
                    // 单独处理图片插入
                    for (let i = 0; i < this.items.length; i++) {
                        const item = this.items[i];
                        const rowNumber = i + 2; // 对应的行号
                        const row = worksheet.getRow(rowNumber);
                        
                        try {
                            const imageBuffer = await this.loadImageToBuffer(item.code);
                            if (imageBuffer) {
                                // 获取图片扩展名
                                const extension = this.getImageExtensionFromBuffer(imageBuffer, item.code);
                                
                                // 添加图片到工作簿
                                const imageId = workbook.addImage({
                                    buffer: imageBuffer,
                                    extension: extension
                                });
                                
                                // 关键修复：调整图片插入位置和大小
                                // B列（索引1），行索引从0开始
                                const colIndex = 1; // B列
                                const rowIndex = rowNumber - 1; // 转换为0-based索引
                                
                                console.log(`插入图片到第${rowNumber}行，第${colIndex+1}列（${String.fromCharCode(65+colIndex)}列）`);
                                
                                // 新的图片插入方式：使用单元格锚点，并设置偏移和扩展
                                worksheet.addImage(imageId, {
                                    tl: { 
                                        col: colIndex, 
                                        row: rowIndex,
                                        offset: 0 // 从单元格左上角开始
                                    },
                                    br: { 
                                        col: colIndex + 1, // 占用到C列
                                        row: rowIndex + 1, // 占用到下一行
                                        offset: 0 // 结束位置
                                    },
                                    editAs: 'oneCell'
                                });
                                
                                // 调整B列宽度以适应图片
                                worksheet.getColumn(colIndex + 1).width = 12; // 进一步增加图片列宽度
                                
                            } else {
                                // 没有图片，在单元格中显示"无图片"
                                row.getCell(2).value = translate('noImage');
                                row.getCell(2).alignment = { vertical: 'middle', horizontal: 'center' };
                            }
                        } catch (error) {
                            console.warn(`无法加载图片: ${item.code}`, error);
                            row.getCell(2).value = translate('imageNotFound');
                            row.getCell(2).alignment = { vertical: 'middle', horizontal: 'center' };
                        }
                    }
                    
                    // 自动调整列宽（跳过图片列）
                    worksheet.columns.forEach((column, index) => {
                        if (index !== 1) { // 跳过B列（索引1）
                            let maxLength = 0;
                            column.eachCell({ includeEmpty: true }, (cell) => {
                                const columnLength = cell.value ? cell.value.toString().length : 10;
                                if (columnLength > maxLength) {
                                    maxLength = columnLength;
                                }
                            });
                            column.width = Math.min(maxLength + 2, 50);
                        }
                    });
                    
                    // 添加汇总信息
                    const summaryStartRow = this.items.length + 3;
                    
                    
                    // 汇总标题
                    const summaryTitleCell = worksheet.getCell(`A${summaryStartRow}`);
                    summaryTitleCell.value = translate('excelSummary');
                    summaryTitleCell.font = { bold: true, color: { argb: '3498DB' }, size: 12 };
                    summaryTitleCell.border = {
                        top: { style: 'thin', color: { argb: '3498DB' } },
                        left: { style: 'thin', color: { argb: '3498DB' } },
                        bottom: { style: 'thin', color: { argb: '3498DB' } },
                        right: { style: 'thin', color: { argb: '3498DB' } }
                    };
                    
                    // 商品种类数
                    worksheet.getCell(`A${summaryStartRow + 1}`).value = translate('excelCategoryCount');
                    worksheet.getCell(`B${summaryStartRow + 1}`).value = this.items.length;
                    
                    // 商品总数量
                    worksheet.getCell(`A${summaryStartRow + 2}`).value = translate('excelTotalQuantity');
                    worksheet.getCell(`B${summaryStartRow + 2}`).value = this.getTotalItems();
                    
                    // 导出日期和时间
                    const currentDate = new Date();
                    const dateFormatter = state.currentLanguage === 'zh-CN' ? 
                        currentDate.toLocaleDateString('zh-CN') : 
                        currentDate.toLocaleDateString('en-US');
                    const timeFormatter = state.currentLanguage === 'zh-CN' ?
                        currentDate.toLocaleTimeString('zh-CN') :
                        currentDate.toLocaleTimeString('en-US');
                    
                    worksheet.getCell(`A${summaryStartRow + 3}`).value = translate('excelExportDate');
                    worksheet.getCell(`B${summaryStartRow + 3}`).value = dateFormatter;
                    
                    worksheet.getCell(`A${summaryStartRow + 4}`).value = translate('excelExportTime');
                    worksheet.getCell(`B${summaryStartRow + 4}`).value = timeFormatter;
                    
                    // 设置汇总信息样式
                    for (let i = summaryStartRow; i <= summaryStartRow + 4; i++) {
                        const row = worksheet.getRow(i);
                        row.height = 20;
                        
                        // 设置A列的粗体和边框
                        const cellA = row.getCell(1);
                        cellA.font = { bold: true };
                        cellA.border = {
                            top: { style: 'thin', color: { argb: 'DDDDDD' } },
                            left: { style: 'thin', color: { argb: 'DDDDDD' } },
                            bottom: { style: 'thin', color: { argb: 'DDDDDD' } },
                            right: { style: 'thin', color: { argb: 'DDDDDD' } }
                        };
                        
                        // 设置B-H列的边框
                        for (let col = 2; col <= 8; col++) {
                            const cell = row.getCell(col);
                            cell.border = {
                                top: { style: 'thin', color: { argb: 'DDDDDD' } },
                                left: { style: 'thin', color: { argb: 'DDDDDD' } },
                                bottom: { style: 'thin', color: { argb: 'DDDDDD' } },
                                right: { style: 'thin', color: { argb: 'DDDDDD' } }
                            };
                        }
                    }
                    
                    // 生成文件名
                    const fileName = state.currentLanguage === 'zh-CN' ? 
                        `订购清单_${new Date().toISOString().slice(0,10)}.xlsx` :
                        `Order_List_${new Date().toISOString().slice(0,10)}.xlsx`;
                    
                    // 写入文件并下载
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { 
                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                    });
                    
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // 清理URL
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url);
                    }, 100);
                    
                    this.showNotification(translate('exportSuccess'));
                    
                } catch (error) {
                    console.error('导出Excel失败:', error);
                    alert('导出失败: ' + error.message);
                } finally {
                    // 恢复按钮状态
                    exportBtn.innerHTML = originalText || `<i class="fas fa-file-excel"></i> <span id="export-cart-text">${translate('exportCart')}</span>`;
                    exportBtn.disabled = false;
                }
            },

            // 保留原来的CSV导出方法作为回退
            exportToCSV() {
                if (this.items.length === 0) {
                    alert(translate('cartEmpty'));
                    return;
                }
                
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                
                const headers = [
                    translate('excelSerial'),
                    translate('excelProductCode'),
                    translate('excelOriginalCode'),
                    translate('excelProductName'),
                    translate('excelSpecs'),
                    translate('excelBrand'),
                    translate('excelQuantity')
                ];
                csvContent += headers.join(',') + '\n';
                
                this.items.forEach((item, index) => {
                    const row = [
                        index + 1,
                        `"${item.code}"`,
                        `"${item.originalCode}"`,
                        `"${this.escapeCSV(item.name)}"`,
                        `"${this.escapeCSV(item.specs)}"`,
                        `"${item.selectedBrand || translate('noBrand')}"`,
                        item.quantity
                    ];
                    csvContent += row.join(',') + '\n';
                });
                
                csvContent += '\n\n';
                
                const currentDate = new Date();
                const dateFormatter = state.currentLanguage === 'zh-CN' ? 
                    currentDate.toLocaleDateString('zh-CN') : 
                    currentDate.toLocaleDateString('en-US');
                
                csvContent += translate('excelSummary') + ':\n';
                csvContent += `${translate('excelCategoryCount')},${this.items.length}\n`;
                csvContent += `${translate('excelTotalQuantity')},${this.getTotalItems()}\n`;
                csvContent += `${translate('excelExportDate')},${dateFormatter}\n`;
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                const fileName = state.currentLanguage === 'zh-CN' ? 
                    `订购清单_${new Date().toISOString().slice(0,10)}.csv` :
                    `Order_List_${new Date().toISOString().slice(0,10)}.csv`;
                link.setAttribute('download', fileName);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },
            // 辅助函数：处理CSV特殊字符
            escapeCSV(text) {
                if (!text) return '';
                // 替换双引号为两个双引号（CSV规范）
                return text.toString().replace(/"/g, '""');
            }
        },
        // 搜索配置
        searchConfig: {
            minSearchLength: 1, // 最小搜索字符数
            searchDebounceDelay: 300, // 防抖延迟
            searchFields: [
                'CODE', 'code',              // 商品编码
                'originalCode',              // 原始编码
                'MODEL', 'model',            // 商品名称/型号
                'NAME', 'name',              // 商品名称
                'FITS MACHINE', 'fits machine', // 适用机器
                'specs', 'SPECS',            // 规格信息
                'BRAND', 'brand',            // 品牌
                'TYPE', 'type',              // 类型
                'DESCRIPTION', 'description', // 描述
                'sheetName'                  // 工作表名称
            ]
        },
        // 当前选择添加到购物车的商品
        selectedProductForCart: null
    };

    // 图标映射（使用工作表图标）
    const sheetIcons = {
        '01': 'fas fa-gas-pump',
        '02': 'fas fa-oil-can',
        '03': 'fas fa-database',
        '04': 'fas fa-coil',
        '05': 'fas fa-cog',
        '06': 'fas fa-oil-can',
        '07': 'fas fa-gas-pump',
        '08': 'fas fa-link',
        '09': 'fas fa-gas-pump',
        '10': 'fas fa-engine',
        '11': 'fas fa-cut',
        '12': 'fas fa-cogs',
        '13': 'fas fa-tire',
        '14': 'fas fa-layer-group',
        '15': 'fas fa-volume-mute',
        '16': 'fas fa-bolt',
        '17': 'fas fa-snowflake',
        '18': 'fas fa-tools',
        '19': 'fas fa-bolt',
        '20': 'fas fa-sliders-h',
        '21': 'fas fa-wind',
        '22': 'fas fa-cut',
        '23': 'fas fa-spray-can',
        '24': 'fas fa-toolbox',
        '25': 'fas fa-wind',
        '26': 'fas fa-filter',
        '27': 'fas fa-hard-hat',
        '28': 'fas fa-cut',
        '29': 'fas fa-gas-pump',
        '30': 'fas fa-tint',
        '31': 'fas fa-question-circle',
        '32': 'fas fa-history',
        '33': 'fas fa-cable-car'
    };

    const defaultIcon = 'fas fa-table';
    const imageExtensions = ['.png', '.jpg', '.jpeg'];
    let searchDebounceTimer = null;

    // 翻译函数
    function translate(key) {
        return translations[state.currentLanguage][key] || key;
    }

    // 切换语言
    function switchLanguage(lang) {
        if (state.currentLanguage === lang) return;
        
        state.currentLanguage = lang;
        localStorage.setItem('product_language', lang);
        
        // 更新页面文本
        updatePageText();
        
        // 更新国旗图标
        updateFlagIcon();
        
        // 更新品牌选择下拉框
        updateBrandSelect();
        
        // 重新渲染当前视图
        refreshCurrentView();
    }

    // 更新国旗图标
    function updateFlagIcon() {
        const languageBtn = document.getElementById('language-btn');
        const flagElement = languageBtn.querySelector('.language-flag');
        
        if (state.currentLanguage === 'zh-CN') {
            flagElement.className = 'language-flag flag-cn';
            flagElement.textContent = '中';
        } else {
            flagElement.className = 'language-flag flag-us';
            flagElement.textContent = 'US';
        }
    }

    // 更新品牌选择下拉框
    function updateBrandSelect() {
        const brandSelect = document.getElementById('brand-select');
        if (!brandSelect) return;
        
        // 保存当前选中的值
        const currentValue = brandSelect.value;
        
        // 清空选项
        brandSelect.innerHTML = '';
        
        // 添加根据当前语言的选项
        const brandOptions = [
            { key: 'no_brand', label: translate('noBrand') },
            { key: 'kelon', label: translate('kelon') },
            { key: 'lixiong', label: translate('lixiong') }
        ];
        
        brandOptions.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.key;
            optionElement.textContent = option.label;
            brandSelect.appendChild(optionElement);
        });
        
        // 恢复之前选中的值
        brandSelect.value = currentValue;
        
        // 如果之前选中的值不存在，使用第一个选项
        if (!brandSelect.value) {
            brandSelect.value = 'no_brand';
        }
    }

    // 更新页面文本
    function updatePageText() {
        // 更新页面标题
        document.getElementById('page-title').textContent = translate('pageTitle');
        document.getElementById('page-subtitle').textContent = translate('pageSubtitle');
        
        // 更新导航栏
        document.getElementById('nav-home').textContent = translate('navHome');
        document.getElementById('nav-machine').textContent = translate('navMachine');
        document.getElementById('nav-cart').textContent = translate('navCart');
        document.getElementById('nav-refresh').textContent = translate('navRefresh');
        document.getElementById('current-language').textContent = state.currentLanguage === 'zh-CN' ? '中文' : 'English';
        
        // 更新侧边栏
        document.getElementById('sidebar-title').textContent = translate('sidebarTitle');
        document.getElementById('product-search-input').placeholder = translate('searchPlaceholder');
        document.getElementById('data-status-text').textContent = translate('loadingData');
        
        // 更新购物车
        document.getElementById('cart-title').textContent = translate('cartTitle');
        document.getElementById('empty-cart-title').textContent = translate('emptyCartTitle');
        document.getElementById('empty-cart-message').textContent = translate('emptyCartMessage');
        document.getElementById('cart-total-label').textContent = translate('cartTotal');
        document.getElementById('cart-total-unit').textContent = translate('cartItemsUnit');
        document.getElementById('clear-cart-text').textContent = translate('clearCart');
        document.getElementById('export-cart-text').textContent = translate('exportCart');
        
        // 更新模态框
        document.getElementById('quantity-modal-title').textContent = translate('selectQuantity');
        document.getElementById('cancel-quantity-text').textContent = translate('cancel');
        document.getElementById('confirm-quantity-text').textContent = translate('confirm');
        
        // 更新页脚
        document.getElementById('footer-text').textContent = translate('footerText');
    }

    // 刷新当前视图
    function refreshCurrentView() {
        if (state.currentView === 'sheets') {
            showSheetsList();
        } else if (state.currentView === 'products') {
            if (state.isSearchMode) {
                showSearchResults();
            } else if (state.selectedSheet) {
                showProductsBySheet(state.selectedSheet);
            }
        } else if (state.currentView === 'detail') {
            showProductDetail(state.selectedProduct, state.selectedSheet);
        }
    }

    // 初始化页面
    document.addEventListener('DOMContentLoaded', async function() {
        // 设置初始语言
        updatePageText();
        updateFlagIcon();
        updateBrandSelect();
        
        // 加载购物车数据
        state.cart.load();
        
        await loadJSONData();
        setupEventListeners();
        
        // 加载后自动显示第一个工作表
        if (state.sheetNames.length > 0) {
            const firstSheet = state.sheetNames[0];
            state.selectedSheet = firstSheet;
            // 重置分页状态
            resetPagination();
            // 显示该工作表中的商品
            showProductsBySheet(firstSheet);
            // 在树形视图中激活第一个工作表
            setTimeout(() => {
                activateSheetInTree(firstSheet);
            }, 100);
        } else {
            showSheetsList();
        }
    });

    // 激活树形视图中的工作表
    function activateSheetInTree(sheetName) {
        document.querySelectorAll('.tree-header').forEach(header => {
            header.classList.remove('active');
        });
        
        const sheetHeader = document.querySelector(`.tree-item[data-sheet="${sheetName}"] .tree-header`);
        if (sheetHeader) {
            sheetHeader.classList.add('active');
        }
    }

    // 从JSON文件加载数据
    async function loadJSONData() {
        try {
            const response = await fetch('products_data.json');
            if (!response.ok) {
                throw new Error(`HTTP错误! 状态: ${response.status}`);
            }
            
            state.jsonData = await response.json();
            state.sheetNames = Object.keys(state.jsonData);
            
            // 处理数据
            processJSONData();
            
            // 更新数据状态
            updateDataStatus(true, translate('dataReady'));
            
            console.log('JSON数据加载完成:', state.sheetNames.length, '个工作表');
            console.log('所有商品总数:', state.allProducts.length, '个');
            
            // 立即初始化树形视图
            initializeTreeView();
            
        } catch (error) {
            console.error('加载JSON数据失败:', error);
            updateDataStatus(false, '加载失败: ' + error.message);
            
            // 显示错误信息
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i>
                    <h3>数据加载失败</h3>
                    <p>${error.message}</p>
                    <p>请确保 products_data.json 文件存在且格式正确</p>
                    <button class="action-button" id="retry-load" style="margin-top: 20px;">
                        <i class="fas fa-redo"></i> ${translate('navRefresh')}
                    </button>
                </div>
            `;
            
            document.getElementById('retry-load')?.addEventListener('click', async () => {
                await loadJSONData();
                initializeTreeView();
                showSheetsList();
            });
        }
    }

    // 安全转换为小写字符串的函数
    function safeToLower(value) {
        if (value === null || value === undefined) {
            return '';
        }
        if (typeof value === 'string') {
            return value.toLowerCase();
        }
        if (typeof value === 'number') {
            return value.toString().toLowerCase();
        }
        if (typeof value === 'boolean') {
            return value.toString().toLowerCase();
        }
        return String(value).toLowerCase();
    }

    // 安全获取字段值的函数（修改为支持"Original CODE"）
    function safeGetValue(obj, keys, defaultValue = '') {
        if (!obj) return defaultValue;
        
        for (const key of Array.isArray(keys) ? keys : [keys]) {
            // 特别处理"Original CODE"字段，可能有空格
            if (key === 'Original CODE' || key === 'originalCode') {
                if (obj['Original CODE'] !== null && obj['Original CODE'] !== undefined) {
                    const value = obj['Original CODE'];
                    if (typeof value === 'string') return value;
                    if (typeof value === 'number') return value.toString();
                    if (typeof value === 'boolean') return value.toString();
                    return String(value);
                }
            }
            
            if (obj[key] !== null && obj[key] !== undefined) {
                const value = obj[key];
                // 确保返回值是字符串
                if (typeof value === 'string') return value;
                if (typeof value === 'number') return value.toString();
                if (typeof value === 'boolean') return value.toString();
                return String(value);
            }
        }
        
        return defaultValue;
    }

    // 处理JSON数据
    function processJSONData() {
        state.productsBySheet = {};
        state.allProducts = [];
        
        // 从所有工作表中提取商品数据
        state.sheetNames.forEach(sheetName => {
            const sheetData = state.jsonData[sheetName];
            
            if (Array.isArray(sheetData)) {
                // 过滤掉无效数据
                const validProducts = sheetData.filter(item => 
                    item && typeof item === 'object'
                );
                
                // 为每个商品添加工作表信息和标准化字段
                validProducts.forEach(product => {
                    product.sheetName = sheetName;
                    
                    // 确保有originalCode字段（从"Original CODE"获取）
                    product.originalCode = safeGetValue(product, ['Original CODE', 'originalCode'], '');
                    
                    // 标准化其他字段以便搜索（使用安全的转换函数）
                    product.searchCode = safeToLower(product.CODE || product.code || '');
                    product.searchModel = safeToLower(product.MODEL || product.model || '');
                    product.searchName = safeToLower(product.NAME || product.name || '');
                    product.searchFitsMachine = safeToLower(product['FITS MACHINE'] || product['fits machine'] || '');
                    product.searchSpecs = safeToLower(product.SPECS || product.specs || '');
                    product.searchBrand = safeToLower(product.BRAND || product.brand || '');
                    product.searchType = safeToLower(product.TYPE || product.type || '');
                    product.searchDescription = safeToLower(product.DESCRIPTION || product.description || '');
                    // 添加Original CODE到搜索字段
                    product.searchOriginalCode = safeToLower(product.originalCode);
                });
                
                state.productsBySheet[sheetName] = validProducts;
                state.allProducts = state.allProducts.concat(validProducts);
            } else {
                state.productsBySheet[sheetName] = [];
            }
        });
    }

    // 更新数据状态
    function updateDataStatus(success, message) {
        const statusElement = document.getElementById('data-status');
        if (statusElement) {
            const icon = statusElement.querySelector('i');
            const text = statusElement.querySelector('span');
            
            if (success) {
                icon.style.color = '#2ecc71';
                icon.className = 'fas fa-check-circle';
                text.textContent = message;
            } else {
                icon.style.color = '#e74c3c';
                icon.className = 'fas fa-exclamation-circle';
                text.textContent = message;
            }
        }
    }

    // 初始化树形视图（显示工作表）
    function initializeTreeView() {
        const treeList = document.getElementById('category-tree');
        treeList.innerHTML = '';
        
        // 添加所有工作表选项
        state.sheetNames.forEach(sheetName => {
            const productCount = state.productsBySheet[sheetName] ? state.productsBySheet[sheetName].length : 0;
            
            // 如果该工作表没有商品，跳过
            if (productCount === 0) return;
            
            const treeItem = document.createElement('li');
            treeItem.className = 'tree-item';
            treeItem.dataset.sheet = sheetName;
            
            // 获取图标（尝试从工作表名称中提取数字部分）
            let icon = defaultIcon;
            const matches = sheetName.match(/\d+/);
            if (matches && sheetIcons[matches[0]]) {
                icon = sheetIcons[matches[0]];
            }
            
            treeItem.innerHTML = `
                <div class="tree-header ${state.selectedSheet === sheetName && state.currentView === 'products' && !state.isSearchMode ? 'active' : ''}">
                    <div class="tree-toggle">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="tree-icon">
                        <i class="${icon}"></i>
                    </div>
                    <span>${sheetName}</span>
                    <div class="part-count">${productCount}</div>
                </div>
            `;
            
            const treeHeader = treeItem.querySelector('.tree-header');
            
            // 点击工作表事件
            treeHeader.addEventListener('click', function(e) {
                e.stopPropagation();
                
                // 退出搜索模式
                exitSearchMode();
                
                // 更新选中状态
                document.querySelectorAll('.tree-header').forEach(header => {
                    header.classList.remove('active');
                });
                treeHeader.classList.add('active');
                
                // 选择该工作表
                state.selectedSheet = sheetName;
                
                // 重置分页状态
                resetPagination();
                
                // 显示该工作表中的商品
                showProductsBySheet(sheetName);
            });
            
            treeList.appendChild(treeItem);
        });
    }

    // 退出搜索模式
    function exitSearchMode() {
        state.isSearchMode = false;
        state.searchTerm = '';
        state.filteredProducts = [];
        
        // 清空搜索框
        const searchInput = document.getElementById('product-search-input');
        if (searchInput) {
            searchInput.value = '';
        }
        
        // 清除防抖定时器
        if (searchDebounceTimer) {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = null;
        }
    }

    // 清空搜索
    function clearSearch() {
        exitSearchMode();
        
        // 如果当前有选中的工作表，显示该工作表的商品
        if (state.selectedSheet) {
            resetPagination();
            showProductsBySheet(state.selectedSheet);
        } else {
            showSheetsList();
        }
    }

    // 重置分页状态
    function resetPagination() {
        state.pagination.currentPage = 1;
        state.pagination.loadedItems = 0;
        state.pagination.isLoading = false;
    }

    // 更新分页信息
    function updatePaginationInfo(totalItems) {
        state.pagination.totalItems = totalItems;
        state.pagination.totalPages = Math.ceil(totalItems / state.pagination.itemsPerPage);
        state.pagination.currentPage = Math.min(state.pagination.currentPage, state.pagination.totalPages);
    }

    // 显示工作表列表页面（更新为双语版本）
    function showSheetsList() {
        const mainContent = document.getElementById('main-content');
        
        // 计算所有商品总数
        const totalProducts = state.allProducts.length;
        
        mainContent.innerHTML = `
            <div class="content-header">
                <div class="content-title">${translate('allSheets')}</div>
                <div class="content-subtitle">${translate('dataDescription')}</div>
            </div>
            <div class="empty-state">
                <i class="fas fa-database" style="color: #3498db;"></i>
                <h3>${translate('dataDirectory')}</h3>
                <p>${translate('dataDescription')}</p>
                <div style="margin-top: 20px; text-align: center;">
                    <div style="display: inline-flex; justify-content: center; gap: 30px; margin-bottom: 20px; flex-wrap: wrap;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 600; color: #3498db;">${state.sheetNames.length}</div>
                            <div style="font-size: 12px; color: #6c757d;">${translate('sheetsCount')}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 600; color: #3498db;">${totalProducts}</div>
                            <div style="font-size: 12px; color: #6c757d;">${translate('partsCount')}</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: left; max-width: 500px;">
                    <h4 style="margin-bottom: 10px; color: #3498db; font-size: 15px;">${translate('instructions')}</h4>
                    <ul style="padding-left: 20px; font-size: 13px;">
                        <li style="margin-bottom: 5px;">${translate('instruction1')}</li>
                        <li style="margin-bottom: 5px;">${translate('instruction2')}</li>
                        <li style="margin-bottom: 5px;">${translate('instruction3')}</li>
                        <li style="margin-bottom: 5px;">${translate('instruction4')}</li>
                        <li style="margin-bottom: 5px;">${translate('instruction5')}</li>
                        <li style="margin-bottom: 5px;">${translate('instruction6')}</li>
                        <li style="margin-bottom: 5px;">${translate('instruction7')}</li>
                        <li style="margin-bottom: 5px;">${translate('instruction8')}</li>
                        <li style="margin-bottom: 5px;">${translate('instruction9')}</li>
                    </ul>
                </div>
            </div>
        `;
        
        state.currentView = 'sheets';
        state.selectedSheet = null;
        state.selectedProduct = null;
        
        // 更新树形视图选中状态
        document.querySelectorAll('.tree-header').forEach(header => {
            header.classList.remove('active');
        });
    }

    // 在所有商品中搜索（增强版，现在包含Original CODE搜索）
    function searchAllProducts(searchTerm) {
        if (!searchTerm || searchTerm.trim().length < state.searchConfig.minSearchLength) {
            return [];
        }
        
        const term = searchTerm.toLowerCase().trim();
        const searchWords = term.split(/\s+/).filter(word => word.length > 0);
        
        return state.allProducts.filter(product => {
            // 如果只有一个搜索词，使用模糊搜索
            if (searchWords.length === 1) {
                const singleWord = searchWords[0];
                return (
                    (product.searchCode && product.searchCode.includes(singleWord)) ||
                    (product.searchOriginalCode && product.searchOriginalCode.includes(singleWord)) ||
                    (product.searchModel && product.searchModel.includes(singleWord)) ||
                    (product.searchName && product.searchName.includes(singleWord)) ||
                    (product.searchFitsMachine && product.searchFitsMachine.includes(singleWord)) ||
                    (product.searchSpecs && product.searchSpecs.includes(singleWord)) ||
                    (product.searchBrand && product.searchBrand.includes(singleWord)) ||
                    (product.searchType && product.searchType.includes(singleWord)) ||
                    (product.searchDescription && product.searchDescription.includes(singleWord)) ||
                    (product.sheetName && safeToLower(product.sheetName).includes(singleWord))
                );
            }
            
            // 多个搜索词，需要所有词都匹配
            return searchWords.every(word => {
                return (
                    (product.searchCode && product.searchCode.includes(word)) ||
                    (product.searchOriginalCode && product.searchOriginalCode.includes(word)) ||
                    (product.searchModel && product.searchModel.includes(word)) ||
                    (product.searchName && product.searchName.includes(word)) ||
                    (product.searchFitsMachine && product.searchFitsMachine.includes(word)) ||
                    (product.searchSpecs && product.searchSpecs.includes(word)) ||
                    (product.searchBrand && product.searchBrand.includes(word)) ||
                    (product.searchType && product.searchType.includes(word)) ||
                    (product.searchDescription && product.searchDescription.includes(word)) ||
                    (product.sheetName && safeToLower(product.sheetName).includes(word))
                );
            });
        });
    }

    // 按工作表显示商品（带分页，更新为双语版本）
    function showProductsBySheet(sheetName) {
        // 如果是搜索模式，显示搜索结果
        if (state.isSearchMode) {
            showSearchResults();
            return;
        }
        
        const products = state.productsBySheet[sheetName] || [];
        
        // 更新分页信息
        updatePaginationInfo(products.length);
        
        // 获取当前页的数据
        const startIndex = (state.pagination.currentPage - 1) * state.pagination.itemsPerPage;
        const endIndex = startIndex + state.pagination.itemsPerPage;
        const currentPageProducts = products.slice(startIndex, endIndex);
        
        const mainContent = document.getElementById('main-content');
        
        mainContent.innerHTML = `
            <div class="content-header">
                <div>
                    <div class="content-title">${sheetName}</div>
                    <div class="content-subtitle">${translate('foundItems')} ${products.length} ${translate('itemsFor')} "${state.searchTerm}"</div>
                </div>
                <button class="action-button" id="back-to-sheets">
                    <i class="fas fa-arrow-left"></i> ${translate('backToList')}
                </button>
            </div>
            <div class="products-grid" id="products-grid">
                ${currentPageProducts.length > 0 ? 
                    currentPageProducts.map((product, index) => createProductCard(product, index)).join('') 
                    : 
                    `<div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-box-open"></i>
                        <h3>${translate('noProducts')}</h3>
                        <p>${translate('noProductsInSheet')}</p>
                    </div>`
                }
            </div>
            
            <!-- 分页控件 -->
            ${products.length > state.pagination.itemsPerPage ? createPaginationControls() : ''}
        `;
        
        // 为每个商品卡片添加点击事件
        document.querySelectorAll('.product-card').forEach((card, index) => {
            const productIndex = startIndex + index;
            const product = products[productIndex];
            
            if (product) {
                // 详情查看事件
                card.addEventListener('click', (e) => {
                    // 如果点击的是购物车按钮，不触发详情查看
                    if (!e.target.closest('.cart-button')) {
                        showProductDetail(product, sheetName);
                    }
                });
                
                // 购物车按钮事件
                const cartBtn = card.querySelector('.cart-button');
                if (cartBtn) {
                    cartBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        addToCart(product);
                    });
                }
            }
        });
        
        // 更新购物车按钮状态
        updateCartButtonStates();
        
        // 返回按钮事件
        document.getElementById('back-to-sheets').addEventListener('click', () => {
            showSheetsList();
        });
        
        // 分页按钮事件
        setupPaginationEvents(sheetName);
        
        state.currentView = 'products';
        state.selectedSheet = sheetName;
        
        // 延迟加载图片
        setTimeout(() => {
            loadProductCardImagesLazily();
        }, 100);
    }

    // 更新购物车按钮状态
    function updateCartButtonStates() {
        document.querySelectorAll('.product-card').forEach(card => {
            const productCode = card.dataset.code;
            const cartBtn = card.querySelector('.cart-button');
            // 注意：现在检查购物车中是否有相同编码的商品（不检查品牌）
            const inCart = state.cart.items.find(item => item.code === productCode);
            
            if (cartBtn) {
                if (inCart) {
                    cartBtn.classList.add('added');
                    cartBtn.innerHTML = '<i class="fas fa-check"></i>';
                    cartBtn.title = translate('removeFromCart');
                } else {
                    cartBtn.classList.remove('added');
                    cartBtn.innerHTML = '<i class="fas fa-cart-plus"></i>';
                    cartBtn.title = translate('addToCart');
                }
            }
        });
    }

    // 创建商品卡片HTML（修改后的结构，添加购物车按钮和显示商品编码、Original CODE）
    function createProductCard(product, index) {
        // 获取商品信息（使用安全函数）
        const productCode = safeGetValue(product, ['CODE', 'code'], `ITEM_${index}`);
        const productName = safeGetValue(product, ['MODEL', 'model', 'NAME', 'name'], '未命名商品');
        const productSpecs = safeGetValue(product, ['FITS MACHINE', 'fits machine', 'SPECS', 'specs'], '');
        const sheetName = product.sheetName || '';
        
        // 获取Original CODE（从"Original CODE"字段）
        const originalCode = safeGetValue(product, ['Original CODE', 'originalCode'], '');
        
        // 检查是否已在购物车中 - 使用相同的编码进行比较（不检查品牌）
        const inCart = state.cart.items.find(item => item.code === productCode);
        
        return `
                <div class="product-card fade-in" data-code="${productCode}">
                    <button class="cart-button ${inCart ? 'added' : ''}" title="${inCart ? translate('removeFromCart') : translate('addToCart')}" data-code="${productCode}">
                        <i class="fas ${inCart ? 'fa-check' : 'fa-cart-plus'}"></i>
                    </button>
                    <div class="product-image" data-code="${productCode}">
                        <div class="image-loading">
                            <i class="fas fa-spinner"></i>
                            <p>${translate('loadingData')}</p>
                        </div>
                    </div>
                    <div class="product-info">
                        <div class="product-name" title="${productName}">${productName}</div>
                        ${productSpecs ? `<div class="product-specs" title="${productSpecs}">${productSpecs}</div>` : ''}
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 10px; border-top: 1px solid #eee;">
                            <div style="flex: 1;">
                                <div style="font-size: 13px; color: #3498db; font-weight: 600; font-family: 'Courier New', monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${productCode}">${productCode}</div>
                            </div>
                            ${originalCode ? `
                                <div style="flex: 1; text-align: right;">
                                    <div style="font-size: 12px; color: #3498db; font-family: 'Courier New', monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${originalCode}">${originalCode}</div>
                                </div>
                            ` : ''}
                        </div>
                        ${sheetName ? `<div style="font-size: 11px; color: #95a5a6; margin-top: 5px;">${sheetName}</div>` : ''}
                    </div>
                </div>
            `;
    }

    // 显示搜索结果（更新为双语版本）
    function showSearchResults() {
        const results = state.filteredProducts;
        
        // 更新分页信息
        updatePaginationInfo(results.length);
        
        // 获取当前页的数据
        const startIndex = (state.pagination.currentPage - 1) * state.pagination.itemsPerPage;
        const endIndex = startIndex + state.pagination.itemsPerPage;
        const currentPageProducts = results.slice(startIndex, endIndex);
        
        const mainContent = document.getElementById('main-content');
        
        mainContent.innerHTML = `
            <div class="content-header">
                <div>
                    <div class="content-title">${translate('searchResults')}</div>
                    <div class="content-subtitle">${translate('foundItems')} ${results.length} ${translate('itemsFor')} "${state.searchTerm}"</div>
                </div>
                <button class="action-button" id="back-to-sheets">
                    <i class="fas fa-arrow-left"></i> ${translate('backToList')}
                </button>
            </div>
            <div class="products-grid" id="products-grid">
                ${currentPageProducts.length > 0 ? 
                    currentPageProducts.map((product, index) => createProductCard(product, index)).join('') 
                    : 
                    `<div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-search"></i>
                        <h3>${translate('noResults')}</h3>
                        <p>${translate('tryOtherKeywords')}</p>
                    </div>`
                }
            </div>
            
            <!-- 分页控件 -->
            ${results.length > state.pagination.itemsPerPage ? createPaginationControls() : ''}
        `;
        
        // 为每个商品卡片添加点击事件
        document.querySelectorAll('.product-card').forEach((card, index) => {
            const productIndex = startIndex + index;
            const product = results[productIndex];
            
            if (product) {
                // 详情查看事件
                card.addEventListener('click', (e) => {
                    // 如果点击的是购物车按钮，不触发详情查看
                    if (!e.target.closest('.cart-button')) {
                        showProductDetail(product, product.sheetName);
                    }
                });
                
                // 购物车按钮事件
                const cartBtn = card.querySelector('.cart-button');
                if (cartBtn) {
                    cartBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        addToCart(product);
                    });
                }
            }
        });
        
        // 更新购物车按钮状态
        updateCartButtonStates();
        
        // 返回按钮事件
        document.getElementById('back-to-sheets').addEventListener('click', () => {
            if (state.selectedSheet) {
                exitSearchMode();
                showProductsBySheet(state.selectedSheet);
            } else {
                showSheetsList();
            }
        });
        
        // 分页按钮事件（在搜索模式下）
        setupSearchPaginationEvents();
        
        state.currentView = 'products';
        
        // 延迟加载图片
        setTimeout(() => {
            loadProductCardImagesLazily();
        }, 100);
    }

    // 创建分页控件（更新为双语版本）
    function createPaginationControls() {
        const pagination = state.pagination;
        const maxVisiblePages = 5;
        let startPage = Math.max(1, pagination.currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(pagination.totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        let pageButtons = '';
        for (let i = startPage; i <= endPage; i++) {
            pageButtons += `
                <button class="pagination-button ${i === pagination.currentPage ? 'active' : ''}" 
                        data-page="${i}">
                    ${i}
                </button>
            `;
        }
        
        return `
            <div class="pagination-container">
                <div class="pagination-info">
                    ${translate('showItems')} ${Math.min((pagination.currentPage - 1) * pagination.itemsPerPage + 1, pagination.totalItems)} 
                    ${translate('to')} ${Math.min(pagination.currentPage * pagination.itemsPerPage, pagination.totalItems)} 
                    ${translate('of')} ${pagination.totalItems} ${translate('items')}
                </div>
                <div class="pagination-controls">
                    <button class="pagination-button" id="first-page" ${pagination.currentPage === 1 ? 'disabled' : ''}>
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                    <button class="pagination-button" id="prev-page" ${pagination.currentPage === 1 ? 'disabled' : ''}>
                        <i class="fas fa-angle-left"></i>
                    </button>
                    
                    <div class="page-numbers">
                        ${pageButtons}
                    </div>
                    
                    <button class="pagination-button" id="next-page" ${pagination.currentPage === pagination.totalPages ? 'disabled' : ''}>
                        <i class="fas fa-angle-right"></i>
                    </button>
                    <button class="pagination-button" id="last-page" ${pagination.currentPage === pagination.totalPages ? 'disabled' : ''}>
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                    
                    <div class="pagination-input-group">
                        <span>${translate('goToPage')}</span>
                        <input type="number" class="pagination-input" id="page-input" 
                               min="1" max="${pagination.totalPages}" 
                               value="${pagination.currentPage}">
                        <span>${translate('page')}</span>
                        <button class="pagination-button" id="go-to-page">${translate('jump')}</button>
                    </div>
                </div>
            </div>
        `;
    }

    // 设置分页事件
    function setupPaginationEvents(sheetName) {
        // 第一页
        document.getElementById('first-page')?.addEventListener('click', () => {
            goToPage(1, sheetName);
        });
        
        // 上一页
        document.getElementById('prev-page')?.addEventListener('click', () => {
            goToPage(state.pagination.currentPage - 1, sheetName);
        });
        
        // 下一页
        document.getElementById('next-page')?.addEventListener('click', () => {
            goToPage(state.pagination.currentPage + 1, sheetName);
        });
        
        // 最后一页
        document.getElementById('last-page')?.addEventListener('click', () => {
            goToPage(state.pagination.totalPages, sheetName);
        });
        
        // 页码按钮
        document.querySelectorAll('.pagination-button[data-page]').forEach(button => {
            button.addEventListener('click', (e) => {
                const page = parseInt(e.target.dataset.page);
                goToPage(page, sheetName);
            });
        });
        
        // 跳转到指定页
        document.getElementById('go-to-page')?.addEventListener('click', () => {
            const input = document.getElementById('page-input');
            const page = parseInt(input.value);
            if (page >= 1 && page <= state.pagination.totalPages) {
                goToPage(page, sheetName);
            } else {
                alert(`请输入有效的页码 (1-${state.pagination.totalPages})`);
                input.value = state.pagination.currentPage;
            }
        });
        
        // 输入框回车事件
        document.getElementById('page-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('go-to-page').click();
            }
        });
    }

    // 跳转到指定页
    function goToPage(page, sheetName) {
        if (page < 1 || page > state.pagination.totalPages || page === state.pagination.currentPage) {
            return;
        }
        
        state.pagination.currentPage = page;
        
        // 重新显示商品网格
        showProductsBySheet(sheetName);
        
        // 滚动到顶部
        document.querySelector('.products-grid').scrollTop = 0;
    }

    // 设置搜索分页事件
    function setupSearchPaginationEvents() {
        // 第一页
        document.getElementById('first-page')?.addEventListener('click', () => {
            goToPageSearch(1);
        });
        
        // 上一页
        document.getElementById('prev-page')?.addEventListener('click', () => {
            goToPageSearch(state.pagination.currentPage - 1);
        });
        
        // 下一页
        document.getElementById('next-page')?.addEventListener('click', () => {
            goToPageSearch(state.pagination.currentPage + 1);
        });
        
        // 最后一页
        document.getElementById('last-page')?.addEventListener('click', () => {
            goToPageSearch(state.pagination.totalPages);
        });
        
        // 页码按钮
        document.querySelectorAll('.pagination-button[data-page]').forEach(button => {
            button.addEventListener('click', (e) => {
                const page = parseInt(e.target.dataset.page);
                goToPageSearch(page);
            });
        });
        
        // 跳转到指定页
        document.getElementById('go-to-page')?.addEventListener('click', () => {
            const input = document.getElementById('page-input');
            const page = parseInt(input.value);
            if (page >= 1 && page <= state.pagination.totalPages) {
                goToPageSearch(page);
            } else {
                alert(`请输入有效的页码 (1-${state.pagination.totalPages})`);
                input.value = state.pagination.currentPage;
            }
        });
        
        // 输入框回车事件
        document.getElementById('page-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('go-to-page').click();
            }
        });
    }

    // 跳转到搜索结果的指定页
    function goToPageSearch(page) {
        if (page < 1 || page > state.pagination.totalPages || page === state.pagination.currentPage) {
            return;
        }
        
        state.pagination.currentPage = page;
        
        // 重新显示搜索结果
        showSearchResults();
        
        // 滚动到顶部
        document.querySelector('.products-grid').scrollTop = 0;
    }

    // 延迟加载商品卡片图片
    function loadProductCardImagesLazily() {
        const productImages = document.querySelectorAll('.product-image');
        const totalImages = productImages.length;
        
        // 如果没有图片需要加载
        if (totalImages === 0) return;
        
        // 分批加载图片
        const batchSize = 5;
        let currentIndex = 0;
        
        function loadNextBatch() {
            const endIndex = Math.min(currentIndex + batchSize, totalImages);
            
            for (let i = currentIndex; i < endIndex; i++) {
                loadSingleProductImage(productImages[i]);
            }
            
            currentIndex = endIndex;
            
            if (currentIndex < totalImages) {
                setTimeout(loadNextBatch, 200);
            }
        }
        
        loadNextBatch();
    }

    // 加载单个商品图片
    async function loadSingleProductImage(imageContainer) {
        const productCode = imageContainer.dataset.code;
        
        // 如果图片已经加载过，直接显示
        if (state.loadedImages[productCode]) {
            imageContainer.innerHTML = `<img src="${state.loadedImages[productCode]}" alt="${productCode}" loading="lazy">`;
            return;
        }
        
        // 如果已知图片不存在
        if (state.imageCache[productCode] === false) {
            imageContainer.innerHTML = `
                <div class="image-placeholder">
                    <i class="fas fa-image"></i>
                    <p>${translate('noImage')}</p>
                </div>
            `;
            return;
        }
        
        // 检查图片是否存在
        const imageUrl = await checkImage(productCode);
        
        if (imageUrl) {
            // 保存到已加载图片缓存
            state.loadedImages[productCode] = imageUrl;
            imageContainer.innerHTML = `<img src="${imageUrl}" alt="${productCode}" loading="lazy">`;
        } else {
            imageContainer.innerHTML = `
                <div class="image-placeholder">
                    <i class="fas fa-image"></i>
                    <p>${translate('noImage')}</p>
                </div>
            `;
        }
    }

    // 显示商品详情页面（更新为双语版本）
    function showProductDetail(product, sheetName) {
        const productCode = safeGetValue(product, ['CODE', 'code'], '未知编码');
        const productName = safeGetValue(product, ['MODEL', 'model', 'NAME', 'name'], '未命名商品');
        const originalCode = safeGetValue(product, ['Original CODE', 'originalCode'], '');
        
        const mainContent = document.getElementById('main-content');
        
        // 构建详情表格
        let detailsHtml = '';
        for (const [key, value] of Object.entries(product)) {
            // 跳过内部字段
            if (key.startsWith('_') || key.startsWith('search')) continue;
            if (key === 'IMAGE' || key === 'image') continue;
            if (key === 'CODE' || key === 'code') continue; // CODE单独显示
            if (key === 'MODEL' || key === 'model' || key === 'NAME' || key === 'name') continue; // MODEL单独显示
            if (key === 'sheetName') continue; // 工作表信息单独显示
            if (key === 'originalCode') continue; // originalCode单独显示
            
            if (value !== null && value !== undefined && value !== '') {
                const displayValue = typeof value === 'string' ? value : JSON.stringify(value);
                detailsHtml += `
                    <tr>
                        <td class="info-label">${key}</td>
                        <td class="info-value">${displayValue}</td>
                    </tr>
                `;
            }
        }
        
        mainContent.innerHTML = `
            <div class="content-header">
                <div>
                    <div class="content-title">${translate('productDetails')}</div>
                    <div class="detail-code">${translate('productCode')} ${productCode} </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="action-button" id="add-to-cart-detail">
                        <i class="fas fa-cart-plus"></i> ${translate('addToCart')}
                    </button>
                    <button class="nav-btn" id="back-to-products">
                        <i class="fas fa-arrow-left"></i> ${translate('backToList')}
                    </button>
                </div>
            </div>
            <div class="product-detail">
                <div class="detail-content slide-in">
                    <div class="detail-image-section" id="detail-image-section">
                        <div class="image-loading">
                            <i class="fas fa-spinner"></i>
                            <p>${translate('loadingData')}</p>
                        </div>
                    </div>
                    <div class="detail-info-section">
                        <div class="info-card">
                            <h3>${translate('basicInfo')}</h3>
                            <table class="info-table">
                                <tr>
                                    <td class="info-label">${translate('productCode')}</td>
                                    <td class="info-value"><span style="font-family: 'Courier New', monospace; font-weight: 600; color: #3498db;">${productCode}</span></td>
                                </tr>
                                <tr>
                                    <td class="info-label">${translate('productName')}</td>
                                    <td class="info-value">${productName}</td>
                                </tr>
                                <tr>
                                    <td class="info-label">${translate('sheetName')}</td>
                                    <td class="info-value">${sheetName}</td>
                                </tr>
                            </table>
                        </div>
                        
                        ${detailsHtml ? `
                            <div class="info-card">
                                <h3>${translate('detailedInfo')}</h3>
                                <table class="info-table">
                                    ${detailsHtml}
                                </table>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
        
        // 加载商品图片
        loadProductImageForDetail(productCode);
        
        // 添加到购物车按钮事件
        document.getElementById('add-to-cart-detail').addEventListener('click', () => {
            addToCart(product);
        });
        
        // 返回按钮事件
        document.getElementById('back-to-products').addEventListener('click', () => {
            if (state.isSearchMode) {
                showSearchResults();
            } else if (state.selectedSheet) {
                showProductsBySheet(state.selectedSheet);
            } else {
                showSheetsList();
            }
        });
        
        state.currentView = 'detail';
        state.selectedProduct = product;
    }

    // 加载商品详情图片
    async function loadProductImageForDetail(productCode) {
        const imageSection = document.getElementById('detail-image-section');
        
        // 先检查是否已有缓存的图片URL
        if (state.loadedImages[productCode]) {
            // 已经有缓存的图片URL，直接显示
            const imageUrl = state.loadedImages[productCode];
            imageSection.innerHTML = `
                <div class="detail-image-wrapper" id="detail-image-wrapper" data-image-url="${imageUrl}">
                    <img src="${imageUrl}" alt="${productCode}" class="detail-image" id="detail-image">
                    <div class="zoom-hint" style="position: absolute; bottom: 10px; right: 10px; background-color: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 3px; font-size: 12px;">${translate('clickToZoom')}</div>
                </div>
            `;
            
            const imageWrapper = document.getElementById('detail-image-wrapper');
            imageWrapper.addEventListener('click', function() {
                openImageModal(productCode, imageUrl);
            });
            return;
        }
        
        // 检查图片是否存在（使用缓存）
        const imageUrl = await checkImage(productCode);
        if (imageUrl) {
            // 保存到已加载图片缓存
            state.loadedImages[productCode] = imageUrl;
            
            imageSection.innerHTML = `
                <div class="detail-image-wrapper" id="detail-image-wrapper" data-image-url="${imageUrl}">
                    <img src="${imageUrl}" alt="${productCode}" class="detail-image" id="detail-image">
                    <div class="zoom-hint" style="position: absolute; bottom: 10px; right: 10px; background-color: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 3px; font-size: 12px;">${translate('clickToZoom')}</div>
                </div>
            `;
            
            const imageWrapper = document.getElementById('detail-image-wrapper');
            imageWrapper.addEventListener('click', function() {
                openImageModal(productCode, imageUrl);
            });
        } else {
            imageSection.innerHTML = `
                <div class="image-placeholder" style="width: 100%; height: 100%;">
                    <i class="fas fa-image"></i>
                    <p>${translate('imageNotFound')}</p>
                    <p style="font-size: 12px; margin-top: 8px;">${translate('productCode')} ${productCode}</p>
                    <p style="font-size: 11px; margin-top: 5px;">${translate('saveImageAs')} images/${productCode}.png/jpg/jpeg</p>
                </div>
            `;
        }
    }

    // 检查图片是否存在
    async function checkImage(code) {
        // 检查缓存
        if (state.imageCache[code] !== undefined) {
            return state.imageCache[code];
        }
        
        // 尝试加载图片
        for (const ext of imageExtensions) {
            const url = `images/${code}${ext}`;
            try {
                const exists = await checkImageExists(url);
                if (exists) {
                    state.imageCache[code] = url;
                    return url;
                }
            } catch (error) {
                continue;
            }
        }
        
        // 图片不存在
        state.imageCache[code] = false;
        return false;
    }

    // 检查图片是否存在
    function checkImageExists(url) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => resolve(true);
            img.onerror = () => resolve(false);
            img.src = url;
        });
    }

    // 图片模态框功能
    function openImageModal(productCode, imageUrl) {
        const modal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        
        modalImage.src = imageUrl;
        modalImage.alt = productCode;
        
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeImageModal() {
        const modal = document.getElementById('image-modal');
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    // 添加商品到购物车
    function addToCart(product) {
        state.selectedProductForCart = product;
        
        // 打开数量选择模态框
        const modal = document.getElementById('quantity-modal');
        const title = document.getElementById('quantity-modal-title');
        const quantityInput = document.getElementById('quantity-input');
        const brandSelect = document.getElementById('brand-select');
        
        const productName = safeGetValue(product, ['MODEL', 'model', 'NAME', 'name'], '未命名商品');
        const productCode = safeGetValue(product, ['CODE', 'code'], '');
        
        title.textContent = `${translate('selectQuantity')} "${productName}"`;
        quantityInput.value = 1;
        quantityInput.focus();
        quantityInput.select();
        
        modal.classList.add('active');
    }

    // 确认添加到购物车
    function confirmAddToCart() {
        const quantityInput = document.getElementById('quantity-input');
        const brandSelect = document.getElementById('brand-select');
        const quantity = parseInt(quantityInput.value);
        const brandKey = brandSelect.value;
        
        if (isNaN(quantity) || quantity < 1) {
            alert(translate('enterQuantity'));
            return;
        }
        
        if (state.selectedProductForCart) {
            state.cart.add(state.selectedProductForCart, quantity, brandKey);
            
            // 关闭模态框
            document.getElementById('quantity-modal').classList.remove('active');
            state.selectedProductForCart = null;
        }
    }

    // 执行搜索功能
    function performSearch() {
        const searchTerm = state.searchTerm.trim();
        
        if (searchTerm.length < state.searchConfig.minSearchLength) {
            // 如果搜索词太短，退出搜索模式
            exitSearchMode();
            
            if (state.selectedSheet) {
                showProductsBySheet(state.selectedSheet);
            } else {
                showSheetsList();
            }
            return;
        }
        
        // 执行搜索
        state.filteredProducts = searchAllProducts(searchTerm);
        state.isSearchMode = true;
        
        // 重置分页状态
        resetPagination();
        
        // 显示搜索结果
        showSearchResults();
        
        // 取消树形视图的选中状态
        document.querySelectorAll('.tree-header').forEach(header => {
            header.classList.remove('active');
        });
    }

    // 购物车开关功能
    function toggleCartSidebar() {
        const cartSidebar = document.getElementById('cart-sidebar');
        const cartOverlay = document.getElementById('cart-overlay');
        
        if (cartSidebar.classList.contains('active')) {
            cartSidebar.classList.remove('active');
            cartOverlay.classList.remove('active');
        } else {
            cartSidebar.classList.add('active');
            cartOverlay.classList.add('active');
        }
    }

    // 关闭购物车
    function closeCartSidebar() {
        document.getElementById('cart-sidebar').classList.remove('active');
        document.getElementById('cart-overlay').classList.remove('active');
    }

    // 设置事件监听器
    function setupEventListeners() {
        // 语言切换器事件
        const languageBtn = document.getElementById('language-btn');
        const languageDropdown = document.getElementById('language-dropdown');
        const languageOptions = document.querySelectorAll('.language-option');
        
        languageBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            languageDropdown.classList.toggle('active');
        });
        
        languageOptions.forEach(option => {
            option.addEventListener('click', function() {
                const lang = this.dataset.lang;
                switchLanguage(lang);
                
                // 更新激活状态
                languageOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                
                // 关闭下拉菜单
                languageDropdown.classList.remove('active');
            });
        });
        
        // 点击页面其他区域关闭语言下拉菜单
        document.addEventListener('click', function() {
            languageDropdown.classList.remove('active');
        });
        
        // 商品搜索框事件
        const searchInput = document.getElementById('product-search-input');
        const clearSearchBtn = document.getElementById('clear-search');
        
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value;
            state.searchTerm = searchTerm;
            
            // 清除之前的防抖定时器
            if (searchDebounceTimer) {
                clearTimeout(searchDebounceTimer);
            }
            
            // 如果搜索框为空，直接清空搜索
            if (!searchTerm.trim()) {
                clearSearch();
                return;
            }
            
            // 设置防抖定时器
            searchDebounceTimer = setTimeout(() => {
                performSearch();
            }, state.searchConfig.searchDebounceDelay);
        });
        
        // 清空搜索按钮
        clearSearchBtn.addEventListener('click', function() {
            clearSearch();
        });
        
        // 搜索框回车事件
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                // 清除防抖定时器，立即执行搜索
                if (searchDebounceTimer) {
                    clearTimeout(searchDebounceTimer);
                }
                performSearch();
            }
        });
        
        // 图片模态框事件
        document.getElementById('modal-close').addEventListener('click', closeImageModal);
        
        document.getElementById('image-modal').addEventListener('click', function(e) {
            if (e.target === this || e.target.classList.contains('modal-image')) {
                closeImageModal();
            }
        });
        
        // 购物车相关事件
        document.getElementById('view-cart').addEventListener('click', function(e) {
            e.stopPropagation();
            toggleCartSidebar();
        });
        
        document.getElementById('cart-close').addEventListener('click', function() {
            closeCartSidebar();
        });
        
        document.getElementById('cart-overlay').addEventListener('click', function() {
            closeCartSidebar();
        });
        
        // 购物车侧边栏内部点击阻止事件冒泡
        document.getElementById('cart-sidebar').addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        document.getElementById('clear-cart').addEventListener('click', function() {
            if (confirm(translate('confirmClearCart'))) {
                state.cart.clear();
            }
        });
        
        document.getElementById('export-cart').addEventListener('click', function() {
            state.cart.exportToExcel();
        });
        
        // 数量选择模态框事件
        document.getElementById('cancel-quantity').addEventListener('click', function() {
            document.getElementById('quantity-modal').classList.remove('active');
            state.selectedProductForCart = null;
        });
        
        document.getElementById('confirm-quantity').addEventListener('click', confirmAddToCart);
        
        document.getElementById('quantity-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmAddToCart();
            }
        });
        
        document.getElementById('brand-select').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmAddToCart();
            }
        });
        
        // 刷新数据按钮
        document.getElementById('refresh-data').addEventListener('click', async () => {
            await loadJSONData();
            initializeTreeView();
            if (state.sheetNames.length > 0) {
                const firstSheet = state.sheetNames[0];
                state.selectedSheet = firstSheet;
                resetPagination();
                clearSearch();
                showProductsBySheet(firstSheet);
                activateSheetInTree(firstSheet);
            } else {
                showSheetsList();
            }
        });
        
        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageModal();
                document.getElementById('quantity-modal').classList.remove('active');
                closeCartSidebar();
                
                // 如果当前在详情页，按ESC返回
                if (state.currentView === 'detail') {
                    if (state.isSearchMode) {
                        showSearchResults();
                    } else if (state.selectedSheet) {
                        showProductsBySheet(state.selectedSheet);
                    } else {
                        showSheetsList();
                    }
                }
            }
            
            // 清空搜索快捷键：Ctrl+K
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                clearSearch();
                searchInput.focus();
            }
            
            // 搜索快捷键：Ctrl+F
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                searchInput.focus();
                searchInput.select();
            }
            
            // 打开购物车快捷键：Ctrl+B
            if (e.ctrlKey && e.key === 'b') {
                e.preventDefault();
                toggleCartSidebar();
            }
            
            // 切换语言快捷键：Ctrl+L
            if (e.ctrlKey && e.key === 'l') {
                e.preventDefault();
                // 切换语言
                const newLang = state.currentLanguage === 'zh-CN' ? 'en-US' : 'zh-CN';
                switchLanguage(newLang);
                
                // 更新语言下拉菜单激活状态
                languageOptions.forEach(opt => {
                    opt.classList.remove('active');
                    if (opt.dataset.lang === newLang) {
                        opt.classList.add('active');
                    }
                });
            }
        });
    }
</script>
</body>
</html>