<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>整机配件目录</title>
    <link rel="icon" href="Info/Title.jpg" type="image/jpeg">
    <link rel="apple-touch-icon" href="Info/Title.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* 语言切换器样式 */
        .language-switcher {
            display: flex;
            gap: 5px;
            margin-left: 20px;
        }

        .lang-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .lang-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .lang-btn:hover:not(.active) {
            background: #f8f9fa;
        }

        /* 购物车相关样式 */
        .cart-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            opacity: 0;
        }

        .part-card:hover .cart-button {
            opacity: 1;
        }

        .cart-button:hover {
            background: #2980b9;
            transform: scale(1.1);
        }

        .cart-button.added {
            background: #27ae60;
        }

        /* 购物车侧边栏 */
        .cart-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .cart-sidebar.active {
            right: 0;
        }

        .cart-header {
            padding: 20px;
            background: #3498db;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .cart-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .cart-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .cart-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            gap: 15px;
        }

        .cart-item-image {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .cart-item-code {
            font-size: 12px;
            color: #7f8c8d;
            font-family: 'Courier New', monospace;
            margin-bottom: 3px;
        }

        .cart-item-original-code {
            font-size: 11px;
            color: #95a5a6;
            font-family: 'Courier New', monospace;
            margin-bottom: 5px;
        }

        .cart-item-sheet {
            font-size: 11px;
            color: #95a5a6;
            margin-bottom: 8px;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quantity-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity-btn:hover {
            background: #f8f9fa;
        }

        .quantity-input {
            width: 50px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .remove-item {
            color: #e74c3c;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .cart-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            background: #f8f9fa;
        }

        .cart-total {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .cart-actions {
            display: flex;
            gap: 10px;
        }

        .cart-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .cart-btn.primary {
            background: #3498db;
            color: white;
        }

        .cart-btn.primary:hover {
            background: #2980b9;
        }

        .cart-btn.secondary {
            background: #95a5a6;
            color: white;
        }

        .cart-btn.secondary:hover {
            background: #7f8c8d;
        }

        .cart-btn.danger {
            background: #e74c3c;
            color: white;
        }

        .cart-btn.danger:hover {
            background: #c0392b;
        }

        /* 购物车通知 */
        .cart-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* 数量选择模态框 */
        .quantity-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .quantity-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .quantity-modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .quantity-modal-title {
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .quantity-input-large {
            width: 100%;
            padding: 12px;
            border: 2px solid #3498db;
            border-radius: 4px;
            font-size: 16px;
            text-align: center;
            margin-bottom: 15px;
        }

        .brand-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 20px;
            background-color: white;
            cursor: pointer;
        }

        .brand-select:focus {
            outline: none;
            border-color: #3498db;
        }

        .quantity-modal-actions {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .modal-btn.primary {
            background: #3498db;
            color: white;
        }

        .modal-btn.secondary {
            background: #95a5a6;
            color: white;
        }

        /* 购物车徽章 */
        .cart-badge {
            position: relative;
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            font-size: 11px;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        /* 在配件详情页添加购物车按钮 */
        .detail-actions {
            display: flex;
            gap: 10px;
        }

        .detail-action-btn {
            padding: 10px 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-action-btn:hover {
            background: var(--primary-dark);
        }

        .detail-action-btn.secondary {
            background: #95a5a6;
            color: white;
        }

        .detail-action-btn.secondary:hover {
            background: #7f8c8d;
        }

        /* 在配件卡片中添加购物车按钮 */
        .part-card {
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .cart-sidebar {
                width: 100%;
                right: -100%;
            }
            
            .cart-button {
                opacity: 1;
            }
            
            .cart-actions {
                flex-direction: column;
            }
            
            .cart-btn {
                width: 100%;
            }
            
            .language-switcher {
                margin-left: 10px;
            }
            
            .lang-btn {
                padding: 4px 8px;
                font-size: 12px;
            }
        }
        
        /* 添加搜索结果分类标签样式 */
        .search-category-tag {
            display: inline-block;
            background: #f1c40f;
            color: #333;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }

        /* 机器类型选择器样式 */
        .machine-type-selector {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .machine-type-card {
            width: 300px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .machine-type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* 修改：图片区域铺满整个卡片顶部区域 */
        .machine-type-icon {
            padding: 0;
            text-align: center;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            height: 180px; /* 增加高度让图片有更大显示空间 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* 防止图片溢出 */
            position: relative;
        }

        /* 修改：让图片铺满整个图标区域 */
        .machine-type-image-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            padding: 0;
            overflow: hidden;
        }

        /* 修改：图片铺满整个区域 */
        .machine-type-image {
            width: 100%;
            height: 100%;
            object-fit: cover; /* 使用cover让图片铺满并裁剪 */
            object-position: center; /* 确保图片中心对齐 */
            transition: transform 0.3s ease; /* 添加过渡效果 */
        }

        /* 鼠标悬停时稍微放大图片 */
        .machine-type-card:hover .machine-type-image {
            transform: scale(1.05);
        }

        /* 在图片上方添加机器名称，使用半透明背景确保文字可读 */
        .machine-type-icon h3 {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
            color: white;
            margin: 0;
            padding: 15px;
            font-size: 22px;
            text-align: center;
            z-index: 2;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .machine-type-info {
            padding: 25px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .machine-type-name {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .machine-type-description {
            color: #7f8c8d;
            line-height: 1.5;
            margin-bottom: 20px;
            flex: 1;
        }

        .machine-type-stats {
            display: flex;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: auto;
        }

        .type-stat-item {
            text-align: center;
            flex: 1;
        }

        .type-stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #3498db;
        }

        .type-stat-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        /* 返回类型选择按钮 */
        .back-to-type-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 10px;
        }

        .back-to-type-btn:hover {
            background: #7f8c8d;
        }
        
        /* 新增：返回机型列表按钮 */
        .back-to-machines-btn {
            background: #7f8c8d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .back-to-machines-btn:hover {
            background: #6c7b7d;
        }
        
        /* 修改机器控制栏样式 - 将搜索框放在左侧并变大 */
        .machine-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .machine-info-section {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .machine-control-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 2;
        }
        
        /* 修改搜索框样式 - 放大并左对齐 */
        .search-box {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px 15px;
            flex: 1;
            max-width: 500px;
            transition: all 0.3s ease;
        }
        
        .search-box:focus-within {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .search-icon {
            color: #6c757d;
            margin-right: 12px;
            font-size: 18px;
        }
        
        .search-box input {
            border: none;
            background: transparent;
            font-size: 16px;
            width: 100%;
            outline: none;
            color: #495057;
        }
        
        .search-box input::placeholder {
            color: #adb5bd;
        }
        
        /* 新增：零件匹配状态样式 */
        .part-match-status {
            display: inline-block;
            padding: 2px 6px;
            font-size: 10px;
            border-radius: 3px;
            margin-left: 5px;
        }
        
        .part-matched {
            background-color: #d4edda;
            color: #155724;
        }
        
        .part-not-matched {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* 修改配件卡片样式 - 始终显示分类和规格 */
        .part-content {
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        .part-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .part-code {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .category-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        /* 修改规格描述为粗体 */
        .part-specs {
            font-size: 14px;
            color: #495057;
            line-height: 1.4;
            margin: 10px 0;
            flex: 1;
            font-weight: 600; /* 添加粗体样式 */
        }
        
        .part-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 12px;
            color: #6c757d;
        }
        
        .part-old-code {
            font-family: 'Courier New', monospace;
        }
        
        /* 在详情页中也将规格描述设置为粗体 */
        .specs-content {
            font-size: 15px;
            line-height: 1.6;
            font-weight: 600; /* 添加粗体样式 */
        }

        /* 修改：增大图片区域，占卡片2/3高度 */
        .part-image-section {
            height: 300px; /* 增大图片区域高度 */
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid #eee;
        }

        /* 懒加载图片相关样式 */
        .lazy-image {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .lazy-image.loading {
            background: #e3f2fd;
        }

        .lazy-image.loaded {
            background: transparent;
        }

        .image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #95a5a6;
        }

        .image-placeholder i {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .part-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: opacity 0.3s ease;
            background: #f8f9fa;
        }

        .image-loading {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #3498db;
        }

        .image-loading i {
            font-size: 32px;
            margin-bottom: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 详情页图片样式 */
        .detail-image-wrapper {
            width: 100%;
            height: 500px; /* 增大详情页图片区域 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .detail-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .zoom-hint {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            text-align: center;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .detail-image-wrapper:hover .zoom-hint {
            opacity: 1;
        }

        /* 机器类型图片懒加载 */
        .machine-type-image-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .lazy-machine-image {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .machine-type-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Service Worker 状态指示器 */
        .sw-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #27ae60;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .sw-status.active {
            opacity: 0.8;
        }
        
        .sw-status.offline {
            background: #e74c3c;
        }
    </style>
</head>
<body>
    <!-- Service Worker 状态指示器 -->
    <div class="sw-status" id="sw-status">
        <i class="fas fa-circle"></i>
        <span>在线</span>
    </div>

    <!-- 购物车侧边栏 -->
    <div class="cart-sidebar" id="cart-sidebar">
        <div class="cart-header">
            <h3 data-key="shopping_cart">购物车</h3>
            <button class="cart-close" id="cart-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="cart-content" id="cart-content">
            <!-- 购物车内容动态生成 -->
            <div class="empty-state">
                <i class="fas fa-shopping-cart"></i>
                <h3 data-key="cart_empty">购物车为空</h3>
                <p data-key="add_items_to_cart">请添加商品到购物车</p>
            </div>
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <span data-key="total">总计</span>: <span id="cart-total-items">0</span> <span data-key="items">件商品</span>
            </div>
            <div class="cart-actions">
                <button class="cart-btn danger" id="clear-cart">
                    <i class="fas fa-trash"></i> <span data-key="clear">清空</span>
                </button>
                <button class="cart-btn secondary" id="export-cart">
                    <i class="fas fa-file-excel"></i> <span data-key="export_excel">导出Excel</span>
                </button>
                <button class="cart-btn primary" id="close-cart">
                    <i class="fas fa-times"></i> <span data-key="close">关闭</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 数量选择模态框 -->
    <div class="quantity-modal" id="quantity-modal">
        <div class="quantity-modal-content">
            <div class="quantity-modal-title" id="quantity-modal-title" data-key="select_quantity_and_brand">选择数量和品牌</div>
            <input type="number" class="quantity-input-large" id="quantity-input" min="1" value="1" autofocus>
            <select class="brand-select" id="brand-select">
                <option value="无品牌" data-key="no_brand">无品牌</option>
                <option value="科龙" data-key="kelon">科龙</option>
                <option value="力雄" data-key="lixiong">力雄</option>
            </select>
            <div class="quantity-modal-actions">
                <button class="modal-btn secondary" id="cancel-quantity" data-key="cancel">取消</button>
                <button class="modal-btn primary" id="confirm-quantity" data-key="confirm">确认</button>
            </div>
        </div>
    </div>

    <!-- 加载指示器 -->
    <div class="loading-overlay" id="loading-overlay">
        <div style="text-align: center;">
            <div class="spinner"></div>
            <p data-key="loading_data">正在加载数据...</p>
        </div>
    </div>
    
    <div class="container">
        <!-- 顶部导航栏 -->
        <div class="top-nav">
            <div class="logo">
                <i class="fas fa-tractor logo-icon"></i>
                <div class="logo-text">
                    <h1 data-key="machine_parts_catalog">整机配件目录</h1>
                    <div class="subtitle" data-key="manage_parts_by_machine_model">按整机型号管理配件</div>
                </div>
            </div>
            <div class="nav-tabs">
                <!-- 语言切换器 -->
                <div class="language-switcher">
                    <button class="lang-btn active" data-lang="zh">中文</button>
                    <button class="lang-btn" data-lang="en">EN</button>
                </div>
                <a href="index.html" class="nav-tab">
                    <i class="fas fa-home"></i> <span data-key="back_to_home">返回首页</span>
                </a>
                <a href="basic-directory.html" class="nav-tab">
                    <i class="fas fa-book"></i> <span data-key="basic_catalog">基础目录</span>
                </a>
                <!-- 添加购物车按钮 -->
                <button class="nav-tab cart-badge" id="view-cart">
                    <i class="fas fa-shopping-cart"></i> <span data-key="shopping_cart">购物车</span>
                    <span class="cart-count" id="cart-count">0</span>
                </button>
            </div>
        </div>
        
        <!-- 主内容区域 -->
        <div class="main-area">
            <!-- 机器类型选择面板 -->
            <div class="machine-type-selector" id="machine-type-selector">
                <!-- 油锯类型卡片 -->
                <div class="machine-type-card" id="chainsaw-type-card">
                    <div class="machine-type-icon">
                        <!-- 懒加载机器类型图片 -->
                        <div class="machine-type-image-container lazy-machine-image" data-image="Info/chainsaw.png">
                            <div class="image-loading">
                                <i class="fas fa-spinner"></i>
                                <p data-key="loading_image">加载图片中...</p>
                            </div>
                        </div>
                        <h3 data-key="chainsaw">油锯</h3>
                    </div>
                    <div class="machine-type-info">
                        <div class="machine-type-description" data-key="chainsaw_description">
                            用于砍伐树木、修剪树枝的便携式锯类工具，主要用于林业、园艺和建筑行业。
                        </div>
                        <div class="machine-type-stats">
                            <div class="type-stat-item">
                                <div class="type-stat-value" id="chainsaw-count">0</div>
                                <div class="type-stat-label" data-key="machine_models">机型数量</div>
                            </div>
                            <div class="type-stat-item">
                                <div class="type-stat-value" id="chainsaw-parts">0</div>
                                <div class="type-stat-label" data-key="parts_count">配件总数</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 割灌机类型卡片 -->
                <div class="machine-type-card" id="brush-cutter-type-card">
                    <div class="machine-type-icon" style="background: linear-gradient(135deg, #27ae60 0%, #219653 100%);">
                        <!-- 懒加载机器类型图片 -->
                        <div class="machine-type-image-container lazy-machine-image" data-image="Info/brush_cutter.jpg">
                            <div class="image-loading">
                                <i class="fas fa-spinner"></i>
                                <p data-key="loading_image">加载图片中...</p>
                            </div>
                        </div>
                        <h3 data-key="brush_cutter">割灌机</h3>
                    </div>
                    <div class="machine-type-info">
                        <div class="machine-type-description" data-key="brush_cutter_description">
                            用于清理灌木、杂草、小树苗的便携式工具，主要用于园林绿化、农业和道路维护。
                        </div>
                        <div class="machine-type-stats">
                            <div class="type-stat-item">
                                <div class="type-stat-value" id="brush-cutter-count">0</div>
                                <div class="type-stat-label" data-key="machine_models">机型数量</div>
                            </div>
                            <div class="type-stat-item">
                                <div class="type-stat-value" id="brush-cutter-parts">0</div>
                                <div class="type-stat-label" data-key="parts_count">配件总数</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 整机选择面板 -->
            <div class="machine-selector" id="machine-selector" style="display: none;">
                <div class="selector-header">
                    <div class="selector-title" id="type-selector-title" data-key="select_machine_model">选择整机型号</div>
                    <div class="selector-stats">
                        <i class="fas fa-filter"></i> <span data-key="total">共</span> <span id="machine-count">0</span> <span data-key="models">个型号</span>
                    </div>
                    <button class="action-button" id="back-to-type-from-selector">
                        <i class="fas fa-arrow-left"></i> <span data-key="back_to_type">返回类型选择</span>
                    </button>
                </div>
                <div class="machine-grid" id="machine-grid">
                    <!-- 整机卡片将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <!-- 整机配件目录 -->
            <div class="machine-parts-container" id="machine-parts-container">
                <!-- 整机目录控制栏 - 修改了布局，搜索框在左侧 -->
                <div class="machine-controls" id="machine-controls">
                    <div class="machine-info-section">
                        <div class="current-machine">
                            <i class="fas fa-tractor"></i>
                            <div class="machine-info">
                                <h3 id="current-machine-name">未选择整机</h3>
                                <p id="current-machine-code">请先选择整机型号</p>
                                <p id="current-machine-type" style="font-size: 12px; color: #7f8c8d; margin-top: 3px;"></p>
                            </div>
                        </div>
                        <button class="action-button" id="back-to-machines">
                            <i class="fas fa-arrow-left"></i> <span>返回机型列表</span>
                        </button>
                    </div>
                    
                    <div class="machine-control-buttons">
                        <!-- 搜索框放在左侧并变大 -->
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="machine-search-input" data-key="search_parts_placeholder" placeholder="搜索配件编码、分类、规格型号...">
                        </div>
                        <button id="reset-filters" class="action-button">
                            <i class="fas fa-redo"></i> <span data-key="reset_filters">重置筛选</span>
                        </button>
                    </div>
                </div>
                
                <!-- 整机目录主内容区 -->
                <div class="machine-main-content">
                    <!-- 整机树形目录 -->
                    <div class="machine-tree-container" id="machine-tree-container">
                        <div class="machine-tree-header">
                            <div class="machine-tree-title" data-key="parts_category_catalog">配件分类目录</div>
                            <button class="toggle-machine-tree" id="toggle-machine-tree" title="折叠/展开目录">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                        </div>
                        <ul class="machine-tree" id="machine-parts-tree">
                            <!-- 树形结构将通过JavaScript动态生成 -->
                        </ul>
                    </div>
                    
                    <!-- 配件卡片展示区 -->
                    <div class="parts-grid-container" id="parts-grid-container">
                        <div class="parts-grid-header">
                            <div>
                                <div class="parts-grid-title" id="parts-grid-title" data-key="parts_list">配件列表</div>
                                <div class="parts-grid-subtitle" id="parts-grid-subtitle" data-key="select_category_to_view_parts">请选择左侧的分类查看配件</div>
                            </div>
                            <div class="parts-count">
                                <i class="fas fa-cube"></i> <span id="visible-parts-count">0</span> / <span id="total-parts-count">0</span>
                            </div>
                        </div>
                        <div class="parts-grid" id="parts-grid">
                            <div class="empty-state">
                                <i class="fas fa-th-large" style="color: var(--primary-color);"></i>
                                <h3 data-key="select_category_to_view_parts">选择分类查看配件</h3>
                                <p data-key="select_category_in_tree">请在左侧树形目录中选择配件类别</p>
                                <div style="margin-top: 20px; text-align: left; max-width: 500px;">
                                    <h4 style="margin-bottom: 10px; color: var(--primary-color);" data-key="instructions">使用说明：</h4>
                                    <ul style="padding-left: 20px; font-size: 14px;">
                                        <li style="margin-bottom: 5px;" data-key="instruction_1">在左侧选择配件分类</li>
                                        <li style="margin-bottom: 5px;" data-key="instruction_2">右侧将显示该分类下的配件卡片</li>
                                        <li style="margin-bottom: 5px;" data-key="instruction_3">点击配件卡片查看详细信息</li>
                                        <li style="margin-bottom: 5px;" data-key="instruction_4">点击购物车图标添加商品到采购清单</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 配件详情页 -->
            <div class="part-detail-container" id="part-detail-container">
                <div class="part-detail-header">
                    <div class="part-detail-title">
                        <h2 id="part-detail-title" data-key="part_details">配件详情</h2>
                        <div class="part-detail-subtitle" id="part-detail-subtitle">整机型号: 未选择</div>
                    </div>
                    <div class="detail-actions">
                        <!-- 添加购物车按钮到详情页 -->
                        <button class="detail-action-btn" id="add-to-cart-detail">
                            <i class="fas fa-cart-plus"></i> <span data-key="add_to_cart">添加到购物车</span>
                        </button>
                        <button class="detail-action-btn secondary" id="back-to-parts-list">
                            <i class="fas fa-arrow-left"></i> <span data-key="back_to_parts_list">返回配件列表</span>
                        </button>
                    </div>
                </div>
                
                <div class="part-detail-content" id="part-detail-content">
                    <!-- 配件详情内容将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 图片放大模态框 -->
        <div class="image-modal" id="image-modal">
            <div class="modal-content">
                <button class="modal-close" id="modal-close">
                    <i class="fas fa-times"></i>
                </button>
                <img id="modal-image" class="modal-image" src="" alt="">
                <div class="modal-zoom-controls">
                    <button class="zoom-btn" id="zoom-out">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button class="zoom-btn" id="zoom-reset">
                        <i class="fas fa-expand-alt"></i>
                    </button>
                    <button class="zoom-btn" id="zoom-in">
                        <i class="fas fa-search-plus"></i>
                    </button>
                </div>
                <button class="modal-download" id="download-image">
                    <i class="fas fa-download"></i> <span data-key="download_image">下载图片</span>
                </button>
            </div>
        </div>
        
        <footer>
            <p>© 2026 <span data-key="parts_catalog_management_system">配件目录管理系统</span> | <span data-key="machine_parts_catalog">整机配件目录</span>
            <p style="margin-top: 5px; font-size: 12px;" data-key="usage_hint">提示: 选择整机型号后，在左侧选择分类查看配件卡片，点击购物车图标添加到采购清单</p>
        </footer>
    </div>

    <!-- 添加ExcelJS库 -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    
    <script>
        // Service Worker 注册
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('Service Worker 注册成功:', registration.scope);
                        updateSWStatus('active');
                    })
                    .catch(function(error) {
                        console.log('Service Worker 注册失败:', error);
                        updateSWStatus('inactive');
                    });
            });
        }

        // 更新Service Worker状态显示
        function updateSWStatus(status) {
            const statusEl = document.getElementById('sw-status');
            if (!statusEl) return;
            
            switch(status) {
                case 'active':
                    statusEl.innerHTML = '<i class="fas fa-circle"></i><span>离线可用</span>';
                    statusEl.classList.add('active');
                    break;
                case 'inactive':
                    statusEl.innerHTML = '<i class="fas fa-circle"></i><span>离线不可用</span>';
                    statusEl.classList.add('active');
                    statusEl.classList.add('offline');
                    break;
                default:
                    statusEl.classList.remove('active');
            }
        }

        // 验证检查脚本
        (function() {
            try {
                // 尝试从本地存储读取认证状态
                const token = localStorage.getItem('uly_access_token');
                
                if (!token) {
                    // 未登录，跳转到验证页面
                    window.location.href = 'auth.html';
                    return;
                }
                
                // 验证token有效性
                const data = JSON.parse(atob(token));
                const now = Date.now();
                
                if (now >= data.expires) {
                    // token已过期，清除并重定向
                    localStorage.removeItem('uly_access_token');
                    window.location.href = 'auth.html';
                }
                
                // token有效，允许访问
            } catch (error) {
                // 解析失败，清除无效token并重定向
                localStorage.removeItem('uly_access_token');
                window.location.href = 'auth.html';
            }
        })();

        // 双语文本定义
        const translations = {
            zh: {
                // 通用
                "machine_parts_catalog": "整机配件目录",
                "manage_parts_by_machine_model": "按整机型号管理配件",
                "back_to_home": "返回首页",
                "basic_catalog": "基础目录",
                "shopping_cart": "购物车",
                "cart_empty": "购物车为空",
                "add_items_to_cart": "请添加商品到购物车",
                "total": "总计",
                "items": "件商品",
                "clear": "清空",
                "export_excel": "导出Excel",
                "close": "关闭",
                "select_quantity_and_brand": "选择数量和品牌",
                "cancel": "取消",
                "confirm": "确认",
                "loading_data": "正在加载数据...",
                "no_machine_selected": "未选择整机",
                "please_select_machine_model": "请先选择整机型号",
                "search_parts_placeholder": "搜索配件编码、分类、规格型号...",
                "reset_filters": "重置筛选",
                "parts_category_catalog": "配件分类目录",
                "parts_list": "配件列表",
                "select_category_to_view_parts": "请选择左侧的分类查看配件",
                "select_category_in_tree": "请在左侧树形目录中选择配件类别",
                "instructions": "使用说明：",
                "instruction_1": "在左侧选择配件分类",
                "instruction_2": "右侧将显示该分类下的配件卡片",
                "instruction_3": "点击配件卡片查看详细信息",
                "instruction_4": "点击购物车图标添加商品到采购清单",
                "part_details": "配件详情",
                "add_to_cart": "添加到购物车",
                "back_to_parts_list": "返回配件列表",
                "download_image": "下载图片",
                "parts_catalog_management_system": "配件目录管理系统",
                "usage_hint": "提示: 选择整机型号后，在左侧选择分类查看配件卡片，点击购物车图标添加到采购清单",
                "select_machine_model": "选择整机型号",
                "models": "个型号",
                
                // 机器类型相关
                "chainsaw": "油锯",
                "brush_cutter": "割灌机",
                "chainsaw_description": "用于砍伐树木、修剪树枝的便携式锯类工具，主要用于林业、园艺和建筑行业。",
                "brush_cutter_description": "用于清理灌木、杂草、小树苗的便携式工具，主要用于园林绿化、农业和道路维护。",
                "machine_models": "机型数量",
                "parts_count": "配件总数",
                "back_to_type": "返回类型选择",
                "current_machine_type": "机器类型",
                
                // 品牌
                "no_brand": "无品牌",
                "kelon": "科龙",
                "lixiong": "力雄",
                
                // 新增翻译
                "total_parts": "配件总数",
                "categories_count": "分类数",
                "no_categories_found": "未找到分类",
                "no_parts_found": "未找到配件",
                "no_parts_in_category": "该分类下暂无配件数据",
                "no_image": "无图片",
                "loading_image": "加载图片中...",
                "basic_info": "基本信息",
                "product_code": "商品编码",
                "original_code": "旧编码",
                "category": "类别",
                "machine_name": "整机名称",
                "brand": "品牌",
                "specifications": "规格型号",
                "previous_part": "上一个配件",
                "next_part": "下一个配件",
                "image_not_found": "图片未找到",
                "product_code_label": "商品编码",
                "click_to_zoom": "点击图片放大查看",
                "product_name": "商品名称",
                "part_name": "配件名称",
                
                // Excel导出列名
                "excel_serial_number": "序号",
                "excel_product_code": "商品编码",
                "excel_original_code": "原始编码",
                "excel_product_name": "商品名称",
                "excel_machine_model": "整机型号",
                "excel_category": "分类",
                "excel_specifications": "规格型号",
                "excel_brand": "品牌",
                "excel_quantity": "数量",
                "excel_total_price": "总价",
                "excel_summary_info": "汇总信息",
                "excel_product_types_count": "商品种类数",
                "excel_total_quantity": "商品总数量",
                "excel_total_amount": "商品总金额",
                "excel_export_date": "导出日期"
            },
            en: {
                // 通用
                "machine_parts_catalog": "Machine Parts Catalog",
                "manage_parts_by_machine_model": "Manage parts by machine model",
                "back_to_home": "Back to Home",
                "basic_catalog": "Basic Catalog",
                "shopping_cart": "Shopping Cart",
                "cart_empty": "Cart is Empty",
                "add_items_to_cart": "Please add items to cart",
                "total": "Total",
                "items": "items",
                "clear": "Clear",
                "export_excel": "Export Excel",
                "close": "Close",
                "select_quantity_and_brand": "Select Quantity and Brand",
                "cancel": "Cancel",
                "confirm": "Confirm",
                "loading_data": "Loading data...",
                "no_machine_selected": "No Machine Selected",
                "please_select_machine_model": "Please select a machine model first",
                "search_parts_placeholder": "Search part code, category, specs...",
                "reset_filters": "Reset Filters",
                "parts_category_catalog": "Parts Category Catalog",
                "parts_list": "Parts List",
                "select_category_to_view_parts": "Please select a category on the left to view parts",
                "select_category_in_tree": "Please select a part category in the left tree directory",
                "instructions": "Instructions:",
                "instruction_1": "Select part category on the left",
                "instruction_2": "Part cards will be displayed on the right",
                "instruction_3": "Click part card to view details",
                "instruction_4": "Click cart icon to add to shopping list",
                "part_details": "Part Details",
                "add_to_cart": "Add to Cart",
                "back_to_parts_list": "Back to Parts List",
                "download_image": "Download Image",
                "parts_catalog_management_system": "Parts Catalog Management System",
                "usage_hint": "Tip: After selecting a machine model, select a category on the left to view part cards, click cart icon to add to shopping list",
                "select_machine_model": "Select Machine Model",
                "models": "models",
                
                // 机器类型相关
                "chainsaw": "Chainsaw",
                "brush_cutter": "Brush Cutter",
                "chainsaw_description": "Portable saw tool for cutting trees and trimming branches, mainly used in forestry, gardening and construction.",
                "brush_cutter_description": "Portable tool for clearing bushes, weeds and small trees, mainly used in landscaping, agriculture and road maintenance.",
                "machine_models": "Machine Models",
                "parts_count": "Parts Count",
                "back_to_type": "Back to Type Selection",
                "current_machine_type": "Machine Type",
                
                // 品牌
                "no_brand": "No Brand",
                "kelon": "Kelon",
                "lixiong": "LiXiong",
                
                // 新增翻译
                "total_parts": "Total Parts",
                "categories_count": "Categories",
                "no_categories_found": "No Categories Found",
                "no_parts_found": "No Parts Found",
                "no_parts_in_category": "No parts in this category",
                "no_image": "No Image",
                "loading_image": "Loading Image...",
                "basic_info": "Basic Information",
                "product_code": "Product Code",
                "original_code": "Original Code",
                "category": "Category",
                "machine_name": "Machine Name",
                "brand": "Brand",
                "specifications": "Specifications",
                "previous_part": "Previous Part",
                "next_part": "Next Part",
                "image_not_found": "Image Not Found",
                "product_code_label": "Product Code",
                "click_to_zoom": "Click to zoom",
                "product_name": "Product Name",
                "part_name": "Part Name",
                
                // Excel导出列名
                "excel_serial_number": "Serial Number",
                "excel_product_code": "Product Code",
                "excel_original_code": "Original Code",
                "excel_product_name": "Product Name",
                "excel_machine_model": "Machine Model",
                "excel_category": "Category",
                "excel_specifications": "Specifications",
                "excel_brand": "Brand",
                "excel_quantity": "Quantity",
                "excel_unit_price": "Unit Price",
                "excel_total_price": "Total Price",
                "excel_summary_info": "Summary Information",
                "excel_product_types_count": "Product Types Count",
                "excel_total_quantity": "Total Quantity",
                "excel_total_amount": "Total Amount",
                "excel_export_date": "Export Date"
            }
        };

        // 标准化配件分类体系
        const standardizedPartsCatalog = {
            'chainsaw': [
                'CARBURETOR', 'CARBURETOR REPAIR KIT', 'CARBURETOR DIAPHRGAM', 'CARBURETOR NEEDLE',
                'AIR FILTER', 'CYLINDER KIT', 'CYLINDER', 'CYLINDER HEAD ASSY', 'PISTON SET',
                'PISTON RING', 'PISTION BEARING', 'VLAUE', 'RECOIL STARTER', 'CHAIN GUIDE',
                'STARTER SPRING', 'STARTER PAW', 'STARTER SPRING COVER', 'BRAKE BAND',
                'STARTER PULLEY', 'STARTER HANDLE', 'OIL PUMP', 'WORM',
                'OIL PUMP COVER', 'FUEL FILTER', 'FUEL SWITCH', 'OIL FILTER', 'FUEL PIPE',
                'OIL PIPE', 'MANIFOLD', 'BUFFER SET', 'CLUTCH', 'CLUTCH DRUM', 'CLUTCH TOOLS',
                'CLUTCH BEARING', 'SPROCKET RIM', 'CLUTCH WASHER', 'SPARK PLUG', 'FUEL TANK',
                'FUEL TANK ASSY', 'FUEL CAP', 'CRANKSHAFT', 'CRANKSHAFT ROD SET', 'OIL SEAL',
                'GASKET', 'CYLINDER GASKET', 'CRANKCASE GASKET', 'MUFFLER GASKET', 'MUFFLER',
                'MUFFLER SUPPORT', 'IGNITION COIL', 'IGNITION SWITCH CABLE', 'COIL CAP',
                'FLYWHEEL', 'FLYWHEEL PAWL SET', 'HANDLE', 
                'BUMPER SPIKE', 'THROTTLE TRIGGER', 'CHAIN SPROCKET COVER',
                'METAL PLATE', 'FOUNT GUARD', 'CHAIN CATCH', 'SNAP RING', 'CRANKCASE',
                'ADJUSTING SCREW NIT', 'BRAKE SPRING'
            ],
            'brush_cutter': [
                'CARBURETOR', 'CARBURETOR FUEL SWITCH', 'CARBURETOR PUMP', 'CARBURETOR ADJUST SCREW',
                'CARBURETOR REPAIR KIT', 'CARBURETOR DIAPHRGAM', 'CARBURETOR NEEDLE', 'AIR FILTER ASSEMBLY',
                'AIR FILTER COVER', 'AIR FILTER SMALL COVER', 'AIR FILTER SPONGE', 'AIR FILTER PLATE',
                'AIR FILTER SUPPORT', 'CYLINDER KIT', 'CYLINDER', 'PISTON SET', 'PISTON RING',
                'PISTION BEARING', 'PISTION PIN', 'RECOIL STARTER', 'STEEL STARTER PARTS',
                'STARTER PULLEY', 'STARTER SPRING', 'STARTER TOP SPRING', 'STARTER HANDLE WITH ROPE',
                'STARTER HANDLE', 'STARTER ROPE', 'STARTER PAW', 'STARTER PULLEY PLATE PAWL SET',
                'ROUND PULLEY PLATE', 'STARTER PLATE', 'GEAR CASE', 'GEAR CASE PARTS SET',
                'GEAR CASE PLATE SET', 'PROTECTOR COVER', 'THREAD NUT', 'GEAR CASE COVER',
                'GEAR CASE PLATE', 'GEAR SET', 'CONNETING PIPE', 'CONNETING PIPE RUBBER',
                'OIL BEARING', 'CONNETING CASE', 'CONNETING PLATE SET', 'FUEL PUMP',
                'FUEL FILTER PIPE ASSEMBLY', 'FUEL PIPE', 'FUEL FILTER', 'FUEL TANK',
                'FUEL CAP', 'FUEL TANK SUPPORT', 'FUELTANK RUBBER WASHER', 'FUEL TANK PALTE',
                'FUEL TANK GROMMENT', 'CLUTCH', 'CLUTCH SHOE', 'CLUTCH SPRING', 'CLUTCH SCREW SET',
                'CLUTCH WAVY WASHER', 'CLUTCH WASHER', 'CLUTCH SCREW', 'CLUTCH DRUM', 'SPARK PLUG',
                'MANIFOLD', 'TRIMMER HEAD', 'CRANKSHAFT', 'SEMI KEY', 'CRANKSHAFT ROD',
                'GASKET KIT', 'CRANKCASE  GASKET', 'CYLINDER GASKET', 'CARBURETOR GASKET',
                'MANIFOLD GASKET', 'MUFFER GASKET', 'MUFFLER', 'IGNITION COIL', 'FLYWHEEL',
                'IGNITION CAP', 'IGNITION CAP SPRING', 'IGNITION SWITCH CABLE', 'TROTHLE WIRE',
                'GRASS GUARD', 'GRASS GUARD PLATE WITH SCREW', 'GRASS GUARD PLATE',
                'GRASS GUARD SUPPORT', 'GRASS GUARD SUPPORT PLATE', 'GRASS GUARD BLADE SCREW',
                'GRASS GUARD SCREW NUT SET', 'GRASS GUARD BLADE', 'GRASS GUARD SIDE PARTS',
                'HANDLE SUPPORT', 'HANDLE SUPPORT WITH RUBBER', 'HANDLE SUPPORT RUBBER',
                'RIGHT SWITCH HANDLE', 'LEFT HANDLE', 'SWITCH HANDLE PARTS', 'SWTICH HANDLE BIG SPRING',
                'SWTICH HANDLE SMALL SPRING', 'SWTICH TRIGGER', 'HANGER', 'TRANSIT', 'SHAFT PIPE',
                'SHAFT PIPE WITH TRANSIT', 'SHAFT PIPE WITH ROTATED PIPE', 'RORATED PIPE',
                'SHAFT PIPE ASSY', 'SHAFT ASSY', 'BRUSH CUTTER PASS PLATE', 'BRUSH CUTTER GRASS HARVSTER',
                'MUFFER COVER', 'TOP COVER', 'CRANKCASE  COVER', 'CYLINDER COVER', 'CRANKCASE',
                'SIDE COVER', 'CONNETING CASE SCREW', 'PIN', 'PRIMER BULB', 'CICRLE',
                'STOP RING FOR CLUTCH CASE', 'SNAP RING', 'OIL SEAL', 'NEEDLE BEARING'
            ]
        };

        // 分类映射
        const categoryMapping = {
            'CARBURETOR': 'CARBURETOR',
            'FUEL HOSE': 'FUEL PIPE',
            'MANIFOLD': 'MANIFOLD',
            'BUFFER SET': 'BUFFER SET',
            'CYLINDER': 'CYLINDER',
            'PISTON ASSEMBLY': 'PISTON SET',
            'PISTON RING': 'PISTON RING',
            'SPIRAL SPRING': 'STARTER SPRING',
            'CLUTCH RETURN SPRING': 'CLUTCH SPRING',
            'ROPE PULLEY': 'STARTER PULLEY',
            'PULLEY DIAL': 'STARTER PULLEY',
            'STARTER PULLEY': 'STARTER PULLEY',
            'GEAR BOX': 'GEAR CASE',
            'CLUTCH HOUSING': 'CLUTCH',
            'HOLDER': 'HANDLE',
            'CLUTCH': 'CLUTCH',
            'CLUTCH DRUM': 'CLUTCH DRUM',
            'NEEDLE GAGE': 'NEEDLE BEARING',
            'FUEL TANK': 'FUEL TANK',
            'LEFT SCREW/GEAR BOX': 'GEAR CASE',
            'CRANKSHAFT': 'CRANKSHAFT',
            'OIL SEAL': 'OIL SEAL',
            'GASKET': 'GASKET',
            'MUFFLER': 'MUFFLER',
            'IGNITION COIL': 'IGNITION COIL',
            'FLYWHEEL': 'FLYWHEEL',
            'THROTTLE LINE': 'THROTTLE CABLE',
            'SHUT OFF': 'IGNITION SWITCH CABLE',
            'AIR FILTER ASSEMBLY': 'AIR FILTER',
            'FUEL FILTER': 'FUEL FILTER'
        };

        // 分类图标映射
        const categoryIcons = {
            'CARBURETOR': 'fas fa-gas-pump',
            '全部': 'fas fa-list'
        };

        const defaultIcon = 'fas fa-cube';

        // 全局状态
        const state = {
            machinesData: [],
            standardizedPartsCatalog: standardizedPartsCatalog,
            categoryMapping: categoryMapping,
            currentMachineType: null,
            currentMachine: null,
            treeData: {},
            partsByCategory: {},
            currentCategory: null,
            filteredParts: [],
            selectedPart: null,
            expandedCategories: new Set(),
            currentFilter: {
                search: '',
                category: ''
            },
            imageZoom: 1,
            imageCache: {},
            loadedImages: {},
            treeCollapsed: false,
            isSearchingAllCategories: false,
            searchResults: [],
            // 懒加载相关
            lazyImageObserver: null,
            currentVisibleImages: new Set(),
            // 智能图片缓存
            smartImageCache: {},
            // 购物车状态
            cart: {
                items: [],
                load() {
                    const saved = localStorage.getItem('machine_product_cart');
                    if (saved) {
                        this.items = JSON.parse(saved);
                    }
                    this.updateUI();
                },
                save() {
                    localStorage.setItem('machine_product_cart', JSON.stringify(this.items));
                    this.updateUI();
                },
                add(part, quantity = 1, brand = '无品牌') {
                    const existingItem = this.items.find(item => 
                        item.code === part.code && item.selectedBrand === brand
                    );
                    
                    if (existingItem) {
                        existingItem.quantity += quantity;
                    } else {
                        this.items.push({
                            code: part.code,
                            originalCode: part.oldCode || part.code,
                            name: part.name || part.category || '未命名商品',
                            machineName: state.currentMachine?.name || '',
                            machineType: state.currentMachineType || '',
                            category: part.category || '',
                            specs: part.specs || '',
                            quantity: quantity,
                            brand: part.brand || '',
                            selectedBrand: brand,
                            price: part.price || 0,
                            image: state.loadedImages[part.code] || null
                        });
                    }
                    this.save();
                    this.showNotification('商品已添加到购物车');
                },
                update(code, quantity) {
                    const item = this.items.find(item => item.code === code);
                    if (item) {
                        if (quantity <= 0) {
                            this.remove(code);
                        } else {
                            item.quantity = quantity;
                            this.save();
                        }
                    }
                },
                remove(code) {
                    this.items = this.items.filter(item => item.code !== code);
                    this.save();
                    this.showNotification('商品已从购物车移除');
                },
                clear() {
                    this.items = [];
                    this.save();
                    this.showNotification('购物车已清空');
                },
                getTotalItems() {
                    return this.items.reduce((total, item) => total + item.quantity, 0);
                },
                getTotalPrice() {
                    return this.items.reduce((total, item) => total + (item.price * item.quantity), 0);
                },
                updateUI() {
                    document.getElementById('cart-count').textContent = this.getTotalItems();
                    this.renderCart();
                    updateCartButtonStates();
                },
                renderCart() {
                    const cartContent = document.getElementById('cart-content');
                    
                    if (this.items.length === 0) {
                        cartContent.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-shopping-cart"></i>
                                <h3 data-key="cart_empty">购物车为空</h3>
                                <p data-key="add_items_to_cart">请添加商品到购物车</p>
                            </div>
                        `;
                        translatePage();
                        document.getElementById('cart-total-items').textContent = '0';
                        return;
                    }
                    
                    let cartHTML = '';
                    
                    this.items.forEach((item, index) => {
                        cartHTML += `
                            <div class="cart-item" data-code="${item.code}">
                                ${item.image ? `<img src="${item.image}" alt="${item.code}" class="cart-item-image">` : 
                                  `<div class="cart-item-image" style="display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
                                    <i class="fas fa-box" style="color: #95a5a6;"></i>
                                  </div>`}
                                <div class="cart-item-info">
                                    <div class="cart-item-name">${item.name}</div>
                                    <div class="cart-item-code">${item.code}</div>
                                    ${item.originalCode ? `<div class="cart-item-original-code">${item.originalCode}</div>` : ''}
                                    ${item.selectedBrand ? `<div class="cart-item-brand" style="font-size: 12px; color: #27ae60; margin-bottom: 5px;">品牌: ${item.selectedBrand}</div>` : ''}
                                    ${item.machineName ? `<div class="cart-item-sheet">整机: ${item.machineName}</div>` : ''}
                                    ${item.machineType ? `<div class="cart-item-sheet">类型: ${item.machineType}</div>` : ''}
                                    ${item.category ? `<div class="cart-item-sheet">分类: ${item.category}</div>` : ''}
                                    <div class="cart-item-controls">
                                        <div class="quantity-control">
                                            <button class="quantity-btn decrease-quantity" data-code="${item.code}">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <input type="number" class="quantity-input" value="${item.quantity}" min="1" data-code="${item.code}">
                                            <button class="quantity-btn increase-quantity" data-code="${item.code}">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                        <button class="remove-item" data-code="${item.code}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    cartContent.innerHTML = cartHTML;
                    document.getElementById('cart-total-items').textContent = this.getTotalItems();
                },
                showNotification(message) {
                    const existingNotification = document.querySelector('.cart-notification');
                    if (existingNotification) {
                        existingNotification.remove();
                    }
                    
                    const notification = document.createElement('div');
                    notification.className = 'cart-notification';
                    notification.innerHTML = `
                        <i class="fas fa-check-circle"></i> ${message}
                    `;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.style.opacity = '0';
                        notification.style.transform = 'translateX(100%)';
                        setTimeout(() => notification.remove(), 300);
                    }, 1000);
                },
                checkImageUrlExists(url) {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.onload = () => resolve(true);
                        img.onerror = () => resolve(false);
                        img.src = url;
                    });
                },
                
                async loadImageToBuffer(productCode) {
                    const url = `images/${productCode}.png`;
                    try {
                        const exists = await checkImageExists(url);
                        if (exists) {
                            const response = await fetch(url);
                            if (!response.ok) {
                                throw new Error(`HTTP错误! 状态: ${response.status}`);
                            }
                            
                            const blob = await response.blob();
                            return new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onloadend = function() {
                                    resolve(this.result);
                                };
                                reader.onerror = reject;
                                reader.readAsArrayBuffer(blob);
                            });
                        }
                    } catch (error) {
                        console.warn(`无法加载图片 ${url}:`, error);
                    }
                    return null;
                },
                
                getImageExtensionFromBuffer(buffer, productCode) {
                    const arr = new Uint8Array(buffer);
                    
                    if (arr.length > 3 && arr[0] === 0x89 && arr[1] === 0x50 && arr[2] === 0x4E && arr[3] === 0x47) {
                        return 'png';
                    }
                    
                    if (arr.length > 1 && arr[0] === 0xFF && arr[1] === 0xD8) {
                        return 'jpeg';
                    }
                    
                    const lowerCode = productCode.toLowerCase();
                    if (lowerCode.endsWith('.png')) return 'png';
                    if (lowerCode.endsWith('.jpg') || lowerCode.endsWith('.jpeg')) return 'jpeg';
                    
                    return 'png';
                },
                
                async exportToExcel() {
                    if (this.items.length === 0) {
                        alert(state.currentLanguage === 'zh' ? '购物车为空，无法导出' : 'Cart is empty, cannot export');
                        return;
                    }
                    
                    const exportBtn = document.getElementById('export-cart');
                    const originalText = exportBtn.innerHTML;
                    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + (state.currentLanguage === 'zh' ? '正在生成Excel...' : 'Generating Excel...');
                    exportBtn.disabled = true;
                    
                    try {
                        const workbook = new ExcelJS.Workbook();
                        workbook.creator = state.currentLanguage === 'zh' ? '配件选购系统' : 'Parts Selection System';
                        workbook.lastModifiedBy = state.currentLanguage === 'zh' ? '配件选购系统' : 'Parts Selection System';
                        workbook.created = new Date();
                        workbook.modified = new Date();
                        
                        const worksheet = workbook.addWorksheet(
                            state.currentLanguage === 'zh' ? '整机配件订购清单' : 'Machine Parts Order List'
                        );
                        
                        worksheet.columns = [
                            { header: translations[state.currentLanguage].excel_serial_number, key: 'serial', width: 8 },
                            { header: translations[state.currentLanguage].excel_product_code, key: 'image', width: 40 },
                            { header: translations[state.currentLanguage].excel_product_code, key: 'code', width: 20 },
                            { header: translations[state.currentLanguage].excel_original_code, key: 'originalCode', width: 20 },
                            { header: translations[state.currentLanguage].excel_product_name, key: 'name', width: 30 },
                            { header: translations[state.currentLanguage].excel_machine_model, key: 'machineModel', width: 20 },
                            { header: translations[state.currentLanguage].excel_category, key: 'category', width: 20 },
                            { header: translations[state.currentLanguage].excel_specifications, key: 'specs', width: 40 },
                            { header: translations[state.currentLanguage].excel_brand, key: 'brand', width: 15 },
                            { header: translations[state.currentLanguage].excel_quantity, key: 'quantity', width: 10 },
                        ];
                        
                        worksheet.getColumn(2).height = 120;
                        
                        const headerRow = worksheet.getRow(1);
                        headerRow.font = { bold: true, color: { argb: 'FFFFFF' } };
                        headerRow.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: '3498DB' }
                        };
                        headerRow.alignment = { vertical: 'middle', horizontal: 'center' };
                        headerRow.height = 25;
                        
                        headerRow.eachCell((cell) => {
                            cell.border = {
                                top: { style: 'thin', color: { argb: '000000' } },
                                left: { style: 'thin', color: { argb: '000000' } },
                                bottom: { style: 'thin', color: { argb: '000000' } },
                                right: { style: 'thin', color: { argb: '000000' } }
                            };
                        });
                        
                        for (let i = 0; i < this.items.length; i++) {
                            const item = this.items[i];
                            const rowNumber = i + 2;
                            
                            const row = worksheet.addRow({
                                serial: i + 1,
                                image: '',
                                code: item.code || '',
                                originalCode: item.originalCode || '',
                                name: item.name || '',
                                machineModel: item.machineName || '',
                                category: item.category || '',
                                specs: item.specs || '',
                                brand: item.selectedBrand || translations[state.currentLanguage].no_brand,
                                quantity: item.quantity || 0,
                            });
                            
                            row.height = 75;
                            
                            for (let col = 1; col <= 10; col++) {
                                const cell = row.getCell(col);
                                cell.border = {
                                    top: { style: 'thin', color: { argb: 'DDDDDD' } },
                                    left: { style: 'thin', color: { argb: 'DDDDDD' } },
                                    bottom: { style: 'thin', color: { argb: 'DDDDDD' } },
                                    right: { style: 'thin', color: { argb: 'DDDDDD' } }
                                };
                                
                                if (col === 1 || col === 9) {
                                    cell.alignment = { vertical: 'middle', horizontal: 'center' };
                                } else if (col === 2) {
                                    cell.alignment = { vertical: 'middle', horizontal: 'center' };
                                } else if (col === 10) {
                                    cell.alignment = { vertical: 'middle', horizontal: 'right' };
                                    cell.numFmt = '#,##0.00';
                                } else {
                                    cell.alignment = { vertical: 'middle', horizontal: 'left' };
                                }
                            }
                        }
                        
                        for (let i = 0; i < this.items.length; i++) {
                            const item = this.items[i];
                            const rowNumber = i + 2;
                            const row = worksheet.getRow(rowNumber);
                            
                            try {
                                const imageBuffer = await this.loadImageToBuffer(item.code);
                                if (imageBuffer) {
                                    const extension = this.getImageExtensionFromBuffer(imageBuffer, item.code);
                                    const imageId = workbook.addImage({
                                        buffer: imageBuffer,
                                        extension: extension
                                    });
                                    
                                    const colIndex = 1;
                                    const rowIndex = rowNumber - 1;
                                    
                                    worksheet.addImage(imageId, {
                                        tl: { 
                                            col: colIndex, 
                                            row: rowIndex,
                                            offset: 0
                                        },
                                        br: { 
                                            col: colIndex + 1,
                                            row: rowIndex + 1,
                                            offset: 0
                                        },
                                        editAs: 'oneCell'
                                    });
                                    
                                    worksheet.getColumn(colIndex + 1).width = 14;
                                    
                                } else {
                                    row.getCell(2).value = translations[state.currentLanguage].no_image;
                                    row.getCell(2).alignment = { vertical: 'middle', horizontal: 'center' };
                                }
                            } catch (error) {
                                console.warn(`无法加载图片: ${item.code}`, error);
                                row.getCell(2).value = translations[state.currentLanguage].image_not_found;
                                row.getCell(2).alignment = { vertical: 'middle', horizontal: 'center' };
                            }
                        }
                        
                        worksheet.columns.forEach((column, index) => {
                            if (index !== 1) {
                                let maxLength = 0;
                                column.eachCell({ includeEmpty: true }, (cell) => {
                                    const columnLength = cell.value ? cell.value.toString().length : 10;
                                    if (columnLength > maxLength) {
                                        maxLength = columnLength;
                                    }
                                });
                                column.width = Math.min(maxLength + 2, 50);
                            }
                        });
                        
                        const summaryStartRow = this.items.length + 3;
                        const separatorRow = worksheet.getRow(this.items.length + 2);
                        separatorRow.height = 5;
                        
                        const summaryTitleCell = worksheet.getCell(`A${summaryStartRow}`);
                        summaryTitleCell.value = translations[state.currentLanguage].excel_summary_info;
                        summaryTitleCell.font = { bold: true, color: { argb: '3498DB' }, size: 12 };
                        summaryTitleCell.border = {
                            top: { style: 'thin', color: { argb: '3498DB' } },
                            left: { style: 'thin', color: { argb: '3498DB' } },
                            bottom: { style: 'thin', color: { argb: '3498DB' } },
                            right: { style: 'thin', color: { argb: '3498DB' } }
                        };
                        
                        worksheet.getCell(`A${summaryStartRow + 1}`).value = translations[state.currentLanguage].excel_product_types_count;
                        worksheet.getCell(`B${summaryStartRow + 1}`).value = this.items.length;
                        
                        worksheet.getCell(`A${summaryStartRow + 2}`).value = translations[state.currentLanguage].excel_total_quantity;
                        worksheet.getCell(`B${summaryStartRow + 2}`).value = this.getTotalItems();
                        
                        worksheet.getCell(`A${summaryStartRow + 3}`).value = translations[state.currentLanguage].excel_total_amount;
                        worksheet.getCell(`B${summaryStartRow + 3}`).value = this.getTotalPrice().toFixed(2);
                        worksheet.getCell(`B${summaryStartRow + 3}`).numFmt = '#,##0.00';
                        
                        const currentDate = new Date();
                        const dateFormatter = state.currentLanguage === 'zh' ? 
                            currentDate.toLocaleDateString('zh-CN') : 
                            currentDate.toLocaleDateString('en-US');
                        
                        worksheet.getCell(`A${summaryStartRow + 4}`).value = translations[state.currentLanguage].excel_export_date;
                        worksheet.getCell(`B${summaryStartRow + 4}`).value = dateFormatter;
                        
                        for (let i = summaryStartRow; i <= summaryStartRow + 4; i++) {
                            const row = worksheet.getRow(i);
                            row.height = 20;
                            
                            const cellA = row.getCell(1);
                            cellA.font = { bold: true };
                            cellA.border = {
                                top: { style: 'thin', color: { argb: 'DDDDDD' } },
                                left: { style: 'thin', color: { argb: 'DDDDDD' } },
                                bottom: { style: 'thin', color: { argb: 'DDDDDD' } },
                                right: { style: 'thin', color: { argb: 'DDDDDD' } }
                            };
                            
                            for (let col = 2; col <= 10; col++) {
                                const cell = row.getCell(col);
                                cell.border = {
                                    top: { style: 'thin', color: { argb: 'DDDDDD' } },
                                    left: { style: 'thin', color: { argb: 'DDDDDD' } },
                                    bottom: { style: 'thin', color: { argb: 'DDDDDD' } },
                                    right: { style: 'thin', color: { argb: 'DDDDDD' } }
                                };
                            }
                        }
                        
                        const fileName = state.currentLanguage === 'zh' ? 
                            `整机配件订购清单_${new Date().toISOString().slice(0,10)}.xlsx` :
                            `Machine_Parts_Order_List_${new Date().toISOString().slice(0,10)}.xlsx`;
                        
                        const buffer = await workbook.xlsx.writeBuffer();
                        const blob = new Blob([buffer], { 
                            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                        });
                        
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = fileName;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        setTimeout(() => {
                            window.URL.revokeObjectURL(url);
                        }, 100);
                        
                        this.showNotification(state.currentLanguage === 'zh' ? '订购清单已导出为Excel文件' : 'Order list has been exported to Excel');
                        
                    } catch (error) {
                        console.error('导出Excel失败:', error);
                        alert((state.currentLanguage === 'zh' ? '导出失败: ' : 'Export failed: ') + error.message);
                    } finally {
                        exportBtn.innerHTML = originalText;
                        exportBtn.disabled = false;
                    }
                }
            },
            selectedProductForCart: null,
            currentLanguage: 'zh'
        };

        // 初始化页面
        document.addEventListener('DOMContentLoaded', async function() {
            showLoading();
            
            state.cart.load();
            
            try {
                await loadMachinesData();
                initializeMachineTypeSelector();
                setupEventListeners();
                initializeLazyLoading();
                loadMachineTypeImages();
                hideLoading();
                
                setupLanguageSwitcher();
            } catch (error) {
                console.error('加载数据失败:', error);
                hideLoading();
                alert('加载数据失败，请检查数据格式');
            }
        });

        // 设置语言切换器
        function setupLanguageSwitcher() {
            const langBtns = document.querySelectorAll('.lang-btn');
            
            langBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const lang = this.dataset.lang;
                    if (state.currentLanguage !== lang) {
                        langBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        state.currentLanguage = lang;
                        
                        translatePage();
                        
                        updateCurrentMachineDisplay();
                        
                        if (state.currentMachine) {
                            renderTree();
                            applyFilters();
                        }
                    }
                });
            });
        }

        // 翻译页面
        function translatePage() {
            const lang = state.currentLanguage;
            const translation = translations[lang];
            
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.getAttribute('data-key');
                if (translation[key]) {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        element.placeholder = translation[key];
                    } else {
                        element.textContent = translation[key];
                    }
                }
            });
            
            const brandSelect = document.getElementById('brand-select');
            if (brandSelect) {
                Array.from(brandSelect.options).forEach(option => {
                    const key = option.getAttribute('data-key');
                    if (key && translation[key]) {
                        option.textContent = translation[key];
                    }
                });
            }
            
            document.querySelectorAll('.machine-card .stat-label').forEach(element => {
                const key = element.getAttribute('data-key');
                if (key && translation[key]) {
                    element.textContent = translation[key];
                }
            });
            
            if (state.machinesData.length > 0) {
                updateMachineTypeStats();
            }
        }

        function showLoading() {
            document.getElementById('loading-overlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
        }

        // 加载机器类型图片
        async function loadMachineTypeImages() {
            const machineTypeImages = document.querySelectorAll('.lazy-machine-image');
            
            machineTypeImages.forEach(async (container) => {
                const imageUrl = container.dataset.image;
                if (!imageUrl) return;
                
                try {
                    const exists = await checkImageExists(imageUrl);
                    if (exists) {
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.className = 'machine-type-image';
                        img.alt = container.closest('.machine-type-card').querySelector('h3').textContent;
                        
                        // 替换加载指示器
                        container.innerHTML = '';
                        container.appendChild(img);
                    } else {
                        container.innerHTML = `
                            <div class="image-placeholder">
                                <i class="fas fa-image"></i>
                                <p data-key="no_image">无图片</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.warn('加载机器类型图片失败:', error);
                    container.innerHTML = `
                        <div class="image-placeholder">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p data-key="image_not_found">图片加载失败</p>
                        </div>
                    `;
                }
            });
        }

        // 初始化懒加载
        function initializeLazyLoading() {
            if ('IntersectionObserver' in window) {
                state.lazyImageObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const imageContainer = entry.target;
                            const productCode = imageContainer.dataset.code;
                            
                            if (productCode) {
                                loadLazyImage(imageContainer, productCode);
                            }
                        }
                    });
                }, {
                    rootMargin: '100px 0px', // 增加预加载距离
                    threshold: 0.1
                });
            }
        }

        // 加载懒加载图片 - 优化版
        async function loadLazyImage(imageContainer, productCode) {
            // 如果已经在加载中或已加载完成，跳过
            if (imageContainer.classList.contains('loading') || imageContainer.classList.contains('loaded')) {
                return;
            }
            
            // 如果图片已经在缓存中
            if (state.loadedImages[productCode]) {
                showLazyImage(imageContainer, state.loadedImages[productCode], productCode);
                return;
            }
            
            // 标记为加载中
            imageContainer.classList.add('loading');
            
            // 智能检查图片是否存在（使用优化的方法）
            const imageUrl = await checkImageWithServiceWorker(productCode);
            
            if (imageUrl) {
                state.loadedImages[productCode] = imageUrl;
                showLazyImage(imageContainer, imageUrl, productCode);
            } else {
                showNoImage(imageContainer, productCode);
            }
        }

        // 智能图片检查（使用Service Worker优化）
        async function checkImageWithServiceWorker(code) {
            // 如果已经在缓存中，直接返回
            if (state.smartImageCache[code]) {
                return state.smartImageCache[code];
            }
            
            const url = `images/${code}.png`;
            
            try {
                // 使用fetch，Service Worker会处理缓存
                const response = await fetch(url, {
                    headers: {
                        'X-Image-Code': code,
                        'Cache-Strategy': 'cache-first'
                    }
                });
                
                if (response.ok) {
                    // 获取图片URL
                    const blob = await response.blob();
                    const objectUrl = URL.createObjectURL(blob);
                    
                    // 缓存结果
                    state.smartImageCache[code] = objectUrl;
                    return objectUrl;
                }
            } catch (error) {
                console.warn(`图片 ${code} 加载失败:`, error);
                // 缓存失败状态
                state.smartImageCache[code] = false;
            }
            
            return false;
        }

        // 显示懒加载图片
        function showLazyImage(imageContainer, imageUrl, productCode) {
            // 如果已经显示过了，跳过
            if (imageContainer.classList.contains('loaded')) {
                return;
            }
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = productCode;
            img.className = 'part-image';
            img.loading = 'lazy';
            
            img.onload = () => {
                imageContainer.classList.remove('loading');
                imageContainer.classList.add('loaded');
                imageContainer.innerHTML = '';
                imageContainer.appendChild(img);
            };
            
            img.onerror = () => {
                showNoImage(imageContainer, productCode);
            };
        }

        // 显示无图片
        function showNoImage(imageContainer, productCode) {
            imageContainer.classList.remove('loading');
            imageContainer.innerHTML = `
                <div class="image-placeholder">
                    <i class="fas fa-image"></i>
                    <p data-key="no_image">无图片</p>
                    <p style="font-size: 11px; margin-top: 5px; color: #95a5a6;">${productCode}</p>
                </div>
            `;
            translatePage();
        }

        // 检查图片是否存在 - 基础版
        function checkImageExists(url) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = url;
            });
        }

        // 加载整机数据
        async function loadMachinesData() {
            try {
                // 加载整机型号列表
                const machinesResponse = await fetch('data/machines.json');
                if (!machinesResponse.ok) {
                    throw new Error('无法加载整机列表数据');
                }
                const machinesList = await machinesResponse.json();
                
                // 加载所有整机的配件数据
                const machinesData = [];
                
                for (const machine of machinesList) {
                    const partsFilename = `${machine.id}-parts.json`;
                    const partsResponse = await fetch(`data/parts/${partsFilename}`);
                    
                    if (partsResponse.ok) {
                        const partsData = await partsResponse.json();
                        
                        // 标准化配件分类
                        const standardizedParts = mapPartsToStandardized(partsData, machine.type);
                        
                        machinesData.push({
                            id: machine.id,
                            name: machine.name,
                            type: machine.type,
                            description: machine.description || '',
                            icon: machine.icon || (machine.type === 'chainsaw' ? 'fas fa-tree' : 'fas fa-leaf'),
                            parts: standardizedParts
                        });
                    } else {
                        console.warn(`无法加载配件数据: ${partsFilename}`);
                        machinesData.push({
                            id: machine.id,
                            name: machine.name,
                            type: machine.type,
                            description: machine.description || '',
                            icon: machine.icon || (machine.type === 'chainsaw' ? 'fas fa-tree' : 'fas fa-leaf'),
                            parts: []
                        });
                    }
                }
                
                state.machinesData = machinesData;
            } catch (error) {
                console.error('加载数据失败:', error);
                // 使用模拟数据作为备用
                state.machinesData = getMockMachinesData();
            }
        }

        // 标准化配件分类
        function mapPartsToStandardized(parts, machineType) {
            return parts.map(part => {
                const originalCategory = part.category;
                let standardizedCategory = originalCategory;
                
                if (state.categoryMapping[originalCategory]) {
                    standardizedCategory = state.categoryMapping[originalCategory];
                }
                
                const standardCategories = state.standardizedPartsCatalog[machineType];
                if (!standardCategories.includes(standardizedCategory)) {
                    const found = standardCategories.find(cat => 
                        cat.includes(originalCategory) || originalCategory.includes(cat)
                    );
                    if (found) {
                        standardizedCategory = found;
                    } else {
                        standardizedCategory = originalCategory;
                    }
                }
                
                return {
                    ...part,
                    originalCategory: originalCategory,
                    category: standardizedCategory,
                    isStandardized: standardCategories.includes(standardizedCategory)
                };
            });
        }

        // 模拟数据
        function getMockMachinesData() {
            const mockPartsData = [
                {
                    id: 'CG430',
                    name: 'CG430',
                    type: 'brush_cutter',
                    description: '割灌机系列 - 经典型号',
                    icon: 'fas fa-leaf',
                    parts: mapPartsToStandardized([
                        { name: "CG430化油器", category: "CARBURETOR", code: "010890", oldCode: "UKBC0102", brand: "", specs: "CG430专用化油器" },
                        { name: "燃油软管", category: "FUEL HOSE", code: "020097", oldCode: "UKFL0202S", brand: "", specs: "耐油橡胶软管" },
                        { name: "进气歧管", category: "MANIFOLD", code: "020117", oldCode: "UKBC0201M", brand: "", specs: "铝合金材质" },
                        { name: "缓冲套件", category: "BUFFER SET", code: "020192", oldCode: "UKBC0201BS", brand: "", specs: "28mm规格" },
                        { name: "缓冲套件", category: "BUFFER SET", code: "020193", oldCode: "UKBC0201BS-1", brand: "", specs: "26mm规格" },
                        { name: "汽缸", category: "CYLINDER", code: "030017", oldCode: "UKBC0305A", brand: "", specs: "40MM直径" },
                        { name: "汽缸", category: "CYLINDER", code: "030018", oldCode: "UKBC0305B", brand: "", specs: "40MM双气道汽缸" },
                        { name: "活塞组件", category: "PISTON ASSEMBLY", code: "030225", oldCode: "UKBC0304P", brand: "", specs: "KC13010AA 40MM" },
                        { name: "活塞环", category: "PISTON RING", code: "030430", oldCode: "UKBC0301R", brand: "", specs: "40MMX1.5MMX2" },
                        { name: "螺旋弹簧", category: "SPIRAL SPRING", code: "040290", oldCode: "UKBC0401S", brand: "", specs: "细型样式" },
                        { name: "螺旋弹簧", category: "SPIRAL SPRING", code: "040291", oldCode: "UKBC0402S", brand: "", specs: "粗型样式" },
                        { name: "离合器回位弹簧", category: "CLUTCH RETURN SPRING", code: "040292", oldCode: "UKBC0403S", brand: "", specs: "" },
                        { name: "拉绳滑轮", category: "ROPE PULLEY", code: "040341", oldCode: "UKBC0401P", brand: "", specs: "" },
                        { name: "滑轮刻度盘", category: "PULLEY DIAL", code: "040342", oldCode: "UKBC0402P", brand: "", specs: "" },
                        { name: "启动滑轮", category: "STARTER PULLEY", code: "040343", oldCode: "UKBC0403P", brand: "", specs: "轻松启动型" },
                    ], 'brush_cutter')
                }
            ];
            
            return mockPartsData;
        }

        // 初始化机器类型选择器
        function initializeMachineTypeSelector() {
            updateMachineTypeStats();
            
            document.getElementById('chainsaw-type-card').addEventListener('click', () => {
                selectMachineType('chainsaw');
            });
            
            document.getElementById('brush-cutter-type-card').addEventListener('click', () => {
                selectMachineType('brush_cutter');
            });
        }

        // 更新机器类型统计信息
        function updateMachineTypeStats() {
            const chainsawMachines = state.machinesData.filter(m => m.type === 'chainsaw');
            const chainsawPartsCount = chainsawMachines.reduce((total, machine) => total + machine.parts.length, 0);
            
            const brushCutterMachines = state.machinesData.filter(m => m.type === 'brush_cutter');
            const brushCutterPartsCount = brushCutterMachines.reduce((total, machine) => total + machine.parts.length, 0);
            
            document.getElementById('chainsaw-count').textContent = chainsawMachines.length;
            document.getElementById('chainsaw-parts').textContent = chainsawPartsCount;
            
            document.getElementById('brush-cutter-count').textContent = brushCutterMachines.length;
            document.getElementById('brush-cutter-parts').textContent = brushCutterPartsCount;
        }

        // 选择机器类型
        function selectMachineType(type) {
            state.currentMachineType = type;
            state.currentMachine = null;
            state.selectedPart = null;
            
            const typeName = state.currentLanguage === 'zh' ? 
                (type === 'chainsaw' ? '油锯' : '割灌机') :
                (type === 'chainsaw' ? 'Chainsaw' : 'Brush Cutter');
            
            document.getElementById('type-selector-title').textContent = `${typeName} - ${translations[state.currentLanguage].select_machine_model}`;
            
            document.getElementById('machine-type-selector').style.display = 'none';
            document.getElementById('machine-selector').style.display = 'block';
            document.getElementById('machine-parts-container').classList.remove('active');
            document.getElementById('part-detail-container').classList.remove('active');
            
            initializeMachineSelectorByType(type);
        }

        // 根据类型初始化整机选择器
        function initializeMachineSelectorByType(type) {
            const machineGrid = document.getElementById('machine-grid');
            machineGrid.innerHTML = '';
            
            const filteredMachines = state.machinesData.filter(machine => machine.type === type);
            
            filteredMachines.forEach(machine => {
                const categories = [...new Set(machine.parts.map(part => part.category))];
                const totalParts = machine.parts.length;
                
                const standardCategories = state.standardizedPartsCatalog[type] || [];
                
                const machineCard = document.createElement('div');
                machineCard.className = 'machine-card fade-in';
                machineCard.dataset.machineId = machine.id;
                
                machineCard.innerHTML = `
                    <div class="machine-icon-section">
                        <i class="${machine.icon} machine-icon"></i>
                    </div>
                    <div class="machine-content">
                        <div class="machine-name">${machine.name}</div>
                        <div class="machine-description">${machine.description}</div>
                        <div class="machine-stats">
                            <div class="stat-item">
                                <div class="stat-value">${totalParts}</div>
                                <div class="stat-label" data-key="total_parts">配件总数</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${categories.length}/${standardCategories.length}</div>
                                <div class="stat-label" data-key="categories_count">分类数</div>
                            </div>
                        </div>
                    </div>
                `;
                
                machineCard.addEventListener('click', () => {
                    selectMachine(machine);
                });
                
                machineGrid.appendChild(machineCard);
            });
            
            document.getElementById('machine-count').textContent = filteredMachines.length;
            
            translatePage();
            
            if (filteredMachines.length === 0) {
                machineGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-circle" style="font-size: 48px; color: #7f8c8d; margin-bottom: 20px;"></i>
                        <h3>暂无${state.currentLanguage === 'zh' ? (type === 'chainsaw' ? '油锯' : '割灌机') : (type === 'chainsaw' ? 'Chainsaw' : 'Brush Cutter')}机型</h3>
                        <p>该类型下暂无整机数据</p>
                        <button class="action-button" id="back-to-type-btn" style="margin-top: 20px;">
                            <i class="fas fa-arrow-left"></i> ${state.currentLanguage === 'zh' ? '返回类型选择' : 'Back to Type Selection'}
                        </button>
                    </div>
                `;
                
                document.getElementById('back-to-type-btn').addEventListener('click', backToTypeSelector);
            }
        }

        // 选择整机
        function selectMachine(machine) {
            state.currentMachine = machine;
            state.currentCategory = '全部';
            state.filteredParts = [];
            state.selectedPart = null;
            state.expandedCategories.clear();
            state.currentFilter.search = '';
            state.isSearchingAllCategories = false;
            
            initializeTreeData();
            updateCurrentMachineDisplay();
            showMachineContent();
            renderTree();
            
            // 直接渲染全部配件
            state.filteredParts = [...state.currentMachine.parts];
            state.expandedCategories.add('全部');
            
            renderFilteredParts(state.filteredParts, 
                `${state.currentMachine.name} - ${state.currentLanguage === 'zh' ? '全部配件' : 'All Parts'}`,
                state.currentLanguage === 'zh' ? 
                    `共 ${state.filteredParts.length} 个配件` :
                    `Total ${state.filteredParts.length} parts`
            );
            
            document.getElementById('machine-search-input').value = '';
            
            // 开始观察懒加载图片
            if (state.lazyImageObserver) {
                // 先停止观察所有图片
                state.lazyImageObserver.disconnect();
                // 重新观察新图片
                setTimeout(() => {
                    document.querySelectorAll('.lazy-image').forEach(img => {
                        state.lazyImageObserver.observe(img);
                    });
                }, 100);
            }
        }

        // 初始化树形数据
        function initializeTreeData() {
            state.treeData = {};
            state.partsByCategory = {};
            
            if (!state.currentMachine) return;
            
            const standardCategories = state.standardizedPartsCatalog[state.currentMachine.type] || [];
            
            standardCategories.forEach(category => {
                state.treeData[category] = [];
                state.partsByCategory[category] = [];
            });
            
            state.currentMachine.parts.forEach(part => {
                const category = part.category;
                
                if (state.treeData[category]) {
                    state.treeData[category].push(part);
                    state.partsByCategory[category].push(part);
                } else {
                    if (!state.treeData[category]) {
                        state.treeData[category] = [];
                        state.partsByCategory[category] = [];
                    }
                    state.treeData[category].push(part);
                    state.partsByCategory[category].push(part);
                }
            });
            
            state.expandedCategories.add('全部');
            
            const categoriesWithParts = Object.keys(state.treeData).filter(category => 
                state.partsByCategory[category] && state.partsByCategory[category].length > 0
            ).sort();
            
            for (let i = 0; i < Math.min(2, categoriesWithParts.length); i++) {
                state.expandedCategories.add(categoriesWithParts[i]);
            }
        }

        // 更新当前整机显示
        function updateCurrentMachineDisplay() {
            if (!state.currentMachine) {
                const currentMachineName = document.getElementById('current-machine-name');
                const currentMachineCode = document.getElementById('current-machine-code');
                const currentMachineType = document.getElementById('current-machine-type');
                
                currentMachineName.textContent = translations[state.currentLanguage].no_machine_selected;
                currentMachineCode.textContent = translations[state.currentLanguage].please_select_machine_model;
                currentMachineType.textContent = '';
                return;
            }
            
            const currentMachineName = document.getElementById('current-machine-name');
            const currentMachineCode = document.getElementById('current-machine-code');
            const currentMachineType = document.getElementById('current-machine-type');
            const partDetailSubtitle = document.getElementById('part-detail-subtitle');
            
            const typeName = state.currentLanguage === 'zh' ? 
                (state.currentMachine.type === 'chainsaw' ? '油锯' : '割灌机') :
                (state.currentMachine.type === 'chainsaw' ? 'Chainsaw' : 'Brush Cutter');
            
            currentMachineName.textContent = state.currentMachine.name;
            currentMachineCode.textContent = state.currentMachine.description;
            currentMachineType.textContent = `${translations[state.currentLanguage].current_machine_type}: ${typeName}`;
            
            document.getElementById('parts-grid-title').textContent = `${state.currentMachine.name} ${state.currentLanguage === 'zh' ? '配件目录' : 'Parts Catalog'}`;
            partDetailSubtitle.textContent = `${state.currentLanguage === 'zh' ? '整机型号' : 'Machine Model'}: ${state.currentMachine.name} (${typeName})`;
        }

        // 显示整机内容
        function showMachineContent() {
            document.getElementById('machine-selector').style.display = 'none';
            document.getElementById('machine-parts-container').classList.add('active');
            document.getElementById('part-detail-container').classList.remove('active');
        }

        // 返回类型选择器
        function backToTypeSelector() {
            state.currentMachineType = null;
            state.currentMachine = null;
            state.selectedPart = null;
            
            document.getElementById('machine-type-selector').style.display = 'flex';
            document.getElementById('machine-selector').style.display = 'none';
            document.getElementById('machine-parts-container').classList.remove('active');
            document.getElementById('part-detail-container').classList.remove('active');
            
            updateCurrentMachineDisplay();
        }

        // 返回选择器
        function backToSelector() {
            if (state.currentMachineType) {
                document.getElementById('machine-selector').style.display = 'block';
                document.getElementById('machine-parts-container').classList.remove('active');
                document.getElementById('part-detail-container').classList.remove('active');
                
                initializeMachineSelectorByType(state.currentMachineType);
                
                state.currentMachine = null;
                state.selectedPart = null;
                
                updateCurrentMachineDisplay();
            } else {
                backToTypeSelector();
            }
        }

        // 渲染树形目录
        function renderTree() {
            const treeContainer = document.getElementById('machine-parts-tree');
            treeContainer.innerHTML = '';
            
            if (!state.currentMachine || !state.currentMachineType) return;
            
            const standardCategories = state.standardizedPartsCatalog[state.currentMachine.type] || [];
            
            // 添加"全部"分类到最前面
            const allCategoryNode = createTreeNode('全部', state.currentMachine.parts.length, 
                state.expandedCategories.has('全部'), state.currentCategory === '全部', true);
            treeContainer.appendChild(allCategoryNode);
            
            // 将分类分为两组：有配件的和没配件的
            const categoriesWithParts = [];
            const categoriesWithoutParts = [];
            
            standardCategories.forEach(category => {
                const categoryParts = state.partsByCategory[category] || [];
                const hasParts = categoryParts.length > 0;
                
                if (hasParts) {
                    categoriesWithParts.push(category);
                } else {
                    categoriesWithoutParts.push(category);
                }
            });
            
            // 有配件的分类按照配件数量降序排列
            categoriesWithParts.sort((a, b) => {
                const countA = state.partsByCategory[a]?.length || 0;
                const countB = state.partsByCategory[b]?.length || 0;
                return countB - countA;
            });
            
            // 无配件的分类按字母顺序排列
            categoriesWithoutParts.sort();
            
            // 先显示有配件的分类
            categoriesWithParts.forEach(category => {
                const categoryParts = state.partsByCategory[category] || [];
                const hasParts = categoryParts.length > 0;
                const isExpanded = state.expandedCategories.has(category);
                const isActive = state.currentCategory === category;
                
                const treeNode = createTreeNode(category, categoryParts.length, isExpanded, isActive, hasParts);
                treeContainer.appendChild(treeNode);
            });
            
            // 显示无配件的分类
            categoriesWithoutParts.forEach(category => {
                const categoryParts = state.partsByCategory[category] || [];
                const hasParts = false;
                const isExpanded = state.expandedCategories.has(category);
                const isActive = state.currentCategory === category;
                
                const treeNode = createTreeNode(category, 0, isExpanded, isActive, hasParts);
                treeContainer.appendChild(treeNode);
            });
            
            if (standardCategories.length === 0 && !state.currentMachine.parts.length) {
                const emptyNode = document.createElement('li');
                emptyNode.className = 'machine-tree-node';
                emptyNode.innerHTML = `
                    <div class="machine-tree-item-header" style="justify-content: center; color: var(--text-light);">
                        <i class="fas fa-search" style="margin-right: 8px;"></i>
                        <span data-key="no_categories_found">未找到分类</span>
                    </div>
                `;
                treeContainer.appendChild(emptyNode);
                translatePage();
            }
        }

        // 创建树节点
        function createTreeNode(category, count, isExpanded, isActive, hasParts) {
            const li = document.createElement('li');
            li.className = 'machine-tree-node';
            
            if (category === '全部') {
                li.classList.add('all-category');
            }
            
            const header = document.createElement('div');
            header.className = 'machine-tree-item-header';
            if (isActive) header.classList.add('active');
            
            if (!hasParts && category !== '全部') {
                header.classList.add('no-parts');
            }
            
            const toggle = document.createElement('div');
            toggle.className = 'machine-tree-toggle';
            if (!isExpanded) toggle.classList.add('collapsed');
            toggle.innerHTML = '<i class="fas fa-chevron-down"></i>';
            
            const icon = document.createElement('div');
            icon.className = 'machine-tree-icon';
            if (category === '全部') {
                icon.innerHTML = '<i class="fas fa-list"></i>';
            } else {
                icon.innerHTML = `<i class="${categoryIcons[category] || defaultIcon}"></i>`;
            }
            
            const label = document.createElement('div');
            label.className = 'machine-tree-label';
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = category;
            label.appendChild(nameSpan);
            
            const countSpan = document.createElement('div');
            countSpan.className = 'machine-tree-count';
            countSpan.textContent = count;
            
            header.appendChild(toggle);
            header.appendChild(icon);
            header.appendChild(label);
            header.appendChild(countSpan);
            
            header.addEventListener('click', function(e) {
                e.stopPropagation();
                selectCategory(category);
            });
            
            li.appendChild(header);
            
            return li;
        }

        // 选择分类
        function selectCategory(category) {
            if (category === '全部') {
                state.currentCategory = '全部';
                state.selectedPart = null;
                state.isSearchingAllCategories = false;
                
                state.filteredParts = [...state.currentMachine.parts];
                
                renderTree();
                
                renderFilteredParts(state.filteredParts, 
                    `${state.currentMachine.name} - ${state.currentLanguage === 'zh' ? '全部配件' : 'All Parts'}`,
                    state.currentLanguage === 'zh' ? 
                        `共 ${state.filteredParts.length} 个配件` :
                        `Total ${state.filteredParts.length} parts`
                );
                return;
            }
            
            state.currentCategory = category;
            state.selectedPart = null;
            state.isSearchingAllCategories = false;
            
            if (state.expandedCategories.has(category)) {
                state.expandedCategories.delete(category);
            } else {
                state.expandedCategories.add(category);
            }
            
            renderTree();
            
            applyFilters();
        }

        // 显示空配件网格
        function showEmptyPartsGrid() {
            const partsGrid = document.getElementById('parts-grid');
            partsGrid.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <i class="fas fa-th-large" style="color: var(--primary-color);"></i>
                    <h3 data-key="select_category_to_view_parts">选择分类查看配件</h3>
                    <p data-key="select_category_in_tree">请在左侧树形目录中选择配件类别</p>
                    <div style="margin-top: 20px; text-align: left; max-width: 500px;">
                        <h4 style="margin-bottom: 10px; color: var(--primary-color);" data-key="instructions">使用说明：</h4>
                        <ul style="padding-left: 20px; font-size: 14px;">
                            <li style="margin-bottom: 5px;" data-key="instruction_1">在左侧选择配件分类</li>
                            <li style="margin-bottom: 5px;" data-key="instruction_2">右侧将显示该分类下的配件卡片</li>
                            <li style="margin-bottom: 5px;" data-key="instruction_3">点击配件卡片查看详细信息</li>
                            <li style="margin-bottom: 5px;" data-key="instruction_4">点击购物车图标添加商品到采购清单</li>
                        </ul>
                    </div>
                </div>
            `;
            
            document.getElementById('visible-parts-count').textContent = '0';
            document.getElementById('total-parts-count').textContent = state.currentMachine ? state.currentMachine.parts.length : '0';
            
            const title = state.currentMachine ? 
                `${state.currentMachine.name} ${state.currentLanguage === 'zh' ? '配件目录' : 'Parts Catalog'}` : 
                (state.currentLanguage === 'zh' ? '配件目录' : 'Parts Catalog');
            
            document.getElementById('parts-grid-title').textContent = title;
            document.getElementById('parts-grid-subtitle').textContent = state.currentLanguage === 'zh' ? '请选择左侧的分类查看配件' : 'Please select a category on the left to view parts';
            
            translatePage();
        }

        // 应用筛选
        function applyFilters() {
            if (!state.currentMachine) return;
            
            if (state.currentCategory === '全部') {
                const searchTerm = state.currentFilter.search.toLowerCase().trim();
                const hasSearch = searchTerm !== '';
                
                let filtered = [];
                let titleText = '';
                let subtitleText = '';
                
                if (hasSearch) {
                    filtered = state.currentMachine.parts.filter(item => 
                        (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                        (item.category && item.category.toLowerCase().includes(searchTerm)) ||
                        (item.code && item.code.toLowerCase().includes(searchTerm)) ||
                        (item.oldCode && item.oldCode.toLowerCase().includes(searchTerm)) ||
                        (item.specs && item.specs.toLowerCase().includes(searchTerm))
                    );
                    titleText = `${state.currentMachine.name} - ${state.currentLanguage === 'zh' ? '全部配件搜索结果' : 'All Parts Search Results'}`;
                    subtitleText = state.currentLanguage === 'zh' ? 
                        `搜索 "${state.currentFilter.search}" 找到 ${filtered.length} 个配件` :
                        `Search "${state.currentFilter.search}" found ${filtered.length} parts`;
                    state.isSearchingAllCategories = true;
                    state.searchResults = filtered;
                } else {
                    filtered = [...state.currentMachine.parts];
                    titleText = `${state.currentMachine.name} - ${state.currentLanguage === 'zh' ? '全部配件' : 'All Parts'}`;
                    subtitleText = state.currentLanguage === 'zh' ? 
                        `共 ${filtered.length} 个配件` :
                        `Total ${filtered.length} parts`;
                    state.isSearchingAllCategories = false;
                }
                
                state.filteredParts = filtered;
                renderFilteredParts(filtered, titleText, subtitleText);
                return;
            }
            
            let filtered = [];
            let titleText = '';
            let subtitleText = '';
            
            const searchTerm = state.currentFilter.search.toLowerCase().trim();
            const hasSearch = searchTerm !== '';
            
            if (hasSearch) {
                if (state.currentCategory) {
                    const categoryParts = state.partsByCategory[state.currentCategory] || [];
                    filtered = categoryParts.filter(item => 
                        (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                        (item.category && item.category.toLowerCase().includes(searchTerm)) ||
                        (item.code && item.code.toLowerCase().includes(searchTerm)) ||
                        (item.oldCode && item.oldCode.toLowerCase().includes(searchTerm)) ||
                        (item.specs && item.specs.toLowerCase().includes(searchTerm))
                    );
                    titleText = `${state.currentMachine.name} - ${state.currentCategory}`;
                    subtitleText = state.currentLanguage === 'zh' ? 
                        `搜索 "${state.currentFilter.search}" 找到 ${filtered.length} 个配件` :
                        `Search "${state.currentFilter.search}" found ${filtered.length} parts`;
                    state.isSearchingAllCategories = false;
                } else {
                    filtered = state.currentMachine.parts.filter(item => 
                        (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                        (item.category && item.category.toLowerCase().includes(searchTerm)) ||
                        (item.code && item.code.toLowerCase().includes(searchTerm)) ||
                        (item.oldCode && item.oldCode.toLowerCase().includes(searchTerm)) ||
                        (item.specs && item.specs.toLowerCase().includes(searchTerm))
                    );
                    titleText = `${state.currentMachine.name} - ${state.currentLanguage === 'zh' ? '搜索结果' : 'Search Results'}`;
                    subtitleText = state.currentLanguage === 'zh' ? 
                        `搜索 "${state.currentFilter.search}" 找到 ${filtered.length} 个配件` :
                        `Search "${state.currentFilter.search}" found ${filtered.length} parts`;
                    state.isSearchingAllCategories = true;
                    state.searchResults = filtered;
                }
            } else {
                if (state.currentCategory) {
                    filtered = [...state.partsByCategory[state.currentCategory] || []];
                    titleText = `${state.currentMachine.name} - ${state.currentCategory}`;
                    
                    if (filtered.length === 0) {
                        subtitleText = state.currentLanguage === 'zh' ? 
                            `该分类暂无配件` :
                            `No parts in this category`;
                    } else {
                        subtitleText = state.currentLanguage === 'zh' ? 
                            `共 ${filtered.length} 个配件` :
                            `Total ${filtered.length} parts`;
                    }
                    state.isSearchingAllCategories = false;
                } else {
                    state.isSearchingAllCategories = false;
                    showEmptyPartsGrid();
                    return;
                }
            }
            
            state.filteredParts = filtered;
            
            renderFilteredParts(filtered, titleText, subtitleText);
            
            if (state.selectedPart && !filtered.some(item => item.code === state.selectedPart.code)) {
                state.selectedPart = null;
                if (document.getElementById('part-detail-container').classList.contains('active')) {
                    backToPartsList();
                }
            }
        }

        // 渲染过滤后配件
        function renderFilteredParts(parts, titleText, subtitleText) {
            const partsGrid = document.getElementById('parts-grid');
            partsGrid.innerHTML = '';
            
            if (parts.length === 0 && state.currentCategory) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'empty-state';
                emptyMessage.style.gridColumn = '1 / -1';
                
                if (state.currentFilter.search.trim() !== '') {
                    emptyMessage.innerHTML = `
                        <i class="fas fa-search"></i>
                        <h3 data-key="no_parts_found">未找到配件</h3>
                        <p>${state.currentLanguage === 'zh' ? '未找到与' : 'No parts found for'} "${state.currentFilter.search}" ${state.currentLanguage === 'zh' ? '相关的配件' : ''}</p>
                    `;
                } else {
                    emptyMessage.innerHTML = `
                        <i class="fas fa-box-open"></i>
                        <h3>${state.currentLanguage === 'zh' ? '该分类暂无配件' : 'No parts in this category'}</h3>
                        <p>${state.currentLanguage === 'zh' ? '该分类下暂无配件数据' : 'No parts data in this category'}</p>
                    `;
                }
                
                partsGrid.appendChild(emptyMessage);
                translatePage();
                return;
            } else if (parts.length === 0) {
                showEmptyPartsGrid();
                return;
            }
            
            parts.forEach(part => {
                const partCard = createPartCard(part);
                partsGrid.appendChild(partCard);
            });
            
            document.getElementById('parts-grid-title').textContent = titleText;
            document.getElementById('parts-grid-subtitle').textContent = subtitleText;
            document.getElementById('visible-parts-count').textContent = parts.length;
            document.getElementById('total-parts-count').textContent = state.currentMachine.parts.length;
            
            updateCartButtonStates();
            
            // 开始观察新添加的懒加载图片
            if (state.lazyImageObserver) {
                setTimeout(() => {
                    document.querySelectorAll('.lazy-image').forEach(img => {
                        // 如果图片已经在缓存中，直接显示
                        const productCode = img.dataset.code;
                        if (state.loadedImages[productCode]) {
                            showLazyImage(img, state.loadedImages[productCode], productCode);
                        } else {
                            state.lazyImageObserver.observe(img);
                        }
                    });
                }, 50);
            }
        }

        // 创建配件卡片
        function createPartCard(part) {
            const isSelected = state.selectedPart && state.selectedPart.code === part.code;
            const inCart = state.cart.items.find(item => item.code === part.code);
            
            const card = document.createElement('div');
            card.className = `part-card fade-in ${isSelected ? 'active' : ''}`;
            card.dataset.code = part.code;
            card.dataset.category = part.category;
            
            const productCode = part.code;
            
            // 使用懒加载图片容器
            const imageHtml = `
                <div class="lazy-image" data-code="${productCode}">
                    <div class="image-loading">
                        <i class="fas fa-spinner"></i>
                        <p data-key="loading_image">加载图片中...</p>
                    </div>
                </div>
            `;
            
            const categoryTag = state.isSearchingAllCategories ? `<span class="search-category-tag">${part.category}</span>` : '';
            
            const standardizedStatus = part.isStandardized !== false ? 
                `<span class="part-match-status part-matched" title="${state.currentLanguage === 'zh' ? '标准化分类' : 'Standardized category'}">STD</span>` : 
                `<span class="part-match-status part-not-matched" title="${state.currentLanguage === 'zh' ? '非标准化分类' : 'Non-standardized category'}">NON</span>`;
            
            card.innerHTML = `
                <button class="cart-button ${inCart ? 'added' : ''}" title="${inCart ? (state.currentLanguage === 'zh' ? '已在购物车中' : 'Already in cart') : (state.currentLanguage === 'zh' ? '添加到购物车' : 'Add to cart')}" data-code="${part.code}">
                    <i class="fas ${inCart ? 'fa-check' : 'fa-cart-plus'}"></i>
                </button>
                <div class="part-image-section">
                    ${imageHtml}
                </div>
                <div class="part-content">
                    <div class="part-header">
                        <div class="part-code">${part.code} ${standardizedStatus}</div>
                        <div class="category-badge">${part.category}</div>
                        ${categoryTag}
                    </div>
                    <div class="part-specs">
                        ${part.specs ? `${part.category} - ${part.specs}` : part.category}
                    </div>
                    <div class="part-footer">
                        <div class="part-old-code">${part.oldCode ? `${state.currentLanguage === 'zh' ? '旧编码' : 'Old Code'}: ${part.oldCode}` : ''}</div>
                        <div class="part-brand">${part.brand || ''}</div>
                    </div>
                </div>
            `;
            
            card.addEventListener('click', function(e) {
                if (!e.target.closest('.cart-button')) {
                    selectPart(part);
                    closeCart();
                }
            });
            
            const cartBtn = card.querySelector('.cart-button');
            if (cartBtn) {
                cartBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    addToCart(part);
                });
            }
            
            return card;
        }

        // 更新购物车按钮状态
        function updateCartButtonStates() {
            document.querySelectorAll('.part-card').forEach(card => {
                const productCode = card.dataset.code;
                const cartBtn = card.querySelector('.cart-button');
                const inCart = state.cart.items.find(item => item.code === productCode);
                
                if (cartBtn) {
                    if (inCart) {
                        cartBtn.classList.add('added');
                        cartBtn.innerHTML = '<i class="fas fa-check"></i>';
                        cartBtn.title = state.currentLanguage === 'zh' ? '已在购物车中' : 'Already in cart';
                    } else {
                        cartBtn.classList.remove('added');
                        cartBtn.innerHTML = '<i class="fas fa-cart-plus"></i>';
                        cartBtn.title = state.currentLanguage === 'zh' ? '添加到购物车' : 'Add to cart';
                    }
                }
            });
        }

        // 选择配件
        function selectPart(part) {
            state.selectedPart = part;
            applyFilters();
            showPartDetail(part);
        }

        // 显示配件详情
        function showPartDetail(part) {
            document.getElementById('machine-parts-container').classList.remove('active');
            document.getElementById('part-detail-container').classList.add('active');
            
            renderPartDetailContent(part);
        }

        // 渲染配件详情内容
        async function renderPartDetailContent(part) {
            const displayTitle = part.name && part.name.trim() !== '' ? 
                `${part.name} - ${part.code}` : 
                `${part.category} - ${part.code}`;
            
            document.getElementById('part-detail-title').textContent = displayTitle;
            
            const machineType = state.currentLanguage === 'zh' ? 
                (state.currentMachine.type === 'chainsaw' ? '油锯' : '割灌机') :
                (state.currentMachine.type === 'chainsaw' ? 'Chainsaw' : 'Brush Cutter');
                
            const machineModelText = state.currentLanguage === 'zh' ? '整机型号' : 'Machine Model';
            const machineTypeText = state.currentLanguage === 'zh' ? '机器类型' : 'Machine Type';
            document.getElementById('part-detail-subtitle').textContent = `${machineModelText}: ${state.currentMachine.name} (${machineTypeText}: ${machineType})`;
            
            const detailContent = document.getElementById('part-detail-content');
            
            const isStandardized = part.isStandardized !== false;
            const standardizedInfo = isStandardized ? 
                `<span class="part-matched" style="padding: 2px 6px; border-radius: 3px; font-size: 12px;">${state.currentLanguage === 'zh' ? '标准化分类' : 'Standardized Category'}</span>` :
                `<span class="part-not-matched" style="padding: 2px 6px; border-radius: 3px; font-size: 12px;">${state.currentLanguage === 'zh' ? '非标准化分类' : 'Non-standardized Category'}</span>`;
            
            const displayName = part.name && part.name.trim() !== '' ? part.name : (state.currentLanguage === 'zh' ? '未命名商品' : 'Unnamed product');
            
            detailContent.innerHTML = `
                <div class="detail-image-section" id="detail-image-section">
                    <div class="image-loading">
                        <i class="fas fa-spinner"></i>
                        <p data-key="loading_image">加载图片中...</p>
                    </div>
                </div>
                <div class="detail-info-section">
                    <div class="info-card">
                        <h3 data-key="basic_info">基本信息</h3>
                        <table class="info-table">
                            <tr>
                                <td class="info-label" data-key="product_name">商品名称</td>
                                <td class="info-value"><strong>${displayName}</strong></td>
                            </tr>
                            <tr>
                                <td class="info-label" data-key="product_code">商品编码</td>
                                <td class="info-value"><span class="code-highlight">${part.code}</span></td>
                            </tr>
                            <tr>
                                <td class="info-label" data-key="original_code">旧编码</td>
                                <td class="info-value">${part.oldCode ? `<span class="code-highlight">${part.oldCode}</span>` : '<span style="color: #999;">无</span>'}</td>
                            </tr>
                            <tr>
                                <td class="info-label" data-key="category">类别</td>
                                <td class="info-value">
                                    <span class="category-badge">${part.category}</span>
                                    ${standardizedInfo}
                                </td>
                            </tr>
                            ${part.originalCategory && part.originalCategory !== part.category ? `
                                <tr>
                                    <td class="info-label">原始分类</td>
                                    <td class="info-value" style="color: #666;">${part.originalCategory}</td>
                                </tr>
                            ` : ''}
                            <tr>
                                <td class="info-label" data-key="machine_name">整机名称</td>
                                <td class="info-value">${state.currentMachine.name}</td>
                            </tr>
                            <tr>
                                <td class="info-label" data-key="brand">品牌</td>
                                <td class="info-value">${part.brand || '<span style="color: #999;">无</span>'}</td>
                            </tr>
                        </table>
                    </div>
                    
                    ${part.specs ? `
                        <div class="info-card">
                            <h3 data-key="specifications">规格型号</h3>
                            <div class="specs-content">${part.specs}</div>
                        </div>
                    ` : ''}
                    
                    <div class="part-navigation">
                        <button class="nav-btn" id="prev-part-btn">
                            <i class="fas fa-chevron-left"></i> <span data-key="previous_part">上一个配件</span>
                        </button>
                        <button class="nav-btn" id="next-part-btn">
                            <span data-key="next_part">下一个配件</span> <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // 使用Service Worker优化加载配件详情图片
            await loadPartDetailImage(part.code);
            
            document.getElementById('prev-part-btn').addEventListener('click', showPreviousPart);
            document.getElementById('next-part-btn').addEventListener('click', showNextPart);
            
            updateNavigationButtons();
            
            translatePage();
        }

        // 加载配件详情图片 - 优化版
        async function loadPartDetailImage(productCode) {
            const imageSection = document.getElementById('detail-image-section');
            
            // 如果图片已经在缓存中
            if (state.loadedImages[productCode]) {
                displayPartDetailImage(imageSection, productCode, state.loadedImages[productCode]);
                return;
            }
            
            // 智能检查图片
            const imageUrl = await checkImageWithServiceWorker(productCode);
            if (imageUrl) {
                state.loadedImages[productCode] = imageUrl;
                displayPartDetailImage(imageSection, productCode, imageUrl);
            } else {
                imageSection.innerHTML = `
                    <div class="image-placeholder" style="width: 100%; height: 100%;">
                        <i class="fas fa-image"></i>
                        <p data-key="image_not_found">图片未找到</p>
                        <p style="font-size: 12px; margin-top: 8px;" data-key="product_code_label">商品编码: ${productCode}</p>
                    </div>
                `;
                translatePage();
            }
        }

        // 显示配件详情图片
        function displayPartDetailImage(imageSection, productCode, imageUrl) {
            imageSection.innerHTML = `
                <div class="detail-image-wrapper" id="detail-image-wrapper" data-image-url="${imageUrl}">
                    <img src="${imageUrl}" alt="${productCode}" class="detail-image" id="detail-image">
                    <div class="zoom-hint" data-key="click_to_zoom">点击图片放大查看</div>
                </div>
            `;
            
            const imageWrapper = document.getElementById('detail-image-wrapper');
            imageWrapper.addEventListener('click', function() {
                openImageModal(productCode, imageUrl);
            });
            
            translatePage();
        }

        // 显示上一个配件
        function showPreviousPart() {
            if (!state.currentMachine || !state.selectedPart) return;
            
            const currentIndex = state.filteredParts.findIndex(p => p.code === state.selectedPart.code);
            if (currentIndex > 0) {
                const prevPart = state.filteredParts[currentIndex - 1];
                selectPart(prevPart);
            }
        }

        // 显示下一个配件
        function showNextPart() {
            if (!state.currentMachine || !state.selectedPart) return;
            
            const currentIndex = state.filteredParts.findIndex(p => p.code === state.selectedPart.code);
            if (currentIndex < state.filteredParts.length - 1) {
                const nextPart = state.filteredParts[currentIndex + 1];
                selectPart(nextPart);
            }
        }

        // 更新导航按钮状态
        function updateNavigationButtons() {
            if (!state.currentMachine || !state.selectedPart) return;
            
            const currentIndex = state.filteredParts.findIndex(p => p.code === state.selectedPart.code);
            const prevBtn = document.getElementById('prev-part-btn');
            const nextBtn = document.getElementById('next-part-btn');
            
            prevBtn.disabled = currentIndex === 0;
            nextBtn.disabled = currentIndex === state.filteredParts.length - 1;
        }

        // 返回配件列表
        function backToPartsList() {
            document.getElementById('machine-parts-container').classList.add('active');
            document.getElementById('part-detail-container').classList.remove('active');
        }

        // 重置筛选
        function resetFilters() {
            document.getElementById('machine-search-input').value = '';
            state.currentFilter.search = '';
            state.currentCategory = '全部';
            state.isSearchingAllCategories = false;
            
            applyFilters();
            
            renderTree();
        }

        // 图片模态框功能
        function openImageModal(partCode, imageUrl) {
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            const downloadBtn = document.getElementById('download-image');
            
            state.imageZoom = 1;
            modalImage.style.transform = `scale(${state.imageZoom})`;
            
            modalImage.src = imageUrl;
            modalImage.alt = partCode;
            
            const fileName = partCode + '.png';
            downloadBtn.onclick = function() {
                downloadImage(imageUrl, fileName);
            };
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            translatePage();
        }

        function closeImageModal() {
            const modal = document.getElementById('image-modal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function zoomImage(delta) {
            const modalImage = document.getElementById('modal-image');
            state.imageZoom += delta;
            state.imageZoom = Math.max(0.5, Math.min(3, state.imageZoom));
            modalImage.style.transform = `scale(${state.imageZoom})`;
            modalImage.style.transition = 'transform 0.3s ease';
        }

        function resetImageZoom() {
            const modalImage = document.getElementById('modal-image');
            state.imageZoom = 1;
            modalImage.style.transform = `scale(${state.imageZoom})`;
            modalImage.style.transition = 'transform 0.3s ease';
        }

        function downloadImage(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // 切换整机树形目录
        function toggleMachineTree() {
            const treeContainer = document.getElementById('machine-tree-container');
            const toggleBtn = document.getElementById('toggle-machine-tree');
            
            state.treeCollapsed = !state.treeCollapsed;
            
            if (state.treeCollapsed) {
                treeContainer.style.width = '40px';
                treeContainer.style.minWidth = '40px';
                treeContainer.style.maxWidth = '40px';
                toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                toggleBtn.title = state.currentLanguage === 'zh' ? '展开目录' : 'Expand directory';
                
                document.querySelector('.machine-tree-header .machine-tree-title').style.display = 'none';
                document.getElementById('machine-parts-tree').style.display = 'none';
            } else {
                treeContainer.style.width = '';
                treeContainer.style.minWidth = '';
                treeContainer.style.maxWidth = '';
                toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                toggleBtn.title = state.currentLanguage === 'zh' ? '折叠目录' : 'Collapse directory';
                
                document.querySelector('.machine-tree-header .machine-tree-title').style.display = 'block';
                document.getElementById('machine-parts-tree').style.display = 'block';
            }
        }

        // 购物车相关功能
        function addToCart(part) {
            state.selectedProductForCart = part;
            
            const modal = document.getElementById('quantity-modal');
            const title = document.getElementById('quantity-modal-title');
            const quantityInput = document.getElementById('quantity-input');
            const brandSelect = document.getElementById('brand-select');
            
            const displayName = part.name && part.name.trim() !== '' ? part.name : part.category;
            title.textContent = state.currentLanguage === 'zh' ? 
                `添加 "${displayName}" 到购物车` : 
                `Add "${displayName}" to cart`;
            quantityInput.value = 1;
            brandSelect.value = '无品牌';
            quantityInput.focus();
            quantityInput.select();
            
            modal.classList.add('active');
            
            translatePage();
        }

        function confirmAddToCart() {
            const quantityInput = document.getElementById('quantity-input');
            const brandSelect = document.getElementById('brand-select');
            const quantity = parseInt(quantityInput.value);
            const brand = brandSelect.value;
            
            if (isNaN(quantity) || quantity < 1) {
                alert(state.currentLanguage === 'zh' ? '请输入有效的数量' : 'Please enter a valid quantity');
                return;
            }
            
            if (state.selectedProductForCart) {
                state.cart.add(state.selectedProductForCart, quantity, brand);
                closeQuantityModal();
            }
        }

        function closeQuantityModal() {
            const modal = document.getElementById('quantity-modal');
            modal.classList.remove('active');
            state.selectedProductForCart = null;
        }

        function openCart() {
            document.getElementById('cart-sidebar').classList.add('active');
        }

        function closeCart() {
            document.getElementById('cart-sidebar').classList.remove('active');
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 整机目录搜索
            document.getElementById('machine-search-input').addEventListener('input', function(e) {
                state.currentFilter.search = e.target.value;
                applyFilters();
            });
            
            // 重置筛选按钮
            document.getElementById('reset-filters').addEventListener('click', resetFilters);
            
            // 返回类型选择按钮
            document.getElementById('back-to-type-from-selector').addEventListener('click', backToTypeSelector);
            
            // 返回机型列表按钮
            document.getElementById('back-to-machines').addEventListener('click', backToSelector);
            
            // 返回配件列表按钮
            document.getElementById('back-to-parts-list').addEventListener('click', backToPartsList);
            
            // 详情页添加到购物车按钮
            document.getElementById('add-to-cart-detail').addEventListener('click', function() {
                if (state.selectedPart) {
                    addToCart(state.selectedPart);
                }
            });
            
            // 切换整机树形目录
            document.getElementById('toggle-machine-tree').addEventListener('click', toggleMachineTree);
            
            // 购物车相关事件
            document.getElementById('view-cart').addEventListener('click', openCart);
            document.getElementById('cart-close').addEventListener('click', closeCart);
            document.getElementById('close-cart').addEventListener('click', closeCart);
            document.getElementById('clear-cart').addEventListener('click', function() {
                if (confirm(state.currentLanguage === 'zh' ? '确定要清空购物车吗？' : 'Are you sure you want to clear the cart?')) {
                    state.cart.clear();
                }
            });
            
            document.getElementById('export-cart').addEventListener('click', function() {
                state.cart.exportToExcel();
            });
            
            // 数量选择模态框事件
            document.getElementById('cancel-quantity').addEventListener('click', closeQuantityModal);
            document.getElementById('confirm-quantity').addEventListener('click', confirmAddToCart);
            
            document.getElementById('quantity-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmAddToCart();
                }
            });
            
            document.getElementById('brand-select').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmAddToCart();
                }
            });
            
            // 图片模态框事件
            document.getElementById('modal-close').addEventListener('click', closeImageModal);
            document.getElementById('zoom-in').addEventListener('click', () => zoomImage(0.2));
            document.getElementById('zoom-out').addEventListener('click', () => zoomImage(-0.2));
            document.getElementById('zoom-reset').addEventListener('click', resetImageZoom);
            
            document.getElementById('image-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeImageModal();
                }
            });
            
            // 全局点击事件
            document.addEventListener('click', function(e) {
                const cartSidebar = document.getElementById('cart-sidebar');
                const viewCartBtn = document.getElementById('view-cart');
                
                if (cartSidebar.classList.contains('active') &&
                    !cartSidebar.contains(e.target) &&
                    !viewCartBtn.contains(e.target) &&
                    !e.target.closest('.quantity-modal') &&
                    !e.target.closest('.quantity-modal-content')) {
                    closeCart();
                }
            });
            
            // 事件委托处理动态生成的购物车内容
            document.addEventListener('click', function(e) {
                if (e.target.closest('.decrease-quantity')) {
                    const code = e.target.closest('.decrease-quantity').dataset.code;
                    const item = state.cart.items.find(item => item.code === code);
                    if (item) {
                        if (item.quantity > 1) {
                            state.cart.update(code, item.quantity - 1);
                        } else {
                            if (confirm(state.currentLanguage === 'zh' ? '确定要从购物车中移除这个商品吗？' : 'Are you sure you want to remove this item from the cart?')) {
                                state.cart.remove(code);
                            }
                        }
                    }
                    e.stopPropagation();
                }
                
                if (e.target.closest('.increase-quantity')) {
                    const code = e.target.closest('.increase-quantity').dataset.code;
                    const item = state.cart.items.find(item => item.code === code);
                    if (item) {
                        state.cart.update(code, item.quantity + 1);
                    }
                    e.stopPropagation();
                }
                
                if (e.target.closest('.remove-item')) {
                    const code = e.target.closest('.remove-item').dataset.code;
                    if (confirm(state.currentLanguage === 'zh' ? '确定要从购物车中移除这个商品吗？' : 'Are you sure you want to remove this item from the cart?')) {
                        state.cart.remove(code);
                    }
                    e.stopPropagation();
                }
            });
            
            // 监听购物车数量输入框的变化
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('quantity-input')) {
                    const code = e.target.dataset.code;
                    const quantity = parseInt(e.target.value);
                    if (!isNaN(quantity) && quantity > 0) {
                        state.cart.update(code, quantity);
                    }
                }
            });
            
            // 键盘快捷键
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeImageModal();
                    closeQuantityModal();
                    closeCart();
                    
                    if (document.getElementById('part-detail-container').classList.contains('active')) {
                        backToPartsList();
                    }
                }
                
                if (state.selectedPart && state.currentMachine && 
                    document.getElementById('part-detail-container').classList.contains('active')) {
                    if (e.key === 'ArrowLeft') {
                        showPreviousPart();
                    } else if (e.key === 'ArrowRight') {
                        showNextPart();
                    }
                }
                
                if (e.ctrlKey && e.key === 'b') {
                    e.preventDefault();
                    openCart();
                }
                
                if (e.ctrlKey && e.key === 'l') {
                    e.preventDefault();
                    const currentLang = state.currentLanguage;
                    const newLang = currentLang === 'zh' ? 'en' : 'zh';
                    
                    document.querySelectorAll('.lang-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.dataset.lang === newLang) {
                            btn.classList.add('active');
                        }
                    });
                    
                    state.currentLanguage = newLang;
                    
                    translatePage();
                    
                    updateCurrentMachineDisplay();
                    
                    updateMachineTypeStats();
                    
                    if (state.currentMachine) {
                        renderTree();
                        applyFilters();
                    }
                }
            });
            
            document.getElementById('image-modal').addEventListener('wheel', function(e) {
                e.preventDefault();
                if (e.deltaY < 0) {
                    zoomImage(0.1);
                } else {
                    zoomImage(-0.1);
                }
            });
            
            // 为配件卡片添加点击事件
            document.getElementById('parts-grid').addEventListener('click', function(e) {
                const partCard = e.target.closest('.part-card');
                if (partCard) {
                    const partCode = partCard.dataset.code;
                    let part = null;
                    
                    part = state.filteredParts.find(p => p.code === partCode);
                    
                    if (part) {
                        selectPart(part);
                        closeCart();
                    }
                }
            });
        }
    </script>
</body>
</html>