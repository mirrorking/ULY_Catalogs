<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºç¡€é…ä»¶ç›®å½• - é€‰è´­ç³»ç»Ÿ</title>
    <link rel="icon" href="Info/Title.jpg" type="image/jpeg">
    <link rel="apple-touch-icon" href="Info/Title.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <!-- é¢„è¿æ¥ä¼˜åŒ– -->
    <link rel="preconnect" href=".">
    <link rel="dns-prefetch" href=".">
    
    <!-- å¼€å‘è€…å·¥å…·æ£€æµ‹å’Œé˜²æŠ¤è„šæœ¬ -->
    <!-- <script src="devtools-detection.js"></script> -->
    
    <style>
        /* ========== æ–°å¢ï¼šé˜²æ­¢æ–‡æœ¬é€‰æ‹©å’Œå³é”®èœå•çš„æ ·å¼ ========== */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        img {
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
        }
        
        /* ========== ä¿®æ”¹ï¼šå®Œå…¨ç§»é™¤å›¾ç‰‡æ¨¡æ€æ¡†ä¸­çš„åˆ‡æ¢æŒ‰é’® ========== */
        #image-modal .modal-prev,
        #image-modal .modal-next {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            width: 0 !important;
            height: 0 !important;
            pointer-events: none !important;
        }
        
        /* ========== æ–°å¢ï¼šå›¾ç‰‡åŠ è½½ä¼˜åŒ–æ ·å¼ ========== */
        .product-image {
            position: relative;
            overflow: hidden;
            background: #f8f9fa;
            will-change: contents;
        }
        
        /* éª¨æ¶å±åŠ¨ç”» */
        .skeleton-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .product-image img {
            opacity: 0;
            transition: opacity 0.3s ease;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .product-image img.loaded {
            opacity: 1;
        }
        
        /* è¯¦æƒ…é¡µå›¾ç‰‡ä¼˜åŒ– */
        .carousel-main-image {
            position: relative;
            min-height: 300px;
            background: #f8f9fa;
        }
        
        .carousel-main-image img.detail-image {
            transition: opacity 0.3s ease;
            opacity: 0;
        }
        
        .carousel-main-image img.detail-image.loaded {
            opacity: 1;
        }
        
        /* å›¾ç‰‡ç¼©ç•¥å›¾åŠ è½½ä¼˜åŒ– */
        .thumbnail img {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .thumbnail img.loaded {
            opacity: 1;
        }
        
        /* æ‡’åŠ è½½å ä½ç¬¦ */
        .lazy-placeholder {
            width: 100%;
            height: 100%;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #95a5a6;
        }
        
        /* å¿«é€ŸåŠ è½½åŠ¨ç”» */
        .quick-load {
            animation: quickFadeIn 0.2s ease;
        }
        
        @keyframes quickFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘é‡ç»˜ */
        .product-card {
            will-change: transform;
            transform: translateZ(0);
            backface-visibility: hidden;
        }
        
        .product-image img {
            will-change: opacity;
        }
        
        /* å›¾ç‰‡åŠ è½½é”™è¯¯çŠ¶æ€ */
        .image-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #e74c3c;
            font-size: 12px;
        }
        
        .image-error i {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        /* å›¾ç‰‡é‡è¯•æŒ‰é’® */
        .retry-btn {
            margin-top: 10px;
            padding: 4px 8px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .retry-btn:hover {
            background: #2980b9;
        }
        
        /* ========== ä¿®æ”¹ï¼šä¼˜åŒ–å›¾ç‰‡åŠ è½½æ ·å¼ ========== */
        @keyframes fadeInImage {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* ========== åŸå§‹CSSæ ·å¼ä¿æŒä¸å˜ ========== */
        /* è¯­è¨€åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .language-switcher {
            position: relative;
            display: flex;
            align-items: center;
            margin-right: 15px;
        }
        
        .language-btn {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #495057;
            transition: all 0.2s ease;
        }
        
        .language-btn:hover {
            background: #e9ecef;
            border-color: #3498db;
        }
        
        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-width: 120px;
            z-index: 100;
            display: none;
        }
        
        .language-dropdown.active {
            display: block;
        }
        
        .language-option {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s ease;
        }
        
        .language-option:hover {
            background: #f8f9fa;
        }
        
        .language-option.active {
            background: #3498db;
            color: white;
        }
        
        .language-flag {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .flag-cn {
            background: #de2910;
            color: #ffde00;
        }
        
        .flag-us {
            background: #3c3b6e;
            color: white;
        }
        
        /* åˆ†é¡µæ§ä»¶æ ·å¼ */
        .pagination-container {
            padding: 20px 25px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-info {
            font-size: 14px;
            color: #6c757d;
            white-space: nowrap;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .pagination-button {
            padding: 8px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            color: #495057;
            transition: all 0.2s ease;
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination-button:hover:not(:disabled) {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-button.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .page-numbers {
            display: flex;
            gap: 5px;
        }

        .pagination-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }

        .pagination-input {
            width: 50px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 13px;
        }

        .pagination-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .pagination-input-group span {
            font-size: 13px;
            color: #6c757d;
        }

        /* å¡ç‰‡åŠ è½½åŠ¨ç”» */
        .product-card {
            animation: fadeIn 0.5s ease forwards;
            opacity: 0;
            position:relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .product-name {
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
            line-height: 1.4;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-word;
            max-height: 2.8em;
        }

        /* å•†å“è§„æ ¼ä¿¡æ¯é™åˆ¶é«˜åº¦ */
        .product-specs {
            font-size: 12px;
            color: #7f8c8d;
            line-height: 1.4;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-word;
            max-height: 2.8em;
        }

        /* æœç´¢æ¡†æ ·å¼ */
        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 10px 10px 35px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #3498db;
        }

        .search-box .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #95a5a6;
            font-size: 14px;
        }

        .search-box .clear-search {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #95a5a6;
            cursor: pointer;
            font-size: 14px;
            display: none;
        }

        .search-box input:not(:placeholder-shown) + .clear-search {
            display: block;
        }

        /* è´­ç‰©è½¦æŒ‰é’®æ ·å¼ */
        .cart-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            opacity: 0;
        }

        .product-card:hover .cart-button {
            opacity: 1;
        }

        .cart-button:hover {
            background: #2980b9;
            transform: scale(1.1);
        }

        .cart-button.added {
            background: #27ae60;
        }

        /* è´­ç‰©è½¦é®ç½©å±‚ */
        .cart-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .cart-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* è´­ç‰©è½¦ä¾§è¾¹æ  */
        .cart-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .cart-sidebar.active {
            right: 0;
        }

        .cart-header {
            padding: 20px;
            background: #3498db;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .cart-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .cart-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .cart-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            gap: 15px;
        }

        .cart-item-image {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .cart-item-code {
            font-size: 12px;
            color: #7f8c8d;
            font-family: 'Courier New', monospace;
            margin-bottom: 3px;
        }

        .cart-item-original-code {
            font-size: 11px;
            color: #95a5a6;
            font-family: 'Courier New', monospace;
            margin-bottom: 5px;
        }

        .cart-item-sheet {
            font-size: 11px;
            color: #95a5a6;
            margin-bottom: 8px;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quantity-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity-btn:hover {
            background: #f8f9fa;
        }

        .quantity-input {
            width: 50px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .remove-item {
            color: #e74c3c;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .cart-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            background: #f8f9fa;
        }

        .cart-total {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .cart-actions {
            display: flex;
            gap: 10px;
        }

        .cart-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .cart-btn.primary {
            background: #3498db;
            color: white;
        }

        .cart-btn.primary:hover {
            background: #2980b9;
        }

        .cart-btn.secondary {
            background: #95a5a6;
            color: white;
        }

        .cart-btn.secondary:hover {
            background: #7f8c8d;
        }

        .cart-btn.danger {
            background: #e74c3c;
            color: white;
        }

        .cart-btn.danger:hover {
            background: #c0392b;
        }

        /* è´­ç‰©è½¦é€šçŸ¥ */
        .cart-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* æ•°é‡é€‰æ‹©æ¨¡æ€æ¡† */
        .quantity-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .quantity-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .quantity-modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .quantity-modal-title {
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .quantity-input-large {
            width: 100%;
            padding: 12px;
            border: 2px solid #3498db;
            border-radius: 4px;
            font-size: 16px;
            text-align: center;
            margin-bottom: 15px;
        }

        .brand-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 20px;
            background-color: white;
            cursor: pointer;
        }

        .brand-select:focus {
            outline: none;
            border-color: #3498db;
        }

        .quantity-modal-actions {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .modal-btn.primary {
            background: #3498db;
            color: white;
        }

        .modal-btn.secondary {
            background: #95a5a6;
            color: white;
        }

        /* è´­ç‰©è½¦å¾½ç«  */
        .cart-badge {
            position: relative;
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            font-size: 11px;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        /* ========== ä¿®æ”¹ï¼šå•†å“ç½‘æ ¼å¸ƒå±€æ ·å¼ ========== */
        /* å•†å“ç½‘æ ¼å¸ƒå±€ - ä¸€è¡Œ4ä¸ª */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            padding: 25px;
            min-height: 300px;
            transition: all 0.3s ease;
        }

        /* å•†å“å¡ç‰‡æ ·å¼è°ƒæ•´ - å›¾ç‰‡å 2/3 */
        .product-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 0;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            height: 400px;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.5s ease forwards;
            opacity: 0;
            overflow: hidden;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: #3498db;
        }

        /* å•†å“å›¾ç‰‡åŒºåŸŸè°ƒæ•´ - å å¡ç‰‡é«˜åº¦çš„2/3 */
        .product-image {
            width: 100%;
            height: 270px;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex-shrink: 0;
        }

        .product-card:hover .product-image img {
            transform: scale(1.05);
        }

        /* å•†å“ä¿¡æ¯åŒºåŸŸè°ƒæ•´ - å å¡ç‰‡é«˜åº¦çš„1/3 */
        .product-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 15px;
            height: 130px;
        }

        /* å›¾ç‰‡åŠ è½½çŠ¶æ€ */
        .image-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #95a5a6;
            font-size: 12px;
        }

        .image-loading i {
            font-size: 24px;
            margin-bottom: 8px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .image-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #95a5a6;
            font-size: 12px;
        }

        .image-placeholder i {
            font-size: 32px;
            margin-bottom: 8px;
        }

        /* ========== ä¿®æ”¹ï¼šå›¾ç‰‡è½®æ’­æ ·å¼ ========== */
        .image-carousel {
            position: relative;
            width: 100%;
            height: 600px;
            border-radius: 8px;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
        }

        .carousel-main-image {
            width: 100%;
            height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            background: #f8f9fa;
        }

        .carousel-main-image img {
            max-width: 90%;
            max-height: 90%;
            width: auto;
            height: auto;
            object-fit: contain;
            cursor: zoom-in;
            transition: opacity 0.3s ease;
            display: block;
            margin: 0 auto;
        }

        .carousel-main-image img.fade-in {
            animation: fadeInImage 0.5s ease;
        }

        @keyframes fadeInImage {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ç¼©ç•¥å›¾å®¹å™¨ */
        .thumbnail-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            gap: 10px;
            padding: 10px;
            overflow-x: auto;
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid #eee;
            height: 100px;
            z-index: 5;
        }

        .thumbnail {
            width: 80px;
            height: 80px;
            flex-shrink: 0;
            border: 2px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 2px;
        }

        .thumbnail:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .thumbnail.active {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(52, 152, 219, 0.8);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .carousel-btn:hover {
            background: rgba(52, 152, 219, 1);
            transform: translateY(-50%) scale(1.1);
        }

        .carousel-btn:disabled {
            background: rgba(149, 165, 166, 0.5);
            cursor: not-allowed;
            transform: translateY(-50%);
        }

        .carousel-btn:disabled:hover {
            background: rgba(149, 165, 166, 0.5);
            transform: translateY(-50%);
        }

        .carousel-btn.prev-btn {
            left: 15px;
        }

        .carousel-btn.next-btn {
            right: 15px;
        }

        .carousel-indicators {
            position: absolute;
            bottom: 110px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 8px;
            z-index: 10;
        }

        .indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(149, 165, 166, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .indicator:hover {
            background: rgba(52, 152, 219, 0.8);
        }

        .indicator.active {
            background: #3498db;
            transform: scale(1.2);
        }

        .carousel-info {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            z-index: 10;
            display: none;
        }

        /* å›¾ç‰‡å ä½ç¬¦ */
        .image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #95a5a6;
            font-size: 12px;
            background: #f8f9fa;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1200px) {
            .products-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 992px) {
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                padding: 15px;
            }
            
            .product-card {
                height: 360px;
            }
            
            .product-image {
                height: 240px;
            }
            
            .product-info {
                height: 120px;
                padding: 12px;
            }
            
            .product-name {
                font-size: 13px;
                margin-bottom: 5px;
            }
            
            .product-specs {
                font-size: 11px;
                margin-bottom: 6px;
                -webkit-line-clamp: 2;
                max-height: 2.4em;
            }
            
            .pagination-container {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }
            
            .pagination-controls {
                justify-content: center;
            }
            
            .page-numbers {
                order: 3;
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
            
            .cart-sidebar {
                width: 100%;
                right: -100%;
            }
            
            .cart-button {
                opacity: 1;
            }
            
            .language-switcher {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .image-carousel {
                height: 500px;
            }
            
            .carousel-main-image {
                height: 400px;
            }
            
            .thumbnail {
                width: 60px;
                height: 60px;
            }
            
            .thumbnail-container {
                height: 80px;
            }
            
            .carousel-btn {
                width: 36px;
                height: 36px;
            }
        }

        @media (max-width: 576px) {
            .products-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 12px;
            }
            
            .product-card {
                height: 320px;
            }
            
            .product-image {
                height: 213px;
            }
            
            .product-info {
                height: 107px;
                padding: 10px;
            }
            
            .image-carousel {
                height: 450px;
            }
            
            .carousel-main-image {
                height: 350px;
            }
            
            .thumbnail {
                width: 50px;
                height: 50px;
            }
            
            .thumbnail-container {
                height: 70px;
            }
        }
    </style>
</head>
<body>
    <!-- ç®€å•éªŒè¯è„šæœ¬ -->
    <script>
        // éªŒè¯æ£€æŸ¥è„šæœ¬
        (function() {
            try {
                // å°è¯•ä»æœ¬åœ°å­˜å‚¨è¯»å–è®¤è¯çŠ¶æ€
                const token = localStorage.getItem('uly_access_token');
                
                if (!token) {
                    // æœªç™»å½•ï¼Œè·³è½¬åˆ°éªŒè¯é¡µé¢
                    window.location.href = 'auth.html';
                    return;
                }
                
                // éªŒè¯tokenæœ‰æ•ˆæ€§
                const data = JSON.parse(atob(token));
                const now = Date.now();
                
                if (now >= data.expires) {
                    // tokenå·²è¿‡æœŸï¼Œæ¸…é™¤å¹¶é‡å®šå‘
                    localStorage.removeItem('uly_access_token');
                    window.location.href = 'auth.html';
                }
                
                // tokenæœ‰æ•ˆï¼Œå…è®¸è®¿é—®
            } catch (error) {
                // è§£æå¤±è´¥ï¼Œæ¸…é™¤æ— æ•ˆtokenå¹¶é‡å®šå‘
                localStorage.removeItem('uly_access_token');
                window.location.href = 'auth.html';
            }
        })();
    </script>
    
    <!-- è´­ç‰©è½¦é®ç½©å±‚ -->
    <div class="cart-overlay" id="cart-overlay"></div>
    
    <!-- è´­ç‰©è½¦ä¾§è¾¹æ  -->
    <div class="cart-sidebar" id="cart-sidebar">
        <div class="cart-header">
            <h3 id="cart-title">è´­ç‰©è½¦</h3>
            <button class="cart-close" id="cart-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="cart-content" id="cart-content">
            <div class="empty-state" id="empty-cart">
                <i class="fas fa-shopping-cart"></i>
                <h3 id="empty-cart-title">è´­ç‰©è½¦ä¸ºç©º</h3>
                <p id="empty-cart-message">è¯·æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦</p>
            </div>
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <span id="cart-total-label">æ€»è®¡:</span> <span id="cart-total-items">0</span> <span id="cart-total-unit">ä»¶å•†å“</span>
            </div>
            <div class="cart-actions">
                <button class="cart-btn danger" id="clear-cart">
                    <i class="fas fa-trash"></i> <span id="clear-cart-text">æ¸…ç©º</span>
                </button>
                <button class="cart-btn secondary" id="export-cart">
                    <i class="fas fa-file-excel"></i> <span id="export-cart-text">å¯¼å‡ºExcel</span>
                </button>
            </div>
        </div>
    </div>

    <!-- æ•°é‡é€‰æ‹©æ¨¡æ€æ¡† -->
    <div class="quantity-modal" id="quantity-modal">
        <div class="quantity-modal-content">
            <div class="quantity-modal-title" id="quantity-modal-title">é€‰æ‹©æ•°é‡å’Œå“ç‰Œ</div>
            <input type="number" class="quantity-input-large" id="quantity-input" min="1" value="1" autofocus>
            <select class="brand-select" id="brand-select">
                <option value="no_brand">æ— å“ç‰Œ</option>
                <option value="kelon">ç§‘é¾™</option>
                <option value="lixiong">åŠ›é›„</option>
            </select>
            <div class="quantity-modal-actions">
                <button class="modal-btn secondary" id="cancel-quantity">
                    <span id="cancel-quantity-text">å–æ¶ˆ</span>
                </button>
                <button class="modal-btn primary" id="confirm-quantity">
                    <span id="confirm-quantity-text">ç¡®è®¤</span>
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="top-nav">
            <div class="logo">
                <i class="fas fa-tools logo-icon"></i>
                <div class="logo-text">
                    <h1 id="page-title">åŸºç¡€é…ä»¶ç›®å½• - é€‰è´­ç³»ç»Ÿ</h1>
                    <div class="subtitle" id="page-subtitle">é€‰æ‹©å•†å“å¹¶æ·»åŠ åˆ°è´­ç‰©è½¦ï¼Œç”Ÿæˆé‡‡è´­æ¸…å•</div>
                </div>
            </div>
            <div class="nav-tabs">
                <!-- è¯­è¨€åˆ‡æ¢å™¨ -->
                <div class="language-switcher">
                    <button class="language-btn" id="language-btn">
                        <div class="language-flag flag-cn">ä¸­</div>
                        <span id="current-language">ä¸­æ–‡</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="language-dropdown" id="language-dropdown">
                        <div class="language-option active" data-lang="zh-CN">
                            <div class="language-flag flag-cn">ä¸­</div>
                            <span>ä¸­æ–‡</span>
                        </div>
                        <div class="language-option" data-lang="en-US">
                            <div class="language-flag flag-us">US</div>
                            <span>English</span>
                        </div>
                    </div>
                </div>
                
                <a href="index.html" class="nav-tab">
                    <i class="fas fa-home"></i> <span id="nav-home">è¿”å›é¦–é¡µ</span>
                </a>
                <a href="machine-directory.html" class="nav-tab">
                    <i class="fas fa-tractor"></i> <span id="nav-machine">æ•´æœºç›®å½•</span>
                </a>
                <button class="nav-tab cart-badge" id="view-cart">
                    <i class="fas fa-shopping-cart"></i> <span id="nav-cart">è´­ç‰©è½¦</span>
                    <span class="cart-count" id="cart-count">0</span>
                </button>
                <button class="nav-tab" id="refresh-data">
                    <i class="fas fa-sync-alt"></i> <span id="nav-refresh">åˆ·æ–°æ•°æ®</span>
                </button>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-area">
            <!-- ä¾§è¾¹æ  - å•†å“ç±»åˆ«æ ‘ -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title" id="sidebar-title">å·¥ä½œè¡¨åˆ—è¡¨</div>
                    
                    <!-- å•†å“æœç´¢æ¡† -->
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="product-search-input" placeholder="åœ¨æ‰€æœ‰å•†å“ä¸­æœç´¢...">
                        <button class="clear-search" id="clear-search">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="data-status" id="data-status">
                        <i class="fas fa-circle"></i>
                        <span id="data-status-text">æ­£åœ¨åŠ è½½æ•°æ®...</span>
                    </div>
                </div>
                
                <!-- æ ‘å½¢åˆ†ç±» -->
                <div class="tree-container">
                    <ul class="tree-list" id="category-tree"></ul>
                </div>
            </div>
            
            <!-- ä¸»å†…å®¹åŒº -->
            <div class="main-content" id="main-content"></div>
        </div>
        
        <!-- å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡† -->
        <div class="image-modal" id="image-modal">
            <div class="modal-content">
                <button class="modal-close" id="modal-close">
                    <i class="fas fa-times"></i>
                </button>
                <img id="modal-image" class="modal-image" src="" alt="">
                <div class="modal-image-info" id="modal-image-info"></div>
            </div>
        </div>
        
        <footer>
            <p id="footer-text">Â© 2023 é…ä»¶ç›®å½•ç®¡ç†ç³»ç»Ÿ | åŸºç¡€é…ä»¶ç›®å½• | æ•°æ®æ¥æº: products_data.json | å›¾ç‰‡è·¯å¾„: images/</p>
        </footer>
    </div>

<!-- æ·»åŠ exceljsåº“ -->
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
<script>
    // === å›¾ç‰‡åŠ è½½ä¼˜åŒ–æ ¸å¿ƒä»£ç  ===

    // å¤šè¯­è¨€æ–‡æœ¬å®šä¹‰
    const translations = {
        'zh-CN': {
            'pageTitle': 'åŸºç¡€é…ä»¶ç›®å½• - é€‰è´­ç³»ç»Ÿ',
            'pageSubtitle': 'é€‰æ‹©å•†å“å¹¶æ·»åŠ åˆ°è´­ç‰©è½¦ï¼Œç”Ÿæˆé‡‡è´­æ¸…å•',
            'navHome': 'è¿”å›é¦–é¡µ',
            'navMachine': 'æ•´æœºç›®å½•',
            'navCart': 'è´­ç‰©è½¦',
            'navRefresh': 'åˆ·æ–°æ•°æ®',
            'sidebarTitle': 'å·¥ä½œè¡¨åˆ—è¡¨',
            'searchPlaceholder': 'åœ¨æ‰€æœ‰å•†å“ä¸­æœç´¢...',
            'loadingData': 'æ­£åœ¨åŠ è½½æ•°æ®...',
            'dataReady': 'æ•°æ®å·²å°±ç»ª',
            'allSheets': 'æ‰€æœ‰å·¥ä½œè¡¨',
            'dataDirectory': 'JSONæ•°æ®ç›®å½•ç³»ç»Ÿ',
            'dataDescription': 'åŸºäºXLSMè½¬æ¢çš„é…ä»¶ä¿¡æ¯ç®¡ç†ç³»ç»Ÿ',
            'sheetsCount': 'å·¥ä½œè¡¨',
            'partsCount': 'åŸºç¡€é…ä»¶',
            'cartTitle': 'è´­ç‰©è½¦',
            'emptyCartTitle': 'è´­ç‰©è½¦ä¸ºç©º',
            'emptyCartMessage': 'è¯·æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦',
            'cartTotal': 'æ€»è®¡:',
            'cartItemsUnit': 'ä»¶å•†å“',
            'clearCart': 'æ¸…ç©º',
            'exportCart': 'å¯¼å‡ºExcel',
            'addToCart': 'æ·»åŠ åˆ°è´­ç‰©è½¦',
            'removeFromCart': 'ä»è´­ç‰©è½¦ç§»é™¤',
            'cartNotification': 'å•†å“å·²æ·»åŠ åˆ°è´­ç‰©è½¦',
            'cartRemoved': 'å•†å“å·²ä»è´­ç‰©è½¦ç§»é™¤',
            'cartCleared': 'è´­ç‰©è½¦å·²æ¸…ç©º',
            'selectQuantity': 'é€‰æ‹©æ•°é‡å’Œå“ç‰Œ',
            'cancel': 'å–æ¶ˆ',
            'confirm': 'ç¡®è®¤',
            'enterQuantity': 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡',
            'productDetails': 'å•†å“è¯¦æƒ…',
            'productCode': 'å•†å“ç¼–ç :',
            'originalCode': 'åŸå§‹ç¼–ç :',
            'backToList': 'è¿”å›åˆ—è¡¨',
            'basicInfo': 'åŸºæœ¬ä¿¡æ¯',
            'productName': 'å•†å“åç§°',
            'sheetName': 'æ‰€å±å·¥ä½œè¡¨',
            'detailedInfo': 'è¯¦ç»†ä¿¡æ¯',
            'searchResults': 'æœç´¢ç»“æœ',
            'foundItems': 'å…±æ‰¾åˆ°',
            'itemsFor': 'ä¸ªå•†å“',
            'noResults': 'æœªæ‰¾åˆ°ç›¸å…³å•†å“',
            'tryOtherKeywords': 'è¯·å°è¯•å…¶ä»–æœç´¢å…³é”®è¯',
            'showItems': 'æ˜¾ç¤ºç¬¬',
            'to': 'åˆ°',
            'of': 'æ¡ï¼Œå…±',
            'items': 'æ¡',
            'goToPage': 'è·³è‡³',
            'page': 'é¡µ',
            'jump': 'è·³è½¬',
            'noProducts': 'æš‚æ— å•†å“',
            'noProductsInSheet': 'è¯¥å·¥ä½œè¡¨ä¸­æš‚æ— å•†å“æ•°æ®',
            'noImage': 'æ— å›¾ç‰‡',
            'clickToZoom': 'ç‚¹å‡»å›¾ç‰‡æ”¾å¤§æŸ¥çœ‹',
            'imageNotFound': 'å›¾ç‰‡æœªæ‰¾åˆ°',
            'saveImageAs': 'è¯·å°†å›¾ç‰‡ä¿å­˜ä¸º:',
            'confirmRemove': 'ç¡®å®šè¦ä»è´­ç‰©è½¦ä¸­ç§»é™¤è¿™ä¸ªå•†å“å—ï¼Ÿ',
            'confirmClearCart': 'ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿ',
            'cartEmpty': 'è´­ç‰©è½¦ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º',
            'exportSuccess': 'è®¢è´­æ¸…å•å·²å¯¼å‡ºä¸ºExcelæ–‡ä»¶',
            'footerText': 'Â© 2026 é…ä»¶ç›®å½•ç®¡ç†ç³»ç»Ÿ | åŸºç¡€é…ä»¶ç›®å½•',
            'noBrand': 'æ— å“ç‰Œ',
            'kelon': 'ç§‘é¾™',
            'lixiong': 'åŠ›é›„',
            'loadingFailed': 'åŠ è½½å¤±è´¥',
            'retry': 'é‡è¯•',
            'loading': 'åŠ è½½ä¸­...',
            'checkingImages': 'æ£€æŸ¥å›¾ç‰‡...',
            'imageLoadError': 'å›¾ç‰‡åŠ è½½é”™è¯¯',
            'checkingImage': 'æ£€æŸ¥å›¾ç‰‡è·¯å¾„...',
            'thumbnail': 'ç¼©ç•¥å›¾'
        },
        'en-US': {
            'pageTitle': 'Basic Parts Directory - Selection System',
            'pageSubtitle': 'Select products and add to cart to generate purchase list',
            'navHome': 'Back to Home',
            'navMachine': 'Machine Directory',
            'navCart': 'Shopping Cart',
            'navRefresh': 'Refresh Data',
            'sidebarTitle': 'Worksheet List',
            'searchPlaceholder': 'Search in all products...',
            'loadingData': 'Loading data...',
            'dataReady': 'Data ready',
            'allSheets': 'All Worksheets',
            'dataDirectory': 'JSON Data Directory System',
            'dataDescription': 'Parts information management system converted from XLSM',
            'sheetsCount': 'Worksheets',
            'partsCount': 'Basic Parts',
            'cartTitle': 'Shopping Cart',
            'emptyCartTitle': 'Cart is empty',
            'emptyCartMessage': 'Please add products to cart',
            'cartTotal': 'Total:',
            'cartItemsUnit': 'items',
            'clearCart': 'Clear',
            'exportCart': 'Export Excel',
            'addToCart': 'Add to Cart',
            'removeFromCart': 'Remove from Cart',
            'cartNotification': 'Product added to cart',
            'cartRemoved': 'Product removed from cart',
            'cartCleared': 'Cart cleared',
            'selectQuantity': 'Select quantity and brand',
            'cancel': 'Cancel',
            'confirm': 'Confirm',
            'enterQuantity': 'Please enter a valid quantity',
            'productDetails': 'Product Details',
            'productCode': 'Product Code:',
            'originalCode': 'Original Code:',
            'backToList': 'Back to List',
            'basicInfo': 'Basic Information',
            'productName': 'Product Name',
            'sheetName': 'Worksheet',
            'detailedInfo': 'Detailed Information',
            'searchResults': 'Search Results',
            'foundItems': 'Found',
            'itemsFor': 'items for',
            'noResults': 'No relevant products found',
            'tryOtherKeywords': 'Please try other keywords',
            'showItems': 'Showing',
            'to': 'to',
            'of': 'of',
            'items': 'items',
            'goToPage': 'Go to',
            'page': 'page',
            'jump': 'Go',
            'noProducts': 'No products',
            'noProductsInSheet': 'No product data in this worksheet',
            'noImage': 'No image',
            'clickToZoom': 'Click image to zoom',
            'imageNotFound': 'Image not found',
            'saveImageAs': 'Please save image as:',
            'confirmRemove': 'Are you sure you want to remove this item from cart?',
            'confirmClearCart': 'Are you sure you want to clear the cart?',
            'cartEmpty': 'Cart is empty, cannot export',
            'exportSuccess': 'Order list exported to Excel file',
            'footerText': 'Â© 2026 Parts Directory Management System | Basic Parts Directory',
            'noBrand': 'No Brand',
            'kelon': 'Kelon',
            'lixiong': 'Lixiong',
            'loadingFailed': 'Loading failed',
            'retry': 'Retry',
            'loading': 'Loading...',
            'checkingImages': 'Checking images...',
            'imageLoadError': 'Image load error',
            'checkingImage': 'Checking image path...',
            'thumbnail': 'thumbnail'
        }
    };

    // å“ç‰Œæ˜ å°„
    const brandMappings = {
        'zh-CN': {
            'no_brand': 'æ— å“ç‰Œ',
            'kelon': 'ç§‘é¾™',
            'lixiong': 'åŠ›é›„'
        },
        'en-US': {
            'no_brand': 'No Brand',
            'kelon': 'Kelon',
            'lixiong': 'Lixiong'
        }
    };

    // ========== ä¼˜åŒ–çš„å›¾ç‰‡åŠ è½½ç³»ç»Ÿ ==========
    const imageCache = new Map();
    const imageLoadingPromises = new Map();
    let lazyImageObserver = null;
    
    // ========== æ–°å¢ï¼šç¼©ç•¥å›¾åŠ è½½éªŒè¯ç³»ç»Ÿ ==========
    const thumbnailVerification = {
        enabled: true, // è®¾ç½®ä¸ºtrueå¼€å¯éªŒè¯
        log: [],
        timestamps: new Map(),
        
        startVerification(productCode) {
            if (!this.enabled) return;
            console.clear();
            console.group('ğŸ”¬ ç¼©ç•¥å›¾åŠ è½½éªŒè¯ç³»ç»Ÿ');
            console.log(`å¼€å§‹éªŒè¯å•†å“: ${productCode}`);
            console.log(`å¼€å§‹æ—¶é—´: ${new Date().toLocaleTimeString()}`);
            console.log('----------------------------------------');
            this.log = [];
            this.timestamps.clear();
        },
        
        logEvent(index, event, url, timestamp) {
            if (!this.enabled) return;
            const time = Date.now();
            const elapsed = time - timestamp;
            const entry = {
                index: index + 1,
                event,
                url: url ? url.split('/').pop() : 'unknown',
                time: time,
                elapsed,
                displayOrder: this.log.length + 1
            };
            
            this.log.push(entry);
            
            // æ§åˆ¶å°è¾“å‡º
            let icon = 'ğŸ“';
            if (event.includes('å¼€å§‹åŠ è½½')) icon = 'ğŸš€';
            if (event.includes('åŠ è½½å®Œæˆ')) icon = 'âœ…';
            if (event.includes('æ·»åŠ åˆ°DOM')) icon = 'ğŸ“·';
            if (event.includes('ç«‹å³æ˜¾ç¤º')) icon = 'âš¡';
            if (event.includes('å»¶è¿Ÿæ˜¾ç¤º')) icon = 'ğŸ¢';
            
            console.log(`${icon} ç¼©ç•¥å›¾ #${entry.index}: ${event}`);
            console.log(`   URL: ${entry.url}`);
            console.log(`   æ—¶é—´æˆ³: ${time}`);
            console.log(`   è€—æ—¶: ${elapsed}ms`);
            console.log(`   æ˜¾ç¤ºé¡ºåº: ${entry.displayOrder}`);
        },
        
        verifyImmediateDisplay() {
            if (!this.enabled || this.log.length === 0) return;
            
            console.log('\nğŸ” éªŒè¯ç»“æœåˆ†æ:');
            console.log('----------------------------------------');
            
            // æŒ‰ç¼©ç•¥å›¾åˆ†ç»„åˆ†æ
            const byIndex = {};
            this.log.forEach(entry => {
                if (!byIndex[entry.index]) byIndex[entry.index] = [];
                byIndex[entry.index].push(entry);
            });
            
            let immediateCount = 0;
            let delayedCount = 0;
            
            Object.keys(byIndex).forEach(index => {
                const events = byIndex[index];
                const startEvent = events.find(e => e.event.includes('å¼€å§‹åŠ è½½'));
                const completeEvent = events.find(e => e.event.includes('åŠ è½½å®Œæˆ'));
                const displayEvent = events.find(e => e.event.includes('ç«‹å³æ˜¾ç¤º') || e.event.includes('å»¶è¿Ÿæ˜¾ç¤º'));
                
                if (startEvent && completeEvent && displayEvent) {
                    const loadTime = completeEvent.time - startEvent.time;
                    const displayDelay = displayEvent.time - completeEvent.time;
                    
                    console.log(`ç¼©ç•¥å›¾ #${index}:`);
                    console.log(`  åŠ è½½è€—æ—¶: ${loadTime}ms`);
                    console.log(`  æ˜¾ç¤ºå»¶è¿Ÿ: ${displayDelay}ms`);
                    
                    if (displayDelay < 50) { // å°äº50msè®¤ä¸ºæ˜¯ç«‹å³æ˜¾ç¤º
                        console.log(`  âœ… éªŒè¯é€šè¿‡: å›¾ç‰‡åŠ è½½å®Œæˆåç«‹å³æ˜¾ç¤º`);
                        immediateCount++;
                    } else {
                        console.log(`  âŒ éªŒè¯å¤±è´¥: å›¾ç‰‡åŠ è½½å®Œæˆåå»¶è¿Ÿ${displayDelay}msæ‰æ˜¾ç¤º`);
                        delayedCount++;
                    }
                }
            });
            
            console.log('\nğŸ“Š æ€»ä½“ç»Ÿè®¡:');
            console.log(`  ç«‹å³æ˜¾ç¤ºçš„ç¼©ç•¥å›¾: ${immediateCount}`);
            console.log(`  å»¶è¿Ÿæ˜¾ç¤ºçš„ç¼©ç•¥å›¾: ${delayedCount}`);
            console.log(`  æ€»éªŒè¯æ•°é‡: ${Object.keys(byIndex).length}`);
            
            if (delayedCount === 0) {
                console.log('\nğŸ‰ æ­å–œï¼æ‰€æœ‰ç¼©ç•¥å›¾éƒ½å®ç°äº†å•ä¸ªåŠ è½½å®Œæˆç«‹å³æ˜¾ç¤ºï¼');
            } else {
                console.log(`\nâš ï¸ æœ‰ ${delayedCount} ä¸ªç¼©ç•¥å›¾å­˜åœ¨å»¶è¿Ÿæ˜¾ç¤ºé—®é¢˜`);
            }
            
            console.groupEnd();
        }
    };

    // ========== å…³é”®ä¿®å¤ï¼šä¼˜åŒ–çš„å›¾ç‰‡æ£€æŸ¥å‡½æ•° ==========
    function checkImageExists(url, timeout = 2000) {
        return new Promise((resolve) => {
            const img = new Image();
            let timer;
            
            img.onload = () => {
                clearTimeout(timer);
                resolve(true);
            };
            
            img.onerror = () => {
                clearTimeout(timer);
                resolve(false);
            };
            
            // å…³é”®ä¿®å¤ï¼šè®¾ç½®æ›´çŸ­çš„è¶…æ—¶æ—¶é—´
            timer = setTimeout(() => {
                img.onload = img.onerror = null;
                img.src = '';
                resolve(false);
            }, timeout);
            
            img.src = url;
        });
    }

    // ========== å…³é”®ä¿®å¤ï¼šæ£€æŸ¥å›¾ç‰‡æ˜¯å¦å·²ç¼“å­˜ ==========
    function checkIfImageIsCached(url) {
        return new Promise((resolve) => {
            const img = new Image();
            
            img.onload = () => {
                resolve({ cached: true, width: img.naturalWidth, height: img.naturalHeight });
            };
            
            img.onerror = () => {
                resolve({ cached: false });
            };
            
            // å¦‚æœå›¾ç‰‡å·²ç»åœ¨ç¼“å­˜ä¸­ï¼Œonloadä¼šç«‹å³è§¦å‘
            img.src = url;
            
            // è®¾ç½®ä¸€ä¸ªå¾ˆå°çš„è¶…æ—¶æ¥æ£€æµ‹ç¼“å­˜
            setTimeout(() => {
                if (img.complete && img.naturalWidth > 0) {
                    resolve({ cached: true, width: img.naturalWidth, height: img.naturalHeight });
                }
            }, 50);
        });
    }

    // ========== å…³é”®ä¿®å¤ï¼šæ˜¾ç¤ºå·²ç¼“å­˜çš„å›¾ç‰‡ ==========
    function displayCachedImage(imageContainer, imageUrl, productCode, loadId, controller) {
        // æ£€æŸ¥åŠ è½½æ˜¯å¦è¢«å–æ¶ˆ
        if (controller.signal.aborted || imageContainer.dataset.loadId !== loadId) {
            return;
        }
        
        const img = new Image();
        img.src = imageUrl;
        img.alt = productCode;
        img.className = 'lazy-image';
        img.decoding = 'async';
        
        // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ å›¾ç‰‡
        imageContainer.innerHTML = '';
        imageContainer.appendChild(img);
        
        // ç«‹å³æ·»åŠ loadedç±»ï¼Œå› ä¸ºå›¾ç‰‡å·²ç»åœ¨ç¼“å­˜ä¸­
        requestAnimationFrame(() => {
            img.classList.add('loaded', 'quick-load');
            imageContainer.dataset.loaded = 'true';
            imageContainer.dataset.loading = 'false';
            
            // æ¸…ç†abortController
            delete imageContainer.abortController;
            
            console.log(`å•†å“ ${productCode} ç¼“å­˜çš„å›¾ç‰‡æˆåŠŸæ˜¾ç¤º`);
        });
        
        // ç¼“å­˜åˆ° loadedImages
        if (!state.loadedImages[productCode]) {
            state.loadedImages[productCode] = imageUrl;
        }
    }

    // ========== å…³é”®ä¿®æ”¹ï¼šä¸»å›¾ç‰‡åªæŸ¥æ‰¾pngæ ¼å¼ï¼Œåªä»imagesç›®å½• ==========
    async function findMainImage(productCode) {
        const cacheKey = `main_${productCode}`;
        
        // å¿«é€Ÿç¼“å­˜æ£€æŸ¥
        if (imageCache.has(cacheKey)) {
            const cached = imageCache.get(cacheKey);
            if (cached.url === null) return null;
            // 10ç§’å†…ç¼“å­˜æœ‰æ•ˆ
            if (Date.now() - cached.timestamp < 10000) {
                return cached.url;
            }
        }
        
        // é˜²æ­¢é‡å¤æ£€æŸ¥
        if (imageLoadingPromises.has(cacheKey)) {
            return imageLoadingPromises.get(cacheKey);
        }
        
        const checkPromise = (async () => {
            try {
                // ä¸»å›¾ç‰‡ï¼šåªæœ‰pngæ ¼å¼ï¼Œåªåœ¨imagesç›®å½•
                const mainImageUrl = `images/${productCode}.png`;
                const exists = await checkImageExists(mainImageUrl);
                
                if (exists) {
                    imageCache.set(cacheKey, { 
                        url: mainImageUrl, 
                        timestamp: Date.now() 
                    });
                    return mainImageUrl;
                }
                
                // æœªæ‰¾åˆ°ä¸»å›¾ç‰‡
                imageCache.set(cacheKey, { 
                    url: null, 
                    timestamp: Date.now() 
                });
                return null;
                
            } catch (error) {
                console.warn(`æ£€æŸ¥ä¸»å›¾å¤±è´¥: ${productCode}`, error);
                imageCache.set(cacheKey, { 
                    url: null, 
                    timestamp: Date.now() 
                });
                return null;
            } finally {
                imageLoadingPromises.delete(cacheKey);
            }
        })();
        
        imageLoadingPromises.set(cacheKey, checkPromise);
        return checkPromise;
    }

    // ========== å…³é”®ä¿®å¤ï¼šé™„åŠ å›¾ç‰‡æ£€æŸ¥ - ä¸€è½®å¤±è´¥å°±åœæ­¢ ==========
    async function findAdditionalImages(productCode) {
        const cacheKey = `additional_${productCode}`;
        
        // æ£€æŸ¥ç¼“å­˜
        if (imageCache.has(cacheKey)) {
            const cached = imageCache.get(cacheKey);
            if (Date.now() - cached.timestamp < 30000) { // é™„åŠ å›¾ç‰‡ç¼“å­˜30ç§’
                return cached.images;
            }
        }
        
        // é˜²æ­¢é‡å¤æ£€æŸ¥
        if (imageLoadingPromises.has(cacheKey)) {
            return imageLoadingPromises.get(cacheKey);
        }
        
        const checkPromise = (async () => {
            try {
                const images = [];
                
                // é™„åŠ å›¾ç‰‡æ ¼å¼æ£€æŸ¥é¡ºåºï¼šjpg â†’ png â†’ jpeg
                const formats = ['.jpg', '.png', '.jpeg'];
                
                // å…³é”®ä¿®å¤ï¼šæ™ºèƒ½åœæ­¢æ£€æŸ¥é€»è¾‘
                let consecutiveFailures = 0;
                const maxConsecutiveFailures = 1; // å…³é”®ä¿®æ”¹ï¼šè¿ç»­1ä¸ªå˜ä½“æ²¡æ‰¾åˆ°å°±åœæ­¢ï¼ˆä¸€è½®å¤±è´¥å°±ç»“æŸï¼‰
                const maxVariants = 8;  // æœ€å¤šæ£€æŸ¥åˆ° (8)
                
                // åªæ£€æŸ¥å¸¦æ‹¬å·çš„å˜ä½“å›¾ç‰‡ (1)-(8)
                for (let i = 1; i <= maxVariants; i++) {
                    // å¦‚æœè¿ç»­1ä¸ªå˜ä½“éƒ½æ²¡æ‰¾åˆ°ä»»ä½•æ ¼å¼çš„å›¾ç‰‡ï¼Œç«‹å³åœæ­¢æ£€æŸ¥
                    if (consecutiveFailures >= maxConsecutiveFailures) {
                        console.log(`å•†å“ ${productCode}: å˜ä½“(${i})æœªæ‰¾åˆ°ä»»ä½•æ ¼å¼å›¾ç‰‡ï¼Œåœæ­¢æ£€æŸ¥åç»­å˜ä½“`);
                        break;
                    }
                    
                    let foundVariant = false;
                    
                    // æ£€æŸ¥å½“å‰å˜ä½“çš„æ‰€æœ‰æ ¼å¼ï¼ˆæŒ‰ä¼˜å…ˆçº§é¡ºåºï¼‰
                    for (const format of formats) {
                        const url = `Moreimages/${productCode}(${i})${format}`;
                        
                        try {
                            const exists = await checkImageExists(url);
                            if (exists) {
                                images.push(url);
                                foundVariant = true;
                                consecutiveFailures = 0; // é‡ç½®è¿ç»­å¤±è´¥è®¡æ•°
                                break; // æ‰¾åˆ°ä¸€ç§æ ¼å¼å°±å¤Ÿäº†ï¼Œè·³è¿‡å…¶ä»–æ ¼å¼æ£€æŸ¥
                            }
                        } catch (error) {
                            console.warn(`æ£€æŸ¥å˜ä½“å›¾ç‰‡å¤±è´¥: ${url}`, error);
                        }
                    }
                    
                    // å¦‚æœè¿™ä¸ªå˜ä½“æ²¡æ‰¾åˆ°ä»»ä½•æ ¼å¼çš„å›¾ç‰‡ï¼Œå¢åŠ è¿ç»­å¤±è´¥è®¡æ•°
                    if (!foundVariant) {
                        consecutiveFailures++;
                    }
                }
                
                const result = { images, timestamp: Date.now() };
                imageCache.set(cacheKey, result);
                
                return images;
                
            } catch (error) {
                console.warn(`æ£€æŸ¥é™„åŠ å›¾ç‰‡å¤±è´¥: ${productCode}`, error);
                const result = { images: [], timestamp: Date.now() };
                imageCache.set(cacheKey, result);
                return [];
            } finally {
                imageLoadingPromises.delete(cacheKey);
            }
        })();
        
        imageLoadingPromises.set(cacheKey, checkPromise);
        return checkPromise;
    }

    // ========== å…³é”®ä¿®æ”¹ï¼šä¸ºå•†å“è¯¦æƒ…é¡µä¼˜åŒ–çš„å›¾ç‰‡æŸ¥æ‰¾å‡½æ•°ï¼ˆç«‹å³è¿”å›Promiseï¼‰==========
    async function findImagesForDetailPage(productCode) {
        const cacheKey = `detail_${productCode}`;
        
        // æ£€æŸ¥ç¼“å­˜
        if (imageCache.has(cacheKey)) {
            const cached = imageCache.get(cacheKey);
            if (Date.now() - cached.timestamp < 60000) { // è¯¦æƒ…é¡µç¼“å­˜1åˆ†é’Ÿ
                return cached.images;
            }
        }
        
        // é˜²æ­¢é‡å¤æ£€æŸ¥
        if (imageLoadingPromises.has(cacheKey)) {
            return imageLoadingPromises.get(cacheKey);
        }
        
        const checkPromise = (async () => {
            try {
                const allImages = [];
                
                // 1. å…ˆè·å–ä¸»å›¾ç‰‡ï¼ˆä¸»å›¾åªæœ‰pngæ ¼å¼ï¼Œåœ¨imagesç›®å½•ï¼‰
                const mainImageUrl = await findMainImage(productCode);
                if (mainImageUrl) {
                    allImages.push(mainImageUrl);
                }
                
                // 2. è·å–é™„åŠ å›¾ç‰‡
                const additionalImages = await findAdditionalImages(productCode);
                
                // åˆå¹¶å›¾ç‰‡ï¼Œç¡®ä¿ä¸é‡å¤
                additionalImages.forEach(img => {
                    if (!allImages.includes(img)) {
                        allImages.push(img);
                    }
                });
                
                const result = { images: allImages, timestamp: Date.now() };
                imageCache.set(cacheKey, result);
                
                return allImages;
                
            } catch (error) {
                console.warn(`æŸ¥æ‰¾è¯¦æƒ…é¡µå›¾ç‰‡å¤±è´¥: ${productCode}`, error);
                const result = { images: [], timestamp: Date.now() };
                imageCache.set(cacheKey, result);
                return [];
            } finally {
                imageLoadingPromises.delete(cacheKey);
            }
        })();
        
        imageLoadingPromises.set(cacheKey, checkPromise);
        return checkPromise;
    }

    // ========== å…³é”®ä¿®å¤ï¼šä¼˜åŒ–çš„å•†å“å¡ç‰‡å›¾ç‰‡åŠ è½½ï¼ˆè§£å†³è¶…æ—¶é—®é¢˜ï¼‰==========
    async function loadProductCardImage(imageContainer, productCode) {
        // å…³é”®ä¿®å¤ï¼šæ·»åŠ å”¯ä¸€çš„åŠ è½½æ ‡è¯†ç¬¦
        const loadId = `card_${productCode}_${Date.now()}`;
        imageContainer.dataset.loadId = loadId;
        imageContainer.dataset.cardCode = productCode;
        
        // æ£€æŸ¥æ˜¯å¦æ­£åœ¨åŠ è½½æˆ–å·²åŠ è½½
        if (imageContainer.dataset.loading === 'true') {
            return;
        }
        
        if (imageContainer.dataset.loaded === 'true') {
            // å¦‚æœå·²åŠ è½½ï¼Œç¡®ä¿æ˜¾ç¤ºå›¾ç‰‡
            const existingImg = imageContainer.querySelector('img.lazy-image');
            if (existingImg && existingImg.complete && existingImg.naturalWidth > 0) {
                existingImg.classList.add('loaded');
                return;
            }
            // å¦‚æœæ ‡è®°ä¸ºå·²åŠ è½½ä½†å®é™…æ²¡æœ‰å›¾ç‰‡ï¼Œé‡ç½®çŠ¶æ€
            imageContainer.dataset.loaded = 'false';
        }
        
        // è®¾ç½®åŠ è½½çŠ¶æ€
        imageContainer.dataset.loading = 'true';
        imageContainer.dataset.code = productCode;
        
        // ç«‹å³æ˜¾ç¤ºéª¨æ¶å±
        imageContainer.innerHTML = '<div class="skeleton-placeholder"></div>';
        
        // ä½¿ç”¨AbortControlleræ¥æ”¯æŒå–æ¶ˆ
        const controller = new AbortController();
        imageContainer.abortController = controller;
        
        // å®šä¹‰è¶…æ—¶ID
        let timeoutId = null;
        
        try {
            // å•†å“å¡ç‰‡åªæŸ¥æ‰¾ä¸»å›¾ç‰‡
            const mainImageUrl = await findMainImage(productCode);
            
            // æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ
            if (controller.signal.aborted) {
                return;
            }
            
            if (mainImageUrl) {
                // å…³é”®ä¿®å¤ï¼šå…ˆæ£€æŸ¥å›¾ç‰‡æ˜¯å¦å·²ç¼“å­˜
                const cachedCheck = await checkIfImageIsCached(mainImageUrl);
                if (cachedCheck.cached) {
                    // å›¾ç‰‡å·²ç¼“å­˜ï¼Œç›´æ¥æ˜¾ç¤º
                    displayCachedImage(imageContainer, mainImageUrl, productCode, loadId, controller);
                    return;
                }
                
                const img = new Image();
                img.alt = productCode;
                img.decoding = 'async';
                img.loading = 'lazy';
                img.className = 'lazy-image';
                
                // å…³é”®ä¿®å¤ï¼šè®¾ç½®æ›´åˆç†çš„è¶…æ—¶æ—¶é—´ï¼ˆ4ç§’ï¼‰
                timeoutId = setTimeout(() => {
                    // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å·²ç»åŠ è½½å®Œæˆ
                    if (img.complete && img.naturalWidth > 0) {
                        // å›¾ç‰‡å·²ç»åŠ è½½å®Œæˆï¼Œå¿½ç•¥è¶…æ—¶
                        return;
                    }
                    
                    if (imageContainer.dataset.loading === 'true' && !controller.signal.aborted) {
                        // å…³é”®ä¿®å¤ï¼šä¸æ˜¾ç¤ºé”™è¯¯ï¼Œåªæ˜¯ä¸è®¾ç½®loadedçŠ¶æ€
                        // å›¾ç‰‡å¯èƒ½è¿˜åœ¨åŠ è½½ä¸­ï¼Œè®©æµè§ˆå™¨ç»§ç»­åŠ è½½
                        console.log(`å•†å“ ${productCode} å›¾ç‰‡åŠ è½½è¾ƒæ…¢ï¼Œç»§ç»­ç­‰å¾…...`);
                    }
                }, 4000);
                
                img.onload = () => {
                    // å…³é”®ä¿®å¤ï¼šç«‹å³æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                    clearTimeout(timeoutId);
                    
                    // æ£€æŸ¥åŠ è½½æ˜¯å¦è¢«å–æ¶ˆ
                    if (controller.signal.aborted || imageContainer.dataset.loadId !== loadId) {
                        return;
                    }
                    
                    // ç›´æ¥æ˜¾ç¤ºå›¾ç‰‡
                    requestAnimationFrame(() => {
                        if (!imageContainer || !imageContainer.parentNode) {
                            return;
                        }
                        
                        // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ å›¾ç‰‡
                        imageContainer.innerHTML = '';
                        imageContainer.appendChild(img);
                        
                        // æ·»åŠ åŠ è½½å®Œæˆç±»
                        setTimeout(() => {
                            img.classList.add('loaded', 'quick-load');
                        }, 10);
                        
                        // æ›´æ–°çŠ¶æ€
                        imageContainer.dataset.loaded = 'true';
                        imageContainer.dataset.loading = 'false';
                        
                        // æ¸…ç†abortController
                        delete imageContainer.abortController;
                    });
                    
                    // ç¼“å­˜åˆ° loadedImages
                    if (!state.loadedImages[productCode]) {
                        state.loadedImages[productCode] = mainImageUrl;
                    }
                    
                    // å¦‚æœè´­ç‰©è½¦ä¸­å·²æœ‰è¯¥å•†å“ï¼Œæ›´æ–°æ¡ç›®çš„ image
                    const cartItem = state.cart.items.find(it => it.code === productCode);
                    if (cartItem && !cartItem.image) {
                        cartItem.image = mainImageUrl;
                        state.cart.save();
                        state.cart.updateUI();
                    }
                };
                
                img.onerror = () => {
                    // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                    clearTimeout(timeoutId);
                    
                    // æ£€æŸ¥åŠ è½½æ˜¯å¦è¢«å–æ¶ˆ
                    if (controller.signal.aborted || imageContainer.dataset.loadId !== loadId) {
                        return;
                    }
                    
                    showNoImagePlaceholder(imageContainer);
                    imageContainer.dataset.loading = 'false';
                    delete imageContainer.abortController;
                };
                
                img.src = mainImageUrl;
                
                // å¦‚æœå›¾ç‰‡å·²ç»åœ¨ç¼“å­˜ä¸­
                if (img.complete) {
                    if (img.naturalWidth > 0) {
                        img.onload();
                    } else {
                        img.onerror();
                    }
                }
            } else {
                // æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ
                if (controller.signal.aborted) return;
                
                // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„è¶…æ—¶
                if (timeoutId) clearTimeout(timeoutId);
                
                showNoImagePlaceholder(imageContainer);
                imageContainer.dataset.loading = 'false';
                delete imageContainer.abortController;
            }
        } catch (error) {
            console.error(`åŠ è½½å•†å“å›¾ç‰‡å¤±è´¥: ${productCode}`, error);
            
            // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
            if (timeoutId) clearTimeout(timeoutId);
            
            // æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ
            if (controller.signal.aborted) return;
            
            showNoImagePlaceholder(imageContainer);
            imageContainer.dataset.loading = 'false';
            delete imageContainer.abortController;
        }
    }

    // ========== å…³é”®ä¿®å¤ï¼šæ¸…ç†å›¾ç‰‡åŠ è½½çŠ¶æ€ ==========
    function cleanupImageLoadingStates() {
        // æ¸…ç†æ‰€æœ‰å›¾ç‰‡å®¹å™¨çš„åŠ è½½çŠ¶æ€
        document.querySelectorAll('.product-image[data-loading="true"]').forEach(container => {
            // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„åŠ è½½
            if (container.abortController) {
                container.abortController.abort();
                delete container.abortController;
            }
            
            // é‡ç½®çŠ¶æ€
            container.dataset.loading = 'false';
            container.dataset.loaded = 'false';
            delete container.dataset.loadId;
            delete container.dataset.cardCode;
        });
    }

    // æ˜¾ç¤ºæ— å›¾ç‰‡å ä½ç¬¦
    function showNoImagePlaceholder(container) {
        if (container.dataset.loaded === 'true') return;
        
        container.innerHTML = `
            <div class="image-placeholder">
                <i class="fas fa-image"></i>
                <p>${translate('noImage')}</p>
            </div>
        `;
        container.dataset.loaded = 'true';
        container.dataset.loading = 'false';
    }

    // ========== å…³é”®ä¿®å¤ï¼šä¼˜åŒ–çš„å•†å“è¯¦æƒ…é¡µå›¾ç‰‡åŠ è½½ï¼ˆå¤ç”¨å•†å“å¡ç‰‡å·²åŠ è½½å›¾ç‰‡ï¼‰==========
    // æ·»åŠ ä¸€ä¸ªçŠ¶æ€è·Ÿè¸ªå™¨
    let currentCarouselLoadId = 0;

    // ========== æ–°å‡½æ•°ï¼šå¿«é€ŸåŠ è½½å•†å“è¯¦æƒ…ä¸»å›¾ï¼ˆå¤ç”¨å¡ç‰‡å·²åŠ è½½å›¾ç‰‡ï¼‰==========
    function quickLoadDetailMainImage(productCode, container, loadId) {
        // æ£€æŸ¥æ˜¯å¦å·²ä»å•†å“å¡ç‰‡åŠ è½½è¿‡è¯¥å›¾ç‰‡
        if (state.loadedImages[productCode]) {
            const cachedUrl = state.loadedImages[productCode];
            
            const img = new Image();
            img.src = cachedUrl;
            img.alt = productCode;
            img.className = 'detail-image';
            img.decoding = 'async';
            
            // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ å›¾ç‰‡
            container.innerHTML = '';
            container.appendChild(img);
            
            // ç«‹å³æ˜¾ç¤º
            requestAnimationFrame(() => {
                if (loadId !== currentCarouselLoadId) return;
                img.classList.add('loaded', 'quick-load');
            });
            
            // æ·»åŠ ç‚¹å‡»æ”¾å¤§åŠŸèƒ½
            img.addEventListener('click', function() {
                openImageModal(productCode, cachedUrl, 0);
            });
            
            console.log(`å•†å“ ${productCode} å¤ç”¨å·²åŠ è½½çš„ä¸»å›¾ç‰‡`);
            return { success: true, url: cachedUrl };
        }
        
        return { success: false };
    }

    // ========== æ–°å‡½æ•°ï¼šåˆå§‹åŒ–ç¼©ç•¥å›¾éª¨æ¶å± ==========
    function initializeThumbnailSkeletons() {
        const thumbnailContainer = document.getElementById('thumbnail-container');
        if (!thumbnailContainer) return;
        
        // æ¸…ç©ºå®¹å™¨
        thumbnailContainer.innerHTML = '';
        
        // åˆ›å»º4ä¸ªéª¨æ¶å±ç¼©ç•¥å›¾ï¼ˆé¢„ä¼°æ•°é‡ï¼Œå®é™…æ•°é‡å¯èƒ½ä¸åŒï¼‰
        for (let i = 0; i < 4; i++) {
            const thumbnail = document.createElement('div');
            thumbnail.className = `thumbnail ${i === 0 ? 'active' : ''}`;
            thumbnail.dataset.index = i;
            thumbnail.dataset.skeleton = 'true';
            thumbnail.dataset.loading = 'false';
            
            // æ˜¾ç¤ºéª¨æ¶å±å ä½ç¬¦
            thumbnail.innerHTML = '<div class="skeleton-placeholder" style="width: 100%; height: 100%;"></div>';
            
            // æ·»åŠ åˆ°å®¹å™¨
            thumbnailContainer.appendChild(thumbnail);
        }
    }

    // ========== å…³é”®ä¿®æ”¹ï¼šå¼‚æ­¥æŸ¥æ‰¾å¹¶åŠ è½½è¯¦æƒ…é¡µå›¾ç‰‡ï¼ˆç«‹å³æ˜¾ç¤ºç¼©ç•¥å›¾ï¼‰==========
    async function asyncLoadDetailImages(productCode, loadId) {
        try {
            // å¯åŠ¨éªŒè¯ç³»ç»Ÿ
            thumbnailVerification.startVerification(productCode);
            
            // å…ˆå°è¯•å¿«é€ŸåŠ è½½å·²ç¼“å­˜çš„å›¾ç‰‡
            const mainContainer = document.getElementById('carousel-main-image');
            const quickLoadResult = quickLoadDetailMainImage(productCode, mainContainer, loadId);
            
            // ========== å…³é”®ä¿®å¤ï¼šç«‹å³åˆå§‹åŒ–ç¼©ç•¥å›¾éª¨æ¶å± ==========
            initializeThumbnailSkeletons();
            
            // ========== å…³é”®ä¿®æ”¹ï¼šå¼‚æ­¥æŸ¥æ‰¾å›¾ç‰‡ï¼Œä½†ç«‹å³å¼€å§‹å¤„ç† ==========
            // å…ˆæŸ¥æ‰¾ä¸»å›¾ç‰‡ï¼ˆè¿™ä¸ªå¾ˆå¿«ï¼Œå› ä¸ºå¤§éƒ¨åˆ†å·²ç»åœ¨ç¼“å­˜ä¸­ï¼‰
            const mainImagePromise = findMainImage(productCode);
            
            // åŒæ—¶å¼€å§‹æŸ¥æ‰¾é™„åŠ å›¾ç‰‡
            const additionalImagesPromise = findAdditionalImages(productCode);
            
            // å¤„ç†ä¸»å›¾ç‰‡
            mainImagePromise.then(mainImageUrl => {
                if (loadId !== currentCarouselLoadId) return;
                
                // å¦‚æœå¿«é€ŸåŠ è½½å¤±è´¥ï¼Œåˆ™ä½¿ç”¨æŸ¥æ‰¾åˆ°çš„ä¸»å›¾
                if (!quickLoadResult.success && mainImageUrl) {
                    const mainImg = new Image();
                    mainImg.className = 'detail-image';
                    mainImg.alt = productCode;
                    mainImg.decoding = 'async';
                    mainImg.loading = 'eager';
                    
                    mainImg.onload = () => {
                        if (loadId !== currentCarouselLoadId) return;
                        mainImg.classList.add('loaded', 'quick-load');
                        
                        // ä¸»å›¾åŠ è½½å®Œæˆåï¼Œè®¾ç½®ç‚¹å‡»äº‹ä»¶ï¼ˆéœ€è¦ç­‰æ‰€æœ‰å›¾ç‰‡æŸ¥æ‰¾å®Œæˆï¼‰
                        mainImg.addEventListener('click', function() {
                            // å¼‚æ­¥è·å–æ‰€æœ‰å›¾ç‰‡
                            Promise.all([mainImagePromise, additionalImagesPromise]).then(([mainUrl, additionalUrls]) => {
                                const allImages = mainUrl ? [mainUrl, ...additionalUrls] : additionalUrls;
                                if (allImages.length > 0) {
                                    openImageModal(productCode, allImages[0], 0);
                                }
                            });
                        });
                    };
                    
                    mainImg.src = mainImageUrl;
                    mainContainer.innerHTML = '';
                    mainContainer.appendChild(mainImg);
                }
            });
            
            // å¤„ç†é™„åŠ å›¾ç‰‡
            additionalImagesPromise.then(additionalImages => {
                if (loadId !== currentCarouselLoadId) return;
                
                // è·å–ä¸»å›¾ç‰‡ï¼ˆå¯èƒ½å·²ç»ç¼“å­˜ï¼‰
                mainImagePromise.then(mainImageUrl => {
                    if (loadId !== currentCarouselLoadId) return;
                    
                    const allImages = mainImageUrl ? [mainImageUrl, ...additionalImages] : additionalImages;
                    
                    // æ›´æ–°çŠ¶æ€
                    state.currentCarouselImages = allImages;
                    state.currentProductCode = productCode;
                    
                    if (allImages.length > 0) {
                        // å¼‚æ­¥åŠ è½½ç¼©ç•¥å›¾ï¼ˆå·²ç»æœ‰éª¨æ¶å±äº†ï¼Œç°åœ¨ç”¨å®é™…å›¾ç‰‡æ›¿æ¢ï¼‰
                        if (allImages.length > 1) {
                            loadThumbnailsAsync(allImages, productCode, loadId);
                        } else {
                            // åªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œç§»é™¤éª¨æ¶å±
                            const thumbnailContainer = document.getElementById('thumbnail-container');
                            if (thumbnailContainer) {
                                thumbnailContainer.innerHTML = '';
                            }
                        }
                    } else {
                        // æ²¡æœ‰å›¾ç‰‡çš„æƒ…å†µ
                        const thumbnailContainer = document.getElementById('thumbnail-container');
                        if (thumbnailContainer) {
                            thumbnailContainer.innerHTML = '';
                        }
                    }
                    
                    // å»¶è¿Ÿæ‰§è¡ŒéªŒè¯åˆ†æ
                    setTimeout(() => {
                        thumbnailVerification.verifyImmediateDisplay();
                    }, 3000);
                });
            }).catch(error => {
                console.error('åŠ è½½é™„åŠ å›¾ç‰‡å¤±è´¥:', error);
                if (loadId !== currentCarouselLoadId) return;
                
                // ç§»é™¤éª¨æ¶å±
                const thumbnailContainer = document.getElementById('thumbnail-container');
                if (thumbnailContainer) {
                    thumbnailContainer.innerHTML = '';
                }
            });
            
        } catch (error) {
            console.error('åŠ è½½å•†å“è½®æ’­å›¾å¤±è´¥:', error);
            if (loadId !== currentCarouselLoadId) return;
            showCarouselError(document.getElementById('carousel-main-image'), productCode);
        }
    }

    // ========== å…³é”®ä¿®æ”¹ï¼šç¼©ç•¥å›¾å¼‚æ­¥ç‹¬ç«‹åŠ è½½ï¼ˆå•ä¸ªåŠ è½½å®Œå°±ç«‹å³æ˜¾ç¤ºï¼‰==========
    function loadThumbnailsAsync(images, productCode, loadId) {
        const thumbnailContainer = document.getElementById('thumbnail-container');
        if (!thumbnailContainer) return;
        
        // è·å–ç°æœ‰çš„éª¨æ¶å±æ•°é‡
        const skeletonCount = thumbnailContainer.querySelectorAll('.thumbnail[data-skeleton="true"]').length;
        
        // å¦‚æœéª¨æ¶å±æ•°é‡ä¸å¤Ÿï¼Œå…ˆæ¸…ç©º
        if (skeletonCount < images.length) {
            thumbnailContainer.innerHTML = '';
            
            // åˆ›å»ºè¶³å¤Ÿçš„éª¨æ¶å±
            for (let i = 0; i < images.length; i++) {
                const thumbnail = document.createElement('div');
                thumbnail.className = `thumbnail ${i === 0 ? 'active' : ''}`;
                thumbnail.dataset.index = i;
                thumbnail.dataset.skeleton = 'true';
                thumbnail.dataset.loading = 'false';
                thumbnail.dataset.url = images[i];
                
                // æ˜¾ç¤ºéª¨æ¶å±å ä½ç¬¦
                thumbnail.innerHTML = '<div class="skeleton-placeholder" style="width: 100%; height: 100%;"></div>';
                
                // æ·»åŠ åˆ°å®¹å™¨
                thumbnailContainer.appendChild(thumbnail);
                
                // ç«‹å³å¼€å§‹å¼‚æ­¥åŠ è½½è¿™ä¸ªç¼©ç•¥å›¾ï¼ˆä½†æ¯ä¸ªæœ‰å»¶è¿Ÿï¼‰
                setTimeout(() => {
                    if (loadId !== currentCarouselLoadId) return;
                    loadSingleThumbnailAsync(thumbnail, images[i], i, productCode, loadId);
                }, i * 100);
            }
        } else {
            // éª¨æ¶å±æ•°é‡è¶³å¤Ÿï¼Œç›´æ¥æ›¿æ¢
            const thumbnails = thumbnailContainer.querySelectorAll('.thumbnail');
            thumbnails.forEach((thumbnail, index) => {
                if (index < images.length) {
                    thumbnail.dataset.skeleton = 'false';
                    thumbnail.dataset.url = images[index];
                    
                    // ç«‹å³å¼€å§‹å¼‚æ­¥åŠ è½½è¿™ä¸ªç¼©ç•¥å›¾ï¼ˆä½†æ¯ä¸ªæœ‰å»¶è¿Ÿï¼‰
                    setTimeout(() => {
                        if (loadId !== currentCarouselLoadId) return;
                        loadSingleThumbnailAsync(thumbnail, images[index], index, productCode, loadId);
                    }, index * 100);
                } else {
                    // å¤šä½™çš„éª¨æ¶å±ç§»é™¤
                    thumbnail.remove();
                }
            });
        }
    }

    // ========== å…³é”®ä¿®å¤ï¼šå•ä¸ªç¼©ç•¥å›¾ç«‹å³æ˜¾ç¤ºç‰ˆæœ¬ ==========
    function loadSingleThumbnailAsync(thumbnail, url, index, productCode, loadId) {
        // è®°å½•å¼€å§‹åŠ è½½æ—¶é—´
        const loadStartTime = Date.now();
        thumbnail.dataset.loadStart = loadStartTime;
        thumbnail.dataset.loading = 'true';
        
        // è®°å½•éªŒè¯æ—¥å¿—
        thumbnailVerification.logEvent(index, 'å¼€å§‹åŠ è½½', url, loadStartTime);
        
        // æ£€æŸ¥æ˜¯å¦è¿˜æ˜¯å½“å‰çš„åŠ è½½ä»»åŠ¡
        if (loadId !== currentCarouselLoadId) {
            return;
        }
        
        const img = new Image();
        img.alt = `${translate('thumbnail')} ${index + 1}`;
        img.decoding = 'async';
        img.loading = 'eager';
        
        // ç›‘å¬åŠ è½½å®Œæˆäº‹ä»¶
        img.addEventListener('load', function onImageLoad() {
            // è®°å½•åŠ è½½å®Œæˆæ—¶é—´
            const loadEndTime = Date.now();
            const loadDuration = loadEndTime - loadStartTime;
            thumbnail.dataset.loadEnd = loadEndTime;
            thumbnail.dataset.loading = 'false';
            
            thumbnailVerification.logEvent(index, `åŠ è½½å®Œæˆ (è€—æ—¶: ${loadDuration}ms)`, url, loadEndTime);
            
            // å†æ¬¡æ£€æŸ¥æ˜¯å¦è¿˜æ˜¯å½“å‰çš„åŠ è½½ä»»åŠ¡
            if (loadId !== currentCarouselLoadId) {
                return;
            }
            
            // å…³é”®ä¿®å¤ï¼šç«‹å³æ˜¾ç¤ºå›¾ç‰‡ï¼Œä¸è¦å»¶è¿ŸåŠ¨ç”»
            const displayStartTime = Date.now();
            
            // 1. ç«‹å³ç§»é™¤éª¨æ¶å±ï¼ˆä¸è¦ç­‰å¾…åŠ¨ç”»ï¼‰
            const placeholder = thumbnail.querySelector('.skeleton-placeholder');
            if (placeholder && placeholder.parentNode === thumbnail) {
                placeholder.style.opacity = '0';
                placeholder.style.transition = 'opacity 100ms ease'; // æ”¹ä¸ºå¿«é€Ÿæ·¡å‡º
                
                // ç«‹å³å¼€å§‹æ·¡å‡ºåŠ¨ç”»ï¼Œä¸ç­‰å¾…
                requestAnimationFrame(() => {
                    placeholder.style.opacity = '0';
                });
            }
            
            // 2. ç«‹å³è®¾ç½®å›¾ç‰‡å¹¶æ˜¾ç¤º
            thumbnail.style.position = 'relative';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'contain';
            img.style.position = 'absolute';
            img.style.top = '0';
            img.style.left = '0';
            img.style.opacity = '0';
            img.style.transition = 'opacity 150ms ease'; // å¿«é€Ÿæ·¡å…¥
            
            // æ·»åŠ åˆ°DOM
            thumbnail.appendChild(img);
            
            // 3. ç«‹å³è§¦å‘æ·¡å…¥åŠ¨ç”»
            requestAnimationFrame(() => {
                // å…ˆç§»é™¤éª¨æ¶å±
                if (placeholder && placeholder.parentNode === thumbnail) {
                    placeholder.remove();
                }
                
                // ç„¶åæ·¡å…¥å›¾ç‰‡
                img.style.opacity = '1';
                img.classList.add('loaded');
                
                // è®°å½•æ˜¾ç¤ºå®Œæˆæ—¶é—´
                const displayEndTime = Date.now();
                const displayDelay = displayEndTime - loadEndTime;
                
                // éªŒè¯æ˜¯å¦ç«‹å³æ˜¾ç¤º
                if (displayDelay < 50) {
                    thumbnailVerification.logEvent(index, `âœ… ç«‹å³æ˜¾ç¤º (å»¶è¿Ÿ: ${displayDelay}ms)`, url, displayEndTime);
                } else {
                    thumbnailVerification.logEvent(index, `âš ï¸ å»¶è¿Ÿæ˜¾ç¤º (å»¶è¿Ÿ: ${displayDelay}ms)`, url, displayEndTime);
                }
                
                thumbnail.dataset.displayed = 'true';
                thumbnail.dataset.displayTime = displayEndTime;
                
                // 150msåç§»é™¤è¿‡æ¸¡æ•ˆæœï¼Œé¿å…å½±å“åç»­äº¤äº’
                setTimeout(() => {
                    img.style.transition = 'none';
                    img.style.position = 'static';
                }, 150);
            });
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            thumbnail.addEventListener('click', function onThumbnailClick() {
                if (loadId !== currentCarouselLoadId) return;
                switchToImage(index, state.currentCarouselImages, productCode);
            });
            
            // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤è§¦å‘
            img.removeEventListener('load', onImageLoad);
        });
        
        img.addEventListener('error', function onImageError() {
            // è®°å½•åŠ è½½å¤±è´¥æ—¶é—´
            const errorTime = Date.now();
            thumbnail.dataset.loading = 'false';
            thumbnail.dataset.error = 'true';
            
            thumbnailVerification.logEvent(index, 'åŠ è½½å¤±è´¥', url, errorTime);
            
            // æ£€æŸ¥æ˜¯å¦è¿˜æ˜¯å½“å‰çš„åŠ è½½ä»»åŠ¡
            if (loadId !== currentCarouselLoadId) {
                return;
            }
            
            // ç«‹å³ç§»é™¤éª¨æ¶å±
            const placeholder = thumbnail.querySelector('.skeleton-placeholder');
            if (placeholder && placeholder.parentNode === thumbnail) {
                placeholder.remove();
            }
            
            // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
            thumbnail.innerHTML = `
                <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
                    <div style="text-align: center; padding: 5px;">
                        <i class="fas fa-exclamation-triangle" style="color: #e74c3c; font-size: 16px;"></i>
                        <div style="font-size: 9px; color: #e74c3c; margin-top: 2px;">åŠ è½½å¤±è´¥</div>
                    </div>
                </div>
            `;
            
            // æ›´æ–°æ•°æ®å±æ€§
            thumbnail.dataset.skeleton = 'false';
            
            // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
            img.removeEventListener('error', onImageError);
        });
        
        // å¼€å§‹åŠ è½½å›¾ç‰‡
        setTimeout(() => {
            if (loadId !== currentCarouselLoadId) {
                return;
            }
            img.src = url;
            
            // å¦‚æœå›¾ç‰‡å·²ç»åœ¨ç¼“å­˜ä¸­ï¼Œç«‹å³è§¦å‘loadäº‹ä»¶
            if (img.complete) {
                if (img.naturalWidth > 0) {
                    img.dispatchEvent(new Event('load'));
                } else {
                    img.dispatchEvent(new Event('error'));
                }
            }
        }, index * 100);
    }

    // ========== å…³é”®ä¿®å¤ï¼šä¼˜åŒ–çš„å•†å“è¯¦æƒ…é¡µå›¾ç‰‡åŠ è½½å‡½æ•° ==========
    async function loadProductCarousel(productCode) {
        // ç”Ÿæˆå½“å‰åŠ è½½çš„å”¯ä¸€ID
        const loadId = ++currentCarouselLoadId;
        
        // æ¸…ç†æ—§çš„åŠ è½½çŠ¶æ€
        const mainImageContainer = document.getElementById('carousel-main-image');
        
        if (mainImageContainer) {
            mainImageContainer.innerHTML = '<div class="skeleton-placeholder"></div>';
        }
        
        // ========== å…³é”®ä¿®å¤ï¼šç«‹å³å¼€å§‹å¼‚æ­¥åŠ è½½è¯¦æƒ…é¡µå›¾ç‰‡ ==========
        // è¿™é‡Œä¸ä¼šç­‰å¾…ï¼Œä¼šç«‹å³æ˜¾ç¤ºéª¨æ¶å±å¹¶å¼€å§‹åŠ è½½
        asyncLoadDetailImages(productCode, loadId);
    }

    function showCarouselError(container, productCode) {
        container.innerHTML = `
            <div class="image-error">
                <i class="fas fa-exclamation-triangle"></i>
                <p>${translate('loadingFailed')}</p>
                <button class="retry-btn" onclick="retryLoadCarousel('${productCode}')">
                    <i class="fas fa-redo"></i> ${translate('retry')}
                </button>
            </div>
        `;
    }

    async function retryLoadCarousel(productCode) {
        // æ¸…é™¤ç¼“å­˜
        imageCache.delete(`detail_${productCode}`);
        imageCache.delete(`additional_${productCode}`);
        imageCache.delete(`main_${productCode}`);
        
        // é‡æ–°åŠ è½½
        loadProductCarousel(productCode);
    }

    // ========== ä¿®æ”¹ï¼šåˆ‡æ¢å›¾ç‰‡å‡½æ•° ==========
    function switchToImage(index, images, productCode) {
        const mainContainer = document.getElementById('carousel-main-image');
        const url = images[index];
        
        if (url) {
            const newImg = new Image();
            newImg.alt = productCode;
            newImg.className = 'detail-image';
            newImg.decoding = 'async';
            
            newImg.onload = function() {
                newImg.classList.add('loaded', 'quick-load');
                mainContainer.innerHTML = '';
                mainContainer.appendChild(newImg);
                
                newImg.addEventListener('click', function() {
                    openImageModal(productCode, url, index);
                });
                
                // æ›´æ–°ç¼©ç•¥å›¾é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.thumbnail').forEach((thumb, i) => {
                    thumb.classList.toggle('active', i === index);
                });
            };
            
            newImg.onerror = function() {
                mainContainer.innerHTML = `
                    <div class="image-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>${translate('imageLoadError')}</p>
                        <button class="retry-btn" onclick="switchToImage(${index}, ${JSON.stringify(images)}, '${productCode}')">
                            <i class="fas fa-redo"></i> ${translate('retry')}
                        </button>
                    </div>
                `;
            };
            
            newImg.src = url;
            
            // å¦‚æœå›¾ç‰‡å·²ç»åœ¨ç¼“å­˜ä¸­
            if (newImg.complete) {
                newImg.onload();
            }
        }
    }

    // åˆå§‹åŒ–æ‡’åŠ è½½
    function initializeLazyLoading() {
        if ('IntersectionObserver' in window) {
            lazyImageObserver = new IntersectionObserver((entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        const imageContainer = entry.target;
                        const productCode = imageContainer.dataset.code;

                        if (productCode && imageContainer.dataset.loading !== 'true' && imageContainer.dataset.loaded !== 'true') {
                            loadProductCardImage(imageContainer, productCode);
                            lazyImageObserver.unobserve(imageContainer);
                        }
                    }
                });
            }, {
                rootMargin: '200px 0px',
                threshold: 0.01
            });
        }
    }

    // æ‰¹é‡å›¾ç‰‡é¢„åŠ è½½
    function preloadVisibleImages() {
        const viewportHeight = window.innerHeight;
        const scrollPosition = window.scrollY;
        
        const imageContainers = document.querySelectorAll('.product-image:not([data-loaded]):not([data-loading])');
        
        imageContainers.forEach(container => {
            const rect = container.getBoundingClientRect();
            const productCode = container.dataset.code;
            
            // é¢„åŠ è½½å¯è§åŒºåŸŸé™„è¿‘çš„å›¾ç‰‡ï¼ˆä¸Šä¸‹200pxï¼‰
            if (rect.top < viewportHeight + 200 && rect.bottom > -200) {
                loadProductCardImage(container, productCode);
            }
        });
    }

    // è®¾ç½®å•†å“å¡ç‰‡å›¾ç‰‡æ‡’åŠ è½½
    function setupProductCardLazyLoading() {
        // å…³é”®ä¿®å¤ï¼šåœ¨é‡æ–°è®¾ç½®æ‡’åŠ è½½å‰ï¼Œæ¸…ç†æ—§çš„åŠ è½½çŠ¶æ€
        cleanupImageLoadingStates();
        
        if (lazyImageObserver) {
            lazyImageObserver.disconnect();
        }
        
        initializeLazyLoading();
        
        const imageContainers = document.querySelectorAll('.product-image:not([data-loaded])');
        imageContainers.forEach(container => {
            // å…³é”®ä¿®å¤ï¼šç¡®ä¿å®¹å™¨æœ‰æ­£ç¡®çš„productCode
            const productCode = container.dataset.code;
            if (!productCode) {
                // å°è¯•ä»çˆ¶å…ƒç´ è·å–productCode
                const productCard = container.closest('.product-card');
                if (productCard && productCard.dataset.code) {
                    container.dataset.code = productCard.dataset.code;
                }
            }
            
            if (lazyImageObserver) {
                lazyImageObserver.observe(container);
            } else {
                const productCode = container.dataset.code;
                if (productCode) {
                    loadProductCardImage(container, productCode);
                }
            }
        });
    }

    // ========== å›¾ç‰‡æ¨¡æ€æ¡† ==========
    function openImageModal(partCode, imageUrl, imageIndex = 0) {
        const modal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const modalImageInfo = document.getElementById('modal-image-info');
        
        modalImage.style.opacity = '0';
        modalImage.src = imageUrl;
        modalImage.alt = partCode;
        modalImageInfo.textContent = `${partCode} - ${translate('image')} ${imageIndex + 1}`;
        
        modalImage.onload = function() {
            modalImage.style.opacity = '1';
        };
        
        modalImage.onerror = function() {
            modalImageInfo.textContent = `${translate('imageNotFound')}: ${partCode}`;
            modalImage.src = '';
        };
        
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeImageModal() {
        const modal = document.getElementById('image-modal');
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    // ========== å…¨å±€çŠ¶æ€å’Œæ ¸å¿ƒåŠŸèƒ½ ==========
    const state = {
        currentLanguage: localStorage.getItem('product_language') || 'en-US',
        jsonData: null,
        sheetNames: [],
        productsBySheet: {},
        allProducts: [],
        selectedSheet: null,
        selectedProduct: null,
        currentView: 'sheets',
        searchTerm: '',
        filteredProducts: [],
        isSearchMode: false,
        loadedImages: {},
        pagination: {
            currentPage: 1,
            itemsPerPage: 12,
            totalItems: 0,
            totalPages: 1,
            loadedItems: 0,
            isLoading: false
        },
        cart: {
            items: [],
            load() {
                const saved = localStorage.getItem('product_cart');
                if (saved) {
                    this.items = JSON.parse(saved);
                }
                this.updateUI();
            },
            save() {
                localStorage.setItem('product_cart', JSON.stringify(this.items));
                this.updateUI();
            },
            add(product, quantity = 1, brandKey = 'no_brand') {
                const productCode = safeGetValue(product, ['CODE', 'code'], '');
                const brandDisplay = brandMappings[state.currentLanguage][brandKey] || brandKey;
                const existingItem = this.items.find(item => 
                    item.code === productCode && item.selectedBrandKey === brandKey
                );
                
                if (existingItem) {
                    existingItem.quantity += quantity;
                    existingItem.selectedBrand = brandDisplay;
                } else {
                    this.items.push({
                        code: productCode,
                        originalCode: safeGetValue(product, 'originalCode', productCode),
                        name: product.MODEL || product.NAME || product.model || product.name || 'æœªå‘½åå•†å“',
                        sheetName: product.sheetName,
                        specs: product.SPECS || product.specs || product['FITS MACHINE'] || product['fits machine'] || '',
                        quantity: quantity,
                        brand: product.BRAND || product.brand || '',
                        selectedBrandKey: brandKey,
                        selectedBrand: brandDisplay,
                        price: product.PRICE || product.price || 0,
                        image: state.loadedImages[productCode] || null
                    });
                }
                this.save();
                (async () => {
                    try {
                        const imgUrl = await findMainImage(productCode);
                        if (imgUrl) {
                            const it = this.items.find(item => item.code === productCode && item.selectedBrandKey === brandKey);
                            if (it && !it.image) {
                                it.image = imgUrl;
                                state.loadedImages[productCode] = imgUrl;
                                this.save();
                                this.updateUI();
                            }
                        }
                    } catch (e) {
                        // å¿½ç•¥æŸ¥æ‰¾é”™è¯¯
                    }
                })();
                this.showNotification(translate('cartNotification'));
            },
            update(code, quantity) {
                const item = this.items.find(item => item.code === code);
                if (item) {
                    if (quantity <= 0) {
                        this.remove(code);
                    } else {
                        item.quantity = quantity;
                        this.save();
                    }
                }
            },
            remove(code) {
                this.items = this.items.filter(item => item.code !== code);
                this.save();
                this.showNotification(translate('cartRemoved'));
            },
            clear() {
                this.items = [];
                this.save();
                this.showNotification(translate('cartCleared'));
            },
            getTotalItems() {
                return this.items.reduce((total, item) => total + item.quantity, 0);
            },
            getTotalPrice() {
                return this.items.reduce((total, item) => total + (item.price * item.quantity), 0);
            },
            updateUI() {
                document.getElementById('cart-count').textContent = this.getTotalItems();
                this.renderCart();
                updateCartButtonStates();
            },
            renderCart() {
                const cartContent = document.getElementById('cart-content');
                
                if (this.items.length === 0) {
                    cartContent.innerHTML = `
                        <div class="empty-state" id="empty-cart">
                            <i class="fas fa-shopping-cart"></i>
                            <h3 id="empty-cart-title">${translate('emptyCartTitle')}</h3>
                            <p id="empty-cart-message">${translate('emptyCartMessage')}</p>
                        </div>
                    `;
                    document.getElementById('cart-total-items').textContent = '0';
                    return;
                }
                
                let cartHTML = '';
                
                this.items.forEach((item, index) => {
                    cartHTML += `
                        <div class="cart-item" data-index="${index}" data-code="${item.code}">
                            ${item.image ? `<img src="${item.image}" alt="${item.code}" class="cart-item-image">` : 
                            `<div class="cart-item-image" style="display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
                                <i class="fas fa-box" style="color: #95a5a6;"></i>
                            </div>`}
                            <div class="cart-item-info">
                                <div class="cart-item-name">${item.name}</div>
                                <div class="cart-item-code">${item.code}</div>
                                <div class="cart-item-original-code">${item.originalCode}</div>
                                ${item.selectedBrand ? `<div class="cart-item-brand" style="font-size: 12px; color: #27ae60; margin-bottom: 5px;">å“ç‰Œ: ${item.selectedBrand}</div>` : ''}
                                <div class="cart-item-sheet">${item.sheetName}</div>
                                <div class="cart-item-controls">
                                    <div class="quantity-control">
                                        <button type="button" class="quantity-btn decrease-quantity" data-code="${item.code}">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <input type="number" class="quantity-input" value="${item.quantity}" min="1" data-code="${item.code}">
                                        <button type="button" class="quantity-btn increase-quantity" data-code="${item.code}">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <button type="button" class="remove-item" data-code="${item.code}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                cartContent.innerHTML = cartHTML;
                document.getElementById('cart-total-items').textContent = this.getTotalItems();
                this.bindCartEvents();
            },
            bindCartEvents() {
                const cartContent = document.getElementById('cart-content');
                
                this.items.forEach(item => {
                    const code = item.code;
                    
                    const decreaseBtn = cartContent.querySelector(`.decrease-quantity[data-code="${code}"]`);
                    if (decreaseBtn) {
                        decreaseBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (item.quantity > 1) {
                                this.update(code, item.quantity - 1);
                            } else {
                                if (confirm(translate('confirmRemove'))) {
                                    this.remove(code);
                                }
                            }
                        });
                    }
                    
                    const increaseBtn = cartContent.querySelector(`.increase-quantity[data-code="${code}"]`);
                    if (increaseBtn) {
                        increaseBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.update(code, item.quantity + 1);
                        });
                    }
                    
                    const removeBtn = cartContent.querySelector(`.remove-item[data-code="${code}"]`);
                    if (removeBtn) {
                        removeBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (confirm(translate('confirmRemove'))) {
                                this.remove(code);
                            }
                        });
                    }
                    
                    const quantityInput = cartContent.querySelector(`.quantity-input[data-code="${code}"]`);
                    if (quantityInput) {
                        quantityInput.addEventListener('change', (e) => {
                            e.stopPropagation();
                            const newQuantity = parseInt(e.target.value);
                            if (!isNaN(newQuantity) && newQuantity > 0) {
                                this.update(code, newQuantity);
                            } else {
                                e.target.value = item.quantity;
                            }
                        });
                    }
                });
            },
            showNotification(message) {
                const existingNotification = document.querySelector('.cart-notification');
                if (existingNotification) {
                    existingNotification.remove();
                }
                
                const notification = document.createElement('div');
                notification.className = 'cart-notification';
                notification.innerHTML = `
                    <i class="fas fa-check-circle"></i> ${message}
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }, 1000);
            },
            async loadImageToBuffer(productCode) {
                const mainImageUrl = await findMainImage(productCode);
                if (!mainImageUrl) return null;
                
                try {
                    const response = await fetch(mainImageUrl);
                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
                    }
                    
                    const blob = await response.blob();
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = function() {
                            resolve(this.result);
                        };
                        reader.onerror = reject;
                        reader.readAsArrayBuffer(blob);
                    });
                } catch (error) {
                    console.warn(`æ— æ³•åŠ è½½å›¾ç‰‡: ${productCode}`, error);
                    return null;
                }
            },
            
            async exportToExcel() {
                if (this.items.length === 0) {
                    alert(translate('cartEmpty'));
                    return;
                }
                
                const exportBtn = document.getElementById('export-cart');
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨ç”ŸæˆExcel...';
                exportBtn.disabled = true;
                
                try {
                    const workbook = new ExcelJS.Workbook();
                    workbook.creator = 'é…ä»¶é€‰è´­ç³»ç»Ÿ';
                    workbook.lastModifiedBy = 'é…ä»¶é€‰è´­ç³»ç»Ÿ';
                    workbook.created = new Date();
                    workbook.modified = new Date();
                    
                    const worksheet = workbook.addWorksheet(
                        state.currentLanguage === 'zh-CN' ? 'è®¢è´­æ¸…å•' : 'Order List'
                    );
                    
                    worksheet.columns = [
                        { header: 'åºå·', key: 'serial', width: 8 },
                        { header: 'å›¾ç‰‡', key: 'image', width: 40 },
                        { header: 'å•†å“ç¼–ç ', key: 'code', width: 20 },
                        { header: 'åŸå§‹ç¼–ç ', key: 'originalCode', width: 20 },
                        { header: 'å•†å“åç§°', key: 'name', width: 30 },
                        { header: 'è§„æ ¼è¯´æ˜', key: 'specs', width: 40 },
                        { header: 'å“ç‰Œ', key: 'brand', width: 15 },
                        { header: 'æ•°é‡', key: 'quantity', width: 10 }
                    ];
                    
                    worksheet.getColumn(2).height = 120;
                    
                    const headerRow = worksheet.getRow(1);
                    headerRow.font = { bold: true, color: { argb: 'FFFFFF' } };
                    headerRow.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: '3498DB' }
                    };
                    headerRow.alignment = { vertical: 'middle', horizontal: 'center' };
                    headerRow.height = 25;
                    
                    headerRow.eachCell((cell) => {
                        cell.border = {
                            top: { style: 'thin', color: { argb: '000000' } },
                            left: { style: 'thin', color: { argb: '000000' } },
                            bottom: { style: 'thin', color: { argb: '000000' } },
                            right: { style: 'thin', color: { argb: '000000' } }
                        };
                    });
                    
                    for (let i = 0; i < this.items.length; i++) {
                        const item = this.items[i];
                        const rowNumber = i + 2;
                        
                        const row = worksheet.addRow({
                            serial: i + 1,
                            image: '',
                            code: item.code || '',
                            originalCode: item.originalCode || '',
                            name: item.name || '',
                            specs: item.specs || '',
                            brand: item.selectedBrand || translate('noBrand'),
                            quantity: item.quantity || 0
                        });
                        
                        row.height = 75;
                        
                        for (let col = 1; col <= 8; col++) {
                            const cell = row.getCell(col);
                            cell.border = {
                                top: { style: 'thin', color: { argb: 'DDDDDD' } },
                                left: { style: 'thin', color: { argb: 'DDDDDD' } },
                                bottom: { style: 'thin', color: { argb: 'DDDDDD' } },
                                right: { style: 'thin', color: { argb: 'DDDDDD' } }
                            };
                            
                            if (col === 1 || col === 8) {
                                cell.alignment = { vertical: 'middle', horizontal: 'center' };
                            } else if (col === 2) {
                                cell.alignment = { vertical: 'middle', horizontal: 'center' };
                            } else {
                                cell.alignment = { vertical: 'middle', horizontal: 'left' };
                            }
                        }
                    }
                    
                    for (let i = 0; i < this.items.length; i++) {
                        const item = this.items[i];
                        const rowNumber = i + 2;
                        const row = worksheet.getRow(rowNumber);
                        
                        try {
                            const imageBuffer = await this.loadImageToBuffer(item.code);
                            if (imageBuffer) {
                                const imageId = workbook.addImage({
                                    buffer: imageBuffer,
                                    extension: 'png'
                                });
                                
                                const colIndex = 1;
                                const rowIndex = rowNumber - 1;
                                
                                worksheet.addImage(imageId, {
                                    tl: { 
                                        col: colIndex, 
                                        row: rowIndex,
                                        offset: 0
                                    },
                                    br: { 
                                        col: colIndex + 1,
                                        row: rowIndex + 1,
                                        offset: 0
                                    },
                                    editAs: 'oneCell'
                                });
                                
                                worksheet.getColumn(colIndex + 1).width = 12;
                                
                            } else {
                                row.getCell(2).value = translate('noImage');
                                row.getCell(2).alignment = { vertical: 'middle', horizontal: 'center' };
                            }
                        } catch (error) {
                            console.warn(`æ— æ³•åŠ è½½å›¾ç‰‡: ${item.code}`, error);
                            row.getCell(2).value = translate('imageNotFound');
                            row.getCell(2).alignment = { vertical: 'middle', horizontal: 'center' };
                        }
                    }
                    
                    const summaryStartRow = this.items.length + 3;
                    
                    const summaryTitleCell = worksheet.getCell(`A${summaryStartRow}`);
                    summaryTitleCell.value = 'æ±‡æ€»ä¿¡æ¯';
                    summaryTitleCell.font = { bold: true, color: { argb: '3498DB' }, size: 12 };
                    summaryTitleCell.border = {
                        top: { style: 'thin', color: { argb: '3498DB' } },
                        left: { style: 'thin', color: { argb: '3498DB' } },
                        bottom: { style: 'thin', color: { argb: '3498DB' } },
                        right: { style: 'thin', color: { argb: '3498DB' } }
                    };
                    
                    worksheet.getCell(`A${summaryStartRow + 1}`).value = 'å•†å“ç§ç±»';
                    worksheet.getCell(`B${summaryStartRow + 1}`).value = this.items.length;
                    
                    worksheet.getCell(`A${summaryStartRow + 2}`).value = 'æ€»æ•°é‡';
                    worksheet.getCell(`B${summaryStartRow + 2}`).value = this.getTotalItems();
                    
                    const currentDate = new Date();
                    const dateFormatter = state.currentLanguage === 'zh-CN' ? 
                        currentDate.toLocaleDateString('zh-CN') : 
                        currentDate.toLocaleDateString('en-US');
                    const timeFormatter = state.currentLanguage === 'zh-CN' ?
                        currentDate.toLocaleTimeString('zh-CN') :
                        currentDate.toLocaleTimeString('en-US');
                    
                    worksheet.getCell(`A${summaryStartRow + 3}`).value = 'å¯¼å‡ºæ—¥æœŸ';
                    worksheet.getCell(`B${summaryStartRow + 3}`).value = dateFormatter;
                    
                    worksheet.getCell(`A${summaryStartRow + 4}`).value = 'å¯¼å‡ºæ—¶é—´';
                    worksheet.getCell(`B${summaryStartRow + 4}`).value = timeFormatter;
                    
                    for (let i = summaryStartRow; i <= summaryStartRow + 4; i++) {
                        const row = worksheet.getRow(i);
                        row.height = 20;
                        
                        const cellA = row.getCell(1);
                        cellA.font = { bold: true };
                        cellA.border = {
                            top: { style: 'thin', color: { argb: 'DDDDDD' } },
                            left: { style: 'thin', color: { argb: 'DDDDDD' } },
                            bottom: { style: 'thin', color: { argb: 'DDDDDD' } },
                            right: { style: 'thin', color: { argb: 'DDDDDD' } }
                        };
                        
                        for (let col = 2; col <= 8; col++) {
                            const cell = row.getCell(col);
                            cell.border = {
                                top: { style: 'thin', color: { argb: 'DDDDDD' } },
                                left: { style: 'thin', color: { argb: 'DDDDDD' } },
                                bottom: { style: 'thin', color: { argb: 'DDDDDD' } },
                                right: { style: 'thin', color: { argb: 'DDDDDD' } }
                            };
                        }
                    }
                    
                    const fileName = state.currentLanguage === 'zh-CN' ? 
                        `è®¢è´­æ¸…å•_${new Date().toISOString().slice(0,10)}.xlsx` :
                        `Order_List_${new Date().toISOString().slice(0,10)}.xlsx`;
                    
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { 
                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                    });
                    
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url);
                    }, 100);
                    
                    this.showNotification(translate('exportSuccess'));
                    
                } catch (error) {
                    console.error('å¯¼å‡ºExcelå¤±è´¥:', error);
                    alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
                } finally {
                    exportBtn.innerHTML = originalText || `<i class="fas fa-file-excel"></i> <span id="export-cart-text">${translate('exportCart')}</span>`;
                    exportBtn.disabled = false;
                }
            }
        },
        selectedProductForCart: null,
        currentCarouselImages: [],
        currentProductCode: ''
    };

    // ========== è¾…åŠ©å‡½æ•° ==========
    function safeToLower(value) {
        if (value === null || value === undefined) return '';
        return String(value).toLowerCase();
    }

    function safeGetValue(obj, keys, defaultValue = '') {
        if (!obj) return defaultValue;
        
        for (const key of Array.isArray(keys) ? keys : [keys]) {
            if (obj[key] !== null && obj[key] !== undefined) {
                return String(obj[key]);
            }
        }
        return defaultValue;
    }

    function translate(key) {
        return translations[state.currentLanguage][key] || key;
    }

    function switchLanguage(lang) {
        if (state.currentLanguage === lang) return;
        
        state.currentLanguage = lang;
        localStorage.setItem('product_language', lang);
        updatePageText();
        updateFlagIcon();
        updateBrandSelect();
        refreshCurrentView();
    }

    function updatePageText() {
        document.getElementById('page-title').textContent = translate('pageTitle');
        document.getElementById('page-subtitle').textContent = translate('pageSubtitle');
        document.getElementById('nav-home').textContent = translate('navHome');
        document.getElementById('nav-machine').textContent = translate('navMachine');
        document.getElementById('nav-cart').textContent = translate('navCart');
        document.getElementById('nav-refresh').textContent = translate('navRefresh');
        document.getElementById('current-language').textContent = state.currentLanguage === 'zh-CN' ? 'ä¸­æ–‡' : 'English';
        document.getElementById('sidebar-title').textContent = translate('sidebarTitle');
        const searchInput = document.getElementById('product-search-input');
        if (searchInput) searchInput.placeholder = translate('searchPlaceholder');
        document.getElementById('data-status-text').textContent = translate('loadingData');
        document.getElementById('cart-title').textContent = translate('cartTitle');
        document.getElementById('empty-cart-title').textContent = translate('emptyCartTitle');
        document.getElementById('empty-cart-message').textContent = translate('emptyCartMessage');
        document.getElementById('cart-total-label').textContent = translate('cartTotal');
        document.getElementById('cart-total-unit').textContent = translate('cartItemsUnit');
        document.getElementById('clear-cart-text').textContent = translate('clearCart');
        document.getElementById('export-cart-text').textContent = translate('exportCart');
        document.getElementById('quantity-modal-title').textContent = translate('selectQuantity');
        document.getElementById('cancel-quantity-text').textContent = translate('cancel');
        document.getElementById('confirm-quantity-text').textContent = translate('confirm');
        document.getElementById('footer-text').textContent = translate('footerText');
    }

    function updateFlagIcon() {
        const languageBtn = document.getElementById('language-btn');
        const flagElement = languageBtn.querySelector('.language-flag');
        
        if (state.currentLanguage === 'zh-CN') {
            flagElement.className = 'language-flag flag-cn';
            flagElement.textContent = 'ä¸­';
        } else {
            flagElement.className = 'language-flag flag-us';
            flagElement.textContent = 'US';
        }
    }

    function updateBrandSelect() {
        const brandSelect = document.getElementById('brand-select');
        if (!brandSelect) return;
        
        const currentValue = brandSelect.value;
        brandSelect.innerHTML = '';
        
        const brandOptions = [
            { key: 'no_brand', label: translate('noBrand') },
            { key: 'kelon', label: translate('kelon') },
            { key: 'lixiong', label: translate('lixiong') }
        ];
        
        brandOptions.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.key;
            optionElement.textContent = option.label;
            brandSelect.appendChild(optionElement);
        });
        
        brandSelect.value = currentValue || 'no_brand';
    }

    // å›¾æ ‡æ˜ å°„
    const sheetIcons = {
        '01': 'fas fa-gas-pump',
        '02': 'fas fa-oil-can',
        '03': 'fas fa-database',
        '04': 'fas fa-coil',
        '05': 'fas fa-cog',
        '06': 'fas fa-oil-can',
        '07': 'fas fa-gas-pump',
        '08': 'fas fa-link',
        '09': 'fas fa-gas-pump',
        '10': 'fas fa-engine',
        '11': 'fas fa-cut',
        '12': 'fas fa-cogs',
        '13': 'fas fa-tire',
        '14': 'fas fa-layer-group',
        '15': 'fas fa-volume-mute',
        '16': 'fas fa-bolt',
        '17': 'fas fa-snowflake',
        '18': 'fas fa-tools',
        '19': 'fas fa-bolt',
        '20': 'fas fa-sliders-h',
        '21': 'fas fa-wind',
        '22': 'fas fa-cut',
        '23': 'fas fa-spray-can',
        '24': 'fas fa-toolbox',
        '25': 'fas fa-wind',
        '26': 'fas fa-filter',
        '27': 'fas fa-hard-hat',
        '28': 'fas fa-cut',
        '29': 'fas fa-gas-pump',
        '30': 'fas fa-tint',
        '31': 'fas fa-question-circle',
        '32': 'fas fa-history',
        '33': 'fas fa-cable-car'
    };

    const defaultIcon = 'fas fa-table';
    let searchDebounceTimer = null;
    let scrollTimer = null;

    // ========== é¡µé¢åˆå§‹åŒ– ==========
    document.addEventListener('DOMContentLoaded', async function() {
        updatePageText();
        updateFlagIcon();
        updateBrandSelect();
        state.cart.load();
        
        await loadJSONData();
        setupEventListeners();
        
        if (state.sheetNames.length > 0) {
            const firstSheet = state.sheetNames[0];
            state.selectedSheet = firstSheet;
            resetPagination();
            showProductsBySheet(firstSheet);
            setTimeout(() => {
                activateSheetInTree(firstSheet);
            }, 100);
        } else {
            showSheetsList();
        }
        
        // åˆå§‹åŒ–æ‡’åŠ è½½
        initializeLazyLoading();
        
        // æ·»åŠ æ»šåŠ¨é¢„åŠ è½½
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimer);
            scrollTimer = setTimeout(() => {
                preloadVisibleImages();
            }, 100);
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåé¢„åŠ è½½é¦–å±å›¾ç‰‡
        setTimeout(() => {
            preloadVisibleImages();
        }, 500);
    });

    // ========== æ•°æ®åŠ è½½å’Œæ˜¾ç¤ºå‡½æ•° ==========
    async function loadJSONData() {
        try {
            const response = await fetch('products_data.json?v=' + Date.now());
            if (!response.ok) throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
            
            const jsonData = await response.json();
            if (!jsonData || typeof jsonData !== 'object') {
                throw new Error('æ— æ•ˆçš„JSONæ•°æ®æ ¼å¼');
            }
            
            state.jsonData = jsonData;
            state.sheetNames = Object.keys(state.jsonData);
            
            processJSONData();
            updateDataStatus(true, translate('dataReady'));
            
            initializeTreeView();
            
        } catch (error) {
            console.error('åŠ è½½JSONæ•°æ®å¤±è´¥:', error);
            updateDataStatus(false, 'åŠ è½½å¤±è´¥: ' + error.message);
            
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i>
                    <h3>æ•°æ®åŠ è½½å¤±è´¥</h3>
                    <p>${error.message}</p>
                    <p>è¯·ç¡®ä¿ products_data.json æ–‡ä»¶å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®</p>
                    <button class="action-button" id="retry-load" style="margin-top: 20px;">
                        <i class="fas fa-redo"></i> ${translate('navRefresh')}
                    </button>
                </div>
            `;
            
            document.getElementById('retry-load')?.addEventListener('click', async () => {
                await loadJSONData();
                initializeTreeView();
                showSheetsList();
            });
        }
    }

    function processJSONData() {
        state.productsBySheet = {};
        state.allProducts = [];
        
        state.sheetNames.forEach(sheetName => {
            const sheetData = state.jsonData[sheetName];
            
            if (Array.isArray(sheetData)) {
                const validProducts = sheetData.filter(item => item && typeof item === 'object');
                
                validProducts.forEach(product => {
                    product.sheetName = sheetName;
                    product.originalCode = safeGetValue(product, ['Original CODE', 'originalCode'], '');
                    product.searchCode = safeToLower(product.CODE || product.code || '');
                    product.searchModel = safeToLower(product.MODEL || product.model || '');
                    product.searchName = safeToLower(product.NAME || product.name || '');
                    product.searchFitsMachine = safeToLower(product['FITS MACHINE'] || product['fits machine'] || '');
                    product.searchSpecs = safeToLower(product.SPECS || product.specs || '');
                    product.searchBrand = safeToLower(product.BRAND || product.brand || '');
                    product.searchType = safeToLower(product.TYPE || product.type || '');
                    product.searchDescription = safeToLower(product.DESCRIPTION || product.description || '');
                    product.searchOriginalCode = safeToLower(product.originalCode);
                });
                
                state.productsBySheet[sheetName] = validProducts;
                state.allProducts = state.allProducts.concat(validProducts);
            } else {
                state.productsBySheet[sheetName] = [];
            }
        });
    }

    function updateDataStatus(success, message) {
        const statusElement = document.getElementById('data-status');
        if (statusElement) {
            const icon = statusElement.querySelector('i');
            const text = statusElement.querySelector('span');
            
            if (success) {
                icon.style.color = '#2ecc71';
                icon.className = 'fas fa-check-circle';
                text.textContent = message;
            } else {
                icon.style.color = '#e74c3c';
                icon.className = 'fas fa-exclamation-circle';
                text.textContent = message;
            }
        }
    }

    // åˆå§‹åŒ–æ ‘å½¢è§†å›¾
    function initializeTreeView() {
        const treeList = document.getElementById('category-tree');
        treeList.innerHTML = '';
        
        state.sheetNames.forEach(sheetName => {
            const productCount = state.productsBySheet[sheetName] ? state.productsBySheet[sheetName].length : 0;
            
            if (productCount === 0) return;
            
            const treeItem = document.createElement('li');
            treeItem.className = 'tree-item';
            treeItem.dataset.sheet = sheetName;
            
            let icon = defaultIcon;
            const matches = sheetName.match(/\d+/);
            if (matches && sheetIcons[matches[0]]) {
                icon = sheetIcons[matches[0]];
            }
            
            treeItem.innerHTML = `
                <div class="tree-header ${state.selectedSheet === sheetName && state.currentView === 'products' && !state.isSearchMode ? 'active' : ''}">
                    <div class="tree-toggle">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="tree-icon">
                        <i class="${icon}"></i>
                    </div>
                    <span>${sheetName}</span>
                    <div class="part-count">${productCount}</div>
                </div>
            `;
            
            const treeHeader = treeItem.querySelector('.tree-header');
            
            treeHeader.addEventListener('click', function(e) {
                e.stopPropagation();
                exitSearchMode();
                
                document.querySelectorAll('.tree-header').forEach(header => {
                    header.classList.remove('active');
                });
                treeHeader.classList.add('active');
                
                state.selectedSheet = sheetName;
                resetPagination();
                showProductsBySheet(sheetName);
            });
            
            treeList.appendChild(treeItem);
        });
    }

    // é€€å‡ºæœç´¢æ¨¡å¼
    function exitSearchMode() {
        state.isSearchMode = false;
        state.searchTerm = '';
        state.filteredProducts = [];
        
        const searchInput = document.getElementById('product-search-input');
        if (searchInput) {
            searchInput.value = '';
        }
        
        if (searchDebounceTimer) {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = null;
        }
    }

    // æ¸…ç©ºæœç´¢
    function clearSearch() {
        exitSearchMode();
        
        if (state.selectedSheet) {
            resetPagination();
            showProductsBySheet(state.selectedSheet);
        } else {
            showSheetsList();
        }
    }

    // é‡ç½®åˆ†é¡µçŠ¶æ€
    function resetPagination() {
        state.pagination.currentPage = 1;
        state.pagination.loadedItems = 0;
        state.pagination.isLoading = false;
    }

    // æ›´æ–°åˆ†é¡µä¿¡æ¯
    function updatePaginationInfo(totalItems) {
        state.pagination.totalItems = totalItems;
        state.pagination.totalPages = Math.ceil(totalItems / state.pagination.itemsPerPage);
        state.pagination.currentPage = Math.min(state.pagination.currentPage, state.pagination.totalPages);
    }

    // æ˜¾ç¤ºå·¥ä½œè¡¨åˆ—è¡¨é¡µé¢
    function showSheetsList() {
        const mainContent = document.getElementById('main-content');
        const totalProducts = state.allProducts.length;
        
        mainContent.innerHTML = `
            <div class="content-header">
                <div class="content-title">${translate('allSheets')}</div>
                <div class="content-subtitle">${translate('dataDescription')}</div>
            </div>
            <div class="empty-state">
                <i class="fas fa-database" style="color: #3498db;"></i>
                <h3>${translate('dataDirectory')}</h3>
                <p>${translate('dataDescription')}</p>
                <div style="margin-top: 20px; text-align: center;">
                    <div style="display: inline-flex; justify-content: center; gap: 30px; margin-bottom: 20px; flex-wrap: wrap;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 600; color: #3498db;">${state.sheetNames.length}</div>
                            <div style="font-size: 12px; color: #6c757d;">${translate('sheetsCount')}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 600; color: #3498db;">${totalProducts}</div>
                            <div style="font-size: 12px; color: #6c757d;">${translate('partsCount')}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        state.currentView = 'sheets';
        state.selectedSheet = null;
        state.selectedProduct = null;
        
        document.querySelectorAll('.tree-header').forEach(header => {
            header.classList.remove('active');
        });
    }

    // åœ¨æ‰€æœ‰å•†å“ä¸­æœç´¢
    function searchAllProducts(searchTerm) {
        if (!searchTerm || searchTerm.trim().length < 1) {
            return [];
        }
        
        const term = searchTerm.toLowerCase().trim();
        const searchWords = term.split(/\s+/).filter(word => word.length > 0);
        
        return state.allProducts.filter(product => {
            if (searchWords.length === 1) {
                const singleWord = searchWords[0];
                return (
                    (product.searchCode && product.searchCode.includes(singleWord)) ||
                    (product.searchOriginalCode && product.searchOriginalCode.includes(singleWord)) ||
                    (product.searchModel && product.searchModel.includes(singleWord)) ||
                    (product.searchName && product.searchName.includes(singleWord)) ||
                    (product.searchFitsMachine && product.searchFitsMachine.includes(singleWord)) ||
                    (product.searchSpecs && product.searchSpecs.includes(singleWord)) ||
                    (product.searchBrand && product.searchBrand.includes(singleWord)) ||
                    (product.searchType && product.searchType.includes(singleWord)) ||
                    (product.searchDescription && product.searchDescription.includes(singleWord)) ||
                    (product.sheetName && safeToLower(product.sheetName).includes(singleWord))
                );
            }
            
            return searchWords.every(word => {
                return (
                    (product.searchCode && product.searchCode.includes(word)) ||
                    (product.searchOriginalCode && product.searchOriginalCode.includes(word)) ||
                    (product.searchModel && product.searchModel.includes(word)) ||
                    (product.searchName && product.searchName.includes(word)) ||
                    (product.searchFitsMachine && product.searchFitsMachine.includes(word)) ||
                    (product.searchSpecs && product.searchSpecs.includes(word)) ||
                    (product.searchBrand && product.searchBrand.includes(word)) ||
                    (product.searchType && product.searchType.includes(word)) ||
                    (product.searchDescription && product.searchDescription.includes(word)) ||
                    (product.sheetName && safeToLower(product.sheetName).includes(word))
                );
            });
        });
    }

    // ========== å…³é”®ä¿®å¤ï¼šæŒ‰å·¥ä½œè¡¨æ˜¾ç¤ºå•†å“ï¼ˆæ¸…ç†åŠ è½½çŠ¶æ€ï¼‰==========
    function showProductsBySheet(sheetName) {
        if (state.isSearchMode) {
            showSearchResults();
            return;
        }
        
        // å…³é”®ä¿®å¤ï¼šåœ¨æ˜¾ç¤ºæ–°å•†å“åˆ—è¡¨å‰æ¸…ç†æ—§çš„åŠ è½½çŠ¶æ€
        cleanupImageLoadingStates();
        
        const products = state.productsBySheet[sheetName] || [];
        updatePaginationInfo(products.length);
        
        const startIndex = (state.pagination.currentPage - 1) * state.pagination.itemsPerPage;
        const endIndex = startIndex + state.pagination.itemsPerPage;
        const currentPageProducts = products.slice(startIndex, endIndex);
        
        const mainContent = document.getElementById('main-content');
        
        mainContent.innerHTML = `
            <div class="content-header">
                <div>
                    <div class="content-title">${sheetName}</div>
                    <div class="content-subtitle">${translate('foundItems')} ${products.length} ${translate('items')}</div>
                </div>
            </div>
            <div class="products-grid" id="products-grid">
                ${currentPageProducts.length > 0 ? 
                    currentPageProducts.map((product, index) => createProductCard(product, index)).join('') 
                    : 
                    `<div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-box-open"></i>
                        <h3>${translate('noProducts')}</h3>
                        <p>${translate('noProductsInSheet')}</p>
                    </div>`
                }
            </div>
            
            ${products.length > state.pagination.itemsPerPage ? createPaginationControls() : ''}
        `;
        
        document.querySelectorAll('.product-card').forEach((card, index) => {
            const product = currentPageProducts[index];
            
            if (product) {
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.cart-button')) {
                        showProductDetail(product, sheetName);
                    }
                });
                
                const cartBtn = card.querySelector('.cart-button');
                if (cartBtn) {
                    cartBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        addToCart(product);
                    });
                }
            }
        });
        
        updateCartButtonStates();
        setupPaginationEvents(sheetName);
        
        state.currentView = 'products';
        state.selectedSheet = sheetName;
        
        setTimeout(() => {
            setupProductCardLazyLoading();
        }, 100);
    }

    // æ›´æ–°è´­ç‰©è½¦æŒ‰é’®çŠ¶æ€
    function updateCartButtonStates() {
        document.querySelectorAll('.product-card').forEach(card => {
            const productCode = card.dataset.code;
            const cartBtn = card.querySelector('.cart-button');
            if (!cartBtn) return;

            const inCart = state.cart.items.some(item => item.code === productCode);
            if (inCart) {
                cartBtn.classList.add('added');
                cartBtn.innerHTML = '<i class="fas fa-check"></i>';
                cartBtn.title = translate('removeFromCart');
            } else {
                cartBtn.classList.remove('added');
                cartBtn.innerHTML = '<i class="fas fa-cart-plus"></i>';
                cartBtn.title = translate('addToCart');
            }
        });
    }

    // åˆ›å»ºå•†å“å¡ç‰‡HTML
    function createProductCard(product, index) {
        const productCode = safeGetValue(product, ['CODE', 'code'], `ITEM_${index}`);
        const productName = safeGetValue(product, ['MODEL', 'model', 'NAME', 'name'], 'æœªå‘½åå•†å“');
        const productSpecs = safeGetValue(product, ['FITS MACHINE', 'fits machine', 'SPECS', 'specs'], '');
        const sheetName = product.sheetName || '';
        const originalCode = safeGetValue(product, ['Original CODE', 'originalCode'], '');
        const inCart = state.cart.items.find(item => item.code === productCode);
        
        return `
            <div class="product-card fade-in" data-code="${productCode}">
                <button class="cart-button ${inCart ? 'added' : ''}" title="${inCart ? translate('removeFromCart') : translate('addToCart')}" data-code="${productCode}">
                    <i class="fas ${inCart ? 'fa-check' : 'fa-cart-plus'}"></i>
                </button>
                <div class="product-image" data-code="${productCode}">
                    <div class="lazy-placeholder">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>${translate('loading')}</span>
                    </div>
                </div>
                <div class="product-info">
                    <div class="product-name" title="${productName}">${productName}</div>
                    ${productSpecs ? `<div class="product-specs" title="${productSpecs}">${productSpecs}</div>` : ''}
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 8px; border-top: 1px solid #eee;">
                        <div style="flex: 1;">
                            <div style="font-size: 12px; color: #3498db; font-weight: 600; font-family: 'Courier New', monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${productCode}">${productCode}</div>
                        </div>
                        ${originalCode ? `
                            <div style="flex: 1; text-align: right;">
                                <div style="font-size: 11px; color: #3498db; font-family: 'Courier New', monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${originalCode}">${originalCode}</div>
                            </div>
                        ` : ''}
                    </div>
                    ${sheetName ? `<div style="font-size: 10px; color: #95a5a6; margin-top: 5px;">${sheetName}</div>` : ''}
                </div>
            </div>
        `;
    }

    // æ˜¾ç¤ºæœç´¢ç»“æœ
    function showSearchResults() {
        const results = state.filteredProducts;
        updatePaginationInfo(results.length);
        
        const startIndex = (state.pagination.currentPage - 1) * state.pagination.itemsPerPage;
        const endIndex = startIndex + state.pagination.itemsPerPage;
        const currentPageProducts = results.slice(startIndex, endIndex);
        
        const mainContent = document.getElementById('main-content');
        
        mainContent.innerHTML = `
            <div class="content-header">
                <div>
                    <div class="content-title">${translate('searchResults')}</div>
                    <div class="content-subtitle">${translate('foundItems')} ${results.length} ${translate('itemsFor')} "${state.searchTerm}"</div>
                </div>
            </div>
            <div class="products-grid" id="products-grid">
                ${currentPageProducts.length > 0 ? 
                    currentPageProducts.map((product, index) => createProductCard(product, index)).join('') 
                    : 
                    `<div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-search"></i>
                        <h3>${translate('noResults')}</h3>
                        <p>${translate('tryOtherKeywords')}</p>
                    </div>`
                }
            </div>
            
            ${results.length > state.pagination.itemsPerPage ? createPaginationControls() : ''}
        `;
        
        document.querySelectorAll('.product-card').forEach((card, index) => {
            const product = currentPageProducts[index];
            
            if (product) {
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.cart-button')) {
                        showProductDetail(product, product.sheetName);
                    }
                });
                
                const cartBtn = card.querySelector('.cart-button');
                if (cartBtn) {
                    cartBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        addToCart(product);
                    });
                }
            }
        });
        
        updateCartButtonStates();
        setupSearchPaginationEvents();
        
        state.currentView = 'products';
        
        setTimeout(() => {
            setupProductCardLazyLoading();
        }, 100);
    }

    // åˆ›å»ºåˆ†é¡µæ§ä»¶
    function createPaginationControls() {
        const pagination = state.pagination;
        const maxVisiblePages = 5;
        let startPage = Math.max(1, pagination.currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(pagination.totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        let pageButtons = '';
        for (let i = startPage; i <= endPage; i++) {
            pageButtons += `
                <button class="pagination-button ${i === pagination.currentPage ? 'active' : ''}" 
                        data-page="${i}">
                    ${i}
                </button>
            `;
        }
        
        return `
            <div class="pagination-container">
                <div class="pagination-info">
                    ${translate('showItems')} ${Math.min((pagination.currentPage - 1) * pagination.itemsPerPage + 1, pagination.totalItems)} 
                    ${translate('to')} ${Math.min(pagination.currentPage * pagination.itemsPerPage, pagination.totalItems)} 
                    ${translate('of')} ${pagination.totalItems} ${translate('items')}
                </div>
                <div class="pagination-controls">
                    <button class="pagination-button" id="first-page" ${pagination.currentPage === 1 ? 'disabled' : ''}>
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                    <button class="pagination-button" id="prev-page" ${pagination.currentPage === 1 ? 'disabled' : ''}>
                        <i class="fas fa-angle-left"></i>
                    </button>
                    
                    <div class="page-numbers">
                        ${pageButtons}
                    </div>
                    
                    <button class="pagination-button" id="next-page" ${pagination.currentPage === pagination.totalPages ? 'disabled' : ''}>
                        <i class="fas fa-angle-right"></i>
                    </button>
                    <button class="pagination-button" id="last-page" ${pagination.currentPage === pagination.totalPages ? 'disabled' : ''}>
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                    
                    <div class="pagination-input-group">
                        <span>${translate('goToPage')}</span>
                        <input type="number" class="pagination-input" id="page-input" 
                            min="1" max="${pagination.totalPages}" 
                            value="${pagination.currentPage}">
                        <span>${translate('page')}</span>
                        <button class="pagination-button" id="go-to-page">${translate('jump')}</button>
                    </div>
                </div>
            </div>
        `;
    }

    // è®¾ç½®åˆ†é¡µäº‹ä»¶
    function setupPaginationEvents(sheetName) {
        document.getElementById('first-page')?.addEventListener('click', () => {
            goToPage(1, sheetName);
        });
        
        document.getElementById('prev-page')?.addEventListener('click', () => {
            goToPage(state.pagination.currentPage - 1, sheetName);
        });
        
        document.getElementById('next-page')?.addEventListener('click', () => {
            goToPage(state.pagination.currentPage + 1, sheetName);
        });
        
        document.getElementById('last-page')?.addEventListener('click', () => {
            goToPage(state.pagination.totalPages, sheetName);
        });
        
        document.querySelectorAll('.pagination-button[data-page]').forEach(button => {
            button.addEventListener('click', (e) => {
                const page = parseInt(e.target.dataset.page);
                goToPage(page, sheetName);
            });
        });
        
        document.getElementById('go-to-page')?.addEventListener('click', () => {
            const input = document.getElementById('page-input');
            const page = parseInt(input.value);
            if (page >= 1 && page <= state.pagination.totalPages) {
                goToPage(page, sheetName);
            } else {
                alert(`è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç  (1-${state.pagination.totalPages})`);
                input.value = state.pagination.currentPage;
            }
        });
        
        document.getElementById('page-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('go-to-page').click();
            }
        });
    }

    // è·³è½¬åˆ°æŒ‡å®šé¡µ
    function goToPage(page, sheetName) {
        if (page < 1 || page > state.pagination.totalPages || page === state.pagination.currentPage) {
            return;
        }
        
        state.pagination.currentPage = page;
        showProductsBySheet(sheetName);
        document.querySelector('.products-grid').scrollTop = 0;
    }

    // è®¾ç½®æœç´¢åˆ†é¡µäº‹ä»¶
    function setupSearchPaginationEvents() {
        document.getElementById('first-page')?.addEventListener('click', () => {
            goToPageSearch(1);
        });
        
        document.getElementById('prev-page')?.addEventListener('click', () => {
            goToPageSearch(state.pagination.currentPage - 1);
        });
        
        document.getElementById('next-page')?.addEventListener('click', () => {
            goToPageSearch(state.pagination.currentPage + 1);
        });
        
        document.getElementById('last-page')?.addEventListener('click', () => {
            goToPageSearch(state.pagination.totalPages);
        });
        
        document.querySelectorAll('.pagination-button[data-page]').forEach(button => {
            button.addEventListener('click', (e) => {
                const page = parseInt(e.target.dataset.page);
                goToPageSearch(page);
            });
        });
        
        document.getElementById('go-to-page')?.addEventListener('click', () => {
            const input = document.getElementById('page-input');
            const page = parseInt(input.value);
            if (page >= 1 && page <= state.pagination.totalPages) {
                goToPageSearch(page);
            } else {
                alert(`è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç  (1-${state.pagination.totalPages})`);
                input.value = state.pagination.currentPage;
            }
        });
        
        document.getElementById('page-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('go-to-page').click();
            }
        });
    }

    // è·³è½¬åˆ°æœç´¢ç»“æœçš„æŒ‡å®šé¡µ
    function goToPageSearch(page) {
        if (page < 1 || page > state.pagination.totalPages || page === state.pagination.currentPage) {
            return;
        }
        
        state.pagination.currentPage = page;
        showSearchResults();
        document.querySelector('.products-grid').scrollTop = 0;
    }

    // ========== å…³é”®ä¿®æ”¹ï¼šæ˜¾ç¤ºå•†å“è¯¦æƒ…é¡µé¢ï¼ˆç«‹å³æ˜¾ç¤ºç¼©ç•¥å›¾éª¨æ¶å±ï¼‰==========
    function showProductDetail(product, sheetName) {
        // å…³é”®ä¿®å¤ï¼šé‡ç½®è½®æ’­åŠ è½½ID
        currentCarouselLoadId = 0;
        
        const productCode = safeGetValue(product, ['CODE', 'code'], 'æœªçŸ¥ç¼–ç ');
        const productName = safeGetValue(product, ['MODEL', 'model', 'NAME', 'name'], 'æœªå‘½åå•†å“');
        const originalCode = safeGetValue(product, ['Original CODE', 'originalCode'], '');
        
        const mainContent = document.getElementById('main-content');
        
        let detailsHtml = '';
        for (const [key, value] of Object.entries(product)) {
            if (key.startsWith('_') || key.startsWith('search')) continue;
            if (key === 'IMAGE' || key === 'image') continue;
            if (key === 'CODE' || key === 'code') continue;
            if (key === 'MODEL' || key === 'model' || key === 'NAME' || key === 'name') continue;
            if (key === 'sheetName') continue;
            if (key === 'originalCode') continue;
            if (key === 'Original CODE') continue;
            
            if (value !== null && value !== undefined && value !== '') {
                const displayValue = typeof value === 'string' ? value : JSON.stringify(value);
                detailsHtml += `
                    <tr>
                        <td class="info-label">${key}</td>
                        <td class="info-value">${displayValue}</td>
                    </tr>
                `;
            }
        }
        
        mainContent.innerHTML = `
            <div class="content-header">
                <div>
                    <div class="content-title">${translate('productDetails')}</div>
                    <div class="detail-code">${translate('productCode')} ${productCode}</div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="action-button" id="back-to-list">
                        <i class="fas fa-arrow-left"></i> ${translate('backToList')}
                    </button>
                    <button class="action-button" id="add-to-cart-detail">
                        <i class="fas fa-cart-plus"></i> ${translate('addToCart')}
                    </button>
                </div>
            </div>
            <div class="product-detail">
                <div class="detail-content slide-in">
                    <div class="detail-image-section" id="detail-image-section">
                        <div class="image-carousel">
                            <div class="carousel-main-image" id="carousel-main-image">
                                <!-- ä¸»å›¾ä¼šç«‹å³åŠ è½½ï¼ˆå¤ç”¨å•†å“å¡ç‰‡å·²åŠ è½½å›¾ç‰‡ï¼‰ -->
                            </div>
                            
                            <div class="thumbnail-container" id="thumbnail-container"></div>
                            
                            <!-- ç§»é™¤åˆ‡æ¢æŒ‰é’® -->
                            <div class="carousel-indicators" id="carousel-indicators"></div>
                            
                            <div class="carousel-info" id="carousel-info" style="display: none;">
                                1 / 1
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-info-section">
                        <div class="info-card">
                            <h3>${translate('basicInfo')}</h3>
                            <table class="info-table">
                                <tr>
                                    <td class="info-label">${translate('productCode')}</td>
                                    <td class="info-value"><span style="font-family: 'Courier New', monospace; font-weight: 600; color: #3498db;">${productCode}</span></td>
                                </tr>
                                ${originalCode ? `<tr>
                                    <td class="info-label">${translate('originalCode')}</td>
                                    <td class="info-value"><span style="font-family: 'Courier New', monospace; font-weight: 600; color: #27ae60;">${originalCode}</span></td>
                                </tr>` : ''}
                                <tr>
                                    <td class="info-label">${translate('productName')}</td>
                                    <td class="info-value">${productName}</td>
                                </tr>
                                <tr>
                                    <td class="info-label">${translate('sheetName')}</td>
                                    <td class="info-value">${sheetName}</td>
                                </tr>
                            </table>
                        </div>
                        
                        ${detailsHtml ? `
                            <div class="info-card">
                                <h3>${translate('detailedInfo')}</h3>
                                <table class="info-table">
                                    ${detailsHtml}
                                </table>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
        
        // å…³é”®ä¿®å¤ï¼šç«‹å³å¼€å§‹åŠ è½½è¯¦æƒ…é¡µå›¾ç‰‡ï¼ˆä¼šç«‹å³æ˜¾ç¤ºç¼©ç•¥å›¾éª¨æ¶å±ï¼‰
        setTimeout(() => {
            loadProductCarousel(productCode);
        }, 50);
        
        document.getElementById('back-to-list').addEventListener('click', () => {
            if (state.isSearchMode) {
                showSearchResults();
            } else if (state.selectedSheet) {
                showProductsBySheet(state.selectedSheet);
            } else {
                showSheetsList();
            }
        });
        
        document.getElementById('add-to-cart-detail').addEventListener('click', () => {
            addToCart(product);
        });
        
        state.currentView = 'detail';
        state.selectedProduct = product;
    }

    // æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦
    function addToCart(product) {
        state.selectedProductForCart = product;
        
        const modal = document.getElementById('quantity-modal');
        const title = document.getElementById('quantity-modal-title');
        const quantityInput = document.getElementById('quantity-input');
        const brandSelect = document.getElementById('brand-select');
        
        const productName = safeGetValue(product, ['MODEL', 'model', 'NAME', 'name'], 'æœªå‘½åå•†å“');
        
        title.textContent = `${translate('selectQuantity')} "${productName}"`;
        quantityInput.value = 1;
        quantityInput.focus();
        quantityInput.select();
        
        modal.classList.add('active');
    }

    // ç¡®è®¤æ·»åŠ åˆ°è´­ç‰©è½¦
    function confirmAddToCart() {
        const quantityInput = document.getElementById('quantity-input');
        const brandSelect = document.getElementById('brand-select');
        const quantity = parseInt(quantityInput.value);
        const brandKey = brandSelect.value;
        
        if (isNaN(quantity) || quantity < 1) {
            alert(translate('enterQuantity'));
            return;
        }
        
        if (state.selectedProductForCart) {
            state.cart.add(state.selectedProductForCart, quantity, brandKey);
            document.getElementById('quantity-modal').classList.remove('active');
            state.selectedProductForCart = null;
        }
    }

    // æ‰§è¡Œæœç´¢åŠŸèƒ½
    function performSearch() {
        const searchTerm = state.searchTerm.trim();
        
        if (searchTerm.length < 1) {
            exitSearchMode();
            
            if (state.selectedSheet) {
                showProductsBySheet(state.selectedSheet);
            } else {
                showSheetsList();
            }
            return;
        }
        
        state.filteredProducts = searchAllProducts(searchTerm);
        state.isSearchMode = true;
        resetPagination();
        showSearchResults();
        
        document.querySelectorAll('.tree-header').forEach(header => {
            header.classList.remove('active');
        });
    }

    // è´­ç‰©è½¦å¼€å…³åŠŸèƒ½
    function toggleCartSidebar() {
        const cartSidebar = document.getElementById('cart-sidebar');
        const cartOverlay = document.getElementById('cart-overlay');
        
        if (cartSidebar.classList.contains('active')) {
            cartSidebar.classList.remove('active');
            cartOverlay.classList.remove('active');
        } else {
            cartSidebar.classList.add('active');
            cartOverlay.classList.add('active');
        }
    }

    // å…³é—­è´­ç‰©è½¦
    function closeCartSidebar() {
        document.getElementById('cart-sidebar').classList.remove('active');
        document.getElementById('cart-overlay').classList.remove('active');
    }

    function refreshCurrentView() {
        if (state.currentView === 'sheets') {
            showSheetsList();
        } else if (state.currentView === 'products') {
            if (state.isSearchMode) {
                showSearchResults();
            } else if (state.selectedSheet) {
                showProductsBySheet(state.selectedSheet);
            }
        } else if (state.currentView === 'detail') {
            showProductDetail(state.selectedProduct, state.selectedSheet);
        }
    }

    function activateSheetInTree(sheetName) {
        document.querySelectorAll('.tree-header').forEach(header => {
            header.classList.remove('active');
        });
        
        const sheetHeader = document.querySelector(`.tree-item[data-sheet="${sheetName}"] .tree-header`);
        if (sheetHeader) {
            sheetHeader.classList.add('active');
        }
    }

    // ========== äº‹ä»¶ç›‘å¬å™¨ ==========
    function setupEventListeners() {
        // è¯­è¨€åˆ‡æ¢
        const languageBtn = document.getElementById('language-btn');
        const languageDropdown = document.getElementById('language-dropdown');
        const languageOptions = document.querySelectorAll('.language-option');
        
        languageBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            languageDropdown.classList.toggle('active');
        });
        
        languageOptions.forEach(option => {
            option.addEventListener('click', function() {
                const lang = this.dataset.lang;
                switchLanguage(lang);
                languageOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                languageDropdown.classList.remove('active');
            });
        });
        
        document.addEventListener('click', function() {
            languageDropdown.classList.remove('active');
        });
        
        // å•†å“æœç´¢æ¡†äº‹ä»¶
        const searchInput = document.getElementById('product-search-input');
        const clearSearchBtn = document.getElementById('clear-search');
        
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value;
            state.searchTerm = searchTerm;
            
            if (searchDebounceTimer) {
                clearTimeout(searchDebounceTimer);
            }
            
            if (!searchTerm.trim()) {
                clearSearch();
                return;
            }
            
            searchDebounceTimer = setTimeout(() => {
                performSearch();
            }, 300);
        });
        
        clearSearchBtn.addEventListener('click', function() {
            clearSearch();
        });
        
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (searchDebounceTimer) {
                    clearTimeout(searchDebounceTimer);
                }
                performSearch();
            }
        });
        
        // å›¾ç‰‡æ¨¡æ€æ¡†äº‹ä»¶
        document.getElementById('modal-close').addEventListener('click', closeImageModal);
        
        document.getElementById('image-modal').addEventListener('click', function(e) {
            if (e.target === this || e.target.classList.contains('modal-image')) {
                closeImageModal();
            }
        });
        
        // è´­ç‰©è½¦ç›¸å…³äº‹ä»¶
        document.getElementById('view-cart').addEventListener('click', function(e) {
            e.stopPropagation();
            toggleCartSidebar();
        });
        
        document.getElementById('cart-close').addEventListener('click', function() {
            closeCartSidebar();
        });
        
        document.getElementById('cart-overlay').addEventListener('click', function() {
            closeCartSidebar();
        });
        
        document.getElementById('cart-sidebar').addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        document.getElementById('clear-cart').addEventListener('click', function() {
            if (confirm(translate('confirmClearCart'))) {
                state.cart.clear();
            }
        });
        
        document.getElementById('export-cart').addEventListener('click', function() {
            state.cart.exportToExcel();
        });
        
        // æ•°é‡é€‰æ‹©æ¨¡æ€æ¡†äº‹ä»¶
        document.getElementById('cancel-quantity').addEventListener('click', function() {
            document.getElementById('quantity-modal').classList.remove('active');
            state.selectedProductForCart = null;
        });
        
        document.getElementById('confirm-quantity').addEventListener('click', confirmAddToCart);
        
        document.getElementById('quantity-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmAddToCart();
            }
        });
        
        document.getElementById('brand-select').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmAddToCart();
            }
        });
        
        // åˆ·æ–°æ•°æ®æŒ‰é’®
        document.getElementById('refresh-data').addEventListener('click', async () => {
            // æ¸…ç†å›¾ç‰‡ç¼“å­˜
            try {
                imageLoadingPromises.clear();
                imageCache.clear();
                if (lazyImageObserver) {
                    try { lazyImageObserver.disconnect(); } catch (e) { /* ignore */ }
                    lazyImageObserver = null;
                }
            } catch (e) {
                console.warn('åˆ·æ–°æ—¶æ¸…ç†å›¾ç‰‡ç¼“å­˜å¤±è´¥', e);
            }

            await loadJSONData();
            initializeTreeView();
            if (state.sheetNames.length > 0) {
                const firstSheet = state.sheetNames[0];
                state.selectedSheet = firstSheet;
                resetPagination();
                clearSearch();
                showProductsBySheet(firstSheet);
                activateSheetInTree(firstSheet);
            } else {
                showSheetsList();
            }
        });
        
        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageModal();
                document.getElementById('quantity-modal').classList.remove('active');
                closeCartSidebar();
                
                if (state.currentView === 'detail') {
                    if (state.isSearchMode) {
                        showSearchResults();
                    } else if (state.selectedSheet) {
                        showProductsBySheet(state.selectedSheet);
                    } else {
                        showSheetsList();
                    }
                }
            }
        });
    }
</script>
</body>
</html>