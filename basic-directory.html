<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基础配件目录 - 选购系统</title>
    <link rel="icon" href="Info/Title.jpg" type="image/jpeg">
    <link rel="apple-touch-icon" href="Info/Title.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <!-- 预连接优化 -->
    <link rel="preconnect" href=".">
    <link rel="dns-prefetch" href=".">
    
    <!-- 开发者工具检测和防护脚本 -->
    <!-- <script src="devtools-detection.js"></script> -->
    
    <style>
        /* ========== 新增：防止文本选择和右键菜单的样式 ========== */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        img {
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
        }
        
        /* ========== 修改：完全移除图片模态框中的切换按钮 ========== */
        #image-modal .modal-prev,
        #image-modal .modal-next {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            width: 0 !important;
            height: 0 !important;
            pointer-events: none !important;
        }
        
        /* ========== 新增：图片加载优化样式 ========== */
        .product-image {
            position: relative;
            overflow: hidden;
            background: #f8f9fa;
            will-change: contents;
        }
        
        /* 骨架屏动画 */
        .skeleton-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .product-image img {
            opacity: 0;
            transition: opacity 0.3s ease;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .product-image img.loaded {
            opacity: 1;
        }
        
        /* 详情页图片优化 */
        .carousel-main-image {
            position: relative;
            min-height: 300px;
            background: #f8f9fa;
        }
        
        .carousel-main-image img.detail-image {
            transition: opacity 0.3s ease;
            opacity: 0;
        }
        
        .carousel-main-image img.detail-image.loaded {
            opacity: 1;
        }
        
        /* 图片缩略图加载优化 */
        .thumbnail img {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .thumbnail img.loaded {
            opacity: 1;
        }
        
        /* 懒加载占位符 */
        .lazy-placeholder {
            width: 100%;
            height: 100%;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #95a5a6;
        }
        
        /* 快速加载动画 */
        .quick-load {
            animation: quickFadeIn 0.2s ease;
        }
        
        @keyframes quickFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* 性能优化：减少重绘 */
        .product-card {
            will-change: transform;
            transform: translateZ(0);
            backface-visibility: hidden;
        }
        
        .product-image img {
            will-change: opacity;
        }
        
        /* 图片加载错误状态 */
        .image-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #e74c3c;
            font-size: 12px;
        }
        
        .image-error i {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        /* 图片重试按钮 */
        .retry-btn {
            margin-top: 10px;
            padding: 4px 8px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .retry-btn:hover {
            background: #2980b9;
        }
        
        /* ========== 修改：优化图片加载样式 ========== */
        @keyframes fadeInImage {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* ========== 原始CSS样式保持不变 ========== */
        /* 语言切换按钮样式 */
        .language-switcher {
            position: relative;
            display: flex;
            align-items: center;
            margin-right: 15px;
        }
        
        .language-btn {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #495057;
            transition: all 0.2s ease;
        }
        
        .language-btn:hover {
            background: #e9ecef;
            border-color: #3498db;
        }
        
        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-width: 120px;
            z-index: 100;
            display: none;
        }
        
        .language-dropdown.active {
            display: block;
        }
        
        .language-option {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s ease;
        }
        
        .language-option:hover {
            background: #f8f9fa;
        }
        
        .language-option.active {
            background: #3498db;
            color: white;
        }
        
        .language-flag {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .flag-cn {
            background: #de2910;
            color: #ffde00;
        }
        
        .flag-us {
            background: #3c3b6e;
            color: white;
        }
        
        /* 分页控件样式 */
        .pagination-container {
            padding: 20px 25px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-info {
            font-size: 14px;
            color: #6c757d;
            white-space: nowrap;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .pagination-button {
            padding: 8px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            color: #495057;
            transition: all 0.2s ease;
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination-button:hover:not(:disabled) {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-button.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .page-numbers {
            display: flex;
            gap: 5px;
        }

        .pagination-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }

        .pagination-input {
            width: 50px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 13px;
        }

        .pagination-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .pagination-input-group span {
            font-size: 13px;
            color: #6c757d;
        }

        /* 卡片加载动画 */
        .product-card {
            animation: fadeIn 0.5s ease forwards;
            opacity: 0;
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .product-name {
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
            line-height: 1.4;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-word;
            max-height: 2.8em;
        }

        /* 商品规格信息限制高度 */
        .product-specs {
            font-size: 12px;
            color: #7f8c8d;
            line-height: 1.4;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-word;
            max-height: 2.8em;
        }

        /* 搜索框样式 */
        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 10px 10px 35px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #3498db;
        }

        .search-box .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #95a5a6;
            font-size: 14px;
        }

        .search-box .clear-search {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #95a5a6;
            cursor: pointer;
            font-size: 14px;
            display: none;
        }

        .search-box input:not(:placeholder-shown) + .clear-search {
            display: block;
        }

        /* 购物车按钮样式 */
        .cart-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            opacity: 0;
        }

        .product-card:hover .cart-button {
            opacity: 1;
        }

        .cart-button:hover {
            background: #2980b9;
            transform: scale(1.1);
        }

        .cart-button.added {
            background: #27ae60;
        }

        /* 购物车遮罩层 */
        .cart-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .cart-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* 购物车侧边栏 */
        .cart-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .cart-sidebar.active {
            right: 0;
        }

        .cart-header {
            padding: 20px;
            background: #3498db;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .cart-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .cart-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .cart-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            gap: 15px;
        }

        .cart-item-image {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .cart-item-code {
            font-size: 12px;
            color: #7f8c8d;
            font-family: 'Courier New', monospace;
            margin-bottom: 3px;
        }

        .cart-item-original-code {
            font-size: 11px;
            color: #95a5a6;
            font-family: 'Courier New', monospace;
            margin-bottom: 5px;
        }

        .cart-item-sheet {
            font-size: 11px;
            color: #95a5a6;
            margin-bottom: 8px;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quantity-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity-btn:hover {
            background: #f8f9fa;
        }

        .quantity-input {
            width: 50px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .remove-item {
            color: #e74c3c;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .cart-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            background: #f8f9fa;
        }

        .cart-total {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .cart-actions {
            display: flex;
            gap: 10px;
        }

        .cart-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .cart-btn.primary {
            background: #3498db;
            color: white;
        }

        .cart-btn.primary:hover {
            background: #2980b9;
        }

        .cart-btn.secondary {
            background: #95a5a6;
            color: white;
        }

        .cart-btn.secondary:hover {
            background: #7f8c8d;
        }

        .cart-btn.danger {
            background: #e74c3c;
            color: white;
        }

        .cart-btn.danger:hover {
            background: #c0392b;
        }

        /* 购物车通知 */
        .cart-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* 数量选择模态框 */
        .quantity-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .quantity-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .quantity-modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .quantity-modal-title {
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .quantity-input-large {
            width: 100%;
            padding: 12px;
            border: 2px solid #3498db;
            border-radius: 4px;
            font-size: 16px;
            text-align: center;
            margin-bottom: 15px;
        }

        .brand-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 20px;
            background-color: white;
            cursor: pointer;
        }

        .brand-select:focus {
            outline: none;
            border-color: #3498db;
        }

        .quantity-modal-actions {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .modal-btn.primary {
            background: #3498db;
            color: white;
        }

        .modal-btn.secondary {
            background: #95a5a6;
            color: white;
        }

        /* 购物车徽章 */
        .cart-badge {
            position: relative;
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            font-size: 11px;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        /* ========== 修改：商品网格布局样式 ========== */
        /* 商品网格布局 - 一行4个 */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            padding: 25px;
            min-height: 300px;
            transition: all 0.3s ease;
        }

        /* 商品卡片样式调整 - 图片占2/3 */
        .product-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 0;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            height: 400px;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.5s ease forwards;
            opacity: 0;
            overflow: hidden;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: #3498db;
        }

        /* 商品图片区域调整 - 占卡片高度的2/3 */
        .product-image {
            width: 100%;
            height: 270px;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex-shrink: 0;
        }

        .product-card:hover .product-image img {
            transform: scale(1.05);
        }

        /* 商品信息区域调整 - 占卡片高度的1/3 */
        .product-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 15px;
            height: 130px;
        }

        /* 图片加载状态 */
        .image-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #95a5a6;
            font-size: 12px;
        }

        .image-loading i {
            font-size: 24px;
            margin-bottom: 8px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .image-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #95a5a6;
            font-size: 12px;
        }

        .image-placeholder i {
            font-size: 32px;
            margin-bottom: 8px;
        }

        /* ========== 修改：图片轮播样式 ========== */
        .image-carousel {
            position: relative;
            width: 100%;
            height: 600px;
            border-radius: 8px;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
        }

        .carousel-main-image {
            width: 100%;
            height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            background: #f8f9fa;
        }

        .carousel-main-image img {
            max-width: 90%;
            max-height: 90%;
            width: auto;
            height: auto;
            object-fit: contain;
            cursor: zoom-in;
            transition: opacity 0.3s ease;
            display: block;
            margin: 0 auto;
        }

        .carousel-main-image img.fade-in {
            animation: fadeInImage 0.5s ease;
        }

        @keyframes fadeInImage {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* 缩略图容器 */
        .thumbnail-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            gap: 10px;
            padding: 10px;
            overflow-x: auto;
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid #eee;
            height: 100px;
            z-index: 5;
        }

        .thumbnail {
            width: 80px;
            height: 80px;
            flex-shrink: 0;
            border: 2px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 2px;
        }

        .thumbnail:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .thumbnail.active {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(52, 152, 219, 0.8);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .carousel-btn:hover {
            background: rgba(52, 152, 219, 1);
            transform: translateY(-50%) scale(1.1);
        }

        .carousel-btn:disabled {
            background: rgba(149, 165, 166, 0.5);
            cursor: not-allowed;
            transform: translateY(-50%);
        }

        .carousel-btn:disabled:hover {
            background: rgba(149, 165, 166, 0.5);
            transform: translateY(-50%);
        }

        .carousel-btn.prev-btn {
            left: 15px;
        }

        .carousel-btn.next-btn {
            right: 15px;
        }

        .carousel-indicators {
            position: absolute;
            bottom: 110px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 8px;
            z-index: 10;
        }

        .indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(149, 165, 166, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .indicator:hover {
            background: rgba(52, 152, 219, 0.8);
        }

        .indicator.active {
            background: #3498db;
            transform: scale(1.2);
        }

        .carousel-info {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            z-index: 10;
            display: none;
        }

        /* 图片占位符 */
        .image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #95a5a6;
            font-size: 12px;
            background: #f8f9fa;
        }

        /* 响应式调整 */
        @media (max-width: 1200px) {
            .products-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 992px) {
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                padding: 15px;
            }
            
            .product-card {
                height: 360px;
            }
            
            .product-image {
                height: 240px;
            }
            
            .product-info {
                height: 120px;
                padding: 12px;
            }
            
            .product-name {
                font-size: 13px;
                margin-bottom: 5px;
            }
            
            .product-specs {
                font-size: 11px;
                margin-bottom: 6px;
                -webkit-line-clamp: 2;
                max-height: 2.4em;
            }
            
            .pagination-container {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }
            
            .pagination-controls {
                justify-content: center;
            }
            
            .page-numbers {
                order: 3;
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
            
            .cart-sidebar {
                width: 100%;
                right: -100%;
            }
            
            .cart-button {
                opacity: 1;
            }
            
            .language-switcher {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .image-carousel {
                height: 500px;
            }
            
            .carousel-main-image {
                height: 400px;
            }
            
            .thumbnail {
                width: 60px;
                height: 60px;
            }
            
            .thumbnail-container {
                height: 80px;
            }
            
            .carousel-btn {
                width: 36px;
                height: 36px;
            }
        }

        @media (max-width: 576px) {
            .products-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 12px;
            }
            
            .product-card {
                height: 320px;
            }
            
            .product-image {
                height: 213px;
            }
            
            .product-info {
                height: 107px;
                padding: 10px;
            }
            
            .image-carousel {
                height: 450px;
            }
            
            .carousel-main-image {
                height: 350px;
            }
            
            .thumbnail {
                width: 50px;
                height: 50px;
            }
            
            .thumbnail-container {
                height: 70px;
            }
        }
    </style>
</head>
<body>
    <!-- 简单验证脚本 -->
    <script>
        (function() {
            try {
                const token = localStorage.getItem('uly_access_token');
                if (!token) {
                    window.location.href = 'auth.html';
                    return;
                }
                
                const data = JSON.parse(atob(token));
                const now = Date.now();
                
                if (now >= data.expires) {
                    localStorage.removeItem('uly_access_token');
                    window.location.href = 'auth.html';
                }
            } catch (error) {
                localStorage.removeItem('uly_access_token');
                window.location.href = 'auth.html';
            }
        })();
    </script>
    
    <!-- 购物车遮罩层 -->
    <div class="cart-overlay" id="cart-overlay"></div>
    
    <!-- 购物车侧边栏 -->
    <div class="cart-sidebar" id="cart-sidebar">
        <div class="cart-header">
            <h3 id="cart-title">购物车</h3>
            <button class="cart-close" id="cart-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="cart-content" id="cart-content">
            <div class="empty-state" id="empty-cart">
                <i class="fas fa-shopping-cart"></i>
                <h3 id="empty-cart-title">购物车为空</h3>
                <p id="empty-cart-message">请添加商品到购物车</p>
            </div>
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <span id="cart-total-label">总计:</span> <span id="cart-total-items">0</span> <span id="cart-total-unit">件商品</span>
            </div>
            <div class="cart-actions">
                <button class="cart-btn danger" id="clear-cart">
                    <i class="fas fa-trash"></i> <span id="clear-cart-text">清空</span>
                </button>
                <button class="cart-btn secondary" id="export-cart">
                    <i class="fas fa-file-excel"></i> <span id="export-cart-text">导出Excel</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 数量选择模态框 -->
    <div class="quantity-modal" id="quantity-modal">
        <div class="quantity-modal-content">
            <div class="quantity-modal-title" id="quantity-modal-title">选择数量和品牌</div>
            <input type="number" class="quantity-input-large" id="quantity-input" min="1" value="1" autofocus>
            <select class="brand-select" id="brand-select">
                <option value="no_brand">无品牌</option>
                <option value="kelon">科龙</option>
                <option value="lixiong">力雄</option>
            </select>
            <div class="quantity-modal-actions">
                <button class="modal-btn secondary" id="cancel-quantity">
                    <span id="cancel-quantity-text">取消</span>
                </button>
                <button class="modal-btn primary" id="confirm-quantity">
                    <span id="confirm-quantity-text">确认</span>
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 顶部导航栏 -->
        <div class="top-nav">
            <div class="logo">
                <i class="fas fa-tools logo-icon"></i>
                <div class="logo-text">
                    <h1 id="page-title">基础配件目录 - 选购系统</h1>
                    <div class="subtitle" id="page-subtitle">选择商品并添加到购物车，生成采购清单</div>
                </div>
            </div>
            <div class="nav-tabs">
                <!-- 语言切换器 -->
                <div class="language-switcher">
                    <button class="language-btn" id="language-btn">
                        <div class="language-flag flag-cn">中</div>
                        <span id="current-language">中文</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="language-dropdown" id="language-dropdown">
                        <div class="language-option active" data-lang="zh-CN">
                            <div class="language-flag flag-cn">中</div>
                            <span>中文</span>
                        </div>
                        <div class="language-option" data-lang="en-US">
                            <div class="language-flag flag-us">US</div>
                            <span>English</span>
                        </div>
                    </div>
                </div>
                
                <a href="index.html" class="nav-tab">
                    <i class="fas fa-home"></i> <span id="nav-home">返回首页</span>
                </a>
                <a href="machine-directory.html" class="nav-tab">
                    <i class="fas fa-tractor"></i> <span id="nav-machine">整机目录</span>
                </a>
                <button class="nav-tab cart-badge" id="view-cart">
                    <i class="fas fa-shopping-cart"></i> <span id="nav-cart">购物车</span>
                    <span class="cart-count" id="cart-count">0</span>
                </button>
                <button class="nav-tab" id="refresh-data">
                    <i class="fas fa-sync-alt"></i> <span id="nav-refresh">刷新数据</span>
                </button>
            </div>
        </div>
        
        <!-- 主内容区域 -->
        <div class="main-area">
            <!-- 侧边栏 - 商品类别树 -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title" id="sidebar-title">工作表列表</div>
                    
                    <!-- 商品搜索框 -->
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="product-search-input" placeholder="在所有商品中搜索...">
                        <button class="clear-search" id="clear-search">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="data-status" id="data-status">
                        <i class="fas fa-circle"></i>
                        <span id="data-status-text">正在加载数据...</span>
                    </div>
                </div>
                
                <!-- 树形分类 -->
                <div class="tree-container">
                    <ul class="tree-list" id="category-tree"></ul>
                </div>
            </div>
            
            <!-- 主内容区 -->
            <div class="main-content" id="main-content"></div>
        </div>
        
        <!-- 图片放大模态框 -->
        <div class="image-modal" id="image-modal">
            <div class="modal-content">
                <button class="modal-close" id="modal-close">
                    <i class="fas fa-times"></i>
                </button>
                <img id="modal-image" class="modal-image" src="" alt="">
                <div class="modal-image-info" id="modal-image-info"></div>
            </div>
        </div>
        
        <footer>
            <p id="footer-text">© 2023 配件目录管理系统 | 基础配件目录 | 数据来源: products_data.json | 图片路径: images/</p>
        </footer>
    </div>

<!-- 添加exceljs库 -->
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
<script>
    // === 图片加载优化核心代码 ===

    // 多语言文本定义
    const translations = {
        'zh-CN': {
            'pageTitle': '基础配件目录 - 选购系统',
            'pageSubtitle': '选择商品并添加到购物车，生成采购清单',
            'navHome': '返回首页',
            'navMachine': '整机目录',
            'navCart': '购物车',
            'navRefresh': '刷新数据',
            'sidebarTitle': '工作表列表',
            'searchPlaceholder': '在所有商品中搜索...',
            'loadingData': '正在加载数据...',
            'dataReady': '数据已就绪',
            'allSheets': '所有工作表',
            'dataDirectory': 'JSON数据目录系统',
            'dataDescription': '基于XLSM转换的配件信息管理系统',
            'sheetsCount': '工作表',
            'partsCount': '基础配件',
            'cartTitle': '购物车',
            'emptyCartTitle': '购物车为空',
            'emptyCartMessage': '请添加商品到购物车',
            'cartTotal': '总计:',
            'cartItemsUnit': '件商品',
            'clearCart': '清空',
            'exportCart': '导出Excel',
            'addToCart': '添加到购物车',
            'removeFromCart': '从购物车移除',
            'cartNotification': '商品已添加到购物车',
            'cartRemoved': '商品已从购物车移除',
            'cartCleared': '购物车已清空',
            'selectQuantity': '选择数量和品牌',
            'cancel': '取消',
            'confirm': '确认',
            'enterQuantity': '请输入有效的数量',
            'productDetails': '商品详情',
            'productCode': '商品编码:',
            'originalCode': '原始编码:',
            'backToList': '返回列表',
            'basicInfo': '基本信息',
            'productName': '商品名称',
            'sheetName': '所属工作表',
            'detailedInfo': '详细信息',
            'searchResults': '搜索结果',
            'foundItems': '共找到',
            'itemsFor': '个商品',
            'noResults': '未找到相关商品',
            'tryOtherKeywords': '请尝试其他搜索关键词',
            'showItems': '显示第',
            'to': '到',
            'of': '条，共',
            'items': '条',
            'goToPage': '跳至',
            'page': '页',
            'jump': '跳转',
            'noProducts': '暂无商品',
            'noProductsInSheet': '该工作表中暂无商品数据',
            'noImage': '无图片',
            'clickToZoom': '点击图片放大查看',
            'imageNotFound': '图片未找到',
            'saveImageAs': '请将图片保存为:',
            'confirmRemove': '确定要从购物车中移除这个商品吗？',
            'confirmClearCart': '确定要清空购物车吗？',
            'cartEmpty': '购物车为空，无法导出',
            'exportSuccess': '订购清单已导出为Excel文件',
            'footerText': '© 2026 配件目录管理系统 | 基础配件目录',
            'noBrand': '无品牌',
            'kelon': '科龙',
            'lixiong': '力雄',
            'loadingFailed': '加载失败',
            'retry': '重试',
            'loading': '加载中...',
            'checkingImages': '检查图片...',
            'imageLoadError': '图片加载错误',
            'checkingImage': '检查图片路径...'
        },
        'en-US': {
            'pageTitle': 'Basic Parts Directory - Selection System',
            'pageSubtitle': 'Select products and add to cart to generate purchase list',
            'navHome': 'Back to Home',
            'navMachine': 'Machine Directory',
            'navCart': 'Shopping Cart',
            'navRefresh': 'Refresh Data',
            'sidebarTitle': 'Worksheet List',
            'searchPlaceholder': 'Search in all products...',
            'loadingData': 'Loading data...',
            'dataReady': 'Data ready',
            'allSheets': 'All Worksheets',
            'dataDirectory': 'JSON Data Directory System',
            'dataDescription': 'Parts information management system converted from XLSM',
            'sheetsCount': 'Worksheets',
            'partsCount': 'Basic Parts',
            'cartTitle': 'Shopping Cart',
            'emptyCartTitle': 'Cart is empty',
            'emptyCartMessage': 'Please add products to cart',
            'cartTotal': 'Total:',
            'cartItemsUnit': 'items',
            'clearCart': 'Clear',
            'exportCart': 'Export Excel',
            'addToCart': 'Add to Cart',
            'removeFromCart': 'Remove from Cart',
            'cartNotification': 'Product added to cart',
            'cartRemoved': 'Product removed from cart',
            'cartCleared': 'Cart cleared',
            'selectQuantity': 'Select quantity and brand',
            'cancel': 'Cancel',
            'confirm': 'Confirm',
            'enterQuantity': 'Please enter a valid quantity',
            'productDetails': 'Product Details',
            'productCode': 'Product Code:',
            'originalCode': 'Original Code:',
            'backToList': 'Back to List',
            'basicInfo': 'Basic Information',
            'productName': 'Product Name',
            'sheetName': 'Worksheet',
            'detailedInfo': 'Detailed Information',
            'searchResults': 'Search Results',
            'foundItems': 'Found',
            'itemsFor': 'items for',
            'noResults': 'No relevant products found',
            'tryOtherKeywords': 'Please try other keywords',
            'showItems': 'Showing',
            'to': 'to',
            'of': 'of',
            'items': 'items',
            'goToPage': 'Go to',
            'page': 'page',
            'jump': 'Go',
            'noProducts': 'No products',
            'noProductsInSheet': 'No product data in this worksheet',
            'noImage': 'No image',
            'clickToZoom': 'Click image to zoom',
            'imageNotFound': 'Image not found',
            'saveImageAs': 'Please save image as:',
            'confirmRemove': 'Are you sure you want to remove this item from cart?',
            'confirmClearCart': 'Are you sure you want to clear the cart?',
            'cartEmpty': 'Cart is empty, cannot export',
            'exportSuccess': 'Order list exported to Excel file',
            'footerText': '© 2026 Parts Directory Management System | Basic Parts Directory',
            'noBrand': 'No Brand',
            'kelon': 'Kelon',
            'lixiong': 'Lixiong',
            'loadingFailed': 'Loading failed',
            'retry': 'Retry',
            'loading': 'Loading...',
            'checkingImages': 'Checking images...',
            'imageLoadError': 'Image load error',
            'checkingImage': 'Checking image path...'
        }
    };

    // 品牌映射
    const brandMappings = {
        'zh-CN': {
            'no_brand': '无品牌',
            'kelon': '科龙',
            'lixiong': '力雄'
        },
        'en-US': {
            'no_brand': 'No Brand',
            'kelon': 'Kelon',
            'lixiong': 'Lixiong'
        }
    };

    // ========== 优化的图片加载系统 ==========
    const imageCache = new Map();
    const imageLoadingPromises = new Map();
    let lazyImageObserver = null;

    // ========== 关键修复：优化的图片检查函数 ==========
    function checkImageExists(url, timeout = 2000) {
        return new Promise((resolve) => {
            const img = new Image();
            let timer;
            
            img.onload = () => {
                clearTimeout(timer);
                resolve(true);
            };
            
            img.onerror = () => {
                clearTimeout(timer);
                resolve(false);
            };
            
            // 关键修复：设置更短的超时时间
            timer = setTimeout(() => {
                img.onload = img.onerror = null;
                img.src = '';
                resolve(false);
            }, timeout);
            
            img.src = url;
        });
    }

    // ========== 关键修复：检查图片是否已缓存 ==========
    function checkIfImageIsCached(url) {
        return new Promise((resolve) => {
            const img = new Image();
            
            img.onload = () => {
                resolve({ cached: true, width: img.naturalWidth, height: img.naturalHeight });
            };
            
            img.onerror = () => {
                resolve({ cached: false });
            };
            
            // 如果图片已经在缓存中，onload会立即触发
            img.src = url;
            
            // 设置一个很小的超时来检测缓存
            setTimeout(() => {
                if (img.complete && img.naturalWidth > 0) {
                    resolve({ cached: true, width: img.naturalWidth, height: img.naturalHeight });
                }
            }, 50);
        });
    }

    // ========== 关键修复：显示已缓存的图片 ==========
    function displayCachedImage(imageContainer, imageUrl, productCode, loadId, controller) {
        // 检查加载是否被取消
        if (controller.signal.aborted || imageContainer.dataset.loadId !== loadId) {
            return;
        }
        
        const img = new Image();
        img.src = imageUrl;
        img.alt = productCode;
        img.className = 'lazy-image';
        img.decoding = 'async';
        
        // 清空容器并添加图片
        imageContainer.innerHTML = '';
        imageContainer.appendChild(img);
        
        // 立即添加loaded类，因为图片已经在缓存中
        requestAnimationFrame(() => {
            img.classList.add('loaded', 'quick-load');
            imageContainer.dataset.loaded = 'true';
            imageContainer.dataset.loading = 'false';
            
            // 清理abortController
            delete imageContainer.abortController;
            
            console.log(`商品 ${productCode} 缓存的图片成功显示`);
        });
        
        // 缓存到 loadedImages
        if (!state.loadedImages[productCode]) {
            state.loadedImages[productCode] = imageUrl;
        }
    }

    // ========== 关键修改：主图片只查找png格式，只从images目录 ==========
    async function findMainImage(productCode) {
        const cacheKey = `main_${productCode}`;
        
        // 快速缓存检查
        if (imageCache.has(cacheKey)) {
            const cached = imageCache.get(cacheKey);
            if (cached.url === null) return null;
            // 10秒内缓存有效
            if (Date.now() - cached.timestamp < 10000) {
                return cached.url;
            }
        }
        
        // 防止重复检查
        if (imageLoadingPromises.has(cacheKey)) {
            return imageLoadingPromises.get(cacheKey);
        }
        
        const checkPromise = (async () => {
            try {
                // 主图片：只有png格式，只在images目录
                const mainImageUrl = `images/${productCode}.png`;
                const exists = await checkImageExists(mainImageUrl);
                
                if (exists) {
                    imageCache.set(cacheKey, { 
                        url: mainImageUrl, 
                        timestamp: Date.now() 
                    });
                    return mainImageUrl;
                }
                
                // 未找到主图片
                imageCache.set(cacheKey, { 
                    url: null, 
                    timestamp: Date.now() 
                });
                return null;
                
            } catch (error) {
                console.warn(`检查主图失败: ${productCode}`, error);
                imageCache.set(cacheKey, { 
                    url: null, 
                    timestamp: Date.now() 
                });
                return null;
            } finally {
                imageLoadingPromises.delete(cacheKey);
            }
        })();
        
        imageLoadingPromises.set(cacheKey, checkPromise);
        return checkPromise;
    }

    // ========== 关键修复：附加图片检查 - 一轮失败就停止 ==========
    async function findAdditionalImages(productCode) {
        const cacheKey = `additional_${productCode}`;
        
        // 检查缓存
        if (imageCache.has(cacheKey)) {
            const cached = imageCache.get(cacheKey);
            if (Date.now() - cached.timestamp < 30000) { // 附加图片缓存30秒
                return cached.images;
            }
        }
        
        // 防止重复检查
        if (imageLoadingPromises.has(cacheKey)) {
            return imageLoadingPromises.get(cacheKey);
        }
        
        const checkPromise = (async () => {
            try {
                const images = [];
                
                // 附加图片格式检查顺序：jpg → png → jpeg
                const formats = ['.jpg', '.png', '.jpeg'];
                
                // 关键修复：智能停止检查逻辑
                let consecutiveFailures = 0;
                const maxConsecutiveFailures = 1; // 关键修改：连续1个变体没找到就停止（一轮失败就结束）
                const maxVariants = 8;  // 最多检查到 (8)
                
                // 只检查带括号的变体图片 (1)-(8)
                for (let i = 1; i <= maxVariants; i++) {
                    // 如果连续1个变体都没找到任何格式的图片，立即停止检查
                    if (consecutiveFailures >= maxConsecutiveFailures) {
                        console.log(`商品 ${productCode}: 变体(${i})未找到任何格式图片，停止检查后续变体`);
                        break;
                    }
                    
                    let foundVariant = false;
                    
                    // 检查当前变体的所有格式（按优先级顺序）
                    for (const format of formats) {
                        const url = `Moreimages/${productCode}(${i})${format}`;
                        
                        try {
                            const exists = await checkImageExists(url);
                            if (exists) {
                                images.push(url);
                                foundVariant = true;
                                consecutiveFailures = 0; // 重置连续失败计数
                                break; // 找到一种格式就够了，跳过其他格式检查
                            }
                        } catch (error) {
                            console.warn(`检查变体图片失败: ${url}`, error);
                        }
                    }
                    
                    // 如果这个变体没找到任何格式的图片，增加连续失败计数
                    if (!foundVariant) {
                        consecutiveFailures++;
                    }
                }
                
                const result = { images, timestamp: Date.now() };
                imageCache.set(cacheKey, result);
                
                return images;
                
            } catch (error) {
                console.warn(`检查附加图片失败: ${productCode}`, error);
                const result = { images: [], timestamp: Date.now() };
                imageCache.set(cacheKey, result);
                return [];
            } finally {
                imageLoadingPromises.delete(cacheKey);
            }
        })();
        
        imageLoadingPromises.set(cacheKey, checkPromise);
        return checkPromise;
    }

    // ========== 为商品详情页优化的图片查找函数 ==========
    async function findImagesForDetailPage(productCode) {
        const cacheKey = `detail_${productCode}`;
        
        // 检查缓存
        if (imageCache.has(cacheKey)) {
            const cached = imageCache.get(cacheKey);
            if (Date.now() - cached.timestamp < 60000) { // 详情页缓存1分钟
                return cached.images;
            }
        }
        
        const checkPromise = (async () => {
            try {
                const allImages = [];
                
                // 1. 先获取主图片（主图只有png格式，在images目录）
                const mainImageUrl = await findMainImage(productCode);
                if (mainImageUrl) {
                    allImages.push(mainImageUrl);
                }
                
                // 2. 获取附加图片
                const additionalImages = await findAdditionalImages(productCode);
                
                // 合并图片，确保不重复
                additionalImages.forEach(img => {
                    if (!allImages.includes(img)) {
                        allImages.push(img);
                    }
                });
                
                const result = { images: allImages, timestamp: Date.now() };
                imageCache.set(cacheKey, result);
                
                return allImages;
                
            } catch (error) {
                console.warn(`查找详情页图片失败: ${productCode}`, error);
                const result = { images: [], timestamp: Date.now() };
                imageCache.set(cacheKey, result);
                return [];
            } finally {
                imageLoadingPromises.delete(cacheKey);
            }
        })();
        
        imageLoadingPromises.set(cacheKey, checkPromise);
        return checkPromise;
    }

    // ========== 关键修复：优化的商品卡片图片加载（解决超时问题）==========
    async function loadProductCardImage(imageContainer, productCode) {
        // 关键修复：添加唯一的加载标识符
        const loadId = `card_${productCode}_${Date.now()}`;
        imageContainer.dataset.loadId = loadId;
        imageContainer.dataset.cardCode = productCode;
        
        // 检查是否正在加载或已加载
        if (imageContainer.dataset.loading === 'true') {
            return;
        }
        
        if (imageContainer.dataset.loaded === 'true') {
            // 如果已加载，确保显示图片
            const existingImg = imageContainer.querySelector('img.lazy-image');
            if (existingImg && existingImg.complete && existingImg.naturalWidth > 0) {
                existingImg.classList.add('loaded');
                return;
            }
            // 如果标记为已加载但实际没有图片，重置状态
            imageContainer.dataset.loaded = 'false';
        }
        
        // 设置加载状态
        imageContainer.dataset.loading = 'true';
        imageContainer.dataset.code = productCode;
        
        // 立即显示骨架屏
        imageContainer.innerHTML = '<div class="skeleton-placeholder"></div>';
        
        // 使用AbortController来支持取消
        const controller = new AbortController();
        imageContainer.abortController = controller;
        
        // 定义超时ID
        let timeoutId = null;
        
        try {
            // 商品卡片只查找主图片
            const mainImageUrl = await findMainImage(productCode);
            
            // 检查是否被取消
            if (controller.signal.aborted) {
                return;
            }
            
            if (mainImageUrl) {
                // 关键修复：先检查图片是否已缓存
                const cachedCheck = await checkIfImageIsCached(mainImageUrl);
                if (cachedCheck.cached) {
                    // 图片已缓存，直接显示
                    displayCachedImage(imageContainer, mainImageUrl, productCode, loadId, controller);
                    return;
                }
                
                const img = new Image();
                img.alt = productCode;
                img.decoding = 'async';
                img.loading = 'lazy';
                img.className = 'lazy-image';
                
                // 关键修复：设置更合理的超时时间（4秒）
                timeoutId = setTimeout(() => {
                    // 检查图片是否已经加载完成
                    if (img.complete && img.naturalWidth > 0) {
                        // 图片已经加载完成，忽略超时
                        return;
                    }
                    
                    if (imageContainer.dataset.loading === 'true' && !controller.signal.aborted) {
                        // 关键修复：不显示错误，只是不设置loaded状态
                        // 图片可能还在加载中，让浏览器继续加载
                        console.log(`商品 ${productCode} 图片加载较慢，继续等待...`);
                    }
                }, 4000);
                
                img.onload = () => {
                    // 关键修复：立即清除超时定时器
                    clearTimeout(timeoutId);
                    
                    // 检查加载是否被取消
                    if (controller.signal.aborted || imageContainer.dataset.loadId !== loadId) {
                        return;
                    }
                    
                    // 直接显示图片
                    requestAnimationFrame(() => {
                        if (!imageContainer || !imageContainer.parentNode) {
                            return;
                        }
                        
                        // 清空容器并添加图片
                        imageContainer.innerHTML = '';
                        imageContainer.appendChild(img);
                        
                        // 添加加载完成类
                        setTimeout(() => {
                            img.classList.add('loaded', 'quick-load');
                        }, 10);
                        
                        // 更新状态
                        imageContainer.dataset.loaded = 'true';
                        imageContainer.dataset.loading = 'false';
                        
                        // 清理abortController
                        delete imageContainer.abortController;
                    });
                    
                    // 缓存到 loadedImages
                    if (!state.loadedImages[productCode]) {
                        state.loadedImages[productCode] = mainImageUrl;
                    }
                    
                    // 如果购物车中已有该商品，更新条目的 image
                    const cartItem = state.cart.items.find(it => it.code === productCode);
                    if (cartItem && !cartItem.image) {
                        cartItem.image = mainImageUrl;
                        state.cart.save();
                        state.cart.updateUI();
                    }
                };
                
                img.onerror = () => {
                    // 清除超时定时器
                    clearTimeout(timeoutId);
                    
                    // 检查加载是否被取消
                    if (controller.signal.aborted || imageContainer.dataset.loadId !== loadId) {
                        return;
                    }
                    
                    showNoImagePlaceholder(imageContainer);
                    imageContainer.dataset.loading = 'false';
                    delete imageContainer.abortController;
                };
                
                img.src = mainImageUrl;
                
                // 如果图片已经在缓存中
                if (img.complete) {
                    if (img.naturalWidth > 0) {
                        img.onload();
                    } else {
                        img.onerror();
                    }
                }
            } else {
                // 检查是否被取消
                if (controller.signal.aborted) return;
                
                // 清除可能存在的超时
                if (timeoutId) clearTimeout(timeoutId);
                
                showNoImagePlaceholder(imageContainer);
                imageContainer.dataset.loading = 'false';
                delete imageContainer.abortController;
            }
        } catch (error) {
            console.error(`加载商品图片失败: ${productCode}`, error);
            
            // 清除超时定时器
            if (timeoutId) clearTimeout(timeoutId);
            
            // 检查是否被取消
            if (controller.signal.aborted) return;
            
            showNoImagePlaceholder(imageContainer);
            imageContainer.dataset.loading = 'false';
            delete imageContainer.abortController;
        }
    }

    // ========== 关键修复：清理图片加载状态 ==========
    function cleanupImageLoadingStates() {
        // 清理所有图片容器的加载状态
        document.querySelectorAll('.product-image[data-loading="true"]').forEach(container => {
            // 取消正在进行的加载
            if (container.abortController) {
                container.abortController.abort();
                delete container.abortController;
            }
            
            // 重置状态
            container.dataset.loading = 'false';
            container.dataset.loaded = 'false';
            delete container.dataset.loadId;
            delete container.dataset.cardCode;
        });
    }

    // 显示无图片占位符
    function showNoImagePlaceholder(container) {
        if (container.dataset.loaded === 'true') return;
        
        container.innerHTML = `
            <div class="image-placeholder">
                <i class="fas fa-image"></i>
                <p>${translate('noImage')}</p>
            </div>
        `;
        container.dataset.loaded = 'true';
        container.dataset.loading = 'false';
    }

    // ========== 优化的商品详情页图片加载 ==========
    // 添加一个状态跟踪器
    let currentCarouselLoadId = 0;

    async function loadProductCarousel(productCode) {
        const mainImageContainer = document.getElementById('carousel-main-image');
        const thumbnailContainer = document.getElementById('thumbnail-container');
        
        // 生成当前加载的唯一ID
        const loadId = ++currentCarouselLoadId;
        
        // 清理旧的加载状态
        mainImageContainer.innerHTML = '';
        thumbnailContainer.innerHTML = '';
        
        // 显示骨架屏
        mainImageContainer.innerHTML = '<div class="skeleton-placeholder"></div>';
        
        try {
            // 使用优化的详情页图片查找函数
            const allImages = await findImagesForDetailPage(productCode);
            
            // 检查是否是最新的加载请求
            if (loadId !== currentCarouselLoadId) {
                return;
            }
            
            state.currentCarouselImages = allImages;
            state.currentProductCode = productCode;
            
            if (allImages.length > 0) {
                // 显示第一张图片
                const mainImg = new Image();
                mainImg.src = allImages[0];
                mainImg.className = 'detail-image';
                mainImg.alt = productCode;
                mainImg.decoding = 'async';
                
                mainImg.onload = () => {
                    // 再次检查是否是最新的加载请求
                    if (loadId !== currentCarouselLoadId) {
                        return;
                    }
                    
                    mainImg.classList.add('loaded', 'quick-load');
                    mainImageContainer.innerHTML = '';
                    mainImageContainer.appendChild(mainImg);
                    
                    // 缓存图片
                    if (!state.loadedImages[productCode]) {
                        state.loadedImages[productCode] = allImages[0];
                    }
                    
                    // 添加点击放大功能
                    mainImg.addEventListener('click', function() {
                        openImageModal(productCode, allImages[0], 0);
                    });
                    
                    // 如果有更多图片，加载缩略图
                    if (allImages.length > 1) {
                        loadThumbnails(allImages, thumbnailContainer, productCode);
                    }
                };
                
                mainImg.onerror = () => {
                    // 检查是否是最新的加载请求
                    if (loadId !== currentCarouselLoadId) return;
                    
                    showCarouselError(mainImageContainer, productCode);
                };
                
                // 如果图片已经在缓存中
                if (mainImg.complete) {
                    mainImg.onload();
                }
            } else {
                mainImageContainer.innerHTML = `
                    <div class="image-placeholder">
                        <i class="fas fa-image"></i>
                        <p>${translate('noImage')}</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('加载商品轮播图失败:', error);
            // 检查是否是最新的加载请求
            if (loadId !== currentCarouselLoadId) return;
            showCarouselError(mainImageContainer, productCode);
        }
    }

    function showCarouselError(container, productCode) {
        container.innerHTML = `
            <div class="image-error">
                <i class="fas fa-exclamation-triangle"></i>
                <p>${translate('loadingFailed')}</p>
                <button class="retry-btn" onclick="retryLoadCarousel('${productCode}')">
                    <i class="fas fa-redo"></i> ${translate('retry')}
                </button>
            </div>
        `;
    }

    async function retryLoadCarousel(productCode) {
        // 清除缓存
        imageCache.delete(`detail_${productCode}`);
        imageCache.delete(`additional_${productCode}`);
        imageCache.delete(`main_${productCode}`);
        
        // 重新加载
        loadProductCarousel(productCode);
    }

    // ========== 优化 loadThumbnails 函数 ==========
    function loadThumbnails(images, container, productCode) {
        container.innerHTML = '';
        
        images.forEach((url, index) => {
            const thumbnail = document.createElement('div');
            thumbnail.className = `thumbnail ${index === 0 ? 'active' : ''}`;
            thumbnail.dataset.index = index;
            
            const img = new Image();
            img.src = url;
            img.alt = `${translate('thumbnail')} ${index + 1}`;
            img.decoding = 'async';
            
            // 添加图片加载状态管理
            thumbnail.innerHTML = '<div class="skeleton-placeholder" style="width: 100%; height: 100%;"></div>';
            
            img.onload = function() {
                if (thumbnail.contains(thumbnail.querySelector('.skeleton-placeholder'))) {
                    thumbnail.innerHTML = '';
                }
                thumbnail.appendChild(img);
                img.classList.add('loaded', 'quick-load');
            };
            
            img.onerror = function() {
                if (thumbnail.contains(thumbnail.querySelector('.skeleton-placeholder'))) {
                    thumbnail.innerHTML = '';
                }
                thumbnail.innerHTML = `
                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i>
                    </div>
                `;
            };
            
            thumbnail.addEventListener('click', function() {
                switchToImage(index, images, productCode);
            });
            
            container.appendChild(thumbnail);
        });
    }

    function switchToImage(index, images, productCode) {
        const mainContainer = document.getElementById('carousel-main-image');
        const url = images[index];
        
        if (url) {
            const newImg = new Image();
            newImg.alt = productCode;
            newImg.className = 'detail-image';
            newImg.decoding = 'async';
            
            newImg.onload = function() {
                newImg.classList.add('loaded', 'quick-load');
                mainContainer.innerHTML = '';
                mainContainer.appendChild(newImg);
                
                newImg.addEventListener('click', function() {
                    openImageModal(productCode, url, index);
                });
                
                // 更新缩略图选中状态
                document.querySelectorAll('.thumbnail').forEach((thumb, i) => {
                    thumb.classList.toggle('active', i === index);
                });
            };
            
            newImg.onerror = function() {
                mainContainer.innerHTML = `
                    <div class="image-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>${translate('imageLoadError')}</p>
                        <button class="retry-btn" onclick="switchToImage(${index}, ${JSON.stringify(images)}, '${productCode}')">
                            <i class="fas fa-redo"></i> ${translate('retry')}
                        </button>
                    </div>
                `;
            };
            
            newImg.src = url;
            
            if (newImg.complete) {
                newImg.onload();
            }
        }
    }

    // 初始化懒加载
    function initializeLazyLoading() {
        if ('IntersectionObserver' in window) {
            lazyImageObserver = new IntersectionObserver((entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        const imageContainer = entry.target;
                        const productCode = imageContainer.dataset.code;

                        if (productCode && imageContainer.dataset.loading !== 'true' && imageContainer.dataset.loaded !== 'true') {
                            loadProductCardImage(imageContainer, productCode);
                            lazyImageObserver.unobserve(imageContainer);
                        }
                    }
                });
            }, {
                rootMargin: '200px 0px',
                threshold: 0.01
            });
        }
    }

    // 批量图片预加载
    function preloadVisibleImages() {
        const viewportHeight = window.innerHeight;
        const scrollPosition = window.scrollY;
        
        const imageContainers = document.querySelectorAll('.product-image:not([data-loaded]):not([data-loading])');
        
        imageContainers.forEach(container => {
            const rect = container.getBoundingClientRect();
            const productCode = container.dataset.code;
            
            // 预加载可见区域附近的图片（上下200px）
            if (rect.top < viewportHeight + 200 && rect.bottom > -200) {
                loadProductCardImage(container, productCode);
            }
        });
    }

    // 设置商品卡片图片懒加载
    function setupProductCardLazyLoading() {
        // 关键修复：在重新设置懒加载前，清理旧的加载状态
        cleanupImageLoadingStates();
        
        if (lazyImageObserver) {
            lazyImageObserver.disconnect();
        }
        
        initializeLazyLoading();
        
        const imageContainers = document.querySelectorAll('.product-image:not([data-loaded])');
        imageContainers.forEach(container => {
            // 关键修复：确保容器有正确的productCode
            const productCode = container.dataset.code;
            if (!productCode) {
                // 尝试从父元素获取productCode
                const productCard = container.closest('.product-card');
                if (productCard && productCard.dataset.code) {
                    container.dataset.code = productCard.dataset.code;
                }
            }
            
            if (lazyImageObserver) {
                lazyImageObserver.observe(container);
            } else {
                const productCode = container.dataset.code;
                if (productCode) {
                    loadProductCardImage(container, productCode);
                }
            }
        });
    }

    // ========== 图片模态框 ==========
    function openImageModal(partCode, imageUrl, imageIndex = 0) {
        const modal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const modalImageInfo = document.getElementById('modal-image-info');
        
        modalImage.style.opacity = '0';
        modalImage.src = imageUrl;
        modalImage.alt = partCode;
        modalImageInfo.textContent = `${partCode} - ${translate('image')} ${imageIndex + 1}`;
        
        modalImage.onload = function() {
            modalImage.style.opacity = '1';
        };
        
        modalImage.onerror = function() {
            modalImageInfo.textContent = `${translate('imageNotFound')}: ${partCode}`;
            modalImage.src = '';
        };
        
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeImageModal() {
        const modal = document.getElementById('image-modal');
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    // ========== 全局状态和核心功能 ==========
    const state = {
        currentLanguage: localStorage.getItem('product_language') || 'en-US',
        jsonData: null,
        sheetNames: [],
        productsBySheet: {},
        allProducts: [],
        selectedSheet: null,
        selectedProduct: null,
        currentView: 'sheets',
        searchTerm: '',
        filteredProducts: [],
        isSearchMode: false,
        loadedImages: {},
        pagination: {
            currentPage: 1,
            itemsPerPage: 12,
            totalItems: 0,
            totalPages: 1,
            loadedItems: 0,
            isLoading: false
        },
        cart: {
            items: [],
            load() {
                const saved = localStorage.getItem('product_cart');
                if (saved) {
                    this.items = JSON.parse(saved);
                }
                this.updateUI();
            },
            save() {
                localStorage.setItem('product_cart', JSON.stringify(this.items));
                this.updateUI();
            },
            add(product, quantity = 1, brandKey = 'no_brand') {
                const productCode = safeGetValue(product, ['CODE', 'code'], '');
                const brandDisplay = brandMappings[state.currentLanguage][brandKey] || brandKey;
                const existingItem = this.items.find(item => 
                    item.code === productCode && item.selectedBrandKey === brandKey
                );
                
                if (existingItem) {
                    existingItem.quantity += quantity;
                    existingItem.selectedBrand = brandDisplay;
                } else {
                    this.items.push({
                        code: productCode,
                        originalCode: safeGetValue(product, 'originalCode', productCode),
                        name: product.MODEL || product.NAME || product.model || product.name || '未命名商品',
                        sheetName: product.sheetName,
                        specs: product.SPECS || product.specs || product['FITS MACHINE'] || product['fits machine'] || '',
                        quantity: quantity,
                        brand: product.BRAND || product.brand || '',
                        selectedBrandKey: brandKey,
                        selectedBrand: brandDisplay,
                        price: product.PRICE || product.price || 0,
                        image: state.loadedImages[productCode] || null
                    });
                }
                this.save();
                // 若当前没有图片，异步尝试查找并更新
                (async () => {
                    try {
                        const imgUrl = await findMainImage(productCode);  // 只查找主图片
                        if (imgUrl) {
                            const it = this.items.find(item => item.code === productCode && item.selectedBrandKey === brandKey);
                            if (it && !it.image) {
                                it.image = imgUrl;
                                state.loadedImages[productCode] = imgUrl;
                                this.save();
                                this.updateUI();
                            }
                        }
                    } catch (e) {
                        // 忽略查找错误
                    }
                })();
                this.showNotification(translate('cartNotification'));
            },
            update(code, quantity) {
                const item = this.items.find(item => item.code === code);
                if (item) {
                    if (quantity <= 0) {
                        this.remove(code);
                    } else {
                        item.quantity = quantity;
                        this.save();
                    }
                }
            },
            remove(code) {
                this.items = this.items.filter(item => item.code !== code);
                this.save();
                this.showNotification(translate('cartRemoved'));
            },
            clear() {
                this.items = [];
                this.save();
                this.showNotification(translate('cartCleared'));
            },
            getTotalItems() {
                return this.items.reduce((total, item) => total + item.quantity, 0);
            },
            getTotalPrice() {
                return this.items.reduce((total, item) => total + (item.price * item.quantity), 0);
            },
            updateUI() {
                document.getElementById('cart-count').textContent = this.getTotalItems();
                this.renderCart();
                updateCartButtonStates();
            },
            renderCart() {
                const cartContent = document.getElementById('cart-content');
                
                if (this.items.length === 0) {
                    cartContent.innerHTML = `
                        <div class="empty-state" id="empty-cart">
                            <i class="fas fa-shopping-cart"></i>
                            <h3 id="empty-cart-title">${translate('emptyCartTitle')}</h3>
                            <p id="empty-cart-message">${translate('emptyCartMessage')}</p>
                        </div>
                    `;
                    document.getElementById('cart-total-items').textContent = '0';
                    return;
                }
                
                let cartHTML = '';
                
                this.items.forEach((item, index) => {
                    cartHTML += `
                        <div class="cart-item" data-index="${index}" data-code="${item.code}">
                            ${item.image ? `<img src="${item.image}" alt="${item.code}" class="cart-item-image">` : 
                            `<div class="cart-item-image" style="display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
                                <i class="fas fa-box" style="color: #95a5a6;"></i>
                            </div>`}
                            <div class="cart-item-info">
                                <div class="cart-item-name">${item.name}</div>
                                <div class="cart-item-code">${item.code}</div>
                                <div class="cart-item-original-code">${item.originalCode}</div>
                                ${item.selectedBrand ? `<div class="cart-item-brand" style="font-size: 12px; color: #27ae60; margin-bottom: 5px;">品牌: ${item.selectedBrand}</div>` : ''}
                                <div class="cart-item-sheet">${item.sheetName}</div>
                                <div class="cart-item-controls">
                                    <div class="quantity-control">
                                        <button type="button" class="quantity-btn decrease-quantity" data-code="${item.code}">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <input type="number" class="quantity-input" value="${item.quantity}" min="1" data-code="${item.code}">
                                        <button type="button" class="quantity-btn increase-quantity" data-code="${item.code}">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <button type="button" class="remove-item" data-code="${item.code}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                cartContent.innerHTML = cartHTML;
                document.getElementById('cart-total-items').textContent = this.getTotalItems();
                this.bindCartEvents();
            },
            bindCartEvents() {
                const cartContent = document.getElementById('cart-content');
                
                this.items.forEach(item => {
                    const code = item.code;
                    
                    const decreaseBtn = cartContent.querySelector(`.decrease-quantity[data-code="${code}"]`);
                    if (decreaseBtn) {
                        decreaseBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (item.quantity > 1) {
                                this.update(code, item.quantity - 1);
                            } else {
                                if (confirm(translate('confirmRemove'))) {
                                    this.remove(code);
                                }
                            }
                        });
                    }
                    
                    const increaseBtn = cartContent.querySelector(`.increase-quantity[data-code="${code}"]`);
                    if (increaseBtn) {
                        increaseBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.update(code, item.quantity + 1);
                        });
                    }
                    
                    const removeBtn = cartContent.querySelector(`.remove-item[data-code="${code}"]`);
                    if (removeBtn) {
                        removeBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (confirm(translate('confirmRemove'))) {
                                this.remove(code);
                            }
                        });
                    }
                    
                    const quantityInput = cartContent.querySelector(`.quantity-input[data-code="${code}"]`);
                    if (quantityInput) {
                        quantityInput.addEventListener('change', (e) => {
                            e.stopPropagation();
                            const newQuantity = parseInt(e.target.value);
                            if (!isNaN(newQuantity) && newQuantity > 0) {
                                this.update(code, newQuantity);
                            } else {
                                e.target.value = item.quantity;
                            }
                        });
                    }
                });
            },
            showNotification(message) {
                const existingNotification = document.querySelector('.cart-notification');
                if (existingNotification) {
                    existingNotification.remove();
                }
                
                const notification = document.createElement('div');
                notification.className = 'cart-notification';
                notification.innerHTML = `
                    <i class="fas fa-check-circle"></i> ${message}
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }, 1000);
            },
            async loadImageToBuffer(productCode) {
                const mainImageUrl = await findMainImage(productCode);  // 只查找主图片
                if (!mainImageUrl) return null;
                
                try {
                    const response = await fetch(mainImageUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status}`);
                    }
                    
                    const blob = await response.blob();
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = function() {
                            resolve(this.result);
                        };
                        reader.onerror = reject;
                        reader.readAsArrayBuffer(blob);
                    });
                } catch (error) {
                    console.warn(`无法加载图片: ${productCode}`, error);
                    return null;
                }
            },
            
            async exportToExcel() {
                if (this.items.length === 0) {
                    alert(translate('cartEmpty'));
                    return;
                }
                
                const exportBtn = document.getElementById('export-cart');
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在生成Excel...';
                exportBtn.disabled = true;
                
                try {
                    const workbook = new ExcelJS.Workbook();
                    workbook.creator = '配件选购系统';
                    workbook.lastModifiedBy = '配件选购系统';
                    workbook.created = new Date();
                    workbook.modified = new Date();
                    
                    const worksheet = workbook.addWorksheet(
                        state.currentLanguage === 'zh-CN' ? '订购清单' : 'Order List'
                    );
                    
                    worksheet.columns = [
                        { header: '序号', key: 'serial', width: 8 },
                        { header: '图片', key: 'image', width: 40 },
                        { header: '商品编码', key: 'code', width: 20 },
                        { header: '原始编码', key: 'originalCode', width: 20 },
                        { header: '商品名称', key: 'name', width: 30 },
                        { header: '规格说明', key: 'specs', width: 40 },
                        { header: '品牌', key: 'brand', width: 15 },
                        { header: '数量', key: 'quantity', width: 10 }
                    ];
                    
                    worksheet.getColumn(2).height = 120;
                    
                    const headerRow = worksheet.getRow(1);
                    headerRow.font = { bold: true, color: { argb: 'FFFFFF' } };
                    headerRow.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: '3498DB' }
                    };
                    headerRow.alignment = { vertical: 'middle', horizontal: 'center' };
                    headerRow.height = 25;
                    
                    headerRow.eachCell((cell) => {
                        cell.border = {
                            top: { style: 'thin', color: { argb: '000000' } },
                            left: { style: 'thin', color: { argb: '000000' } },
                            bottom: { style: 'thin', color: { argb: '000000' } },
                            right: { style: 'thin', color: { argb: '000000' } }
                        };
                    });
                    
                    for (let i = 0; i < this.items.length; i++) {
                        const item = this.items[i];
                        const rowNumber = i + 2;
                        
                        const row = worksheet.addRow({
                            serial: i + 1,
                            image: '',
                            code: item.code || '',
                            originalCode: item.originalCode || '',
                            name: item.name || '',
                            specs: item.specs || '',
                            brand: item.selectedBrand || translate('noBrand'),
                            quantity: item.quantity || 0
                        });
                        
                        row.height = 75;
                        
                        for (let col = 1; col <= 8; col++) {
                            const cell = row.getCell(col);
                            cell.border = {
                                top: { style: 'thin', color: { argb: 'DDDDDD' } },
                                left: { style: 'thin', color: { argb: 'DDDDDD' } },
                                bottom: { style: 'thin', color: { argb: 'DDDDDD' } },
                                right: { style: 'thin', color: { argb: 'DDDDDD' } }
                            };
                            
                            if (col === 1 || col === 8) {
                                cell.alignment = { vertical: 'middle', horizontal: 'center' };
                            } else if (col === 2) {
                                cell.alignment = { vertical: 'middle', horizontal: 'center' };
                            } else {
                                cell.alignment = { vertical: 'middle', horizontal: 'left' };
                            }
                        }
                    }
                    
                    for (let i = 0; i < this.items.length; i++) {
                        const item = this.items[i];
                        const rowNumber = i + 2;
                        const row = worksheet.getRow(rowNumber);
                        
                        try {
                            const imageBuffer = await this.loadImageToBuffer(item.code);
                            if (imageBuffer) {
                                const imageId = workbook.addImage({
                                    buffer: imageBuffer,
                                    extension: 'png'
                                });
                                
                                const colIndex = 1;
                                const rowIndex = rowNumber - 1;
                                
                                worksheet.addImage(imageId, {
                                    tl: { 
                                        col: colIndex, 
                                        row: rowIndex,
                                        offset: 0
                                    },
                                    br: { 
                                        col: colIndex + 1,
                                        row: rowIndex + 1,
                                        offset: 0
                                    },
                                    editAs: 'oneCell'
                                });
                                
                                worksheet.getColumn(colIndex + 1).width = 12;
                                
                            } else {
                                row.getCell(2).value = translate('noImage');
                                row.getCell(2).alignment = { vertical: 'middle', horizontal: 'center' };
                            }
                        } catch (error) {
                            console.warn(`无法加载图片: ${item.code}`, error);
                            row.getCell(2).value = translate('imageNotFound');
                            row.getCell(2).alignment = { vertical: 'middle', horizontal: 'center' };
                        }
                    }
                    
                    const summaryStartRow = this.items.length + 3;
                    
                    const summaryTitleCell = worksheet.getCell(`A${summaryStartRow}`);
                    summaryTitleCell.value = '汇总信息';
                    summaryTitleCell.font = { bold: true, color: { argb: '3498DB' }, size: 12 };
                    summaryTitleCell.border = {
                        top: { style: 'thin', color: { argb: '3498DB' } },
                        left: { style: 'thin', color: { argb: '3498DB' } },
                        bottom: { style: 'thin', color: { argb: '3498DB' } },
                        right: { style: 'thin', color: { argb: '3498DB' } }
                    };
                    
                    worksheet.getCell(`A${summaryStartRow + 1}`).value = '商品种类';
                    worksheet.getCell(`B${summaryStartRow + 1}`).value = this.items.length;
                    
                    worksheet.getCell(`A${summaryStartRow + 2}`).value = '总数量';
                    worksheet.getCell(`B${summaryStartRow + 2}`).value = this.getTotalItems();
                    
                    const currentDate = new Date();
                    const dateFormatter = state.currentLanguage === 'zh-CN' ? 
                        currentDate.toLocaleDateString('zh-CN') : 
                        currentDate.toLocaleDateString('en-US');
                    const timeFormatter = state.currentLanguage === 'zh-CN' ?
                        currentDate.toLocaleTimeString('zh-CN') :
                        currentDate.toLocaleTimeString('en-US');
                    
                    worksheet.getCell(`A${summaryStartRow + 3}`).value = '导出日期';
                    worksheet.getCell(`B${summaryStartRow + 3}`).value = dateFormatter;
                    
                    worksheet.getCell(`A${summaryStartRow + 4}`).value = '导出时间';
                    worksheet.getCell(`B${summaryStartRow + 4}`).value = timeFormatter;
                    
                    for (let i = summaryStartRow; i <= summaryStartRow + 4; i++) {
                        const row = worksheet.getRow(i);
                        row.height = 20;
                        
                        const cellA = row.getCell(1);
                        cellA.font = { bold: true };
                        cellA.border = {
                            top: { style: 'thin', color: { argb: 'DDDDDD' } },
                            left: { style: 'thin', color: { argb: 'DDDDDD' } },
                            bottom: { style: 'thin', color: { argb: 'DDDDDD' } },
                            right: { style: 'thin', color: { argb: 'DDDDDD' } }
                        };
                        
                        for (let col = 2; col <= 8; col++) {
                            const cell = row.getCell(col);
                            cell.border = {
                                top: { style: 'thin', color: { argb: 'DDDDDD' } },
                                left: { style: 'thin', color: { argb: 'DDDDDD' } },
                                bottom: { style: 'thin', color: { argb: 'DDDDDD' } },
                                right: { style: 'thin', color: { argb: 'DDDDDD' } }
                            };
                        }
                    }
                    
                    const fileName = state.currentLanguage === 'zh-CN' ? 
                        `订购清单_${new Date().toISOString().slice(0,10)}.xlsx` :
                        `Order_List_${new Date().toISOString().slice(0,10)}.xlsx`;
                    
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { 
                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                    });
                    
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url);
                    }, 100);
                    
                    this.showNotification(translate('exportSuccess'));
                    
                } catch (error) {
                    console.error('导出Excel失败:', error);
                    alert('导出失败: ' + error.message);
                } finally {
                    exportBtn.innerHTML = originalText || `<i class="fas fa-file-excel"></i> <span id="export-cart-text">${translate('exportCart')}</span>`;
                    exportBtn.disabled = false;
                }
            }
        },
        selectedProductForCart: null,
        currentCarouselImages: [],
        currentProductCode: ''
    };

    // ========== 辅助函数 ==========
    function safeToLower(value) {
        if (value === null || value === undefined) return '';
        return String(value).toLowerCase();
    }

    function safeGetValue(obj, keys, defaultValue = '') {
        if (!obj) return defaultValue;
        
        for (const key of Array.isArray(keys) ? keys : [keys]) {
            if (obj[key] !== null && obj[key] !== undefined) {
                return String(obj[key]);
            }
        }
        return defaultValue;
    }

    function translate(key) {
        return translations[state.currentLanguage][key] || key;
    }

    function switchLanguage(lang) {
        if (state.currentLanguage === lang) return;
        
        state.currentLanguage = lang;
        localStorage.setItem('product_language', lang);
        updatePageText();
        updateFlagIcon();
        updateBrandSelect();
        refreshCurrentView();
    }

    function updatePageText() {
        // 更新页面文本
        document.getElementById('page-title').textContent = translate('pageTitle');
        document.getElementById('page-subtitle').textContent = translate('pageSubtitle');
        document.getElementById('nav-home').textContent = translate('navHome');
        document.getElementById('nav-machine').textContent = translate('navMachine');
        document.getElementById('nav-cart').textContent = translate('navCart');
        document.getElementById('nav-refresh').textContent = translate('navRefresh');
        document.getElementById('current-language').textContent = state.currentLanguage === 'zh-CN' ? '中文' : 'English';
        document.getElementById('sidebar-title').textContent = translate('sidebarTitle');
        const searchInput = document.getElementById('product-search-input');
        if (searchInput) searchInput.placeholder = translate('searchPlaceholder');
        document.getElementById('data-status-text').textContent = translate('loadingData');
        document.getElementById('cart-title').textContent = translate('cartTitle');
        document.getElementById('empty-cart-title').textContent = translate('emptyCartTitle');
        document.getElementById('empty-cart-message').textContent = translate('emptyCartMessage');
        document.getElementById('cart-total-label').textContent = translate('cartTotal');
        document.getElementById('cart-total-unit').textContent = translate('cartItemsUnit');
        document.getElementById('clear-cart-text').textContent = translate('clearCart');
        document.getElementById('export-cart-text').textContent = translate('exportCart');
        document.getElementById('quantity-modal-title').textContent = translate('selectQuantity');
        document.getElementById('cancel-quantity-text').textContent = translate('cancel');
        document.getElementById('confirm-quantity-text').textContent = translate('confirm');
        document.getElementById('footer-text').textContent = translate('footerText');
    }

    function updateFlagIcon() {
        const languageBtn = document.getElementById('language-btn');
        const flagElement = languageBtn.querySelector('.language-flag');
        
        if (state.currentLanguage === 'zh-CN') {
            flagElement.className = 'language-flag flag-cn';
            flagElement.textContent = '中';
        } else {
            flagElement.className = 'language-flag flag-us';
            flagElement.textContent = 'US';
        }
    }

    function updateBrandSelect() {
        const brandSelect = document.getElementById('brand-select');
        if (!brandSelect) return;
        
        const currentValue = brandSelect.value;
        brandSelect.innerHTML = '';
        
        const brandOptions = [
            { key: 'no_brand', label: translate('noBrand') },
            { key: 'kelon', label: translate('kelon') },
            { key: 'lixiong', label: translate('lixiong') }
        ];
        
        brandOptions.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.key;
            optionElement.textContent = option.label;
            brandSelect.appendChild(optionElement);
        });
        
        brandSelect.value = currentValue || 'no_brand';
    }

    // 图标映射
    const sheetIcons = {
        '01': 'fas fa-gas-pump',
        '02': 'fas fa-oil-can',
        '03': 'fas fa-database',
        '04': 'fas fa-coil',
        '05': 'fas fa-cog',
        '06': 'fas fa-oil-can',
        '07': 'fas fa-gas-pump',
        '08': 'fas fa-link',
        '09': 'fas fa-gas-pump',
        '10': 'fas fa-engine',
        '11': 'fas fa-cut',
        '12': 'fas fa-cogs',
        '13': 'fas fa-tire',
        '14': 'fas fa-layer-group',
        '15': 'fas fa-volume-mute',
        '16': 'fas fa-bolt',
        '17': 'fas fa-snowflake',
        '18': 'fas fa-tools',
        '19': 'fas fa-bolt',
        '20': 'fas fa-sliders-h',
        '21': 'fas fa-wind',
        '22': 'fas fa-cut',
        '23': 'fas fa-spray-can',
        '24': 'fas fa-toolbox',
        '25': 'fas fa-wind',
        '26': 'fas fa-filter',
        '27': 'fas fa-hard-hat',
        '28': 'fas fa-cut',
        '29': 'fas fa-gas-pump',
        '30': 'fas fa-tint',
        '31': 'fas fa-question-circle',
        '32': 'fas fa-history',
        '33': 'fas fa-cable-car'
    };

    const defaultIcon = 'fas fa-table';
    let searchDebounceTimer = null;
    let scrollTimer = null;

    // ========== 页面初始化 ==========
    document.addEventListener('DOMContentLoaded', async function() {
        updatePageText();
        updateFlagIcon();
        updateBrandSelect();
        state.cart.load();
        
        await loadJSONData();
        setupEventListeners();
        
        if (state.sheetNames.length > 0) {
            const firstSheet = state.sheetNames[0];
            state.selectedSheet = firstSheet;
            resetPagination();
            showProductsBySheet(firstSheet);
            setTimeout(() => {
                activateSheetInTree(firstSheet);
            }, 100);
        } else {
            showSheetsList();
        }
        
        // 初始化懒加载
        initializeLazyLoading();
        
        // 添加滚动预加载
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimer);
            scrollTimer = setTimeout(() => {
                preloadVisibleImages();
            }, 100);
        });
        
        // 页面加载完成后预加载首屏图片
        setTimeout(() => {
            preloadVisibleImages();
        }, 500);
    });

    // ========== 数据加载和显示函数 ==========
    async function loadJSONData() {
        try {
            const response = await fetch('products_data.json?v=' + Date.now());
            if (!response.ok) throw new Error(`HTTP错误! 状态: ${response.status}`);
            
            const jsonData = await response.json();
            if (!jsonData || typeof jsonData !== 'object') {
                throw new Error('无效的JSON数据格式');
            }
            
            state.jsonData = jsonData;
            state.sheetNames = Object.keys(state.jsonData);
            
            processJSONData();
            updateDataStatus(true, translate('dataReady'));
            
            initializeTreeView();
            
        } catch (error) {
            console.error('加载JSON数据失败:', error);
            updateDataStatus(false, '加载失败: ' + error.message);
            
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i>
                    <h3>数据加载失败</h3>
                    <p>${error.message}</p>
                    <p>请确保 products_data.json 文件存在且格式正确</p>
                    <button class="action-button" id="retry-load" style="margin-top: 20px;">
                        <i class="fas fa-redo"></i> ${translate('navRefresh')}
                    </button>
                </div>
            `;
            
            document.getElementById('retry-load')?.addEventListener('click', async () => {
                await loadJSONData();
                initializeTreeView();
                showSheetsList();
            });
        }
    }

    function processJSONData() {
        state.productsBySheet = {};
        state.allProducts = [];
        
        state.sheetNames.forEach(sheetName => {
            const sheetData = state.jsonData[sheetName];
            
            if (Array.isArray(sheetData)) {
                const validProducts = sheetData.filter(item => item && typeof item === 'object');
                
                validProducts.forEach(product => {
                    product.sheetName = sheetName;
                    product.originalCode = safeGetValue(product, ['Original CODE', 'originalCode'], '');
                    product.searchCode = safeToLower(product.CODE || product.code || '');
                    product.searchModel = safeToLower(product.MODEL || product.model || '');
                    product.searchName = safeToLower(product.NAME || product.name || '');
                    product.searchFitsMachine = safeToLower(product['FITS MACHINE'] || product['fits machine'] || '');
                    product.searchSpecs = safeToLower(product.SPECS || product.specs || '');
                    product.searchBrand = safeToLower(product.BRAND || product.brand || '');
                    product.searchType = safeToLower(product.TYPE || product.type || '');
                    product.searchDescription = safeToLower(product.DESCRIPTION || product.description || '');
                    product.searchOriginalCode = safeToLower(product.originalCode);
                });
                
                state.productsBySheet[sheetName] = validProducts;
                state.allProducts = state.allProducts.concat(validProducts);
            } else {
                state.productsBySheet[sheetName] = [];
            }
        });
    }

    function updateDataStatus(success, message) {
        const statusElement = document.getElementById('data-status');
        if (statusElement) {
            const icon = statusElement.querySelector('i');
            const text = statusElement.querySelector('span');
            
            if (success) {
                icon.style.color = '#2ecc71';
                icon.className = 'fas fa-check-circle';
                text.textContent = message;
            } else {
                icon.style.color = '#e74c3c';
                icon.className = 'fas fa-exclamation-circle';
                text.textContent = message;
            }
        }
    }

    // 初始化树形视图
    function initializeTreeView() {
        const treeList = document.getElementById('category-tree');
        treeList.innerHTML = '';
        
        state.sheetNames.forEach(sheetName => {
            const productCount = state.productsBySheet[sheetName] ? state.productsBySheet[sheetName].length : 0;
            
            if (productCount === 0) return;
            
            const treeItem = document.createElement('li');
            treeItem.className = 'tree-item';
            treeItem.dataset.sheet = sheetName;
            
            let icon = defaultIcon;
            const matches = sheetName.match(/\d+/);
            if (matches && sheetIcons[matches[0]]) {
                icon = sheetIcons[matches[0]];
            }
            
            treeItem.innerHTML = `
                <div class="tree-header ${state.selectedSheet === sheetName && state.currentView === 'products' && !state.isSearchMode ? 'active' : ''}">
                    <div class="tree-toggle">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="tree-icon">
                        <i class="${icon}"></i>
                    </div>
                    <span>${sheetName}</span>
                    <div class="part-count">${productCount}</div>
                </div>
            `;
            
            const treeHeader = treeItem.querySelector('.tree-header');
            
            treeHeader.addEventListener('click', function(e) {
                e.stopPropagation();
                exitSearchMode();
                
                document.querySelectorAll('.tree-header').forEach(header => {
                    header.classList.remove('active');
                });
                treeHeader.classList.add('active');
                
                state.selectedSheet = sheetName;
                resetPagination();
                showProductsBySheet(sheetName);
            });
            
            treeList.appendChild(treeItem);
        });
    }

    // 退出搜索模式
    function exitSearchMode() {
        state.isSearchMode = false;
        state.searchTerm = '';
        state.filteredProducts = [];
        
        const searchInput = document.getElementById('product-search-input');
        if (searchInput) {
            searchInput.value = '';
        }
        
        if (searchDebounceTimer) {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = null;
        }
    }

    // 清空搜索
    function clearSearch() {
        exitSearchMode();
        
        if (state.selectedSheet) {
            resetPagination();
            showProductsBySheet(state.selectedSheet);
        } else {
            showSheetsList();
        }
    }

    // 重置分页状态
    function resetPagination() {
        state.pagination.currentPage = 1;
        state.pagination.loadedItems = 0;
        state.pagination.isLoading = false;
    }

    // 更新分页信息
    function updatePaginationInfo(totalItems) {
        state.pagination.totalItems = totalItems;
        state.pagination.totalPages = Math.ceil(totalItems / state.pagination.itemsPerPage);
        state.pagination.currentPage = Math.min(state.pagination.currentPage, state.pagination.totalPages);
    }

    // 显示工作表列表页面
    function showSheetsList() {
        const mainContent = document.getElementById('main-content');
        const totalProducts = state.allProducts.length;
        
        mainContent.innerHTML = `
            <div class="content-header">
                <div class="content-title">${translate('allSheets')}</div>
                <div class="content-subtitle">${translate('dataDescription')}</div>
            </div>
            <div class="empty-state">
                <i class="fas fa-database" style="color: #3498db;"></i>
                <h3>${translate('dataDirectory')}</h3>
                <p>${translate('dataDescription')}</p>
                <div style="margin-top: 20px; text-align: center;">
                    <div style="display: inline-flex; justify-content: center; gap: 30px; margin-bottom: 20px; flex-wrap: wrap;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 600; color: #3498db;">${state.sheetNames.length}</div>
                            <div style="font-size: 12px; color: #6c757d;">${translate('sheetsCount')}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 600; color: #3498db;">${totalProducts}</div>
                            <div style="font-size: 12px; color: #6c757d;">${translate('partsCount')}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        state.currentView = 'sheets';
        state.selectedSheet = null;
        state.selectedProduct = null;
        
        document.querySelectorAll('.tree-header').forEach(header => {
            header.classList.remove('active');
        });
    }

    // 在所有商品中搜索
    function searchAllProducts(searchTerm) {
        if (!searchTerm || searchTerm.trim().length < 1) {
            return [];
        }
        
        const term = searchTerm.toLowerCase().trim();
        const searchWords = term.split(/\s+/).filter(word => word.length > 0);
        
        return state.allProducts.filter(product => {
            if (searchWords.length === 1) {
                const singleWord = searchWords[0];
                return (
                    (product.searchCode && product.searchCode.includes(singleWord)) ||
                    (product.searchOriginalCode && product.searchOriginalCode.includes(singleWord)) ||
                    (product.searchModel && product.searchModel.includes(singleWord)) ||
                    (product.searchName && product.searchName.includes(singleWord)) ||
                    (product.searchFitsMachine && product.searchFitsMachine.includes(singleWord)) ||
                    (product.searchSpecs && product.searchSpecs.includes(singleWord)) ||
                    (product.searchBrand && product.searchBrand.includes(singleWord)) ||
                    (product.searchType && product.searchType.includes(singleWord)) ||
                    (product.searchDescription && product.searchDescription.includes(singleWord)) ||
                    (product.sheetName && safeToLower(product.sheetName).includes(singleWord))
                );
            }
            
            return searchWords.every(word => {
                return (
                    (product.searchCode && product.searchCode.includes(word)) ||
                    (product.searchOriginalCode && product.searchOriginalCode.includes(word)) ||
                    (product.searchModel && product.searchModel.includes(word)) ||
                    (product.searchName && product.searchName.includes(word)) ||
                    (product.searchFitsMachine && product.searchFitsMachine.includes(word)) ||
                    (product.searchSpecs && product.searchSpecs.includes(word)) ||
                    (product.searchBrand && product.searchBrand.includes(word)) ||
                    (product.searchType && product.searchType.includes(word)) ||
                    (product.searchDescription && product.searchDescription.includes(word)) ||
                    (product.sheetName && safeToLower(product.sheetName).includes(word))
                );
            });
        });
    }

    // ========== 关键修复：按工作表显示商品（清理加载状态）==========
    function showProductsBySheet(sheetName) {
        if (state.isSearchMode) {
            showSearchResults();
            return;
        }
        
        // 关键修复：在显示新商品列表前清理旧的加载状态
        cleanupImageLoadingStates();
        
        const products = state.productsBySheet[sheetName] || [];
        updatePaginationInfo(products.length);
        
        const startIndex = (state.pagination.currentPage - 1) * state.pagination.itemsPerPage;
        const endIndex = startIndex + state.pagination.itemsPerPage;
        const currentPageProducts = products.slice(startIndex, endIndex);
        
        const mainContent = document.getElementById('main-content');
        
        mainContent.innerHTML = `
            <div class="content-header">
                <div>
                    <div class="content-title">${sheetName}</div>
                    <div class="content-subtitle">${translate('foundItems')} ${products.length} ${translate('items')}</div>
                </div>
            </div>
            <div class="products-grid" id="products-grid">
                ${currentPageProducts.length > 0 ? 
                    currentPageProducts.map((product, index) => createProductCard(product, index)).join('') 
                    : 
                    `<div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-box-open"></i>
                        <h3>${translate('noProducts')}</h3>
                        <p>${translate('noProductsInSheet')}</p>
                    </div>`
                }
            </div>
            
            ${products.length > state.pagination.itemsPerPage ? createPaginationControls() : ''}
        `;
        
        document.querySelectorAll('.product-card').forEach((card, index) => {
            const product = currentPageProducts[index];
            
            if (product) {
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.cart-button')) {
                        showProductDetail(product, sheetName);
                    }
                });
                
                const cartBtn = card.querySelector('.cart-button');
                if (cartBtn) {
                    cartBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        addToCart(product);
                    });
                }
            }
        });
        
        updateCartButtonStates();
        setupPaginationEvents(sheetName);
        
        state.currentView = 'products';
        state.selectedSheet = sheetName;
        
        setTimeout(() => {
            setupProductCardLazyLoading();
        }, 100);
    }

    // 更新购物车按钮状态
    function updateCartButtonStates() {
        document.querySelectorAll('.product-card').forEach(card => {
            const productCode = card.dataset.code;
            const cartBtn = card.querySelector('.cart-button');
            if (!cartBtn) return;

            const inCart = state.cart.items.some(item => item.code === productCode);
            if (inCart) {
                cartBtn.classList.add('added');
                cartBtn.innerHTML = '<i class="fas fa-check"></i>';
                cartBtn.title = translate('removeFromCart');
            } else {
                cartBtn.classList.remove('added');
                cartBtn.innerHTML = '<i class="fas fa-cart-plus"></i>';
                cartBtn.title = translate('addToCart');
            }
        });
    }

    // 创建商品卡片HTML
    function createProductCard(product, index) {
        const productCode = safeGetValue(product, ['CODE', 'code'], `ITEM_${index}`);
        const productName = safeGetValue(product, ['MODEL', 'model', 'NAME', 'name'], '未命名商品');
        const productSpecs = safeGetValue(product, ['FITS MACHINE', 'fits machine', 'SPECS', 'specs'], '');
        const sheetName = product.sheetName || '';
        const originalCode = safeGetValue(product, ['Original CODE', 'originalCode'], '');
        const inCart = state.cart.items.find(item => item.code === productCode);
        
        return `
            <div class="product-card fade-in" data-code="${productCode}">
                <button class="cart-button ${inCart ? 'added' : ''}" title="${inCart ? translate('removeFromCart') : translate('addToCart')}" data-code="${productCode}">
                    <i class="fas ${inCart ? 'fa-check' : 'fa-cart-plus'}"></i>
                </button>
                <div class="product-image" data-code="${productCode}">
                    <div class="lazy-placeholder">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>${translate('loading')}</span>
                    </div>
                </div>
                <div class="product-info">
                    <div class="product-name" title="${productName}">${productName}</div>
                    ${productSpecs ? `<div class="product-specs" title="${productSpecs}">${productSpecs}</div>` : ''}
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 8px; border-top: 1px solid #eee;">
                        <div style="flex: 1;">
                            <div style="font-size: 12px; color: #3498db; font-weight: 600; font-family: 'Courier New', monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${productCode}">${productCode}</div>
                        </div>
                        ${originalCode ? `
                            <div style="flex: 1; text-align: right;">
                                <div style="font-size: 11px; color: #3498db; font-family: 'Courier New', monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${originalCode}">${originalCode}</div>
                            </div>
                        ` : ''}
                    </div>
                    ${sheetName ? `<div style="font-size: 10px; color: #95a5a6; margin-top: 5px;">${sheetName}</div>` : ''}
                </div>
            </div>
        `;
    }

    // 显示搜索结果
    function showSearchResults() {
        const results = state.filteredProducts;
        updatePaginationInfo(results.length);
        
        const startIndex = (state.pagination.currentPage - 1) * state.pagination.itemsPerPage;
        const endIndex = startIndex + state.pagination.itemsPerPage;
        const currentPageProducts = results.slice(startIndex, endIndex);
        
        const mainContent = document.getElementById('main-content');
        
        mainContent.innerHTML = `
            <div class="content-header">
                <div>
                    <div class="content-title">${translate('searchResults')}</div>
                    <div class="content-subtitle">${translate('foundItems')} ${results.length} ${translate('itemsFor')} "${state.searchTerm}"</div>
                </div>
            </div>
            <div class="products-grid" id="products-grid">
                ${currentPageProducts.length > 0 ? 
                    currentPageProducts.map((product, index) => createProductCard(product, index)).join('') 
                    : 
                    `<div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-search"></i>
                        <h3>${translate('noResults')}</h3>
                        <p>${translate('tryOtherKeywords')}</p>
                    </div>`
                }
            </div>
            
            ${results.length > state.pagination.itemsPerPage ? createPaginationControls() : ''}
        `;
        
        document.querySelectorAll('.product-card').forEach((card, index) => {
            const product = currentPageProducts[index];
            
            if (product) {
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.cart-button')) {
                        showProductDetail(product, product.sheetName);
                    }
                });
                
                const cartBtn = card.querySelector('.cart-button');
                if (cartBtn) {
                    cartBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        addToCart(product);
                    });
                }
            }
        });
        
        updateCartButtonStates();
        setupSearchPaginationEvents();
        
        state.currentView = 'products';
        
        setTimeout(() => {
            setupProductCardLazyLoading();
        }, 100);
    }

    // 创建分页控件
    function createPaginationControls() {
        const pagination = state.pagination;
        const maxVisiblePages = 5;
        let startPage = Math.max(1, pagination.currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(pagination.totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        let pageButtons = '';
        for (let i = startPage; i <= endPage; i++) {
            pageButtons += `
                <button class="pagination-button ${i === pagination.currentPage ? 'active' : ''}" 
                        data-page="${i}">
                    ${i}
                </button>
            `;
        }
        
        return `
            <div class="pagination-container">
                <div class="pagination-info">
                    ${translate('showItems')} ${Math.min((pagination.currentPage - 1) * pagination.itemsPerPage + 1, pagination.totalItems)} 
                    ${translate('to')} ${Math.min(pagination.currentPage * pagination.itemsPerPage, pagination.totalItems)} 
                    ${translate('of')} ${pagination.totalItems} ${translate('items')}
                </div>
                <div class="pagination-controls">
                    <button class="pagination-button" id="first-page" ${pagination.currentPage === 1 ? 'disabled' : ''}>
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                    <button class="pagination-button" id="prev-page" ${pagination.currentPage === 1 ? 'disabled' : ''}>
                        <i class="fas fa-angle-left"></i>
                    </button>
                    
                    <div class="page-numbers">
                        ${pageButtons}
                    </div>
                    
                    <button class="pagination-button" id="next-page" ${pagination.currentPage === pagination.totalPages ? 'disabled' : ''}>
                        <i class="fas fa-angle-right"></i>
                    </button>
                    <button class="pagination-button" id="last-page" ${pagination.currentPage === pagination.totalPages ? 'disabled' : ''}>
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                    
                    <div class="pagination-input-group">
                        <span>${translate('goToPage')}</span>
                        <input type="number" class="pagination-input" id="page-input" 
                            min="1" max="${pagination.totalPages}" 
                            value="${pagination.currentPage}">
                        <span>${translate('page')}</span>
                        <button class="pagination-button" id="go-to-page">${translate('jump')}</button>
                    </div>
                </div>
            </div>
        `;
    }

    // 设置分页事件
    function setupPaginationEvents(sheetName) {
        document.getElementById('first-page')?.addEventListener('click', () => {
            goToPage(1, sheetName);
        });
        
        document.getElementById('prev-page')?.addEventListener('click', () => {
            goToPage(state.pagination.currentPage - 1, sheetName);
        });
        
        document.getElementById('next-page')?.addEventListener('click', () => {
            goToPage(state.pagination.currentPage + 1, sheetName);
        });
        
        document.getElementById('last-page')?.addEventListener('click', () => {
            goToPage(state.pagination.totalPages, sheetName);
        });
        
        document.querySelectorAll('.pagination-button[data-page]').forEach(button => {
            button.addEventListener('click', (e) => {
                const page = parseInt(e.target.dataset.page);
                goToPage(page, sheetName);
            });
        });
        
        document.getElementById('go-to-page')?.addEventListener('click', () => {
            const input = document.getElementById('page-input');
            const page = parseInt(input.value);
            if (page >= 1 && page <= state.pagination.totalPages) {
                goToPage(page, sheetName);
            } else {
                alert(`请输入有效的页码 (1-${state.pagination.totalPages})`);
                input.value = state.pagination.currentPage;
            }
        });
        
        document.getElementById('page-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('go-to-page').click();
            }
        });
    }

    // 跳转到指定页
    function goToPage(page, sheetName) {
        if (page < 1 || page > state.pagination.totalPages || page === state.pagination.currentPage) {
            return;
        }
        
        state.pagination.currentPage = page;
        showProductsBySheet(sheetName);
        document.querySelector('.products-grid').scrollTop = 0;
    }

    // 设置搜索分页事件
    function setupSearchPaginationEvents() {
        document.getElementById('first-page')?.addEventListener('click', () => {
            goToPageSearch(1);
        });
        
        document.getElementById('prev-page')?.addEventListener('click', () => {
            goToPageSearch(state.pagination.currentPage - 1);
        });
        
        document.getElementById('next-page')?.addEventListener('click', () => {
            goToPageSearch(state.pagination.currentPage + 1);
        });
        
        document.getElementById('last-page')?.addEventListener('click', () => {
            goToPageSearch(state.pagination.totalPages);
        });
        
        document.querySelectorAll('.pagination-button[data-page]').forEach(button => {
            button.addEventListener('click', (e) => {
                const page = parseInt(e.target.dataset.page);
                goToPageSearch(page);
            });
        });
        
        document.getElementById('go-to-page')?.addEventListener('click', () => {
            const input = document.getElementById('page-input');
            const page = parseInt(input.value);
            if (page >= 1 && page <= state.pagination.totalPages) {
                goToPageSearch(page);
            } else {
                alert(`请输入有效的页码 (1-${state.pagination.totalPages})`);
                input.value = state.pagination.currentPage;
            }
        });
        
        document.getElementById('page-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('go-to-page').click();
            }
        });
    }

    // 跳转到搜索结果的指定页
    function goToPageSearch(page) {
        if (page < 1 || page > state.pagination.totalPages || page === state.pagination.currentPage) {
            return;
        }
        
        state.pagination.currentPage = page;
        showSearchResults();
        document.querySelector('.products-grid').scrollTop = 0;
    }

    // ========== 关键修复：显示商品详情页面（重置轮播加载状态）==========
    function showProductDetail(product, sheetName) {
        // 关键修复：重置轮播加载ID
        currentCarouselLoadId = 0;
        
        const productCode = safeGetValue(product, ['CODE', 'code'], '未知编码');
        const productName = safeGetValue(product, ['MODEL', 'model', 'NAME', 'name'], '未命名商品');
        const originalCode = safeGetValue(product, ['Original CODE', 'originalCode'], '');
        
        const mainContent = document.getElementById('main-content');
        
        let detailsHtml = '';
        for (const [key, value] of Object.entries(product)) {
            if (key.startsWith('_') || key.startsWith('search')) continue;
            if (key === 'IMAGE' || key === 'image') continue;
            if (key === 'CODE' || key === 'code') continue;
            if (key === 'MODEL' || key === 'model' || key === 'NAME' || key === 'name') continue;
            if (key === 'sheetName') continue;
            if (key === 'originalCode') continue;
            if (key === 'Original CODE') continue;
            
            if (value !== null && value !== undefined && value !== '') {
                const displayValue = typeof value === 'string' ? value : JSON.stringify(value);
                detailsHtml += `
                    <tr>
                        <td class="info-label">${key}</td>
                        <td class="info-value">${displayValue}</td>
                    </tr>
                `;
            }
        }
        
        mainContent.innerHTML = `
            <div class="content-header">
                <div>
                    <div class="content-title">${translate('productDetails')}</div>
                    <div class="detail-code">${translate('productCode')} ${productCode}</div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="action-button" id="back-to-list">
                        <i class="fas fa-arrow-left"></i> ${translate('backToList')}
                    </button>
                    <button class="action-button" id="add-to-cart-detail">
                        <i class="fas fa-cart-plus"></i> ${translate('addToCart')}
                    </button>
                </div>
            </div>
            <div class="product-detail">
                <div class="detail-content slide-in">
                    <div class="detail-image-section" id="detail-image-section">
                        <div class="image-carousel">
                            <div class="carousel-main-image" id="carousel-main-image">
                                <div class="lazy-placeholder">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>${translate('checkingImages')}...</span>
                                </div>
                            </div>
                            
                            <div class="thumbnail-container" id="thumbnail-container"></div>
                            
                            <button class="carousel-btn prev-btn" id="prev-btn">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="carousel-btn next-btn" id="next-btn">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            
                            <div class="carousel-indicators" id="carousel-indicators"></div>
                            
                            <div class="carousel-info" id="carousel-info" style="display: none;">
                                1 / 1
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-info-section">
                        <div class="info-card">
                            <h3>${translate('basicInfo')}</h3>
                            <table class="info-table">
                                <tr>
                                    <td class="info-label">${translate('productCode')}</td>
                                    <td class="info-value"><span style="font-family: 'Courier New', monospace; font-weight: 600; color: #3498db;">${productCode}</span></td>
                                </tr>
                                ${originalCode ? `<tr>
                                    <td class="info-label">${translate('originalCode')}</td>
                                    <td class="info-value"><span style="font-family: 'Courier New', monospace; font-weight: 600; color: #27ae60;">${originalCode}</span></td>
                                </tr>` : ''}
                                <tr>
                                    <td class="info-label">${translate('productName')}</td>
                                    <td class="info-value">${productName}</td>
                                </tr>
                                <tr>
                                    <td class="info-label">${translate('sheetName')}</td>
                                    <td class="info-value">${sheetName}</td>
                                </tr>
                            </table>
                        </div>
                        
                        ${detailsHtml ? `
                            <div class="info-card">
                                <h3>${translate('detailedInfo')}</h3>
                                <table class="info-table">
                                    ${detailsHtml}
                                </table>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
        
        // 关键修复：确保在DOM更新后加载轮播图
        setTimeout(() => {
            loadProductCarousel(productCode);
        }, 50);
        
        document.getElementById('back-to-list').addEventListener('click', () => {
            if (state.isSearchMode) {
                showSearchResults();
            } else if (state.selectedSheet) {
                showProductsBySheet(state.selectedSheet);
            } else {
                showSheetsList();
            }
        });
        
        document.getElementById('add-to-cart-detail').addEventListener('click', () => {
            addToCart(product);
        });
        
        state.currentView = 'detail';
        state.selectedProduct = product;
    }

    // 添加商品到购物车
    function addToCart(product) {
        state.selectedProductForCart = product;
        
        const modal = document.getElementById('quantity-modal');
        const title = document.getElementById('quantity-modal-title');
        const quantityInput = document.getElementById('quantity-input');
        const brandSelect = document.getElementById('brand-select');
        
        const productName = safeGetValue(product, ['MODEL', 'model', 'NAME', 'name'], '未命名商品');
        
        title.textContent = `${translate('selectQuantity')} "${productName}"`;
        quantityInput.value = 1;
        quantityInput.focus();
        quantityInput.select();
        
        modal.classList.add('active');
    }

    // 确认添加到购物车
    function confirmAddToCart() {
        const quantityInput = document.getElementById('quantity-input');
        const brandSelect = document.getElementById('brand-select');
        const quantity = parseInt(quantityInput.value);
        const brandKey = brandSelect.value;
        
        if (isNaN(quantity) || quantity < 1) {
            alert(translate('enterQuantity'));
            return;
        }
        
        if (state.selectedProductForCart) {
            state.cart.add(state.selectedProductForCart, quantity, brandKey);
            document.getElementById('quantity-modal').classList.remove('active');
            state.selectedProductForCart = null;
        }
    }

    // 执行搜索功能
    function performSearch() {
        const searchTerm = state.searchTerm.trim();
        
        if (searchTerm.length < 1) {
            exitSearchMode();
            
            if (state.selectedSheet) {
                showProductsBySheet(state.selectedSheet);
            } else {
                showSheetsList();
            }
            return;
        }
        
        state.filteredProducts = searchAllProducts(searchTerm);
        state.isSearchMode = true;
        resetPagination();
        showSearchResults();
        
        document.querySelectorAll('.tree-header').forEach(header => {
            header.classList.remove('active');
        });
    }

    // 购物车开关功能
    function toggleCartSidebar() {
        const cartSidebar = document.getElementById('cart-sidebar');
        const cartOverlay = document.getElementById('cart-overlay');
        
        if (cartSidebar.classList.contains('active')) {
            cartSidebar.classList.remove('active');
            cartOverlay.classList.remove('active');
        } else {
            cartSidebar.classList.add('active');
            cartOverlay.classList.add('active');
        }
    }

    // 关闭购物车
    function closeCartSidebar() {
        document.getElementById('cart-sidebar').classList.remove('active');
        document.getElementById('cart-overlay').classList.remove('active');
    }

    function refreshCurrentView() {
        if (state.currentView === 'sheets') {
            showSheetsList();
        } else if (state.currentView === 'products') {
            if (state.isSearchMode) {
                showSearchResults();
            } else if (state.selectedSheet) {
                showProductsBySheet(state.selectedSheet);
            }
        } else if (state.currentView === 'detail') {
            showProductDetail(state.selectedProduct, state.selectedSheet);
        }
    }

    function activateSheetInTree(sheetName) {
        document.querySelectorAll('.tree-header').forEach(header => {
            header.classList.remove('active');
        });
        
        const sheetHeader = document.querySelector(`.tree-item[data-sheet="${sheetName}"] .tree-header`);
        if (sheetHeader) {
            sheetHeader.classList.add('active');
        }
    }

    // ========== 事件监听器 ==========
    function setupEventListeners() {
        // 语言切换
        const languageBtn = document.getElementById('language-btn');
        const languageDropdown = document.getElementById('language-dropdown');
        const languageOptions = document.querySelectorAll('.language-option');
        
        languageBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            languageDropdown.classList.toggle('active');
        });
        
        languageOptions.forEach(option => {
            option.addEventListener('click', function() {
                const lang = this.dataset.lang;
                switchLanguage(lang);
                languageOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                languageDropdown.classList.remove('active');
            });
        });
        
        document.addEventListener('click', function() {
            languageDropdown.classList.remove('active');
        });
        
        // 商品搜索框事件
        const searchInput = document.getElementById('product-search-input');
        const clearSearchBtn = document.getElementById('clear-search');
        
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value;
            state.searchTerm = searchTerm;
            
            if (searchDebounceTimer) {
                clearTimeout(searchDebounceTimer);
            }
            
            if (!searchTerm.trim()) {
                clearSearch();
                return;
            }
            
            searchDebounceTimer = setTimeout(() => {
                performSearch();
            }, 300);
        });
        
        clearSearchBtn.addEventListener('click', function() {
            clearSearch();
        });
        
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (searchDebounceTimer) {
                    clearTimeout(searchDebounceTimer);
                }
                performSearch();
            }
        });
        
        // 图片模态框事件
        document.getElementById('modal-close').addEventListener('click', closeImageModal);
        
        document.getElementById('image-modal').addEventListener('click', function(e) {
            if (e.target === this || e.target.classList.contains('modal-image')) {
                closeImageModal();
            }
        });
        
        // 购物车相关事件
        document.getElementById('view-cart').addEventListener('click', function(e) {
            e.stopPropagation();
            toggleCartSidebar();
        });
        
        document.getElementById('cart-close').addEventListener('click', function() {
            closeCartSidebar();
        });
        
        document.getElementById('cart-overlay').addEventListener('click', function() {
            closeCartSidebar();
        });
        
        document.getElementById('cart-sidebar').addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        document.getElementById('clear-cart').addEventListener('click', function() {
            if (confirm(translate('confirmClearCart'))) {
                state.cart.clear();
            }
        });
        
        document.getElementById('export-cart').addEventListener('click', function() {
            state.cart.exportToExcel();
        });
        
        // 数量选择模态框事件
        document.getElementById('cancel-quantity').addEventListener('click', function() {
            document.getElementById('quantity-modal').classList.remove('active');
            state.selectedProductForCart = null;
        });
        
        document.getElementById('confirm-quantity').addEventListener('click', confirmAddToCart);
        
        document.getElementById('quantity-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmAddToCart();
            }
        });
        
        document.getElementById('brand-select').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmAddToCart();
            }
        });
        
        // 刷新数据按钮
        document.getElementById('refresh-data').addEventListener('click', async () => {
            // 清理图片缓存
            try {
                imageLoadingPromises.clear();
                imageCache.clear();
                if (lazyImageObserver) {
                    try { lazyImageObserver.disconnect(); } catch (e) { /* ignore */ }
                    lazyImageObserver = null;
                }
            } catch (e) {
                console.warn('刷新时清理图片缓存失败', e);
            }

            await loadJSONData();
            initializeTreeView();
            if (state.sheetNames.length > 0) {
                const firstSheet = state.sheetNames[0];
                state.selectedSheet = firstSheet;
                resetPagination();
                clearSearch();
                showProductsBySheet(firstSheet);
                activateSheetInTree(firstSheet);
            } else {
                showSheetsList();
            }
        });
        
        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageModal();
                document.getElementById('quantity-modal').classList.remove('active');
                closeCartSidebar();
                
                if (state.currentView === 'detail') {
                    if (state.isSearchMode) {
                        showSearchResults();
                    } else if (state.selectedSheet) {
                        showProductsBySheet(state.selectedSheet);
                    } else {
                        showSheetsList();
                    }
                }
            }
        });
    }
</script>
</body>
</html>